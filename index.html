<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-云计算/云计算常见概念" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.939Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="SaaS、PaaS、IaaS"><a href="#SaaS、PaaS、IaaS" class="headerlink" title="SaaS、PaaS、IaaS"></a>SaaS、PaaS、IaaS</h4><p>简单的说都属于云计算服务，也就是云计算+服务</p>
<p>维基百科有以下定义：Cloud computing is a new form of Internet-based computing that provides shared computer processing resources and data to computers and other devices on demand. </p>
<p>云计算就是一种按照需求通过Internet获取计算资源的形态。这些计算资源被包装成为服务，提供给用户。而提供这些服务的主体，我们称之为云服务供应商（Cloud Service Provider）。</p>
<p>按照NIST (National Institute of Standards and Technology，美国国家标准和技术研究院)的定义，云服务最主要的有三类，就是IaaS、PaaS、SaaS</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/v2-1a82f8a4997b0ba53d801639d4c6706e_r.jpg" alt="v2-1a82f8a4997b0ba53d801639d4c6706e_r"></p>
<p>IaaS（Infrastructure as a service – 基础设施即服务）：用户可以在云服务提供商提供的基础设施上部署和运行任何软件，包括操作系统和应用软件。用户没有权限管理和访问底层的基础设施，如服务器、交换机、硬盘等，但是有权管理操作系统、存储内容，可以安装管理应用程序，甚至是有权管理网络组件。简单的说用户使用IaaS，有权管理操作系统之上的一切功能。我们常见的IaaS服务有虚拟机、虚拟网络、以及存储。</p>
<p>PaaS（Platform as a service – 平台即服务）：PaaS给用户提供的能力是使用由云服务提供商支持的编程语言、库、服务以及开发工具来创建、开发应用程序并部署在相关的基础设施上。用户无需管理底层的基础设施，包括网络、服务器，操作系统或者存储。他们只能控制部署在基础设施中操作系统上的应用程序，配置应用程序所托管的环境的可配置参数。常见的PaaS服务有数据库服务、web应用以及容器服务。成熟的PaaS服务会简化开发人员，提供完备的PC端和移动端软件开发套件（SDK），拥有丰富的开发环境（Inteli、Eclipse、VS等），完全可托管的数据库服务，可配置式的应用程序构建，支持多语言的开发，面向应用市场。</p>
<p>SaaS（Software as a Service – 软件即服务）：SaaS给用户提供的能力是使用在云基础架构上运行的云服务提供商的应用程序。可以通过轻量的客户端接口（诸如web浏览器（例如，基于web的电子邮件））或程序接口从各种客户端设备访问应用程序。 用户无需管理或控制底层云基础架构，包括网络，服务器，操作系统，存储甚至单独的应用程序功能，可能的例外是有限的用户特定应用程序配置设置。类似的服务有：各类的网盘(Dropbox、百度网盘等)，JIRA，GitLab等服务。而这些应用的提供者不仅仅是云服务提供商，还有众多的第三方提供商（ISV: independent software provider）。</p>
<h4 id="公有云、私有云与混合云"><a href="#公有云、私有云与混合云" class="headerlink" title="公有云、私有云与混合云"></a>公有云、私有云与混合云</h4><p>公有云：众多企业公用一个云服务器，可以理解为共享资源服务。如果公有云比喻成出租公寓，那么企业就是其中的租户之一，当企业选择停止租用时，空间将被清理并释放出来租给下个租户。</p>
<p>公有云的优点是价格低廉、使用便捷、节省维护成本，所以用户多以创业公司和个人居多。</p>
<p>缺点是不够安全，容易发生文件泄露的风险，而且当需要移动大量数据的时候，企业面临的将是很大一笔费用。</p>
<p>私有云：服务器可以是企业自己建立也可以是租用第三方服务器，企业独享服务器只为该企业提供数据服务。如果公有云是出租公寓，那么私有云就是独门独户的小别墅。</p>
<p>私有云的优点是提供了更加安全的环境，用户可以根据需求选择定制其资源。</p>
<p>缺点是安装成本高，高度安全性可能会使部分功能操作有局限性。</p>
<p>混合云：混合了公有云和私有云的一种解决方式，企业可以将重要文件放置私有云，普通文件放置公有云，两者之间可以进行数据和应用的移植。</p>
<p>混合云的优点是可以满足企业多样化需求，节省必要的开支。</p>
<p>缺点是开发过程中因兼容等问题会变得比较复杂，后期的维护也需要花费时间和人力，对于企业的实力要求较高。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/" data-id="ckk2gq3tp0017z8pqfinq3xys" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-延迟消息发送/03_Redis实现延迟消息发送" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.932Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="1、引入redis依赖"><a href="#1、引入redis依赖" class="headerlink" title="1、引入redis依赖"></a>1、引入redis依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="2、配置redis监听器"><a href="#2、配置redis监听器" class="headerlink" title="2、配置redis监听器"></a>2、配置redis监听器</h4>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/" data-id="ckk2gq3tt001cz8pqfrjf75fw" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-延迟消息发送/02_RabbitMQ实现延迟消息发送" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.930Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/1577032972133000359.png" alt="Xnip2019-12-23_00-42-10.png"></p>
<p>1、死信队列</p>
<p>2、延迟队列，需下载插件</p>
<h4 id="1、docker下载并启动RabbitMQ"><a href="#1、docker下载并启动RabbitMQ" class="headerlink" title="1、docker下载并启动RabbitMQ"></a>1、docker下载并启动RabbitMQ</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">安装：</span></span><br><span class="line"><span class="meta">#</span><span class="bash">management表示该版本带管理界面</span></span><br><span class="line">docker pull rabbitmq:3-management</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">启动：</span></span><br><span class="line">docker run -d -p 5672:5672 -p 15672:15672 --name myrabbitmq 64a1f920fb0d</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">插件</span></span><br><span class="line">docker image inspect d4489446dfcc|grep -i version</span><br></pre></td></tr></table></figure>


<h4 id="2、下载RabbitMQ延迟消息队列插件"><a href="#2、下载RabbitMQ延迟消息队列插件" class="headerlink" title="2、下载RabbitMQ延迟消息队列插件"></a>2、下载RabbitMQ延迟消息队列插件</h4><p><a target="_blank" rel="noopener" href="https://www.rabbitmq.com/community-plugins.html">下载地址：RabbitMQ插件社区</a></p>
<p>==一定选好版本号，由于我使用的是RabbitMQ 3.8.9,因此对应的<code>rabbitmq_delayed_message_exchange</code>插件也必须选择3.8.x的,我下载了rabbitmq_delayed_message_exchange-3.8.0.ez==</p>
<h4 id="3、将延迟消息插件安装到RabbitMQ中"><a href="#3、将延迟消息插件安装到RabbitMQ中" class="headerlink" title="3、将延迟消息插件安装到RabbitMQ中"></a>3、将延迟消息插件安装到RabbitMQ中</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">1、将插件上传到虚拟机服务器</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">2、将插件赋值到docker插件目录下</span></span><br><span class="line">docker cp rabbitmq_delayed_message_exchange-3.8.0.ez fd8e90c9c58d:plugins</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3、将进入到docker容器内部</span></span><br><span class="line">docker exec -it d4489446dfcc /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">3、修改插件所有者</span></span><br><span class="line">chown -R rabbitmq:rabbitmq rabbitmq_delayed_message_exchange-3.8.0.ez</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">4、修改插件读写权限</span></span><br><span class="line">chmod 644 rabbitmq:rabbitmq rabbitmq_delayed_message_exchange-3.8.0.ez</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">5、启用插件</span></span><br><span class="line">rabbitmq-plugins enable rabbitmq_delayed_message_exchange</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">6、查看</span></span><br><span class="line">rabbitmq-plugins list</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">7、重新启动RabbitMQ容器</span></span><br><span class="line">docker restart 773067241f96</span><br></pre></td></tr></table></figure>


<h4 id="4、创建项目，引入RabbitMQ"><a href="#4、创建项目，引入RabbitMQ" class="headerlink" title="4、创建项目，引入RabbitMQ"></a>4、创建项目，引入RabbitMQ</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="5、配置RabbitMQ参数"><a href="#5、配置RabbitMQ参数" class="headerlink" title="5、配置RabbitMQ参数"></a>5、配置RabbitMQ参数</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.rabbitmq.host</span>=<span class="string">192.168.56.80</span></span><br><span class="line"><span class="meta">spring.rabbitmq.port</span>=<span class="string">5672</span></span><br><span class="line"><span class="meta">spring.rabbitmq.username</span>=<span class="string">guest</span></span><br><span class="line"><span class="meta">spring.rabbitmq.password</span>=<span class="string">guest</span></span><br></pre></td></tr></table></figure>
<h4 id="6、编写RabbitMQ配置-可忽略，springboot自带RabbitMQ配置"><a href="#6、编写RabbitMQ配置-可忽略，springboot自带RabbitMQ配置" class="headerlink" title="6、编写RabbitMQ配置(可忽略，springboot自带RabbitMQ配置)"></a>6、编写RabbitMQ配置(可忽略，springboot自带RabbitMQ配置)</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yjb.delayedmessage.rabbitmq;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.CachingConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.connection.ConnectionFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.rabbitmq&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMqConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String host;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line">    <span class="keyword">private</span> String userName;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConnectionFactory <span class="title">connectionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        CachingConnectionFactory cachingConnectionFactory = <span class="keyword">new</span> CachingConnectionFactory(host,port);</span><br><span class="line">        cachingConnectionFactory.setUsername(userName);</span><br><span class="line">        cachingConnectionFactory.setPassword(password);</span><br><span class="line">        cachingConnectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        cachingConnectionFactory.setPublisherConfirms(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> cachingConnectionFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RabbitTemplate <span class="title">rabbitTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RabbitTemplate rabbitTemplate = <span class="keyword">new</span> RabbitTemplate(connectionFactory());</span><br><span class="line">        <span class="keyword">return</span> rabbitTemplate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHost</span><span class="params">(String host)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.host = host;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPort</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.port = port;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUserName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUserName</span><span class="params">(String userName)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userName = userName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPassword</span><span class="params">(String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="7、编写延迟队列配置"><a href="#7、编写延迟队列配置" class="headerlink" title="7、编写延迟队列配置"></a>7、编写延迟队列配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package com.yjb.delayedmessage.rabbitmq;</span><br><span class="line"></span><br><span class="line">import org.springframework.amqp.core.Binding;</span><br><span class="line">import org.springframework.amqp.core.BindingBuilder;</span><br><span class="line">import org.springframework.amqp.core.CustomExchange;</span><br><span class="line">import org.springframework.amqp.core.Queue;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">@Configuration</span><br><span class="line">public class QueueConfig &#123;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public CustomExchange delayExchange() &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">        args.put(&quot;x-delayed-type&quot;, &quot;direct&quot;);</span><br><span class="line">        return new CustomExchange(&quot;delayed_exchange&quot;, &quot;x-delayed-message&quot;,true, false,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public Queue queue() &#123;</span><br><span class="line">        return new Queue(&quot;delayed_send_queue&quot;, true);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Bean</span><br><span class="line">    public Binding binding() &#123;</span><br><span class="line">        return BindingBuilder.bind(queue()).to(delayExchange()).with(&quot;delayed_send_queue&quot;).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8、编写消息生产者"><a href="#8、编写消息生产者" class="headerlink" title="8、编写消息生产者"></a>8、编写消息生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yjb.delayedmessage.rabbitmq.service.impl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.yjb.delayedmessage.rabbitmq.service.MessageService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.AmqpException;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Message;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.MessagePostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageServiceImpl</span> <span class="keyword">implements</span> <span class="title">MessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMsg</span><span class="params">(String queueName,String msg)</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送时间:&quot;</span>+sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;test_exchange&quot;</span>, queueName, msg, <span class="keyword">new</span> MessagePostProcessor() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Message <span class="title">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException </span>&#123;</span><br><span class="line">                message.getMessageProperties().setHeader(<span class="string">&quot;x-delay&quot;</span>,<span class="number">3000</span>);</span><br><span class="line">                <span class="keyword">return</span> message;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="9、编写消息消费者"><a href="#9、编写消息消费者" class="headerlink" title="9、编写消息消费者"></a>9、编写消息消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.yjb.delayedmessage.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageReceiver</span> </span>&#123;</span><br><span class="line">    <span class="meta">@RabbitListener(queues = &quot;test_queue_1&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receive</span><span class="params">(String msg)</span> </span>&#123;</span><br><span class="line">        SimpleDateFormat sdf = <span class="keyword">new</span> SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息接收时间:&quot;</span>+sdf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">        System.out.println(<span class="string">&quot;接收到的消息:&quot;</span>+msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>10、编写测试类（）</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/" data-id="ckk2gq3ts001bz8pq64y12wlu" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-延迟消息发送/01_延迟队列的方案介绍" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.929Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <table>
<thead>
<tr>
<th align="center">方案</th>
<th align="center">优势</th>
<th align="center">劣势</th>
<th align="center">选用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>JDK</code>内置的延迟队列<code>DelayQueue</code></td>
<td align="center">实现简单</td>
<td align="center">数据内存态，不可靠</td>
<td align="center">一致性相对低的场景</td>
</tr>
<tr>
<td align="center">调度框架和<code>MySQL</code>进行短间隔轮询</td>
<td align="center">实现简单，可靠性高</td>
<td align="center">存在明显的性能瓶颈</td>
<td align="center">数据量较少实时性相对低的场景</td>
</tr>
<tr>
<td align="center"><code>RabbitMQ</code>的<code>DLX</code>和<code>TTL</code>，一般称为<strong>死信队列</strong>方案</td>
<td align="center">异步交互可以削峰</td>
<td align="center">延时的时间长度不可控，如果数据需要持久化则性能会降低</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">调度框架和<code>Redis</code>进行短间隔轮询</td>
<td align="center">数据持久化，高性能</td>
<td align="center">实现难度大</td>
<td align="center"><strong>常见于支付结果回调方案</strong></td>
</tr>
<tr>
<td align="center">时间轮</td>
<td align="center">实时性高</td>
<td align="center">实现难度大，内存消耗大</td>
<td align="center">实时性高的场景</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/" data-id="ckk2gq3tq001az8pqcdgh97qz" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-其他小技巧/github下载速度太慢" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.924Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="安装chrome的github加速插件"><a href="#安装chrome的github加速插件" class="headerlink" title="安装chrome的github加速插件"></a>安装chrome的github加速插件</h4><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/v2-087a4f3d175e59c003eda80b1d6c832d_hd.png" alt="v2-087a4f3d175e59c003eda80b1d6c832d_hd"></p>
<p>然后就可以直接通过加速链接 下载了，如图所示。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/v2-2c222aadc33267268990e2e71b795827_hd.jpg" alt="v2-2c222aadc33267268990e2e71b795827_hd"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/" data-id="ckk2gq3tp0019z8pq8gh953ez" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-其他小技巧/Github+jsDelivr+PicGo实现免费图床" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/Github+jsDelivr+PicGo%E5%AE%9E%E7%8E%B0%E5%85%8D%E8%B4%B9%E5%9B%BE%E5%BA%8A/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.923Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、前言"><a href="#一、前言" class="headerlink" title="一、前言"></a>一、前言</h4><p>图床是个啥东西就不用过多介绍了，先来对比一下各路图床：</p>
<blockquote>
<ul>
<li>微博图床：以前用的人比较多，从2019年4月开始开启了防盗链，凉凉</li>
<li>SM.MS：运营四年多了，也变得越来越慢了，到了晚上直接打不开图片，速度堪忧</li>
<li>其他小众图床：随时有挂掉的风险</li>
<li>Imgur等国外图床：国内访问速度太慢，随时有被墙的风险</li>
<li>大厂储存服务：例如七牛云、又拍云、腾讯云COS、阿里云OSS等，容量限制，操作繁琐，又是实名认证又是域名备案的，麻烦，而且还要花钱（有钱又不怕麻烦的当我没说）</li>
</ul>
</blockquote>
<p>因此，GitHub 图床是个不错的选择，GitHub已经开放私人仓库，且不限制空间大小，超过1G时会邮件提示，单个文件不超过50M，GitHub访问速度过慢的问题可以利用 jsDelivr CDN 加速访问（jsDelivr 是一个免费开源的 CDN 解决方案），PicGo 工具一键上传，操作简单高效，GitHub 和 jsDelivr 都是大厂，不用担心跑路问题，不用担心速度和容量问题，而且完全免费，可以说是目前免费图床的最佳解决方案！</p>
<hr>
<h4 id="二、GitHub设置"><a href="#二、GitHub设置" class="headerlink" title="二、GitHub设置"></a>二、GitHub设置</h4><h5 id="1、新建GitHub仓库"><a href="#1、新建GitHub仓库" class="headerlink" title="1、新建GitHub仓库"></a>1、新建GitHub仓库</h5><p>登录/注册GitHub，新建一个仓库，填写好仓库名，仓库描述，根据需求选择是否为仓库初始化一个README.md描述文件</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124106.jpg" alt="01"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124138.jpg" alt="02"></p>
<hr>
<h5 id="2、生成一个Token"><a href="#2、生成一个Token" class="headerlink" title="2、生成一个Token"></a>2、生成一个Token</h5><p>在主页依次选择【Settings】-【Developer settings】-【Personal access tokens】-【Generate new token】，填写好描述，勾选【repo】，然后点击【Generate token】生成一个Token，注意这个Token只会显示一次，自己先保存下来，或者等后面配置好PicGo后再关闭此网页</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124200.jpg" alt="03"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124248.jpg" alt="04"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124306.jpg" alt="05"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124345.jpg" alt="06"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111124416.jpg" alt="07"></p>
<h4 id="三、配置PicGo"><a href="#三、配置PicGo" class="headerlink" title="三、配置PicGo"></a>三、配置PicGo</h4><h5 id="1、下载PicGo-Core"><a href="#1、下载PicGo-Core" class="headerlink" title="1、下载PicGo Core"></a>1、下载PicGo Core</h5><p>Typora中下载PicGo Core</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111095910.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111095957.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111100148.png" alt="img"></p>
<h5 id="2、配置GitHub图床"><a href="#2、配置GitHub图床" class="headerlink" title="2、配置GitHub图床"></a>2、配置GitHub图床</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111095722.png" alt="img"></p>
<p>PicGo默认的配置文件地址在：C:/Users[windos用户]/.picgo/config.json，以GitHub为例，也可以配置其他如阿里云oss、七牛云等</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;picBed&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;current&quot;</span>: <span class="string">&quot;github&quot;</span>,	<span class="comment">//当前图床</span></span><br><span class="line">    <span class="attr">&quot;github&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;branch&quot;</span>: <span class="string">&quot;master&quot;</span>,	<span class="comment">//仓库分支,默认master</span></span><br><span class="line">      <span class="attr">&quot;customUrl&quot;</span>: <span class="string">&quot;https://cdn.jsdelivr.net/gh/FateCause/typoraPic&quot;</span>,	<span class="comment">//自定义域名，这里配置jsdelivr cdn加速域名</span></span><br><span class="line">      <span class="attr">&quot;path&quot;</span>: <span class="string">&quot;images/&quot;</span>,	<span class="comment">//自定义存储路径，会在仓库自动创建该文件夹</span></span><br><span class="line">      <span class="attr">&quot;repo&quot;</span>: <span class="string">&quot;FateCause/typoraPic&quot;</span>,	<span class="comment">//存储仓库：用户名/仓库名</span></span><br><span class="line">      <span class="attr">&quot;token&quot;</span>: <span class="string">&quot;597be0133f5bec14820f46bc11b91dc60fe57df9&quot;</span>	<span class="comment">//GitHub个人token，可在Settings-Developer settings-Personal access tokens中生成</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;picgoPlugins&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;picgo-plugin-super-prefix&quot;</span>: <span class="literal">true</span>	<span class="comment">//上传自动以时间戳命名文件插件，重复上传文件不报错</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;picgo-plugin-super-prefix&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;fileFormat&quot;</span>: <span class="string">&quot;YYYYMMDDHHmmss&quot;</span>	<span class="comment">//时间戳自动命名格式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3、安装NODEJS"><a href="#3、安装NODEJS" class="headerlink" title="3、安装NODEJS"></a>3、安装NODEJS</h5><p>因为使用载插件需要nodejs的运行时环境，所以下载node.js</p>
<ol>
<li><p>下载地址：<a target="_blank" rel="noopener" href="https://nodejs.org/en/">https://nodejs.org/en/</a></p>
</li>
<li><p>安装node-v12.16.2-x64.msi文件，一路next就可以了</p>
</li>
</ol>
<h5 id="4、下载picgo-plugin-super-prefix时间戳插件"><a href="#4、下载picgo-plugin-super-prefix时间戳插件" class="headerlink" title="4、下载picgo-plugin-super-prefix时间戳插件"></a>4、下载picgo-plugin-super-prefix时间戳插件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">进入PicGo安装路径：cd C:\Users\[Windows用户]\AppData\Roaming\Typora\picgo\win64</span><br><span class="line"></span><br><span class="line">cmd执行命令:.\picgo.exe install super-prefix</span><br></pre></td></tr></table></figure>
<h5 id="5、验证功能"><a href="#5、验证功能" class="headerlink" title="5、验证功能"></a>5、验证功能</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111101313.png" alt="img"></p>
<h4 id="四、实现jsdelivr-cdn加速"><a href="#四、实现jsdelivr-cdn加速" class="headerlink" title="四、实现jsdelivr cdn加速"></a>四、实现jsdelivr cdn加速</h4><h5 id="1、GitHub仓库新建一个js文件"><a href="#1、GitHub仓库新建一个js文件" class="headerlink" title="1、GitHub仓库新建一个js文件"></a>1、GitHub仓库新建一个js文件</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111101528.jpg" alt="img"></p>
<h5 id="2、创建Releases分支"><a href="#2、创建Releases分支" class="headerlink" title="2、创建Releases分支"></a>2、创建Releases分支</h5><p> 版本号输入1.0 ，目标是 master 分支！</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111101618.jpg" alt="img"></p>
<h5 id="3、访问jsdelivr-加速地址"><a href="#3、访问jsdelivr-加速地址" class="headerlink" title="3、访问jsdelivr 加速地址"></a>3、访问jsdelivr 加速地址</h5><p>访问：<a target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/%E7%94%A8%E6%88%B7%E5%90%8D/%E4%BB%93%E5%BA%93%E5%90%8D@%E7%89%88%E6%9C%AC%E5%8F%B7/">https://cdn.jsdelivr.net/gh/用户名/仓库名@版本号/</a> 即可访问你的内容了！</p>
<p>文件不想带版本号？将版本号换成latest即可！或者不带版本号！或者直接@master(或者其他分支名称)！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/Github+jsDelivr+PicGo%E5%AE%9E%E7%8E%B0%E5%85%8D%E8%B4%B9%E5%9B%BE%E5%BA%8A/" data-id="ckk2gq3tp0018z8pq05rbhks3" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-XXL-JOB分布式调度/XXL-JOB源码解读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.873Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、xxl-job的Bean模式开发步骤："><a href="#一、xxl-job的Bean模式开发步骤：" class="headerlink" title="一、xxl-job的Bean模式开发步骤："></a>一、xxl-job的Bean模式开发步骤：</h4><p>xxl-job调度任务的开发主要执行器的开发，按照业务需求创建处理不同业务逻辑的执行器后，在调度中心创建任务、设置调度规则，绑定相应的执行后，当满足调度规则的条件时即可调起执行器完成调度处理</p>
<h5 id="1）创建项目和配置"><a href="#1）创建项目和配置" class="headerlink" title="1）创建项目和配置"></a>1）创建项目和配置</h5><p>创建执行器项目，在配置文件中做相应配置，注册到注册中心、指定执行器名</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### xxl-job admin address list, such as &quot;http://address&quot; or &quot;http://address01,http://address02&quot;</span></span><br><span class="line"><span class="meta">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### xxl-job, access token</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment">### xxl-job executor appname</span></span><br><span class="line"><span class="meta">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### xxl-job executor registry-address: default use address to registry , otherwise use ip:port if address is null</span></span><br><span class="line"><span class="meta">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### xxl-job executor server-info</span></span><br><span class="line"><span class="meta">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="meta">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### xxl-job executor log-path</span></span><br><span class="line"><span class="meta">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### xxl-job executor log-retention-days</span></span><br><span class="line"><span class="meta">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> xxl_job_lock：任务调度锁表；</span><br><span class="line"><span class="operator">-</span> xxl_job_group：执行器信息表，维护任务执行器信息；</span><br><span class="line"><span class="operator">-</span> xxl_job_info：调度扩展信息表： 用于保存XXL<span class="operator">-</span>JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</span><br><span class="line"><span class="operator">-</span> xxl_job_log：调度日志表： 用于保存XXL<span class="operator">-</span>JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</span><br><span class="line"><span class="operator">-</span> xxl_job_log_report：调度日志报表：用户存储XXL<span class="operator">-</span>JOB任务调度日志的报表，调度中心报表功能页面会用到；</span><br><span class="line"><span class="operator">-</span> xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</span><br><span class="line"><span class="operator">-</span> xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</span><br><span class="line"><span class="operator">-</span> xxl_job_user：系统用户表；</span><br></pre></td></tr></table></figure>


<h5 id="2）创建执行器类和handler方法"><a href="#2）创建执行器类和handler方法" class="headerlink" title="2）创建执行器类和handler方法"></a>2）创建执行器类和handler方法</h5><p>创建一个类SampleXxlJob并注入到spring容器中，类中创建JobHandler方法，加上注解@XxlJob(“demoJobHandler”)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleXxlJob</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）注册中心创建任务并绑定JobHandler"><a href="#3）注册中心创建任务并绑定JobHandler" class="headerlink" title="3）注册中心创建任务并绑定JobHandler"></a>3）注册中心创建任务并绑定JobHandler</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120507.png" alt="image-20201026170023820"></p>
<p>JobHandler需与执行器方法的@XxlJob注解一致，当满足Cron配置的条件时即可调起执行器中对应的JobHandler</p>
<h4 id="二、xxl-job-admin的原理："><a href="#二、xxl-job-admin的原理：" class="headerlink" title="二、xxl-job-admin的原理："></a>二、xxl-job-admin的原理：</h4><h5 id="1）xxl-job-admin项目的启动与初始化"><a href="#1）xxl-job-admin项目的启动与初始化" class="headerlink" title="1）xxl-job-admin项目的启动与初始化"></a>1）xxl-job-admin项目的启动与初始化</h5><p>xxl-job-admin是xxl-job工具的调度中心，启动运行时加载配置项和初始化类，其中除了初始化绑定了application.properties中配置的参数外，重要的一点是初始化xxl-job重要调度者com.xxl.job.admin.core.scheduler.XxlJobScheduler类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobAdminConfig</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> XxlJobAdminConfig adminConfig = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> XxlJobAdminConfig <span class="title">getAdminConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adminConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- XxlJobScheduler ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XxlJobScheduler xxlJobScheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        adminConfig = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//xxl-job重要调度者</span></span><br><span class="line">        xxlJobScheduler = <span class="keyword">new</span> XxlJobScheduler();</span><br><span class="line">        xxlJobScheduler.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        xxlJobScheduler.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- XxlJobScheduler ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// conf</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.i18n&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String i18n;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.mail.from&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String emailFrom;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.triggerpool.fast.max&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> triggerPoolFastMax;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.triggerpool.slow.max&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> triggerPoolSlowMax;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> logretentiondays;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dao, service</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogDao xxlJobLogDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobInfoDao xxlJobInfoDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobRegistryDao xxlJobRegistryDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobGroupDao xxlJobGroupDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogReportDao xxlJobLogReportDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JavaMailSender mailSender;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JobAlarmer jobAlarmer;</span><br></pre></td></tr></table></figure>


<h5 id="2）xxl-job-admin中的调度者XxlJobScheduler"><a href="#2）xxl-job-admin中的调度者XxlJobScheduler" class="headerlink" title="2）xxl-job-admin中的调度者XxlJobScheduler"></a>2）xxl-job-admin中的调度者XxlJobScheduler</h5><p>xxl-job-admin启动后初始化的的调度者com.xxl.job.admin.core.scheduler.XxlJobScheduler，调度者主要包含两个重要作用：</p>
<p>①初始化xxl-job调度中心的重要各种助手类JobXXXHelper，并执行相应start()方法启动运行，这些助手类支撑了调度中心运行和各种重要功能，</p>
<p>②初始化执行客户端的仓库executorBizRepository，可以通过仓库的get方法获取执行器客户端ExecutorBizClient，通过客户端远程调用执行器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobScheduler</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(XxlJobScheduler.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// init i18n</span></span><br><span class="line">        initI18n();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化多种JobXXXHelper助手类，并调用运行方法启动</span></span><br><span class="line">        <span class="comment">// admin registry monitor run</span></span><br><span class="line">        JobRegistryMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin fail-monitor run</span></span><br><span class="line">        JobFailMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin lose-monitor run</span></span><br><span class="line">        JobLosedMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin trigger pool start</span></span><br><span class="line">        JobTriggerPoolHelper.toStart();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin log report start</span></span><br><span class="line">        JobLogReportHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start-schedule</span></span><br><span class="line">        JobScheduleHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; init xxl-job admin success.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化执行器客户端仓库executorBizRepository，并可通过get方法获取仓库中的执行器客户端ExecutorBizClient</span></span><br><span class="line">     <span class="comment">// ---------------------- executor-client ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, ExecutorBiz&gt; executorBizRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExecutorBiz&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorBiz <span class="title">getExecutorBiz</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (address==<span class="keyword">null</span> || address.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load-cache</span></span><br><span class="line">        address = address.trim();</span><br><span class="line">        ExecutorBiz executorBiz = executorBizRepository.get(address);</span><br><span class="line">        <span class="keyword">if</span> (executorBiz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> executorBiz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set-cache</span></span><br><span class="line">        executorBiz = <span class="keyword">new</span> ExecutorBizClient(address, XxlJobAdminConfig.getAdminConfig().getAccessToken());</span><br><span class="line"></span><br><span class="line">        executorBizRepository.put(address, executorBiz);</span><br><span class="line">        <span class="keyword">return</span> executorBiz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）xxl-job-admin的调度助手JobScheduleHelper"><a href="#3）xxl-job-admin的调度助手JobScheduleHelper" class="headerlink" title="3）xxl-job-admin的调度助手JobScheduleHelper"></a>3）xxl-job-admin的调度助手JobScheduleHelper</h5><p>xxl-job-admin的调度助手类com.xxl.job.admin.core.thread.JobScheduleHelper,用于管理调度中心的任务和触发，使用到xxl_job_info表</p>
<p>⑤过期处理策略</p>
<p>任务调度错过触发时间时的处理策略：</p>
<ul>
<li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li>
<li>==处理策略：==<ul>
<li>==过期超5s：本次忽略，当前时间开始计算下次触发时间==</li>
<li>==过期5s内：立即触发一次，当前时间开始计算下次触发时间==</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduleHelper</span> </span>&#123; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// schedule thread</span></span><br><span class="line">        scheduleThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">5000</span> - System.currentTimeMillis()%<span class="number">1000</span> );</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!scheduleThreadToStop) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; init xxl-job admin scheduler success.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// pre-read count: treadpool-size * trigger-qps (each trigger cost 50ms, qps = 1000/50 = 20)</span></span><br><span class="line">                <span class="keyword">int</span> preReadCount = (XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax() + XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax()) * <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (!scheduleThreadToStop) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Scan Job</span></span><br><span class="line">                    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                    Connection conn = <span class="keyword">null</span>;</span><br><span class="line">                    Boolean connAutoCommit = <span class="keyword">null</span>;</span><br><span class="line">                    PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> preReadSuc = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                        conn = XxlJobAdminConfig.getAdminConfig().getDataSource().getConnection();</span><br><span class="line">                        connAutoCommit = conn.getAutoCommit();</span><br><span class="line">                        conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//1、获取调度锁，因为调度中心是支持集群，所以使用数据库xxl_job_lock表作为分布式锁</span></span><br><span class="line">                        preparedStatement = conn.prepareStatement(  <span class="string">&quot;select * from xxl_job_lock where lock_name = &#x27;schedule_lock&#x27; for update&quot;</span> );</span><br><span class="line">                        preparedStatement.execute();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// tx start</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 1、pre read</span></span><br><span class="line">                        <span class="keyword">long</span> nowTime = System.currentTimeMillis();</span><br><span class="line">                        <span class="comment">//2、查询所有正在运行中的任务列表</span></span><br><span class="line">                        List&lt;XxlJobInfo&gt; scheduleList = XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().scheduleJobQuery(nowTime + PRE_READ_MS, preReadCount);</span><br><span class="line">                        <span class="keyword">if</span> (scheduleList!=<span class="keyword">null</span> &amp;&amp; scheduleList.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 2、push time-ring</span></span><br><span class="line">                            <span class="keyword">for</span> (XxlJobInfo jobInfo: scheduleList) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// time-ring jump</span></span><br><span class="line">                                <span class="comment">//3、如果任务过期超过5秒，则根据当前时间刷新下次触发时间</span></span><br><span class="line">                                <span class="keyword">if</span> (nowTime &gt; jobInfo.getTriggerNextTime() + PRE_READ_MS) &#123;</span><br><span class="line">                                    <span class="comment">// 2.1、trigger-  &gt; 5s：pass &amp;&amp; make next-trigger-time</span></span><br><span class="line">                                    logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, schedule misfire, jobId = &quot;</span> + jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &gt; jobInfo.getTriggerNextTime()) &#123;</span><br><span class="line">                                    <span class="comment">// 2.2、trigger-expire &lt; 5s：direct-trigger &amp;&amp; make next-trigger-time</span></span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 1、trigger</span></span><br><span class="line">                                    <span class="comment">//4、任务过期不超过5秒，调用触发池助手的方法触发任务</span></span><br><span class="line">                                    JobTriggerPoolHelper.trigger(jobInfo.getId(), TriggerTypeEnum.CRON, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                    logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, schedule push trigger : jobId = &quot;</span> + jobInfo.getId() );</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 2、fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// next-trigger-time in 5s, pre-read again</span></span><br><span class="line">                                    <span class="keyword">if</span> (jobInfo.getTriggerStatus()==<span class="number">1</span> &amp;&amp; nowTime + PRE_READ_MS &gt; jobInfo.getTriggerNextTime()) &#123;</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 1、make ring second</span></span><br><span class="line">                                        <span class="keyword">int</span> ringSecond = (<span class="keyword">int</span>)((jobInfo.getTriggerNextTime()/<span class="number">1000</span>)%<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 2、push time ring</span></span><br><span class="line">                                        pushTimeRing(ringSecond, jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 3、fresh next</span></span><br><span class="line">                                        refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date(jobInfo.getTriggerNextTime()));</span><br><span class="line"></span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// 2.3、trigger-pre-read：time-ring trigger &amp;&amp; make next-trigger-time</span></span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 1、make ring second</span></span><br><span class="line">                                    <span class="keyword">int</span> ringSecond = (<span class="keyword">int</span>)((jobInfo.getTriggerNextTime()/<span class="number">1000</span>)%<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 2、push time ring</span></span><br><span class="line">                                    pushTimeRing(ringSecond, jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 3、fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date(jobInfo.getTriggerNextTime()));</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 3、update trigger info</span></span><br><span class="line">                            <span class="keyword">for</span> (XxlJobInfo jobInfo: scheduleList) &#123;</span><br><span class="line">                                XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().scheduleUpdate(jobInfo);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4）xxl-job-admin触发池助手JobTriggerPoolHelper"><a href="#4）xxl-job-admin触发池助手JobTriggerPoolHelper" class="headerlink" title="4）xxl-job-admin触发池助手JobTriggerPoolHelper"></a>4）xxl-job-admin触发池助手JobTriggerPoolHelper</h5><p>xxl-job-admin中的com.xxl.job.admin.core.thread.JobTriggerPoolHelper任务触发池助手类，可以实例化任务触发池,创建了trigger方法触发任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTriggerPoolHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JobTriggerPoolHelper.class);</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="comment">//初始化触发池</span></span><br><span class="line">        fastTriggerPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">10</span>,</span><br><span class="line">                XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax(),</span><br><span class="line">                <span class="number">60L</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">1000</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-fastTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        slowTriggerPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">10</span>,</span><br><span class="line">                XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax(),</span><br><span class="line">                <span class="number">60L</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">2000</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-slowTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">int</span> jobId, TriggerTypeEnum triggerType, <span class="keyword">int</span> failRetryCount, String executorShardingParam, String executorParam, String addressList)</span> </span>&#123;</span><br><span class="line">        helper.addTrigger(jobId, triggerType, failRetryCount, executorShardingParam, executorParam, addressList);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">       	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTrigger</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> jobId,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> TriggerTypeEnum triggerType,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> <span class="keyword">int</span> failRetryCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String executorShardingParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String executorParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String addressList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// choose thread pool</span></span><br><span class="line">        ThreadPoolExecutor triggerPool_ = fastTriggerPool;</span><br><span class="line">        AtomicInteger jobTimeoutCount = jobTimeoutCountMap.get(jobId);</span><br><span class="line">        <span class="keyword">if</span> (jobTimeoutCount!=<span class="keyword">null</span> &amp;&amp; jobTimeoutCount.get() &gt; <span class="number">10</span>) &#123;      <span class="comment">// job-timeout 10 times in 1 min</span></span><br><span class="line">            triggerPool_ = slowTriggerPool;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trigger</span></span><br><span class="line">        triggerPool_.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// do trigger</span></span><br><span class="line">                    <span class="comment">//调用触发器触发任务</span></span><br><span class="line">                    XxlJobTrigger.trigger(jobId, triggerType, failRetryCount, executorShardingParam, executorParam, addressList);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(e.getMessage(), e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// check timeout-count-map</span></span><br><span class="line">                    <span class="keyword">long</span> minTim_now = System.currentTimeMillis()/<span class="number">60000</span>;</span><br><span class="line">                    <span class="keyword">if</span> (minTim != minTim_now) &#123;</span><br><span class="line">                        minTim = minTim_now;</span><br><span class="line">                        jobTimeoutCountMap.clear();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// incr timeout-count-map</span></span><br><span class="line">                    <span class="keyword">long</span> cost = System.currentTimeMillis()-start;</span><br><span class="line">                    <span class="keyword">if</span> (cost &gt; <span class="number">500</span>) &#123;       <span class="comment">// ob-timeout threshold 500ms</span></span><br><span class="line">                        AtomicInteger timeoutCount = jobTimeoutCountMap.putIfAbsent(jobId, <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>));</span><br><span class="line">                        <span class="keyword">if</span> (timeoutCount != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            timeoutCount.incrementAndGet();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5）xxl-job-admin任务触发器XxlJobTrigger"><a href="#5）xxl-job-admin任务触发器XxlJobTrigger" class="headerlink" title="5）xxl-job-admin任务触发器XxlJobTrigger"></a>5）xxl-job-admin任务触发器XxlJobTrigger</h5><p>xxl-job-admin中的com.xxl.job.admin.core.trigger.XxlJobTrigger提供了调起任务的方法，向执行器发起任务调度</p>
<p>==在processTrigger方法中实例化XxlJobLog类，用于记录xxl-job调度日志==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobTrigger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(XxlJobTrigger.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * trigger job</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> failRetryCount</span></span><br><span class="line"><span class="comment">     * 			&gt;=0: use this param</span></span><br><span class="line"><span class="comment">     * 			&lt;0: use param from job info config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executorShardingParam</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executorParam</span></span><br><span class="line"><span class="comment">     *          null: use job param</span></span><br><span class="line"><span class="comment">     *          not null: cover job param</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressList</span></span><br><span class="line"><span class="comment">     *          null: use executor addressList</span></span><br><span class="line"><span class="comment">     *          not null: cover</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">int</span> jobId,</span></span></span><br><span class="line"><span class="function"><span class="params">                               TriggerTypeEnum triggerType,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> failRetryCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String executorShardingParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String executorParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String addressList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load data</span></span><br><span class="line">        <span class="comment">//1、加载任务信息xxl_job_info表中</span></span><br><span class="line">        XxlJobInfo jobInfo = XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().loadById(jobId);</span><br><span class="line">        <span class="keyword">if</span> (jobInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; trigger fail, jobId invalid，jobId=&#123;&#125;&quot;</span>, jobId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (executorParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobInfo.setExecutorParam(executorParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> finalFailRetryCount = failRetryCount&gt;=<span class="number">0</span>?failRetryCount:jobInfo.getExecutorFailRetryCount();</span><br><span class="line">        <span class="comment">//2.查询支持该任务的集群xxl_job_registry</span></span><br><span class="line">        XxlJobGroup group = XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().load(jobInfo.getJobGroup());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cover addressList</span></span><br><span class="line">        <span class="keyword">if</span> (addressList!=<span class="keyword">null</span> &amp;&amp; addressList.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            group.setAddressType(<span class="number">1</span>);</span><br><span class="line">            group.setAddressList(addressList.trim());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sharding param</span></span><br><span class="line">        <span class="keyword">int</span>[] shardingParam = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (executorShardingParam!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            String[] shardingArr = executorShardingParam.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (shardingArr.length==<span class="number">2</span> &amp;&amp; isNumeric(shardingArr[<span class="number">0</span>]) &amp;&amp; isNumeric(shardingArr[<span class="number">1</span>])) &#123;</span><br><span class="line">                shardingParam = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">                shardingParam[<span class="number">0</span>] = Integer.valueOf(shardingArr[<span class="number">0</span>]);</span><br><span class="line">                shardingParam[<span class="number">1</span>] = Integer.valueOf(shardingArr[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ExecutorRouteStrategyEnum.SHARDING_BROADCAST==ExecutorRouteStrategyEnum.match(jobInfo.getExecutorRouteStrategy(), <span class="keyword">null</span>)</span><br><span class="line">                &amp;&amp; group.getRegistryList()!=<span class="keyword">null</span> &amp;&amp; !group.getRegistryList().isEmpty()</span><br><span class="line">                &amp;&amp; shardingParam==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; group.getRegistryList().size(); i++) &#123;</span><br><span class="line">                processTrigger(group, jobInfo, finalFailRetryCount, triggerType, i, group.getRegistryList().size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (shardingParam == <span class="keyword">null</span>) &#123;</span><br><span class="line">                shardingParam = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.进程触发方法</span></span><br><span class="line">            processTrigger(group, jobInfo, finalFailRetryCount, triggerType, shardingParam[<span class="number">0</span>], shardingParam[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group                     job group, registry list may be empty</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finalFailRetryCount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index                     sharding index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> total                     sharding index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processTrigger</span><span class="params">(XxlJobGroup group, XxlJobInfo jobInfo, <span class="keyword">int</span> finalFailRetryCount, TriggerTypeEnum triggerType, <span class="keyword">int</span> index, <span class="keyword">int</span> total)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、设置并行策略</span></span><br><span class="line">        ExecutorBlockStrategyEnum blockStrategy = ExecutorBlockStrategyEnum.match(jobInfo.getExecutorBlockStrategy(), ExecutorBlockStrategyEnum.SERIAL_EXECUTION);  <span class="comment">// block strategy</span></span><br><span class="line">        <span class="comment">//2.路由策略</span></span><br><span class="line">        ExecutorRouteStrategyEnum executorRouteStrategyEnum = ExecutorRouteStrategyEnum.match(jobInfo.getExecutorRouteStrategy(), <span class="keyword">null</span>);    <span class="comment">// route strategy</span></span><br><span class="line">        <span class="comment">//3.分片参数</span></span><br><span class="line">        String shardingParam = (ExecutorRouteStrategyEnum.SHARDING_BROADCAST==executorRouteStrategyEnum)?String.valueOf(index).concat(<span class="string">&quot;/&quot;</span>).concat(String.valueOf(total)):<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.化XxlJobLog日志记录对象，只用使用该日志对象打印日志才会出现在执行日志中</span></span><br><span class="line">        XxlJobLog jobLog = <span class="keyword">new</span> XxlJobLog();</span><br><span class="line">        jobLog.setJobGroup(jobInfo.getJobGroup());</span><br><span class="line">        jobLog.setJobId(jobInfo.getId());</span><br><span class="line">        jobLog.setTriggerTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="comment">//5.保存日志到xxl_job_log表中，记录日志，后续可查询、修改</span></span><br><span class="line">        XxlJobAdminConfig.getAdminConfig().getXxlJobLogDao().save(jobLog);</span><br><span class="line">        logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger start, jobId:&#123;&#125;&quot;</span>, jobLog.getId());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.设置触发参数</span></span><br><span class="line">        TriggerParam triggerParam = <span class="keyword">new</span> TriggerParam();</span><br><span class="line">        triggerParam.setJobId(jobInfo.getId());</span><br><span class="line">        triggerParam.setExecutorHandler(jobInfo.getExecutorHandler());</span><br><span class="line">        triggerParam.setExecutorParams(jobInfo.getExecutorParam());</span><br><span class="line">        triggerParam.setExecutorBlockStrategy(jobInfo.getExecutorBlockStrategy());</span><br><span class="line">        triggerParam.setExecutorTimeout(jobInfo.getExecutorTimeout());</span><br><span class="line">        triggerParam.setLogId(jobLog.getId());</span><br><span class="line">        triggerParam.setLogDateTime(jobLog.getTriggerTime().getTime());</span><br><span class="line">        triggerParam.setGlueType(jobInfo.getGlueType());</span><br><span class="line">        triggerParam.setGlueSource(jobInfo.getGlueSource());</span><br><span class="line">        triggerParam.setGlueUpdatetime(jobInfo.getGlueUpdatetime().getTime());</span><br><span class="line">        triggerParam.setBroadcastIndex(index);</span><br><span class="line">        triggerParam.setBroadcastTotal(total);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、init address</span></span><br><span class="line">        String address = <span class="keyword">null</span>;</span><br><span class="line">        ReturnT&lt;String&gt; routeAddressResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (group.getRegistryList()!=<span class="keyword">null</span> &amp;&amp; !group.getRegistryList().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ExecutorRouteStrategyEnum.SHARDING_BROADCAST == executorRouteStrategyEnum) &#123;</span><br><span class="line">                <span class="keyword">if</span> (index &lt; group.getRegistryList().size()) &#123;</span><br><span class="line">                    address = group.getRegistryList().get(index);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    address = group.getRegistryList().get(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//7.根据路由参数设置路由地址,从集群中选取合适的执行器机器</span></span><br><span class="line">                routeAddressResult = executorRouteStrategyEnum.getRouter().route(triggerParam, group.getRegistryList());</span><br><span class="line">                <span class="keyword">if</span> (routeAddressResult.getCode() == ReturnT.SUCCESS_CODE) &#123;</span><br><span class="line">                    address = routeAddressResult.getContent();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            routeAddressResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, I18nUtil.getString(<span class="string">&quot;jobconf_trigger_address_empty&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReturnT&lt;String&gt; triggerResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (address != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//8.调用runExecutor运行执行器，并获取执行结果</span></span><br><span class="line">            triggerResult = runExecutor(triggerParam, address);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            triggerResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9、设置任务执行信息</span></span><br><span class="line">        StringBuffer triggerMsgSb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        triggerMsgSb.append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_type&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(triggerType.getTitle());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_admin_adress&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(IpUtil.getIp());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_exe_regtype&quot;</span>)).append(<span class="string">&quot;：&quot;</span>)</span><br><span class="line">                .append( (group.getAddressType() == <span class="number">0</span>)?I18nUtil.getString(<span class="string">&quot;jobgroup_field_addressType_0&quot;</span>):I18nUtil.getString(<span class="string">&quot;jobgroup_field_addressType_1&quot;</span>) );</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_exe_regaddress&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(group.getRegistryList());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorRouteStrategy&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(executorRouteStrategyEnum.getTitle());</span><br><span class="line">        <span class="keyword">if</span> (shardingParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggerMsgSb.append(<span class="string">&quot;(&quot;</span>+shardingParam+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorBlockStrategy&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(blockStrategy.getTitle());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_timeout&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(jobInfo.getExecutorTimeout());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorFailRetryCount&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(finalFailRetryCount);</span><br><span class="line"></span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&lt;br&gt;&lt;span style=\&quot;color:#00c0ef;\&quot; &gt; &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>+ I18nUtil.getString(<span class="string">&quot;jobconf_trigger_run&quot;</span>) +<span class="string">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; &lt;/span&gt;&lt;br&gt;&quot;</span>)</span><br><span class="line">                .append((routeAddressResult!=<span class="keyword">null</span>&amp;&amp;routeAddressResult.getMsg()!=<span class="keyword">null</span>)?routeAddressResult.getMsg()+<span class="string">&quot;&lt;br&gt;&lt;br&gt;&quot;</span>:<span class="string">&quot;&quot;</span>).append(triggerResult.getMsg()!=<span class="keyword">null</span>?triggerResult.getMsg():<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10、设置任务执行结果等信息</span></span><br><span class="line">        jobLog.setExecutorAddress(address);</span><br><span class="line">        jobLog.setExecutorHandler(jobInfo.getExecutorHandler());</span><br><span class="line">        jobLog.setExecutorParam(jobInfo.getExecutorParam());</span><br><span class="line">        jobLog.setExecutorShardingParam(shardingParam);</span><br><span class="line">        jobLog.setExecutorFailRetryCount(finalFailRetryCount);</span><br><span class="line">        <span class="comment">//jobLog.setTriggerTime();</span></span><br><span class="line">        jobLog.setTriggerCode(triggerResult.getCode());</span><br><span class="line">        jobLog.setTriggerMsg(triggerMsgSb.toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 11、更新xxl_job_log表中日志信息</span></span><br><span class="line">        XxlJobAdminConfig.getAdminConfig().getXxlJobLogDao().updateTriggerInfo(jobLog);</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger end, jobId:&#123;&#125;&quot;</span>, jobLog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run executor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerParam</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReturnT&lt;String&gt; <span class="title">runExecutor</span><span class="params">(TriggerParam triggerParam, String address)</span></span>&#123;</span><br><span class="line">        ReturnT&lt;String&gt; runResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//8.1调用XxlJobScheduler的get方法获取执行器客户端ExecutorBizClient</span></span><br><span class="line">            ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(address);</span><br><span class="line">            runResult = executorBiz.run(triggerParam);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger error, please check if the executor[&#123;&#125;] is running.&quot;</span>, address, e);</span><br><span class="line">            runResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, ThrowableUtil.toString(e));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringBuffer runResultSB = <span class="keyword">new</span> StringBuffer(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_run&quot;</span>) + <span class="string">&quot;：&quot;</span>);</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;address：&quot;</span>).append(address);</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;code：&quot;</span>).append(runResult.getCode());</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;msg：&quot;</span>).append(runResult.getMsg());</span><br><span class="line"></span><br><span class="line">        runResult.setMsg(runResultSB.toString());</span><br><span class="line">        <span class="keyword">return</span> runResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="6）xxl-job-core执行器客户端ExecutorBizClient"><a href="#6）xxl-job-core执行器客户端ExecutorBizClient" class="headerlink" title="6）xxl-job-core执行器客户端ExecutorBizClient"></a>6）xxl-job-core执行器客户端ExecutorBizClient</h5><p>xxl-job-admin执行器客户端调用XxlJobRemotingUtil远程调用工具，通过http请求远程调用指定地址的执行器，并接受返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizClient</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//8.1.1调用xxml远程连接工具类rpc调用执行器</span></span><br><span class="line">        <span class="keyword">return</span> XxlJobRemotingUtil.postBody(addressUrl + <span class="string">&quot;run&quot;</span>, accessToken, timeout, triggerParam, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobRemotingUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReturnT <span class="title">postBody</span><span class="params">(String url, String accessToken, <span class="keyword">int</span> timeout, Object requestObj, Class returnTargClassOfT)</span></span>&#123;</span><br><span class="line">        HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader bufferedReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// connection</span></span><br><span class="line">            URL realUrl = <span class="keyword">new</span> URL(url);</span><br><span class="line">            connection = (HttpURLConnection) realUrl.openConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// trust-https</span></span><br><span class="line">            <span class="keyword">boolean</span> useHttps = url.startsWith(<span class="string">&quot;https&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (useHttps) &#123;</span><br><span class="line">                HttpsURLConnection https = (HttpsURLConnection) connection;</span><br><span class="line">                trustAllHosts(https);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// connection setting</span></span><br><span class="line">            connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">            connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">            connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">            connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">            connection.setReadTimeout(timeout * <span class="number">1000</span>);</span><br><span class="line">            connection.setConnectTimeout(<span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;connection&quot;</span>, <span class="string">&quot;Keep-Alive&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(accessToken!=<span class="keyword">null</span> &amp;&amp; accessToken.trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                connection.setRequestProperty(XXL_JOB_ACCESS_TOKEN, accessToken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do connection</span></span><br><span class="line">            connection.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// write requestBody</span></span><br><span class="line">            <span class="keyword">if</span> (requestObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String requestBody = GsonTool.toJson(requestObj);</span><br><span class="line"></span><br><span class="line">                DataOutputStream dataOutputStream = <span class="keyword">new</span> DataOutputStream(connection.getOutputStream());</span><br><span class="line">                dataOutputStream.write(requestBody.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                dataOutputStream.flush();</span><br><span class="line">                dataOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*byte[] requestBodyBytes = requestBody.getBytes(&quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">            connection.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(requestBodyBytes.length));</span></span><br><span class="line"><span class="comment">            OutputStream outwritestream = connection.getOutputStream();</span></span><br><span class="line"><span class="comment">            outwritestream.write(requestBodyBytes);</span></span><br><span class="line"><span class="comment">            outwritestream.flush();</span></span><br><span class="line"><span class="comment">            outwritestream.close();*/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid StatusCode</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = connection.getResponseCode();</span><br><span class="line">            <span class="keyword">if</span> (statusCode != <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;xxl-rpc remoting fail, StatusCode(&quot;</span>+ statusCode +<span class="string">&quot;) invalid. for url : &quot;</span> + url);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// result</span></span><br><span class="line">            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream()));</span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            String resultJson = result.toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// parse returnT</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//8.1.1.1发送http请求到执行器服务器</span></span><br><span class="line">                ReturnT returnT = GsonTool.fromJson(resultJson, ReturnT.class, returnTargClassOfT);</span><br><span class="line">                <span class="keyword">return</span> returnT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper"><a href="#7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper" class="headerlink" title="7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper"></a>7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper</h5><p>xxl-job-admin中机器注册监控助手：com.xxl.job.admin.core.thread.JobRegistryMonitorHelper注册集群中所有正常状态的机器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">		registryThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//除非调度中心停止，否则秩序执行</span></span><br><span class="line">				<span class="keyword">while</span> (!toStop) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// auto registry group</span></span><br><span class="line">                        <span class="comment">//1.查询数据库xxl_job_group表中的所有的执行器集群</span></span><br><span class="line">						List&lt;XxlJobGroup&gt; groupList = XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().findByAddressType(<span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (groupList!=<span class="keyword">null</span> &amp;&amp; !groupList.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                            </span><br><span class="line">							<span class="comment">// remove dead address (admin/executor)</span></span><br><span class="line">                            <span class="comment">//2.所有集群循环删除xxl_job_registry表中注册的所有死亡的机器</span></span><br><span class="line">							List&lt;Integer&gt; ids = XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().findDead(RegistryConfig.DEAD_TIMEOUT, <span class="keyword">new</span> Date());</span><br><span class="line">							<span class="keyword">if</span> (ids!=<span class="keyword">null</span> &amp;&amp; ids.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">								XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().removeDead(ids);</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="comment">// fresh online address (admin/executor)</span></span><br><span class="line">                        	<span class="comment">//3.查询出xxl_job_registry表中注册的所有在线的注册机器，并存入容器appAddressMap中</span></span><br><span class="line">							HashMap&lt;String, List&lt;String&gt;&gt; appAddressMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">							List&lt;XxlJobRegistry&gt; list = XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().findAll(RegistryConfig.DEAD_TIMEOUT, <span class="keyword">new</span> Date());</span><br><span class="line">							<span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">								<span class="keyword">for</span> (XxlJobRegistry item: list) &#123;</span><br><span class="line">									<span class="keyword">if</span> (RegistryConfig.RegistType.EXECUTOR.name().equals(item.getRegistryGroup())) &#123;</span><br><span class="line">										String appname = item.getRegistryKey();</span><br><span class="line">										List&lt;String&gt; registryList = appAddressMap.get(appname);</span><br><span class="line">										<span class="keyword">if</span> (registryList == <span class="keyword">null</span>) &#123;</span><br><span class="line">											registryList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">										&#125;</span><br><span class="line"></span><br><span class="line">										<span class="keyword">if</span> (!registryList.contains(item.getRegistryValue())) &#123;</span><br><span class="line">											registryList.add(item.getRegistryValue());</span><br><span class="line">										&#125;</span><br><span class="line">										appAddressMap.put(appname, registryList);</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="comment">// fresh group address</span></span><br><span class="line">                            <span class="comment">//4.更新数据库xxl_job_group表中的集群的机器列表</span></span><br><span class="line">							<span class="keyword">for</span> (XxlJobGroup group: groupList) &#123;</span><br><span class="line">								List&lt;String&gt; registryList = appAddressMap.get(group.getAppname());</span><br><span class="line">								String addressListStr = <span class="keyword">null</span>;</span><br><span class="line">								<span class="keyword">if</span> (registryList!=<span class="keyword">null</span> &amp;&amp; !registryList.isEmpty()) &#123;</span><br><span class="line">									Collections.sort(registryList);</span><br><span class="line">									StringBuilder addressListSB = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">									<span class="keyword">for</span> (String item:registryList) &#123;</span><br><span class="line">										addressListSB.append(item).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">									&#125;</span><br><span class="line">									addressListStr = addressListSB.toString();</span><br><span class="line">									addressListStr = addressListStr.substring(<span class="number">0</span>, addressListStr.length()-<span class="number">1</span>);</span><br><span class="line">								&#125;</span><br><span class="line">								group.setAddressList(addressListStr);</span><br><span class="line">								XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().update(group);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						<span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">							logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread error:&#123;&#125;&quot;</span>, e);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						TimeUnit.SECONDS.sleep(RegistryConfig.BEAT_TIMEOUT);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">						<span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">							logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread error:&#123;&#125;&quot;</span>, e);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread stop&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		registryThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">		registryThread.setName(<span class="string">&quot;xxl-job, admin JobRegistryMonitorHelper&quot;</span>);</span><br><span class="line">		registryThread.start();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><h4 id="三、xxl-job-executor的原理："><a href="#三、xxl-job-executor的原理：" class="headerlink" title="三、xxl-job-executor的原理："></a>三、xxl-job-executor的原理：</h4><h5 id="1）xxl-job-executor项目启动与初始化"><a href="#1）xxl-job-executor项目启动与初始化" class="headerlink" title="1）xxl-job-executor项目启动与初始化"></a>1）xxl-job-executor项目启动与初始化</h5><p>xxl-job-executor是xxl-job工具调度中心，启动运行时加载配置项和初始化类，其中除了初始化绑定了application.properties中配置的参数外，重要的一点是初始化xxl-job-executor的执行者com.xxl.job.core.executor.XxlJobExecutor(springboot的bean模式初始化的是继承的子类XxlJobSpringExecutor)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化XxlJobExecutor类</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        XxlJobSpringExecutor xxlJobSpringExecutor = <span class="keyword">new</span> XxlJobSpringExecutor();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-xxl-job-core执行者XxlJobExecutor"><a href="#2-xxl-job-core执行者XxlJobExecutor" class="headerlink" title="2)xxl-job-core执行者XxlJobExecutor"></a>2)xxl-job-core执行者XxlJobExecutor</h5><p>xxl-job工作依赖于核心模块xxl-job-core，在该项目执行者com.xxl.job.core.executor.XxlJobExecutor做了两个重要作用：</p>
<p>①将xxl-job-exector中编写handler注册到jobHandlerRepository仓库中，将工作线程注册到jobThreadRepository仓库中</p>
<p>②调用父类start方法实例化并启动支撑xxl-job-core功能的重要工具==XxlJobFileAppender==、initAdminBizList、JobLogFileCleanThread、TriggerCallbackThread、==initEmbedServer==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobSpringExecutor</span> <span class="keyword">extends</span> <span class="title">XxlJobExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobSpringExecutor</span> <span class="keyword">extends</span> <span class="title">XxlJobExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(XxlJobSpringExecutor.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// start</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init JobHandler Repository</span></span><br><span class="line">        <span class="comment">/*initJobHandlerRepository(applicationContext);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// init JobHandler Repository (for method)</span></span><br><span class="line">        initJobHandlerMethodRepository(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// refresh GlueFactory</span></span><br><span class="line">        GlueFactory.refreshInstance(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// super start</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initJobHandlerMethodRepository</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.获取spring容器中所有的类名的数组,所以执行器的类必须注入spring否则获取不到</span></span><br><span class="line">        <span class="comment">// init job handler from method</span></span><br><span class="line">        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2.循环通过类名获取容器中的类</span></span><br><span class="line">            Object bean = applicationContext.getBean(beanDefinitionName);</span><br><span class="line"></span><br><span class="line">            Map&lt;Method, XxlJob&gt; annotatedMethods = <span class="keyword">null</span>;   <span class="comment">// referred to ：org.springframework.context.event.EventListenerMethodProcessor.processBean</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				</span><br><span class="line">                <span class="comment">//3.通过MethodIntrospector获取类的方法</span></span><br><span class="line">                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),</span><br><span class="line">                        <span class="keyword">new</span> MethodIntrospector.MetadataLookup&lt;XxlJob&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> XxlJob <span class="title">inspect</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">                                <span class="comment">//4.获取方法上所有的注解</span></span><br><span class="line">                                <span class="keyword">return</span> AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;xxl-job method-jobhandler resolve error for bean[&quot;</span> + beanDefinitionName + <span class="string">&quot;].&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (annotatedMethods==<span class="keyword">null</span> || annotatedMethods.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Method, XxlJob&gt; methodXxlJobEntry : annotatedMethods.entrySet()) &#123;</span><br><span class="line">                Method method = methodXxlJobEntry.getKey();</span><br><span class="line">                XxlJob xxlJob = methodXxlJobEntry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (xxlJob == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//5.获取注解中的属性值</span></span><br><span class="line">                String name = xxlJob.value();</span><br><span class="line">                <span class="keyword">if</span> (name.trim().length() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler name invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//6.注解值为空或者handler的存放容器jobHandlerRepository中已存在该jobHandler时抛出异常，jobHandler是一个			  ConcurrentHashMap</span></span><br><span class="line">                <span class="keyword">if</span> (loadJobHandler(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job jobhandler[&quot;</span> + name + <span class="string">&quot;] naming conflicts.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// execute method</span></span><br><span class="line">                <span class="keyword">if</span> (!(method.getParameterTypes().length == <span class="number">1</span> &amp;&amp; method.getParameterTypes()[<span class="number">0</span>].isAssignableFrom(String.class))) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler param-classtype invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] , &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;The correct method format like \&quot; public ReturnT&lt;String&gt; execute(String param) \&quot; .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!method.getReturnType().isAssignableFrom(ReturnT.class)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler return-classtype invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] , &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;The correct method format like \&quot; public ReturnT&lt;String&gt; execute(String param) \&quot; .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// init and destory</span></span><br><span class="line">                Method initMethod = <span class="keyword">null</span>;</span><br><span class="line">                Method destroyMethod = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (xxlJob.init().trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        initMethod = bean.getClass().getDeclaredMethod(xxlJob.init());</span><br><span class="line">                        initMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler initMethod invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xxlJob.destroy().trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        destroyMethod = bean.getClass().getDeclaredMethod(xxlJob.destroy());</span><br><span class="line">                        destroyMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler destroyMethod invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// registry jobhandler</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//7.注册到handler存放的容器jobHandlerRepository中</span></span><br><span class="line">                registJobHandler(name, <span class="keyword">new</span> MethodJobHandler(bean, method, initMethod, destroyMethod));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job handler repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, IJobHandler&gt; jobHandlerRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IJobHandler&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">registJobHandler</span><span class="params">(String name, IJobHandler jobHandler)</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job register jobhandler success, name:&#123;&#125;, jobHandler:&#123;&#125;&quot;</span>, name, jobHandler);</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.put(name, jobHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">loadJobHandler</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ---------------------- job thread repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;Integer, JobThread&gt; jobThreadRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, JobThread&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">registJobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler, String removeOldReason)</span></span>&#123;</span><br><span class="line">        JobThread newJobThread = <span class="keyword">new</span> JobThread(jobId, handler);</span><br><span class="line">        newJobThread.start();</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job regist JobThread success, jobId:&#123;&#125;, handler:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;jobId, handler&#125;);</span><br><span class="line"></span><br><span class="line">        JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);	<span class="comment">// putIfAbsent | oh my god, map&#x27;s put method return the old value!!!</span></span><br><span class="line">        <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldJobThread.toStop(removeOldReason);</span><br><span class="line">            oldJobThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newJobThread;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>==xxl-job执行器handler注册入jobHandlerRepository仓库容器条件：==</p>
<p>==开发xxl-job执行器时要求我们必须==</p>
<p>==1、创建类注入到spring中==</p>
<p>==2、创建JobHandler方法并加上注解@XxlJob(“demoJobHandler”)==</p>
<p>==3、如果是java原生的Bean模式，需要在XxlJobConfig的初始化方法中手动注册handler==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleXxlJob</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>XxlJobSpringExecutor调用父类的start方法实例化XxlJobFileAppender、initAdminBizList、JobLogFileCleanThread、TriggerCallbackThread、initEmbedServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobExecutor</span>  </span>&#123;</span><br><span class="line">	<span class="comment">// ---------------------- start + stop ----------------------</span></span><br><span class="line">    <span class="comment">//初始化xxl-core重要功能模块</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化创建日志路径</span></span><br><span class="line">        XxlJobFileAppender.initLogPath(logPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化调度中心列表</span></span><br><span class="line">        initAdminBizList(adminAddresses, accessToken);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化日志清理线程</span></span><br><span class="line">        JobLogFileCleanThread.getInstance().start(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化触发回调线程</span></span><br><span class="line">        TriggerCallbackThread.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化嵌入服务</span></span><br><span class="line">        initEmbedServer(address, ip, port, appname, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// ---------------------- admin-client (rpc invoker) ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; adminBizList;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAdminBizList</span><span class="params">(String adminAddresses, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (adminAddresses!=<span class="keyword">null</span> &amp;&amp; adminAddresses.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String address: adminAddresses.trim().split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (address!=<span class="keyword">null</span> &amp;&amp; address.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    AdminBiz adminBiz = <span class="keyword">new</span> AdminBizClient(address.trim(), accessToken);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (adminBizList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        adminBizList = <span class="keyword">new</span> ArrayList&lt;AdminBiz&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    adminBizList.add(adminBiz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; <span class="title">getAdminBizList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adminBizList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- executor-server (rpc provider) ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> EmbedServer embedServer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initEmbedServer</span><span class="params">(String address, String ip, <span class="keyword">int</span> port, String appname, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill ip port</span></span><br><span class="line">        port = port&gt;<span class="number">0</span>?port: NetUtil.findAvailablePort(<span class="number">9999</span>);</span><br><span class="line">        ip = (ip!=<span class="keyword">null</span>&amp;&amp;ip.trim().length()&gt;<span class="number">0</span>)?ip: IpUtil.getIp();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// generate address</span></span><br><span class="line">        <span class="keyword">if</span> (address==<span class="keyword">null</span> || address.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            String ip_port_address = IpUtil.getIpPort(ip, port);   <span class="comment">// registry-address：default use address to registry , otherwise use ip:port if address is null</span></span><br><span class="line">            address = <span class="string">&quot;http://&#123;ip_port&#125;/&quot;</span>.replace(<span class="string">&quot;&#123;ip_port&#125;&quot;</span>, ip_port_address);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start</span></span><br><span class="line">        embedServer = <span class="keyword">new</span> EmbedServer();</span><br><span class="line">        embedServer.start(address, port, appname, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job handler repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, IJobHandler&gt; jobHandlerRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IJobHandler&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">registJobHandler</span><span class="params">(String name, IJobHandler jobHandler)</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job register jobhandler success, name:&#123;&#125;, jobHandler:&#123;&#125;&quot;</span>, name, jobHandler);</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.put(name, jobHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">loadJobHandler</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.get(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job thread repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;Integer, JobThread&gt; jobThreadRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, JobThread&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">registJobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler, String removeOldReason)</span></span>&#123;</span><br><span class="line">        JobThread newJobThread = <span class="keyword">new</span> JobThread(jobId, handler);</span><br><span class="line">        newJobThread.start();</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job regist JobThread success, jobId:&#123;&#125;, handler:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;jobId, handler&#125;);</span><br><span class="line"></span><br><span class="line">        JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);	<span class="comment">// putIfAbsent | oh my god, map&#x27;s put method return the old value!!!</span></span><br><span class="line">        <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldJobThread.toStop(removeOldReason);</span><br><span class="line">            oldJobThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newJobThread;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">loadJobThread</span><span class="params">(<span class="keyword">int</span> jobId)</span></span>&#123;</span><br><span class="line">        JobThread jobThread = jobThreadRepository.get(jobId);</span><br><span class="line">        <span class="keyword">return</span> jobThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）xxl-job-core的日志操作类XxlJobFileAppender"><a href="#3）xxl-job-core的日志操作类XxlJobFileAppender" class="headerlink" title="3）xxl-job-core的日志操作类XxlJobFileAppender"></a>3）xxl-job-core的日志操作类XxlJobFileAppender</h5><p>XxlJobFileAppender是xxl-core日志操作的类，可以添加日志的XxlJobLogger即使用该类的方法，XxlJobFileAppender日志是写入application.properties配置中的路径和文件中，不在spring的日志文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobFileAppender</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化日志路径方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initLogPath</span><span class="params">(String logPath)</span></span>&#123;</span><br><span class="line">		<span class="comment">// init</span></span><br><span class="line">		<span class="keyword">if</span> (logPath!=<span class="keyword">null</span> &amp;&amp; logPath.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">			logBasePath = logPath;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// mk base dir</span></span><br><span class="line">		File logPathDir = <span class="keyword">new</span> File(logBasePath);</span><br><span class="line">		<span class="keyword">if</span> (!logPathDir.exists()) &#123;</span><br><span class="line">			logPathDir.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		logBasePath = logPathDir.getPath();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mk glue dir</span></span><br><span class="line">		File glueBaseDir = <span class="keyword">new</span> File(logPathDir, <span class="string">&quot;gluesource&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!glueBaseDir.exists()) &#123;</span><br><span class="line">			glueBaseDir.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		glueSrcPath = glueBaseDir.getPath();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * append log</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> logFileName</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> appendLog</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//添加日志内容方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendLog</span><span class="params">(String logFileName, String appendLog)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// log file</span></span><br><span class="line">		<span class="keyword">if</span> (logFileName==<span class="keyword">null</span> || logFileName.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		File logFile = <span class="keyword">new</span> File(logFileName);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!logFile.exists()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				logFile.createNewFile();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				logger.error(e.getMessage(), e);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<h5 id="4）xxl-job-core的嵌入服务EmbedServer"><a href="#4）xxl-job-core的嵌入服务EmbedServer" class="headerlink" title="4）xxl-job-core的嵌入服务EmbedServer"></a>4）xxl-job-core的嵌入服务EmbedServer</h5><p>启动一个内嵌的netty服务，用于处理请求的处理，主要做了以下两点任务：</p>
<p>①实例化一个netty服务并绑定了配置的端口，默认9999，并且指定com.xxl.job.core.biz.ExecutorBiz为netty的http服务处理类</p>
<p>②调用执行器注册线程ExecutorRegistryThread的注册方法，将当前执行器的机器注册到调度中心的xxl_job_registry表中，供调度中心调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbedServer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> String address, <span class="keyword">final</span> <span class="keyword">int</span> port, <span class="keyword">final</span> String appname, <span class="keyword">final</span> String accessToken)</span> </span>&#123;</span><br><span class="line">        executorBiz = <span class="keyword">new</span> ExecutorBizImpl();</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// param</span></span><br><span class="line">                EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">                EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">                <span class="comment">//1.创建服务线程池</span></span><br><span class="line">                ThreadPoolExecutor bizThreadPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        <span class="number">200</span>,</span><br><span class="line">                        <span class="number">60L</span>,</span><br><span class="line">                        TimeUnit.SECONDS,</span><br><span class="line">                        <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">2000</span>),</span><br><span class="line">                        <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-rpc, EmbedServer bizThreadPool-&quot;</span> + r.hashCode());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="keyword">new</span> RejectedExecutionHandler() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job, EmbedServer bizThreadPool is EXHAUSTED!&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// start server</span></span><br><span class="line">                    <span class="number">2</span>、实例化netty的ServerBootstrap并绑定端口监听客户端请求，指定executorBiz为内嵌的netty服务的http服务处理器</span><br><span class="line">                    ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">                    bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                            .channel(NioServerSocketChannel.class)</span><br><span class="line">                            .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                    channel.pipeline()</span><br><span class="line">                                            .addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, <span class="number">30</span> * <span class="number">3</span>, TimeUnit.SECONDS))  <span class="comment">// beat 3N, close if idle</span></span><br><span class="line">                                            .addLast(<span class="keyword">new</span> HttpServerCodec())</span><br><span class="line">                                            .addLast(<span class="keyword">new</span> HttpObjectAggregator(<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>))  <span class="comment">// merge request &amp; reponse to FULL</span></span><br><span class="line">                                            .addLast(<span class="keyword">new</span> EmbedHttpServerHandler(executorBiz, accessToken, bizThreadPool));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// bind</span></span><br><span class="line">                    ChannelFuture future = bootstrap.bind(port).sync();</span><br><span class="line"></span><br><span class="line">                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server start success, nettype = &#123;&#125;, port = &#123;&#125;&quot;</span>, EmbedServer.class, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// start registry</span></span><br><span class="line">                    <span class="comment">//3、调用com.xxl.job.core.thread.ExecutorRegistryThread执行器注册线程将执行器注册到xxl_job_registry表中</span></span><br><span class="line">                    startRegistry(appname, address);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// wait util stop</span></span><br><span class="line">                    future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server stop.&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// stop</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        workerGroup.shutdownGracefully();</span><br><span class="line">                        bossGroup.shutdownGracefully();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);	<span class="comment">// daemon, service jvm, user thread leave &gt;&gt;&gt; daemon leave &gt;&gt;&gt; jvm leave</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// ---------------------- registry ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRegistry</span><span class="params">(<span class="keyword">final</span> String appname, <span class="keyword">final</span> String address)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// start registry</span></span><br><span class="line">        ExecutorRegistryThread.getInstance().start(appname, address);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4、当netty服务接受到客户端的请求时，进入该方法处理</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">process</span><span class="params">(HttpMethod httpMethod, String uri, String requestData, String accessTokenReq)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// valid</span></span><br><span class="line">            <span class="keyword">if</span> (HttpMethod.POST != httpMethod) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, HttpMethod not support.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (uri==<span class="keyword">null</span> || uri.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, uri-mapping empty.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (accessToken!=<span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; accessToken.trim().length()&gt;<span class="number">0</span></span><br><span class="line">                    &amp;&amp; !accessToken.equals(accessTokenReq)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;The access token is wrong.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// services mapping</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;/beat&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.beat();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/idleBeat&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    IdleBeatParam idleBeatParam = GsonTool.fromJson(requestData, IdleBeatParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.idleBeat(idleBeatParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/run&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    TriggerParam triggerParam = GsonTool.fromJson(requestData, TriggerParam.class);</span><br><span class="line">                    <span class="comment">//6、该方法再调用ExecutorBiz处理</span></span><br><span class="line">                    <span class="keyword">return</span> executorBiz.run(triggerParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/kill&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    KillParam killParam = GsonTool.fromJson(requestData, KillParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.kill(killParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/log&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    LogParam logParam = GsonTool.fromJson(requestData, LogParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.log(logParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, uri-mapping(&quot;</span>+ uri +<span class="string">&quot;) not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(e.getMessage(), e);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;request error:&quot;</span> + ThrowableUtil.toString(e));</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5）xxl-job-core的请求处理服务类ExecutorBiz"><a href="#5）xxl-job-core的请求处理服务类ExecutorBiz" class="headerlink" title="5）xxl-job-core的请求处理服务类ExecutorBiz"></a>5）xxl-job-core的请求处理服务类ExecutorBiz</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizImpl</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// load old：jobHandler + jobThread</span></span><br><span class="line">        <span class="comment">//1、调用XxlJobExecutor的加载线程方法获得jobThreadRepository线程仓库获得线程</span></span><br><span class="line">        JobThread jobThread = XxlJobExecutor.loadJobThread(triggerParam.getJobId());</span><br><span class="line">        <span class="comment">//2、如果线程不为null则从线程获取处理器</span></span><br><span class="line">        IJobHandler jobHandler = jobThread!=<span class="keyword">null</span>?jobThread.getHandler():<span class="keyword">null</span>;</span><br><span class="line">        String removeOldReason = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// valid：jobHandler + jobThread</span></span><br><span class="line">        GlueTypeEnum glueTypeEnum = GlueTypeEnum.match(triggerParam.getGlueType());</span><br><span class="line">        <span class="keyword">if</span> (GlueTypeEnum.BEAN == glueTypeEnum) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// new jobhandler</span></span><br><span class="line">            <span class="comment">//3、如果是Bean模式，则调用执行者registJobThread的方法从jobHandlerRepository执行器仓库获取一个新执行者</span></span><br><span class="line">            IJobHandler newJobHandler = XxlJobExecutor.loadJobHandler(triggerParam.getExecutorHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid old jobThread</span></span><br><span class="line">            <span class="keyword">if</span> (jobThread!=<span class="keyword">null</span> &amp;&amp; jobHandler != newJobHandler) &#123;</span><br><span class="line">                <span class="comment">// change handler, need kill old thread</span></span><br><span class="line">                removeOldReason = <span class="string">&quot;change jobhandler or glue type, and terminate the old job thread.&quot;</span>;</span><br><span class="line"></span><br><span class="line">                jobThread = <span class="keyword">null</span>;</span><br><span class="line">                jobHandler = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid handler</span></span><br><span class="line">            <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//4、如果获得handler和线程中旧handler不相等，就替换成新的handler</span></span><br><span class="line">                jobHandler = newJobHandler;</span><br><span class="line">                <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;job handler [&quot;</span> + triggerParam.getExecutorHandler() + <span class="string">&quot;] not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// executor block strategy</span></span><br><span class="line">        <span class="comment">//4、如果工作线程不为空</span></span><br><span class="line">        <span class="keyword">if</span> (jobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//5、根据触发参数的并行策略决定，是否创建新线程，是否停止旧线程</span></span><br><span class="line">            ExecutorBlockStrategyEnum blockStrategy = ExecutorBlockStrategyEnum.match(triggerParam.getExecutorBlockStrategy(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//6、如果是丢弃后来的策略，就报错不可执行</span></span><br><span class="line">            <span class="keyword">if</span> (ExecutorBlockStrategyEnum.DISCARD_LATER == blockStrategy) &#123;</span><br><span class="line">                <span class="comment">// discard when running</span></span><br><span class="line">                <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;block strategy effect：&quot;</span>+ExecutorBlockStrategyEnum.DISCARD_LATER.getTitle());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//7、如果是覆盖旧线程的策略，则旧线程清除</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorBlockStrategyEnum.COVER_EARLY == blockStrategy) &#123;</span><br><span class="line">                <span class="comment">// kill running jobThread</span></span><br><span class="line">                <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">                    removeOldReason = <span class="string">&quot;block strategy effect：&quot;</span> + ExecutorBlockStrategyEnum.COVER_EARLY.getTitle();</span><br><span class="line"></span><br><span class="line">                    jobThread = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// just queue trigger</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// replace thread (new or exists invalid)</span></span><br><span class="line">        <span class="comment">//8、如果当前线程为空，根据触发的任务id和jobhandler注册一个新的线程</span></span><br><span class="line">        <span class="keyword">if</span> (jobThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobThread = XxlJobExecutor.registJobThread(triggerParam.getJobId(), jobHandler, removeOldReason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// push data to queue</span></span><br><span class="line">        <span class="comment">//9、将新的触发数据，放入线程触发队列中，等待触发执行</span></span><br><span class="line">        ReturnT&lt;String&gt; pushResult = jobThread.pushTriggerQueue(triggerParam);</span><br><span class="line">        <span class="keyword">return</span> pushResult;</span><br></pre></td></tr></table></figure>
<h5 id="6）xxl-job-core中的执行线程JobThread（重要）"><a href="#6）xxl-job-core中的执行线程JobThread（重要）" class="headerlink" title="6）xxl-job-core中的执行线程JobThread（重要）"></a>6）xxl-job-core中的执行线程JobThread（重要）</h5><p>xxl-job-core是执行任务的核心工作模块，调起任务时运行其中的com.xxl.job.core.thread.JobThread类中run方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">public class JobThread extends Thread&#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;将触发参数放入触发队列中</span><br><span class="line">	public ReturnT&lt;String&gt; pushTriggerQueue(TriggerParam triggerParam) &#123;</span><br><span class="line">		&#x2F;&#x2F; avoid repeat</span><br><span class="line">		if (triggerLogIdSet.contains(triggerParam.getLogId())) &#123;</span><br><span class="line">			logger.info(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; repeate trigger job, logId:&#123;&#125;&quot;, triggerParam.getLogId());</span><br><span class="line">			return new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, &quot;repeate trigger job, logId:&quot; + triggerParam.getLogId());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		triggerLogIdSet.add(triggerParam.getLogId());</span><br><span class="line">		triggerQueue.add(triggerParam);</span><br><span class="line">        return ReturnT.SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    @Override</span><br><span class="line">	public void run() &#123;</span><br><span class="line"></span><br><span class="line">    	&#x2F;&#x2F; init</span><br><span class="line">    	try &#123;</span><br><span class="line">			handler.init();</span><br><span class="line">		&#125; catch (Throwable e) &#123;</span><br><span class="line">    		logger.error(e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; execute</span><br><span class="line">		while(!toStop)&#123;</span><br><span class="line">			running &#x3D; false;</span><br><span class="line">			idleTimes++;</span><br><span class="line"></span><br><span class="line">            TriggerParam triggerParam &#x3D; null;</span><br><span class="line">            ReturnT&lt;String&gt; executeResult &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">				&#x2F;&#x2F; to check toStop signal, we need cycle, so wo cannot use queue.take(), instand of poll(timeout)</span><br><span class="line">				&#x2F;&#x2F;1、每3秒从触发队列里面poll一个触发参数</span><br><span class="line">				triggerParam &#x3D; triggerQueue.poll(3L, TimeUnit.SECONDS);</span><br><span class="line">				if (triggerParam!&#x3D;null) &#123;</span><br><span class="line">					running &#x3D; true;</span><br><span class="line">					idleTimes &#x3D; 0;</span><br><span class="line">					&#x2F;&#x2F;2、如果该触发任务正在进行中，旧删除原触发日志</span><br><span class="line">					triggerLogIdSet.remove(triggerParam.getLogId());</span><br><span class="line"></span><br><span class="line">					&#x2F;&#x2F; log filename, like &quot;logPath&#x2F;yyyy-MM-dd&#x2F;9999.log&quot;</span><br><span class="line">					&#x2F;&#x2F;3、重新创建日志文件，并初始化工作上下文容器的值</span><br><span class="line">					String logFileName &#x3D; XxlJobFileAppender.makeLogFileName(new Date(triggerParam.getLogDateTime()), triggerParam.getLogId());</span><br><span class="line">					XxlJobContext.setXxlJobContext(new XxlJobContext(</span><br><span class="line">							triggerParam.getLogId(),</span><br><span class="line">							logFileName,</span><br><span class="line">							triggerParam.getBroadcastIndex(),</span><br><span class="line">							triggerParam.getBroadcastTotal()));</span><br><span class="line"></span><br><span class="line">					&#x2F;&#x2F; execute</span><br><span class="line">					&#x2F;&#x2F;4、打印线程开始执行日志（熟悉的味道）</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute start -----------&lt;br&gt;----------- Param:&quot; + triggerParam.getExecutorParams());</span><br><span class="line"></span><br><span class="line">					if (triggerParam.getExecutorTimeout() &gt; 0) &#123;</span><br><span class="line">						&#x2F;&#x2F; limit timeout</span><br><span class="line">						Thread futureThread &#x3D; null;</span><br><span class="line">						try &#123;</span><br><span class="line">							final TriggerParam triggerParamTmp &#x3D; triggerParam;</span><br><span class="line">							FutureTask&lt;ReturnT&lt;String&gt;&gt; futureTask &#x3D; new FutureTask&lt;ReturnT&lt;String&gt;&gt;(new Callable&lt;ReturnT&lt;String&gt;&gt;() &#123;</span><br><span class="line">								@Override</span><br><span class="line">								public ReturnT&lt;String&gt; call() throws Exception &#123;</span><br><span class="line">									&#x2F;&#x2F;5.handler执行该任务</span><br><span class="line">									return handler.execute(triggerParamTmp.getExecutorParams());</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;);</span><br><span class="line">							&#x2F;&#x2F;6.开辟新的线程异步获取handler执行结果</span><br><span class="line">							futureThread &#x3D; new Thread(futureTask);</span><br><span class="line">							futureThread.start();</span><br><span class="line"></span><br><span class="line">							executeResult &#x3D; futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);</span><br><span class="line">						&#125; catch (TimeoutException e) &#123;</span><br><span class="line">							&#x2F;&#x2F;7、如果执行超时打印超时日志，并创建执行超时返回结果</span><br><span class="line">							XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute timeout&quot;);</span><br><span class="line">							XxlJobLogger.log(e);</span><br><span class="line"></span><br><span class="line">							executeResult &#x3D; new ReturnT&lt;String&gt;(IJobHandler.FAIL_TIMEOUT.getCode(), &quot;job execute timeout &quot;);</span><br><span class="line">						&#125; finally &#123;</span><br><span class="line">							futureThread.interrupt();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">					&#x2F;&#x2F;8、执行成功，设置执行信息，打印执行成功日志</span><br><span class="line">						&#x2F;&#x2F; just execute</span><br><span class="line">						executeResult &#x3D; handler.execute(triggerParam.getExecutorParams());</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					if (executeResult &#x3D;&#x3D; null) &#123;</span><br><span class="line">						executeResult &#x3D; IJobHandler.FAIL;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						executeResult.setMsg(</span><br><span class="line">								(executeResult!&#x3D;null&amp;&amp;executeResult.getMsg()!&#x3D;null&amp;&amp;executeResult.getMsg().length()&gt;50000)</span><br><span class="line">										?executeResult.getMsg().substring(0, 50000).concat(&quot;...&quot;)</span><br><span class="line">										:executeResult.getMsg());</span><br><span class="line">						executeResult.setContent(null);	&#x2F;&#x2F; limit obj size</span><br><span class="line">					&#125;</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute end(finish) -----------&lt;br&gt;----------- ReturnT:&quot; + executeResult);</span><br><span class="line"></span><br><span class="line">				&#125; else &#123;</span><br><span class="line">				&#x2F;&#x2F;9、调度次数超过30次删除该调度任务</span><br><span class="line">					if (idleTimes &gt; 30) &#123;</span><br><span class="line">						if(triggerQueue.size() &#x3D;&#x3D; 0) &#123;	&#x2F;&#x2F; avoid concurrent trigger causes jobId-lost</span><br><span class="line">							XxlJobExecutor.removeJobThread(jobId, &quot;excutor idel times over limit.&quot;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; catch (Throwable e) &#123;</span><br><span class="line">				if (toStop) &#123;</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- JobThread toStop, stopReason:&quot; + stopReason);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				StringWriter stringWriter &#x3D; new StringWriter();</span><br><span class="line">				e.printStackTrace(new PrintWriter(stringWriter));</span><br><span class="line">				String errorMsg &#x3D; stringWriter.toString();</span><br><span class="line">				executeResult &#x3D; new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, errorMsg);</span><br><span class="line"></span><br><span class="line">				XxlJobLogger.log(&quot;&lt;br&gt;----------- JobThread Exception:&quot; + errorMsg + &quot;&lt;br&gt;----------- xxl-job job execute end(error) -----------&quot;);</span><br><span class="line">			&#125; finally &#123;</span><br><span class="line">                if(triggerParam !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; callback handler info</span><br><span class="line">                    if (!toStop) &#123;</span><br><span class="line">                        &#x2F;&#x2F;10、触发回调线程调用xxl-job的回调接口，将执行结果返回给调度中心</span><br><span class="line">                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(triggerParam.getLogId(), triggerParam.getLogDateTime(), executeResult));</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        &#x2F;&#x2F; is killed</span><br><span class="line">                        ReturnT&lt;String&gt; stopResult &#x3D; new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, stopReason + &quot; [job running, killed]&quot;);</span><br><span class="line">                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(triggerParam.getLogId(), triggerParam.getLogDateTime(), stopResult));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h5 id="7）xxl-job的执行器注册线程ExecutorRegistryThread"><a href="#7）xxl-job的执行器注册线程ExecutorRegistryThread" class="headerlink" title="7）xxl-job的执行器注册线程ExecutorRegistryThread"></a>7）xxl-job的执行器注册线程ExecutorRegistryThread</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorRegistryThread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> String appname, <span class="keyword">final</span> String address)</span></span>&#123;</span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (appname==<span class="keyword">null</span> || appname.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry config fail, appname is null.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (XxlJobExecutor.getAdminBizList() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry config fail, adminAddresses is null.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        registryThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// registry</span></span><br><span class="line">                <span class="keyword">while</span> (!toStop) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//1、创建一个xxl_job_registry注册表的实体对象</span></span><br><span class="line">                        RegistryParam registryParam = <span class="keyword">new</span> RegistryParam(RegistryConfig.RegistType.EXECUTOR.name(), appname, address);</span><br><span class="line">                        <span class="comment">//2、对调度中心地址列表循环，application.properties中配置的xxl.job.admin.addresses</span></span><br><span class="line">                        <span class="keyword">for</span> (AdminBiz adminBiz: XxlJobExecutor.getAdminBizList()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">//3、调用AdminBizImpl注册方法，将执行器机器注册到每个调度中心</span></span><br><span class="line">                                ReturnT&lt;String&gt; registryResult = adminBiz.registry(registryParam);</span><br><span class="line">                                <span class="keyword">if</span> (registryResult!=<span class="keyword">null</span> &amp;&amp; ReturnT.SUCCESS_CODE == registryResult.getCode()) &#123;</span><br><span class="line">                                    registryResult = ReturnT.SUCCESS;</span><br><span class="line">                                    logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry success, registryParam:&#123;&#125;, registryResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;registryParam, registryResult&#125;);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry fail, registryParam:&#123;&#125;, registryResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;registryParam, registryResult&#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry error, registryParam:&#123;&#125;&quot;</span>, registryParam, e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            logger.error(e.getMessage(), e);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            TimeUnit.SECONDS.sleep(RegistryConfig.BEAT_TIMEOUT);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry thread interrupted, error msg:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminBizImpl</span> <span class="keyword">implements</span> <span class="title">AdminBiz</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">registry</span><span class="params">(RegistryParam registryParam)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(registryParam.getRegistryGroup())</span><br><span class="line">                || !StringUtils.hasText(registryParam.getRegistryKey())</span><br><span class="line">                || !StringUtils.hasText(registryParam.getRegistryValue())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;Illegal Argument.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret = xxlJobRegistryDao.registryUpdate(registryParam.getRegistryGroup(), registryParam.getRegistryKey(), registryParam.getRegistryValue(), <span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            xxlJobRegistryDao.registrySave(registryParam.getRegistryGroup(), registryParam.getRegistryKey(), registryParam.getRegistryValue(), <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// fresh</span></span><br><span class="line">            freshGroupRegistryInfo(registryParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="四、xxl-job项目的日志分析"><a href="#四、xxl-job项目的日志分析" class="headerlink" title="四、xxl-job项目的日志分析"></a>四、xxl-job项目的日志分析</h4><h5 id="1-项目的spring日志"><a href="#1-项目的spring日志" class="headerlink" title="1)项目的spring日志"></a>1)项目的spring日志</h5><p>与普通项目spring日志相同查看方式，xxl-job-admin和xxl-job-executor项目的spring日志分别记录项目启动和基本服务的日志</p>
<h5 id="2-调度日志列表"><a href="#2-调度日志列表" class="headerlink" title="2)调度日志列表"></a>2)调度日志列表</h5><p>请求了url：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120547.png" alt="image-20201028091534918"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/pageList&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">pageList</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> start,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="meta">@RequestParam(required = false, defaultValue = &quot;10&quot;)</span> <span class="keyword">int</span> length,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="keyword">int</span> jobGroup, <span class="keyword">int</span> jobId, <span class="keyword">int</span> logStatus, String filterTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// valid permission</span></span><br><span class="line">	JobInfoController.validPermission(request, jobGroup);	<span class="comment">// 仅管理员支持查询全部；普通用户仅支持查询有权限的 jobGroup</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// parse param</span></span><br><span class="line">	Date triggerTimeStart = <span class="keyword">null</span>;</span><br><span class="line">	Date triggerTimeEnd = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (filterTime!=<span class="keyword">null</span> &amp;&amp; filterTime.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">		String[] temp = filterTime.split(<span class="string">&quot; - &quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (temp.length == <span class="number">2</span>) &#123;</span><br><span class="line">			triggerTimeStart = DateUtil.parseDateTime(temp[<span class="number">0</span>]);</span><br><span class="line">			triggerTimeEnd = DateUtil.parseDateTime(temp[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// page query</span></span><br><span class="line">	List&lt;XxlJobLog&gt; list = xxlJobLogDao.pageList(start, length, jobGroup, jobId, triggerTimeStart, triggerTimeEnd, logStatus);</span><br><span class="line">	<span class="keyword">int</span> list_count = xxlJobLogDao.pageListCount(start, length, jobGroup, jobId, triggerTimeStart, triggerTimeEnd, logStatus);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// package result</span></span><br><span class="line">	Map&lt;String, Object&gt; maps = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    maps.put(<span class="string">&quot;recordsTotal&quot;</span>, list_count);		<span class="comment">// 总记录数</span></span><br><span class="line">    maps.put(<span class="string">&quot;recordsFiltered&quot;</span>, list_count);	<span class="comment">// 过滤后的总记录数</span></span><br><span class="line">    maps.put(<span class="string">&quot;data&quot;</span>, list);  					<span class="comment">// 分页列表</span></span><br><span class="line">	<span class="keyword">return</span> maps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;XxlJobLog&quot;</span>&gt;</span></span><br><span class="line">	SELECT <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span></span><br><span class="line">	FROM xxl_job_log AS t</span><br><span class="line">	<span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;WHERE&quot;</span> <span class="attr">prefixOverrides</span>=<span class="string">&quot;AND | OR&quot;</span> &gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;jobId==0 and jobGroup gt 0&quot;</span>&gt;</span></span><br><span class="line">			AND t.job_group = #&#123;jobGroup&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;jobId gt 0&quot;</span>&gt;</span></span><br><span class="line">			AND t.job_id = #&#123;jobId&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;triggerTimeStart != null&quot;</span>&gt;</span></span><br><span class="line">			AND t.trigger_time &lt;![CDATA[ &gt;= ]]&gt; #&#123;triggerTimeStart&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;triggerTimeEnd != null&quot;</span>&gt;</span></span><br><span class="line">			AND t.trigger_time &lt;![CDATA[ &lt;= ]]&gt; #&#123;triggerTimeEnd&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 1&quot;</span> &gt;</span></span><br><span class="line">			AND t.handle_code = 200</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 2&quot;</span> &gt;</span></span><br><span class="line">			AND (</span><br><span class="line">				t.trigger_code NOT IN (0, 200) OR</span><br><span class="line">				t.handle_code NOT IN (0, 200)</span><br><span class="line">			)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 3&quot;</span> &gt;</span></span><br><span class="line">			AND t.trigger_code = 200</span><br><span class="line">			AND t.handle_code = 0</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">	ORDER BY t.trigger_time DESC</span><br><span class="line">	LIMIT #&#123;offset&#125;, #&#123;pagesize&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-执行日志详情"><a href="#3-执行日志详情" class="headerlink" title="3)执行日志详情"></a>3)执行日志详情</h5><p>请求了url：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120555.png" alt="image-20201028091927853"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/logDetailCat&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;LogResult&gt; <span class="title">logDetailCat</span><span class="params">(String executorAddress, <span class="keyword">long</span> triggerTime, <span class="keyword">long</span> logId, <span class="keyword">int</span> fromLineNum)</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//通过admin的调度器XxlJobScheduler获取执行器客户端</span></span><br><span class="line">		ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(executorAddress);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//远程调用获取日志</span></span><br><span class="line">		ReturnT&lt;LogResult&gt; logResult = executorBiz.log(<span class="keyword">new</span> LogParam(triggerTime, logId, fromLineNum));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// is end</span></span><br><span class="line">           <span class="keyword">if</span> (logResult.getContent()!=<span class="keyword">null</span> &amp;&amp; logResult.getContent().getFromLineNum() &gt; logResult.getContent().getToLineNum()) &#123;</span><br><span class="line">               XxlJobLog jobLog = xxlJobLogDao.load(logId);</span><br><span class="line">               <span class="keyword">if</span> (jobLog.getHandleCode() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   logResult.getContent().setEnd(<span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> logResult;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.error(e.getMessage(), e);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;LogResult&gt;(ReturnT.FAIL_CODE, e.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xxl-job-core中处理客户端http请求的com.xxl.job.core.biz.impl.ExecutorBizImpl的log方法读取日志内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizImpl</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;LogResult&gt; <span class="title">log</span><span class="params">(LogParam logParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// log filename: logPath/yyyy-MM-dd/9999.log</span></span><br><span class="line">        String logFileName = XxlJobFileAppender.makeLogFileName(<span class="keyword">new</span> Date(logParam.getLogDateTim()), logParam.getLogId());</span><br><span class="line"></span><br><span class="line">        LogResult logResult = XxlJobFileAppender.readLog(logFileName, logParam.getFromLineNum());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;LogResult&gt;(logResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="五、BCRM项目中xxl-job实际执行问题分析"><a href="#五、BCRM项目中xxl-job实际执行问题分析" class="headerlink" title="五、BCRM项目中xxl-job实际执行问题分析"></a>五、BCRM项目中xxl-job实际执行问题分析</h4><h5 id="问题案例1："><a href="#问题案例1：" class="headerlink" title="问题案例1："></a>问题案例1：</h5><p>问题：近期生产上BCRM项目xxl-job调度中心一个调度任务报表中没有其执行结果，有该任务调度日志，但是没有执行器处理结果和执行日志，无法得知执行流程</p>
<p>解决方法：</p>
<p>xxl-job常规问题排查流程</p>
<p>1）查询数据库xxl_job_log表或调度中心调度日志，查看调度任务步骤、任务id、执行器信息等</p>
<p>2）查看spring日志，查看交易是否调起，线程执行到哪一步</p>
<p>3）xxl-job_executor配置的xxl-job的路径下查看是否有该任务的xxl-job执行器日志</p>
<p>最终得知从xxl-job执行器的日志中查到问题原因，是该执行器中循环拼接30万条数据插入数据库sql语句，导致sql语句长度超过mysql数据库的最大限制，所以插入数据失败，同时因为循环打印日志，导致xxl-job执行器的日志达到17MB，==日志文件过大调度中心通过http请求加载日志加载不出来==</p>
<h5 id="问题案例2："><a href="#问题案例2：" class="headerlink" title="问题案例2："></a>问题案例2：</h5><p>问题：BCRM某执行器执行失败，调度日志显示执行结果code=500，没有报错信息无法指导失败原因</p>
<p>解决方法：</p>
<p>xxl-job-admin调度中心触发执行任务，本质就是向xxl-job-executor执行器的内嵌netty服务发起http协议的请求，远程rpc调用JobHandler,JobHandler最终将执行器处理结果ReturnT通过回调接口返回调度中心，</p>
<p>该问题调度中心收到500的错误码，所以调度中心和执行器之间的请求和回调流程是正常走完的，这属于业务上报错</p>
<p>由于该执行器模块的开发者未注意开发规范，执行器方法中既未使用slf4j日志模块打印spring日志，也未使用XxlJobLogger.log打印xxl-job执行日志，所以造成定位该业务报错困难，==请代码严格遵守开发规范阶段性打印spring和xxl-job日志，方便后期跟踪排查==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Spring Scheduler脚本调度的痛点</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="ckk2gq3um001vz8pq2axy9qrx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-XXL-JOB分布式调度/XXL-JOB任务调度笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.872Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、xxl-job是什么？"><a href="#一、xxl-job是什么？" class="headerlink" title="一、xxl-job是什么？"></a>一、xxl-job是什么？</h4><p>​    XXL-JOB是一个开源的分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展，可以达到开箱即用的程度。</p>
<p><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">官方学习指导文档地址</a></p>
<h4 id="二、XXL-JOB源码下载"><a href="#二、XXL-JOB源码下载" class="headerlink" title="二、XXL-JOB源码下载"></a>二、XXL-JOB源码下载</h4><p><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">XXL-JOB下载地址</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">maven中央仓库地址</span><br><span class="line"><span class="comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;最新稳定版本&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">环境要求：</span><br><span class="line">Maven3+</span><br><span class="line">Jdk1.8+</span><br><span class="line">Mysql5.7+</span><br></pre></td></tr></table></figure>
<h4 id="三、快速入门"><a href="#三、快速入门" class="headerlink" title="三、快速入门"></a>三、快速入门</h4><h5 id="1）创建xxl-job调度需要的数据库表"><a href="#1）创建xxl-job调度需要的数据库表" class="headerlink" title="1）创建xxl-job调度需要的数据库表"></a>1）创建xxl-job调度需要的数据库表</h5><p>​    执行“调度数据库初始化SQL脚本” 需要的表，位置为:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/doc/db/tables_xxl_job.sql</span><br><span class="line"></span><br><span class="line">调度中心支持集群部署，集群情况下各节点务必连接同一个mysql实例;</span><br><span class="line">如果mysql做主从,调度中心集群节点务必强制走主库;</span><br></pre></td></tr></table></figure>
<h5 id="2）编译源码"><a href="#2）编译源码" class="headerlink" title="2）编译源码"></a>2）编译源码</h5><p>解压源码,按照maven格式将源码导入IDE, 使用maven进行编译即可，源码结构如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xxl-job-admin：调度中心</span><br><span class="line">xxl-job-core：公共依赖</span><br><span class="line">xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用，也可以参考其并将现有项目改造成执行器）</span><br><span class="line">    ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</span><br><span class="line">    ：xxl-job-executor-sample-spring：Spring版本，通过Spring容器管理执行器，比较通用；</span><br><span class="line">    ：xxl-job-executor-sample-frameless：无框架版本；</span><br><span class="line">    ：xxl-job-executor-sample-jfinal：JFinal版本，通过JFinal管理执行器；</span><br><span class="line">    ：xxl-job-executor-sample-nutz：Nutz版本，通过Nutz管理执行器；</span><br><span class="line">    ：xxl-job-executor-sample-jboot：jboot版本，通过jboot管理执行器；</span><br></pre></td></tr></table></figure>
<h5 id="3-配置部署调度中心"><a href="#3-配置部署调度中心" class="headerlink" title="3)配置部署调度中心"></a>3)配置部署调度中心</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度中心配置文件地址：</span></span><br><span class="line"><span class="attr">/xxl-job/xxl-job-admin/src/main/resources/application.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">调度中心配置内容说明：</span></span><br><span class="line"><span class="comment">### 调度中心JDBC链接：链接地址请保持和 2.1章节 所创建的调度数据库的地址一致</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root_pwd</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="comment">### 报警邮箱</span></span><br><span class="line"><span class="meta">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="meta">spring.mail.port</span>=<span class="string">25</span></span><br><span class="line"><span class="meta">spring.mail.username</span>=<span class="string">xxx@qq.com</span></span><br><span class="line"><span class="meta">spring.mail.password</span>=<span class="string">xxx</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line"><span class="comment">### 调度中心通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 调度中心国际化配置 [必填]： 默认为 &quot;zh_CN&quot;/中文简体, 可选范围为 &quot;zh_CN&quot;/中文简体, &quot;zh_TC&quot;/中文繁体 and &quot;en&quot;/英文；</span></span><br><span class="line"><span class="meta">xxl.job.i18n</span>=<span class="string">zh_CN</span></span><br><span class="line"><span class="comment">## 调度线程池最大线程配置【必填】</span></span><br><span class="line"><span class="meta">xxl.job.triggerpool.fast.max</span>=<span class="string">200</span></span><br><span class="line"><span class="meta">xxl.job.triggerpool.slow.max</span>=<span class="string">100</span></span><br><span class="line"><span class="comment">### 调度中心日志表数据保存天数 [必填]：过期日志自动清理；限制大于等于7时生效，否则, 如-1，关闭自动清理功能；</span></span><br><span class="line"><span class="meta">xxl.job.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<p>如果已经正确进行上述配置，可将项目编译打包部署。</p>
<p>调度中心访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> (该地址执行器将会使用到，作为回调地址)</p>
<p>==默认登录账号 “admin/123456”, 登录后即可查看运行界面。==</p>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p>
<p>==调度中心集群部署时，几点要求和建议：==</p>
<ul>
<li>==DB配置保持一致；==</li>
<li>==集群机器时钟保持一致（单机集群忽视）；==</li>
<li>==建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过该域名进行。==</li>
</ul>
<h5 id="4）配置部署执行器项目"><a href="#4）配置部署执行器项目" class="headerlink" title="4）配置部署执行器项目"></a>4）配置部署执行器项目</h5><h6 id="①确认pom文件中引入了-“xxl-job-core”-的maven依赖；"><a href="#①确认pom文件中引入了-“xxl-job-core”-的maven依赖；" class="headerlink" title="①确认pom文件中引入了 “xxl-job-core” 的maven依赖；"></a>①确认pom文件中引入了 “xxl-job-core” 的maven依赖；</h6><h6 id="②执行器配置"><a href="#②执行器配置" class="headerlink" title="②执行器配置"></a>②执行器配置</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">执行器配置，配置文件地址：</span></span><br><span class="line"><span class="attr">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/resources/application.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">执行器配置，配置内容说明：</span></span><br><span class="line"><span class="comment">### 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span></span><br><span class="line"><span class="meta">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"><span class="comment">### 执行器通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line"><span class="meta">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line"><span class="meta">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span></span><br><span class="line"><span class="meta">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line"><span class="meta">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line"><span class="meta">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line"><span class="meta">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<h6 id="③执行器组件配置"><a href="#③执行器组件配置" class="headerlink" title="③执行器组件配置"></a>③执行器组件配置</h6><p>执行器组件，配置文件地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/java/com/xxl/job/executor/core/config/XxlJobConfig.java</span><br></pre></td></tr></table></figure>
<p>执行器组件，配置内容说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">    XxlJobSpringExecutor xxlJobSpringExecutor = <span class="keyword">new</span> XxlJobSpringExecutor();</span><br><span class="line">    xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">    xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">    xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">    xxlJobSpringExecutor.setPort(port);</span><br><span class="line">    xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">    xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">    xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line">    <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="④部署执行器项目："><a href="#④部署执行器项目：" class="headerlink" title="④部署执行器项目："></a>④部署执行器项目：</h6><p>如果已经正确进行上述配置，可将执行器项目编译打部署</p>
<h6 id="⑤执行器集群（可选）："><a href="#⑤执行器集群（可选）：" class="headerlink" title="⑤执行器集群（可选）："></a>⑤执行器集群（可选）：</h6><p>执行器支持集群部署，提升调度系统可用性，同时提升任务处理能力。</p>
<p>执行器集群部署时，几点要求和建议：</p>
<ul>
<li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li>
<li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li>
</ul>
<h5 id="5）开发第一个Hello-World"><a href="#5）开发第一个Hello-World" class="headerlink" title="5）开发第一个Hello World"></a>5）开发第一个Hello World</h5><p>示例以新建一个 “GLUE模式(Java)” 运行模式的任务为例</p>
<h6 id="①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"><a href="#①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务" class="headerlink" title="①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"></a>①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务</h6><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120321.png" alt="输入图片说明"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120330.png" alt="image-20201026134526501"></p>
<h6 id="②GLUE模式-Java-”-任务开发："><a href="#②GLUE模式-Java-”-任务开发：" class="headerlink" title="②GLUE模式(Java)” 任务开发："></a>②GLUE模式(Java)” 任务开发：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.service.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.log.XxlJobLogger;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.biz.model.ReturnT;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.IJobHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoGlueJobHandler</span> <span class="keyword">extends</span> <span class="title">IJobHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">execute</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="③触发执行："><a href="#③触发执行：" class="headerlink" title="③触发执行："></a>③触发执行：</h6><p>点击任务右侧 “执行” 按钮，可手动触发一次任务执行（通常情况下，通过配置Cron表达式进行任务调度触发）</p>
<h6 id="④查看日志："><a href="#④查看日志：" class="headerlink" title="④查看日志："></a>④查看日志：</h6><p>点击任务右侧 “日志” 按钮，可前往任务日志界面查看任务日志。<br>在任务日志界面中，可查看该任务的历史调度记录以及每一次调度的任务调度信息、执行参数和执行信息。运行中的任务点击右侧的“执行日志”按钮，可进入日志控制台查看实时执行日志。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120334.png" alt="image-20201026134959200"></p>
<p>在日志控制台，可以Rolling方式实时查看任务在执行器一侧运行输出的日志信息，实时监控任务进度；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120339.png" alt="image-20201026135028147"></p>
<h4 id="四、任务详解"><a href="#四、任务详解" class="headerlink" title="四、任务详解"></a>四、任务详解</h4><p>配置属性详细说明：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">执行器：任务的绑定的执行器，任务触发调度时将会自动发现注册成功的执行器, 实现任务自动发现功能; 另一方面也可以方便的进行任务分组。每个任务必须绑定一个执行器, 可在 &quot;执行器管理&quot; 进行设置;</span></span><br><span class="line"><span class="meta">-</span> <span class="string">任务描述：任务的描述信息，便于任务管理；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span></span><br><span class="line">    <span class="attr">FIRST（第一个）：固定选择第一个机器；</span></span><br><span class="line">    <span class="attr">LAST（最后一个）：固定选择最后一个机器；</span></span><br><span class="line">    <span class="attr">ROUND（轮询）：；</span></span><br><span class="line">    <span class="attr">RANDOM（随机）：随机选择在线的机器；</span></span><br><span class="line">    <span class="attr">CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span></span><br><span class="line">    <span class="attr">LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span></span><br><span class="line">    <span class="attr">LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span></span><br><span class="line">    <span class="attr">FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span></span><br><span class="line">    <span class="attr">BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span></span><br><span class="line">    <span class="attr">SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">Cron：触发任务执行的Cron表达式；</span></span><br><span class="line">	<span class="attr">与spring的定时任务表达式区别，最后多一个，表示年</span></span><br><span class="line">	<span class="meta">如：0</span> <span class="string">0 * * * ？ * 表示每小时0分0秒触发一次</span></span><br><span class="line"><span class="meta">-</span> <span class="string">运行模式：</span></span><br><span class="line">    <span class="meta">BEAN模式：任务以JobHandler方式维护在执行器端；需要结合</span> <span class="string">&quot;JobHandler&quot; 属性匹配执行器中任务；</span></span><br><span class="line">    <span class="meta">GLUE模式(Java)：任务以源码方式维护在调度中心；该模式的任务实际上是一段继承自IJobHandler的Java类代码并</span> <span class="string">&quot;groovy&quot; 源码方式维护，它在执行器项目中运行，可使用@Resource/@Autowire注入执行器里中的其他服务；</span></span><br><span class="line">    <span class="meta">GLUE模式(Shell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;shell&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(Python)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;python&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(PHP)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;php&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(NodeJS)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;nodejs&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(PowerShell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;PowerShell&quot; 脚本；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">JobHandler：运行模式为 &quot;BEAN模式&quot; 时生效，对应执行器中新开发的JobHandler类“@JobHandler”注解自定义的value值；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span></span><br><span class="line">    <span class="attr">单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span></span><br><span class="line">    <span class="attr">丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span></span><br><span class="line">    <span class="attr">覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度。</span></span><br><span class="line"><span class="meta">-</span> <span class="string">任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">报警邮件：任务调度失败时邮件通知的邮箱地址，支持配置多邮箱地址，配置多个邮箱地址时用逗号分隔；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">负责人：任务的负责人；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">执行参数：任务执行所需的参数；</span></span><br></pre></td></tr></table></figure>
<h5 id="1）BEAN模式（类形式）"><a href="#1）BEAN模式（类形式）" class="headerlink" title="1）BEAN模式（类形式）"></a>1）BEAN模式（类形式）</h5><p>Bean模式任务，支持基于类的开发方式，每个任务对应一个Java类。</p>
<ul>
<li>优点：不限制项目环境，兼容性好。即使是无框架项目，如main方法直接启动的项目也可以提供支持，可以参考示例项目 “xxl-job-executor-sample-frameless”；</li>
<li>缺点：<ul>
<li>每个任务需要占用一个Java类，造成类的浪费；</li>
<li>不支持自动扫描任务并注入到执行器容器，需要手动注入。</li>
</ul>
</li>
</ul>
<h6 id="①执行器项目中，开发Job类："><a href="#①执行器项目中，开发Job类：" class="headerlink" title="①执行器项目中，开发Job类："></a>①执行器项目中，开发Job类：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、开发一个继承自<span class="string">&quot;com.xxl.job.core.handler.IJobHandler&quot;</span>的JobHandler类，实现其中任务方法。</span><br><span class="line"><span class="number">2</span>、手动通过如下方式注入到执行器容器。</span><br><span class="line">​```</span><br><span class="line">XxlJobExecutor.registJobHandler(<span class="string">&quot;demoJobHandler&quot;</span>, <span class="keyword">new</span> DemoJobHandler());</span><br><span class="line">​```</span><br></pre></td></tr></table></figure>
<h6 id="②调度中心，新建调度任务"><a href="#②调度中心，新建调度任务" class="headerlink" title="②调度中心，新建调度任务"></a>②调度中心，新建调度任务</h6><h5 id="2）BEAN模式（方法形式）"><a href="#2）BEAN模式（方法形式）" class="headerlink" title="2）BEAN模式（方法形式）"></a>2）BEAN模式（方法形式）</h5><p>Bean模式任务，支持基于方法的开发方式，每个任务对应一个方法。</p>
<ul>
<li><p>优点：</p>
<ul>
<li>每个任务只需要开发一个方法，并添加”<a target="_blank" rel="noopener" href="https://github.com/XxlJob">@XxlJob</a>”注解即可，更加方便、快速。</li>
<li>支持自动扫描任务并注入到执行器容器。</li>
</ul>
</li>
<li><p>缺点：要求Spring容器环境；</p>
<p><em>基于方法开发的任务，底层会生成JobHandler代理，和基于类的方式一样，任务也会以JobHandler的形式存在于执行器任务容器中。</em></p>
</li>
</ul>
<h6 id="①执行器项目中，开发Job方法："><a href="#①执行器项目中，开发Job方法：" class="headerlink" title="①执行器项目中，开发Job方法："></a>①执行器项目中，开发Job方法：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在Spring Bean实例中，开发Job方法，方式格式要求为 <span class="string">&quot;public ReturnT&lt;String&gt; execute(String param)&quot;</span></span><br><span class="line"><span class="number">2</span>、为Job方法添加注解 <span class="string">&quot;@XxlJob(value=&quot;</span>自定义jobhandler名称<span class="string">&quot;, init = &quot;</span>JobHandler初始化方法<span class="string">&quot;, destroy = &quot;</span>JobHandler销毁方法<span class="string">&quot;)&quot;</span>，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="line"><span class="number">3</span>、执行日志：需要通过 <span class="string">&quot;XxlJobLogger.log&quot;</span> 打印执行日志；</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 可参考Sample示例执行器中的 &quot;com.xxl.job.executor.service.jobhandler.SampleXxlJob&quot; ，如下：</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">execute</span><span class="params">(String param)</span> </span>&#123;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;hello world.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==注意：执行日志，需要通过 “XxlJobLogger.log” 打印执行日志；==</p>
<h6 id="②调度中心，新建调度任务-1"><a href="#②调度中心，新建调度任务-1" class="headerlink" title="②调度中心，新建调度任务"></a>②调度中心，新建调度任务</h6><p>对新建的任务进行参数配置，运行模式选中 “BEAN模式”，JobHandler属性填写任务注解“<a target="_blank" rel="noopener" href="https://github.com/XxlJob">@XxlJob</a>”中定义的值</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120345.png" alt="输入图片说明"></p>
<h6 id="③原生内置Bean模式任务"><a href="#③原生内置Bean模式任务" class="headerlink" title="③原生内置Bean模式任务"></a>③原生内置Bean模式任务</h6><p>为方便用户参考与快速实用，示例执行器内原生提供多个Bean模式任务Handler，可以直接配置实用，如下：</p>
<ul>
<li><p>demoJobHandler：简单示例任务，任务内部模拟耗时任务逻辑，用户可在线体验Rolling Log等功能；</p>
</li>
<li><p>shardingJobHandler：分片示例任务，任务内部模拟处理分片参数，可参考熟悉分片任务；</p>
</li>
<li><p>httpJobHandler：通用HTTP任务Handler；业务方只需要提供HTTP链接等信息即可，不限制语言、平台。示例任务入参如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url: http:<span class="comment">//www.xxx.com</span></span><br><span class="line">method: get 或 post</span><br><span class="line">data: post-data</span><br></pre></td></tr></table></figure>
<h5 id="3）GLUE模式-Java"><a href="#3）GLUE模式-Java" class="headerlink" title="3）GLUE模式(Java)"></a>3）GLUE模式(Java)</h5></li>
</ul>
<p>任务以源码方式维护在调度中心，支持通过Web IDE在线更新，实时编译和生效，因此不需要指定JobHandler。开发流程如下：</p>
<h6 id="①调度中心，新建调度任务："><a href="#①调度中心，新建调度任务：" class="headerlink" title="①调度中心，新建调度任务："></a>①调度中心，新建调度任务：</h6><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(Java)”；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120353.png" alt="输入图片说明"></p>
<p>②开发任务代码：</p>
<p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p>
<p>版本回溯功能（支持30个版本的版本回溯）：在GLUE任务的Web IDE界面，选择右上角下拉框“版本回溯”，会列出该GLUE的更新历史，选择相应版本即可显示该版本代码，保存后GLUE代码即回退到对应的历史版本；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120359.png" alt="输入图片说明"></p>
<h5 id="4）GLUE模式-Shell"><a href="#4）GLUE模式-Shell" class="headerlink" title="4）GLUE模式(Shell)"></a>4）GLUE模式(Shell)</h5><p>①调度中心，新建调度任务</p>
<p>新建的任务进行参数配置，运行模式选中 “GLUE模式(Shell)”；</p>
<p>②开发任务代码：</p>
<p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p>
<p>该模式的任务实际上是一段 “shell” 脚本；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120407.png" alt="输入图片说明"></p>
<h4 id="五、操作指南："><a href="#五、操作指南：" class="headerlink" title="五、操作指南："></a>五、操作指南：</h4><h5 id="1-配置执行器"><a href="#1-配置执行器" class="headerlink" title="1)配置执行器"></a>1)配置执行器</h5><p>点击进入”执行器管理”界面, 如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120416.png" alt="输入图片说明"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1、&quot;调度中心OnLine</span>:<span class="string">&quot;右侧显示在线的&quot;调度中心&quot;列表, 任务执行结束后, 将会以failover的模式进行回调调度中心通知执行结果, 避免回调的单点风险;</span></span><br><span class="line"><span class="meta">2、&quot;执行器列表&quot;</span> <span class="string">中显示在线的执行器列表, 可通过&quot;OnLine 机器&quot;查看对应执行器的集群机器。</span></span><br></pre></td></tr></table></figure>
<p>点击按钮 “+新增执行器” 弹框如下图, 可新增执行器配置:</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120419.png" alt="输入图片说明"></p>
<p>执行器属性说明:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AppName</span>: <span class="string">是每个执行器集群的唯一标示AppName, 执行器会周期性以AppName为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用;</span></span><br><span class="line"><span class="meta">名称</span>: <span class="string">执行器的名称, 因为AppName限制字母数字等组成,可读性不强, 名称为了提高执行器的可读性;</span></span><br><span class="line"><span class="meta">排序</span>: <span class="string">执行器的排序, 系统中需要执行器的地方,如任务新增, 将会按照该排序读取可用的执行器列表;</span></span><br><span class="line"><span class="attr">注册方式：调度中心获取执行器地址的方式；</span></span><br><span class="line">    <span class="attr">自动注册：执行器自动进行执行器注册，调度中心通过底层注册表可以动态发现执行器机器地址；</span></span><br><span class="line">    <span class="attr">手动录入：人工手动录入执行器的地址信息，多地址逗号分隔，供调度中心使用；</span></span><br><span class="line"><span class="attr">机器地址：&quot;注册方式&quot;为&quot;手动录入&quot;时有效，支持人工维护执行器的地址信息；</span></span><br></pre></td></tr></table></figure>
<h5 id="2）启动-停止任务"><a href="#2）启动-停止任务" class="headerlink" title="2）启动/停止任务"></a>2）启动/停止任务</h5><p>可对任务进行“启动”和“停止”操作。<br>需要注意的是，此处的启动/停止仅针对任务的后续调度触发行为，不会影响到已经触发的调度任务，如需终止已经触发的调度任务，可查看“终止运行中的任务”</p>
<h5 id="3-手动触发一次调度"><a href="#3-手动触发一次调度" class="headerlink" title="3)手动触发一次调度"></a>3)手动触发一次调度</h5><p>点击“执行”按钮，可手动触发一次任务调度，不影响原有调度规则。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120428.png" alt="输入图片说明"></p>
<h5 id="4-查看调度日志"><a href="#4-查看调度日志" class="headerlink" title="4)查看调度日志"></a>4)查看调度日志</h5><p>点击“日志”按钮，可以查看任务历史调度日志。在历史调入日志界面可查看每次任务调度的调度结果、执行结果等，点击“执行日志”按钮可查看执行器完整日志。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120433.png" alt="输入图片说明"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度时间：&quot;调度中心&quot;触发本次调度并向&quot;执行器&quot;发送任务执行信号的时间；</span></span><br><span class="line"><span class="attr">调度结果：&quot;调度中心&quot;触发本次调度的结果，200表示成功，500或其他表示失败；</span></span><br><span class="line"><span class="attr">调度备注：&quot;调度中心&quot;触发本次调度的日志信息；</span></span><br><span class="line"><span class="attr">执行器地址：本次任务执行的机器地址</span></span><br><span class="line"><span class="meta">运行模式：触发调度时任务的运行模式，运行模式可参考章节</span> <span class="string">”任务详解&quot;；</span></span><br><span class="line"><span class="attr">任务参数：本地任务执行的入参</span></span><br><span class="line"><span class="attr">执行时间：&quot;执行器&quot;中本次任务执行结束后回调的时间；</span></span><br><span class="line"><span class="attr">执行结果：&quot;执行器&quot;中本次任务执行的结果，200表示成功，500或其他表示失败；</span></span><br><span class="line"><span class="attr">执行备注：&quot;执行器&quot;中本次任务执行的日志信息；</span></span><br><span class="line"><span class="attr">操作：</span></span><br><span class="line">    <span class="attr">&quot;执行日志&quot;按钮：点击可查看本地任务执行的详细日志信息；详见“查看执行日志”；</span></span><br><span class="line">    <span class="attr">&quot;终止任务&quot;按钮：点击可终止本地调度对应执行器上本任务的执行线程，包括未执行的阻塞任务一并被终止；</span></span><br></pre></td></tr></table></figure>
<h5 id="5-终止运行中的任务"><a href="#5-终止运行中的任务" class="headerlink" title="5)终止运行中的任务"></a>5)终止运行中的任务</h5><p>仅针对执行中的任务。<br>在任务日志界面，点击右侧的“终止任务”按钮，将会向本次任务对应的执行器发送任务终止请求，将会终止掉本次任务，同时会清空掉整个任务执行队列。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120440.png" alt="输入图片说明"></p>
<p>==任务终止时通过 “interrupt” 执行线程的方式实现, 将会触发 “InterruptedException” 异常。因此如果JobHandler内部catch到了该异常并消化掉的话, 任务终止功能将不可用。==</p>
<p>因此, 如果遇到上述任务终止不可用的情况, 需要在JobHandler中应该针对 “InterruptedException” 异常进行特殊处理 (向上抛出) , 正确逻辑如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.warn(<span class="string">&quot;&#123;&#125;&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==而且，在JobHandler中开启子线程时，子线程也不可catch处理”InterruptedException”，应该主动向上抛出。==</p>
<p>==任务终止时会执行对应JobHandler的”destroy()”方法，可以借助该方法处理一些资源回收的逻辑。==</p>
<h5 id="6-用户管理"><a href="#6-用户管理" class="headerlink" title="6)用户管理"></a>6)用户管理</h5><p>进入 “用户管理” 界面，可查看和管理用户信息；</p>
<p>目前用户分为两种角色：</p>
<ul>
<li>管理员：拥有全量权限，支持在线管理用户信息，为用户分配权限，权限分配粒度为执行器；</li>
<li>普通用户：仅拥有被分配权限的执行器，及相关任务的操作权限；</li>
</ul>
<h4 id="六、总体设计"><a href="#六、总体设计" class="headerlink" title="六、总体设计"></a>六、总体设计</h4><h5 id="1-源码目录"><a href="#1-源码目录" class="headerlink" title="1)源码目录"></a>1)源码目录</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">/doc :文档资料</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/db :“调度数据库”建表脚本</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-admin :调度中心，项目源码</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-core :公共Jar依赖</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-executor-samples :执行器，Sample示例项目（大家可以在该项目上进行开发，也可以将现有项目改造生成执行器项目）</span></span><br></pre></td></tr></table></figure>
<h5 id="2-调度数据库配置"><a href="#2-调度数据库配置" class="headerlink" title="2)调度数据库配置"></a>2)调度数据库配置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">xxl_job_lock：任务调度锁表；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_group：执行器信息表，维护任务执行器信息；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_log_report：调度日志报表：用户存储XXL-JOB任务调度日志的报表，调度中心报表功能页面会用到；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_user：系统用户表；</span></span><br></pre></td></tr></table></figure>
<h5 id="3-架构设计"><a href="#3-架构设计" class="headerlink" title="3)架构设计"></a>3)架构设计</h5><h6 id="①设计思想"><a href="#①设计思想" class="headerlink" title="①设计思想"></a>①设计思想</h6><p>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</p>
<p>将任务抽象成分散的JobHandler，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</p>
<p>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；</p>
<h6 id="②系统组成"><a href="#②系统组成" class="headerlink" title="②系统组成"></a>②系统组成</h6><ul>
<li><strong>调度模块（调度中心）</strong>：<br>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；<br>支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。</li>
<li><strong>执行模块（执行器）</strong>：<br>负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；<br>接收“调度中心”的执行请求、终止请求和日志请求等。</li>
</ul>
<h6 id="③架构图"><a href="#③架构图" class="headerlink" title="③架构图"></a>③架构图</h6><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120447.png" alt="输入图片说明"></p>
<h5 id="4）调度模块剖析"><a href="#4）调度模块剖析" class="headerlink" title="4）调度模块剖析"></a>4）调度模块剖析</h5><h6 id="①自研调度模块"><a href="#①自研调度模块" class="headerlink" title="①自研调度模块"></a>①自研调度模块</h6><p>XXL-JOB中“调度模块”和“任务模块”完全解耦，调度模块进行任务调度时，将会解析不同的任务参数发起远程调用，调用各自的远程执行器服务。这种调用模型类似RPC调用，调度中心提供调用代理的功能，而执行器提供远程服务的功能。</p>
<h6 id="②调度中心HA（集群）"><a href="#②调度中心HA（集群）" class="headerlink" title="②调度中心HA（集群）"></a>②调度中心HA（集群）</h6><p>基于数据库的集群方案，数据库选用Mysql；集群分布式并发环境中进行定时任务调度时，会在各个节点会上报任务，存到数据库中，执行时会从数据库中取出触发器来执行，如果触发器的名称和执行时间相同，则只有一个节点去执行此任务。</p>
<h6 id="③调度线程池"><a href="#③调度线程池" class="headerlink" title="③调度线程池"></a>③调度线程池</h6><p>调度采用线程池方式实现，避免单线程因阻塞而引起任务调度延迟。</p>
<h6 id="④并行调度"><a href="#④并行调度" class="headerlink" title="④并行调度"></a>④并行调度</h6><p>XXL-JOB调度模块默认采用并行机制，在多线程调度的情况下，调度模块被阻塞的几率很低，大大提高了调度系统的承载量。</p>
<p>XXL-JOB的每个调度任务虽然在调度模块是并行调度执行的，但是任务调度传递到任务模块的“执行器”确实串行执行的，同时支持任务终止。</p>
<h6 id="⑤过期处理策略"><a href="#⑤过期处理策略" class="headerlink" title="⑤过期处理策略"></a>⑤过期处理策略</h6><p>任务调度错过触发时间时的处理策略：</p>
<ul>
<li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li>
<li>==处理策略：==<ul>
<li>==过期超5s：本次忽略，当前时间开始计算下次触发时间==</li>
<li>==过期5s内：立即触发一次，当前时间开始计算下次触发时间==</li>
</ul>
</li>
</ul>
<h6 id="⑥日志回调服务"><a href="#⑥日志回调服务" class="headerlink" title="⑥日志回调服务"></a>⑥日志回调服务</h6><p>调度模块的“调度中心”作为Web服务部署时，一方面承担调度中心功能，另一方面也为执行器提供API服务。</p>
<p>调度中心提供的”日志回调服务API服务”代码位置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl-job-admin#com.xxl.job.admin.controller.JobApiController.callback</span></span><br></pre></td></tr></table></figure>
<p>“执行器”在接收到任务执行请求后，执行任务，在执行结束之后会将执行结果回调通知“调度中心”：</p>
<h6 id="⑦任务HA（Failover）"><a href="#⑦任务HA（Failover）" class="headerlink" title="⑦任务HA（Failover）"></a>⑦任务HA（Failover）</h6><p>执行器如若集群部署，调度中心将会感知到在线的所有执行器，如“127.0.0.1:9997, 127.0.0.1:9998, 127.0.0.1:9999”。</p>
<p>当任务”路由策略”选择”故障转移(FAILOVER)”时，当调度中心每次发起调度请求时，会按照顺序对执行器发出心跳检测请求，第一个检测为存活状态的执行器将会被选定并发送调度请求。</p>
<p>调度成功后，可在日志监控界面查看“调度备注”；</p>
<p>“调度备注”可以看出本地调度运行轨迹，执行器的”注册方式”、”地址列表”和任务的”路由策略”。”故障转移(FAILOVER)”路由策略下，调度中心首先对第一个地址进行心跳检测，心跳失败因此自动跳过，第二个依然心跳检测失败……<br>直至心跳检测第三个地址“127.0.0.1:9999”成功，选定为“目标执行器”；然后对“目标执行器”发送调度请求，调度流程结束，等待执行器回调执行结果。；</p>
<h6 id="⑧调度日志"><a href="#⑧调度日志" class="headerlink" title="⑧调度日志"></a>⑧调度日志</h6><p>调度中心每次进行任务调度，都会记录一条任务日志，任务日志主要包括以下三部分内容：</p>
<ul>
<li>任务信息：包括“执行器地址”、“JobHandler”和“执行参数”等属性，点击任务ID按钮可查看，根据这些参数，可以精确的定位任务执行的具体机器和任务代码；</li>
<li>调度信息：包括“调度时间”、“调度结果”和“调度日志”等，根据这些参数，可以了解“调度中心”发起调度请求时具体情况。</li>
<li>执行信息：包括“执行时间”、“执行结果”和“执行日志”等，根据这些参数，可以了解在“执行器”端任务执行的具体情况；</li>
</ul>
<p>调度日志，针对单次调度，属性说明如下：</p>
<ul>
<li>执行器地址：任务执行的机器地址；</li>
<li>JobHandler：Bean模式表示任务执行的JobHandler名称；</li>
<li>任务参数：任务执行的入参；</li>
<li>调度时间：调度中心，发起调度的时间；</li>
<li>调度结果：调度中心，发起调度的结果，SUCCESS或FAIL；</li>
<li>调度备注：调度中心，发起调度的备注信息，如地址心跳检测日志等；</li>
<li>执行时间：执行器，任务执行结束后回调的时间；</li>
<li>执行结果：执行器，任务执行的结果，SUCCESS或FAIL；</li>
<li>执行备注：执行器，任务执行的备注信息，如异常日志等；</li>
<li>执行日志：任务执行过程中，业务代码中打印的完整执行日志，见“查看执行日志”；</li>
</ul>
<h6 id="⑨任务依赖"><a href="#⑨任务依赖" class="headerlink" title="⑨任务依赖"></a>⑨任务依赖</h6><p>原理：XXL-JOB中每个任务都对应有一个任务ID，同时，每个任务支持设置属性“子任务ID”，因此，通过“任务ID”可以匹配任务依赖关系。</p>
<p>当父任务执行结束并且执行成功时，将会根据“子任务ID”匹配子任务依赖，如果匹配到子任务，将会主动触发一次子任务的执行。</p>
<p>在任务日志界面，点击任务的“执行备注”的“查看”按钮，可以看到匹配子任务以及触发子任务执行的日志信息，如无信息则表示未触发子任务执行，可参考下图。</p>
<h6 id="⑩全异步化-amp-轻量级"><a href="#⑩全异步化-amp-轻量级" class="headerlink" title="⑩全异步化 &amp; 轻量级"></a>⑩全异步化 &amp; 轻量级</h6><ul>
<li>全异步化设计：XXL-JOB系统中业务逻辑在远程执行器执行，触发流程全异步化设计。相比直接在调度中心内部执行业务逻辑，极大的降低了调度线程占用时间；<ul>
<li>异步调度：调度中心每次任务触发时仅发送一次调度请求，该调度请求首先推送“异步调度队列”，然后异步推送给远程执行器</li>
<li>异步执行：执行器会将请求存入“异步执行队列”并且立即响应调度中心，异步运行。</li>
</ul>
</li>
<li>轻量级设计：XXL-JOB调度中心中每个JOB逻辑非常 “轻”，在全异步化的基础上，单个JOB一次运行平均耗时基本在 “10ms” 之内（基本为一次请求的网络开销）；因此，可以保证使用有限的线程支撑大量的JOB并发运行；</li>
</ul>
<p>得益于上述两点优化，理论上默认配置下的调度中心，单机能够支撑 5000 任务并发运行稳定运行；</p>
<p>实际场景中，由于调度中心与执行器网络ping延迟不同、DB读写耗时不同、任务调度密集程度不同，会导致任务量上限会上下波动。</p>
<p>如若需要支撑更多的任务量，可以通过 “调大调度线程数” 、”降低调度中心与执行器ping延迟” 和 “提升机器配置” 几种方式优化。</p>
<h6 id="⑩①均衡调度"><a href="#⑩①均衡调度" class="headerlink" title="⑩①均衡调度"></a>⑩①均衡调度</h6><p>调度中心在集群部署时会自动进行任务平均分配，触发组件每次获取与线程池数量（调度中心支持自定义调度线程池大小）相关数量的任务，避免大量任务集中在单个调度中心集群节点；</p>
<h5 id="5）任务-“运行模式”-剖析"><a href="#5）任务-“运行模式”-剖析" class="headerlink" title="5）任务 “运行模式” 剖析"></a>5）任务 “运行模式” 剖析</h5><h6 id="①“Bean模式”-任务"><a href="#①“Bean模式”-任务" class="headerlink" title="①“Bean模式” 任务"></a>①“Bean模式” 任务</h6><p>原理：每个Bean模式任务都是一个Spring的Bean类实例，它被维护在“执行器”项目的Spring容器中。任务类需要加“<a target="_blank" rel="noopener" href="https://github.com/JobHandler">@JobHandler</a>(value=”名称”)”注解，因为“执行器”会根据该注解识别Spring容器中的任务。任务类需要继承统一接口“IJobHandler”，任务逻辑在execute方法中开发，因为“执行器”在接收到调度中心的调度请求时，将会调用“IJobHandler”的execute方法，执行任务逻辑。</p>
<h6 id="②“GLUE模式-Java-”-任务"><a href="#②“GLUE模式-Java-”-任务" class="headerlink" title="②“GLUE模式(Java)” 任务"></a>②“GLUE模式(Java)” 任务</h6><p>原理：每个 “GLUE模式(Java)” 任务的代码，实际上是“一个继承自“IJobHandler”的实现类的类代码”，“执行器”接收到“调度中心”的调度请求时，会通过Groovy类加载器加载此代码，实例化成Java对象，同时注入此代码中声明的Spring服务（请确保Glue代码中的服务和类引用在“执行器”项目中存在），然后调用该对象的execute方法，执行任务逻辑。</p>
<h6 id="③执行器"><a href="#③执行器" class="headerlink" title="③执行器"></a>③执行器</h6><p>执行器实际上是一个内嵌的Server，默认端口9999（配置项：xxl.job.executor.port）。</p>
<p>在项目启动时，执行器会通过“<a target="_blank" rel="noopener" href="https://github.com/JobHandler">@JobHandler</a>”识别Spring容器中“Bean模式任务”，以注解的value属性为key管理起来。</p>
<p>“执行器”接收到“调度中心”的调度请求时，如果任务类型为“Bean模式”，将会匹配Spring容器中的“Bean模式任务”，然后调用其execute方法，执行任务逻辑。如果任务类型为“GLUE模式”，将会加载GLue代码，实例化Java对象，注入依赖的Spring服务（注意：Glue代码中注入的Spring服务，必须存在与该“执行器”项目的Spring容器中），然后调用execute方法，执行任务逻辑。</p>
<h6 id="④任务日志"><a href="#④任务日志" class="headerlink" title="④任务日志"></a>④任务日志</h6><p>XXL-JOB会为每次调度请求生成一个单独的日志文件，需要通过 “XxlJobLogger.log” 打印执行日志，“调度中心”查看执行日志时将会加载对应的日志文件。</p>
<p>(历史版本通过重写LOG4J的Appender实现，存在依赖限制，该方式在新版本已经被抛弃)</p>
<p>日志文件存放的位置可在“执行器”配置文件进行自定义，默认目录格式为：/data/applogs/xxl-job/jobhandler/“格式化日期”/“数据库调度日志记录的主键ID.log”。</p>
<p>在JobHandler中开启子线程时，子线程将会将会把日志打印在父线程即JobHandler的执行日志中，方便日志追踪。</p>
<h5 id="6）通讯模块剖析"><a href="#6）通讯模块剖析" class="headerlink" title="6）通讯模块剖析"></a>6）通讯模块剖析</h5><h6 id="①一次完整的任务调度通讯流程"><a href="#①一次完整的任务调度通讯流程" class="headerlink" title="①一次完整的任务调度通讯流程"></a>①一次完整的任务调度通讯流程</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- <span class="number">1</span>、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口<span class="number">9999</span>;</span><br><span class="line">- <span class="number">2</span>、“执行器”执行任务逻辑；</span><br><span class="line">- <span class="number">3</span>、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务;</span><br></pre></td></tr></table></figure>
<h6 id="②通讯数据加密"><a href="#②通讯数据加密" class="headerlink" title="②通讯数据加密"></a>②通讯数据加密</h6><p>调度中心向执行器发送的调度请求时使用RequestModel和ResponseModel两个对象封装调度请求参数和响应数据, 在进行通讯之前底层会将上述两个对象对象序列化，并进行数据协议以及时间戳检验,从而达到数据加密的功能;</p>
<h5 id="7）任务注册-任务自动发现"><a href="#7）任务注册-任务自动发现" class="headerlink" title="7）任务注册, 任务自动发现"></a>7）任务注册, 任务自动发现</h5><p>自v1.5版本之后, 任务取消了”任务执行机器”属性, 改为通过任务注册和自动发现的方式, 动态获取远程执行器地址并执行。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AppName</span>: <span class="string">每个执行器机器集群的唯一标示, 任务注册以 &quot;执行器&quot; 为最小粒度进行注册; 每个任务通过其绑定的执行器可感知对应的执行器机器列表;</span></span><br><span class="line"><span class="meta">注册表</span>: <span class="string">见&quot;xxl_job_registry&quot;表, &quot;执行器&quot; 在进行任务注册时将会周期性维护一条注册记录，即机器地址和AppName的绑定关系; &quot;调度中心&quot; 从而可以动态感知每个AppName在线的机器列表;</span></span><br><span class="line"><span class="meta">执行器注册</span>: <span class="string">任务注册Beat周期默认30s; 执行器以一倍Beat进行执行器注册, 调度中心以一倍Beat进行动态任务发现; 注册信息的失效时间为三倍Beat; </span></span><br><span class="line"><span class="attr">执行器注册摘除：执行器销毁时，将会主动上报调度中心并摘除对应的执行器机器信息，提高心跳注册的实时性</span></span><br></pre></td></tr></table></figure>
<h5 id="8）任务执行结果"><a href="#8）任务执行结果" class="headerlink" title="8）任务执行结果"></a>8）任务执行结果</h5><p>自v1.6.2之后，任务执行结果通过 “IJobHandler” 的返回值 “ReturnT” 进行判断；<br>当返回值符合 “ReturnT.code == ReturnT.SUCCESS_CODE” 时表示任务执行成功，否则表示任务执行失败，而且可以通过 “ReturnT.msg” 回调错误信息给调度中心；<br>从而，在任务逻辑中可以方便的控制任务执行结果；</p>
<h5 id="9）分片广播-amp-动态分片"><a href="#9）分片广播-amp-动态分片" class="headerlink" title="9）分片广播 &amp; 动态分片"></a>9）分片广播 &amp; 动态分片</h5><p>执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</p>
<p>“分片广播” 以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</p>
<p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数，获取分片参数进行分片业务处理。</p>
<ul>
<li><p>Java语言任务获取分片参数方式：BEAN、GLUE模式(Java)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可参考Sample示例执行器中的示例任务&quot;ShardingJobHandler&quot;了解试用 </span></span><br><span class="line">ShardingUtil.ShardingVO shardingVO = ShardingUtil.getShardingVo();</span><br></pre></td></tr></table></figure>
<p>脚本语言任务获取分片参数方式：GLUE模式(Shell)、GLUE模式(Python)、GLUE模式(Nodejs)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 脚本任务入参固定为三个，依次为：任务传参、分片序号、分片总数。以Shell模式任务为例，获取分片参数代码如下</span><br><span class="line">echo &quot;分片序号 index = $2&quot;</span><br><span class="line">echo &quot;分片总数 total = $3&quot;</span><br></pre></td></tr></table></figure>
<p>分片参数属性说明：</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index：当前分片序号(从0开始)，执行器集群列表中当前执行器的序号；</span></span><br><span class="line"><span class="attr">total：总分片数，执行器集群的总机器数量；</span></span><br></pre></td></tr></table></figure>
<p>==该特性适用场景如：==</p>
<ul>
<li>==1、分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；==</li>
<li>==2、广播任务场景：广播执行器机器运行shell脚本、广播集群节点进行缓存更新等==</li>
</ul>
<h5 id="10-访问令牌（AccessToken）"><a href="#10-访问令牌（AccessToken）" class="headerlink" title="10)访问令牌（AccessToken）"></a>10)访问令牌（AccessToken）</h5><p>为提升系统安全性，调度中心和执行器进行安全性校验，双方AccessToken匹配才允许通讯；</p>
<p>调度中心和执行器，可通过配置项 “xxl.job.accessToken” 进行AccessToken的设置。</p>
<p>调度中心和执行器，如果需要正常通讯，只有两种设置；</p>
<ul>
<li>设置一：调度中心和执行器，均不设置AccessToken；关闭安全性校验；</li>
<li>设置二：调度中心和执行器，设置了相同的AccessToken；</li>
</ul>
<h5 id="11-故障转移-amp-失败重试"><a href="#11-故障转移-amp-失败重试" class="headerlink" title="11)故障转移 &amp; 失败重试"></a>11)故障转移 &amp; 失败重试</h5><p>一次完整任务流程包括”调度（调度中心） + 执行（执行器）”两个阶段。</p>
<ul>
<li>“故障转移”发生在调度阶段，在执行器集群部署时，如果某一台执行器发生故障，该策略支持自动进行Failover切换到一台正常的执行器机器并且完成调度请求流程。</li>
<li>“失败重试”发生在”调度 + 执行”两个阶段，支持通过自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</li>
</ul>
<h5 id="12-执行器灰度上线"><a href="#12-执行器灰度上线" class="headerlink" title="12)执行器灰度上线"></a>12)执行器灰度上线</h5><p>调度中心与业务解耦，只需部署一次后常年不需要维护。但是，执行器中托管运行着业务作业，作业上线和变更需要重启执行器，尤其是Bean模式任务。<br>执行器重启可能会中断运行中的任务。但是，XXL-JOB得益于自建执行器与自建注册中心，可以通过灰度上线的方式，避免因重启导致的任务中断的问题。</p>
<p>步骤如下：</p>
<ul>
<li>1、执行器改为手动注册，下线一半机器列表（A组），线上运行另一半机器列表（B组）；</li>
<li>2、等待A组机器任务运行结束并编译上线；执行器注册地址替换为A组；</li>
<li>3、等待B组机器任务运行结束并编译上线；执行器注册地址替换为A组+B组；<br>操作结束；</li>
</ul>
<h5 id="13-任务执行结果说明"><a href="#13-任务执行结果说明" class="headerlink" title="13)任务执行结果说明"></a>13)任务执行结果说明</h5><p>系统根据以下标准判断任务执行结果，可参考之。</p>
<table>
<thead>
<tr>
<th align="left">—</th>
<th align="left">Bean/Glue(Java)</th>
<th align="left">Glue(Shell) 等脚本任务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">成功</td>
<td align="left">IJobHandler.SUCCESS</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">失败</td>
<td align="left">IJobHandler.FAIL</td>
<td align="left">-1（非0状态码）</td>
</tr>
</tbody></table>
<h5 id="14-任务超时控制"><a href="#14-任务超时控制" class="headerlink" title="14)任务超时控制"></a>14)任务超时控制</h5><p>支持设置任务超时时间，任务运行超时的情况下，将会主动中断任务；</p>
<p>需要注意的是，任务超时中断时与任务终止机制（可查看“4.9 终止运行中的任务”）类似，也是通过 “interrupt” 中断任务，因此业务代码需要将 “InterruptedException” 外抛，否则功能不可用。</p>
<h5 id="15-跨语言"><a href="#15-跨语言" class="headerlink" title="15) 跨语言"></a>15) 跨语言</h5><p>XXL-JOB是一个跨语言的任务调度平台，主要体现在如下几个方面：</p>
<ul>
<li>1、RESTful API：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。（可参考章节 “调度中心/执行器 RESTful API” ）</li>
<li>2、多任务模式：提供Java、Python、PHP……等十来种任务模式，可参考章节 “5.5 任务 “运行模式” ”；理论上可扩展任意语言任务模式；</li>
<li>2、提供基于HTTP的任务Handler（Bean任务，JobHandler=”httpJobHandler”）；业务方只需要提供HTTP链接等相关信息即可，不限制语言、平台；（可参考章节 “原生内置Bean模式任务” ）</li>
</ul>
<h5 id="16-任务失败告警"><a href="#16-任务失败告警" class="headerlink" title="16) 任务失败告警"></a>16) 任务失败告警</h5><p>默认提供邮件失败告警，可扩展短信、钉钉等方式。如果需要新增一种告警方式，只需要新增一个实现 “com.xxl.job.admin.core.alarm.JobAlarm” 接口的告警实现即可。可以参考默认提供邮箱告警实现 “EmailJobAlarm”。</p>
<h5 id="17-调度中心Docker镜像构建"><a href="#17-调度中心Docker镜像构建" class="headerlink" title="17 调度中心Docker镜像构建"></a>17 调度中心Docker镜像构建</h5><p>可以通过以下命令快速构建调度中心，并启动运行；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean packagedocker build -t xuxueli&#x2F;xxl-job-admin .&#x2F;xxl-job-admindocker run --name xxl-job-admin -p 8080:8080 -d xuxueli&#x2F;xxl-job-admin</span><br></pre></td></tr></table></figure>
<h5 id="18-避免任务重复执行"><a href="#18-避免任务重复执行" class="headerlink" title="18)避免任务重复执行"></a>18)避免任务重复执行</h5><p>调度密集或者耗时任务可能会导致任务阻塞，集群情况下调度组件小概率情况下会重复触发；<br>针对上述情况，可以通过结合 “单机路由策略（如：第一台、一致性哈希）” + “阻塞策略（如：单机串行、丢弃后续调度）” 来规避，最终避免任务重复执行。</p>
<h5 id="19-命令行任务"><a href="#19-命令行任务" class="headerlink" title="19) 命令行任务"></a>19) 命令行任务</h5><p>原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；<br>如任务参数 “pwd” 将会执行命令并输出数据；</p>
<h5 id="20-日志自动清理"><a href="#20-日志自动清理" class="headerlink" title="20) 日志自动清理"></a>20) 日志自动清理</h5><p>XXL-JOB日志主要包含如下两部分，均支持日志自动清理，说明如下：</p>
<ul>
<li>调度中心日志表数据：可借助配置项 “xxl.job.logretentiondays” 设置日志表数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li>
<li>执行器日志文件数据：可借助配置项 “xxl.job.executor.logretentiondays” 设置日志文件数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li>
</ul>
<h5 id="21-调度结果丢失处理"><a href="#21-调度结果丢失处理" class="headerlink" title="21) 调度结果丢失处理"></a>21) 调度结果丢失处理</h5><p>执行器因网络抖动回调失败或宕机等异常情况，会导致任务调度结果丢失。由于调度中心依赖执行器回调来感知调度结果，因此会导致调度日志永远处于 “运行中” 状态。</p>
<p>针对该问题，调度中心提供内置组件进行处理，逻辑为：调度记录停留在 “运行中” 状态超过10min，且对应执行器心跳注册失败不在线，则将本地调度主动标记失败；</p>
<h4 id="七、调度中心-执行器-RESTful-API（暂不关注）"><a href="#七、调度中心-执行器-RESTful-API（暂不关注）" class="headerlink" title="七、调度中心/执行器 RESTful API（暂不关注）"></a>七、调度中心/执行器 RESTful API（暂不关注）</h4><p>XXL-JOB 目标是一种跨平台、跨语言的任务调度规范和协议。</p>
<p>针对Java应用，可以直接通过官方提供的调度中心与执行器，方便快速的接入和使用调度中心，可以参考上文 “快速入门” 章节。</p>
<p>针对非Java应用，可借助 XXL-JOB 的标准 RESTful API 方便的实现多语言支持。</p>
<ul>
<li>调度中心 RESTful API：<ul>
<li>说明：调度中心提供给执行器使用的API；不局限于官方执行器使用，第三方可使用该API来实现执行器；</li>
<li>API列表：执行器注册、任务结果回调等；</li>
</ul>
</li>
<li>执行器 RESTful API ：<ul>
<li>说明：执行器提供给调度中心使用的API；官方执行器默认已实现，第三方执行器需要实现并对接提供给调度中心；</li>
<li>API列表：任务触发、任务终止、任务日志查询……等；</li>
</ul>
</li>
</ul>
<p>此处 RESTful API 主要用于非Java语言定制个性化执行器使用，实现跨语言。除此之外，如果有需要通过API操作调度中心，可以个性化扩展 “调度中心 RESTful API” 并使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/" data-id="ckk2gq3uj001sz8pqcmz8gjhu" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Wordpress搭建个人博客/基于aliyun云服务搭建wordpress个人博客" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Wordpress%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/%E5%9F%BA%E4%BA%8Ealiyun%E4%BA%91%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BAwordpress%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.836Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="WordPress搭建个人博客小白教程"><a href="#WordPress搭建个人博客小白教程" class="headerlink" title="WordPress搭建个人博客小白教程"></a>WordPress搭建个人博客小白教程</h3><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/5699898b1ef1">摘自简书-落殇画T1的笔记分享，侵删</a></p>
<h4 id="一、为什么要建私人博客？"><a href="#一、为什么要建私人博客？" class="headerlink" title="一、为什么要建私人博客？"></a>一、为什么要建私人博客？</h4><p>我想这问题应该问你自己，每个人都应该有自己的想法，对于我而言，作为一名计算机专业的学生，我想建博客完全是专业的原因与兴趣的热爱，我在最近的课程中是基于B/S的web开发，因为老师为了让我们熟悉开发流程让我们自己做了个项目，为了更好的演示项目所以购买了阿里云主机，交接成果后服务器就空着吗？之前有一次项目实训老师问我们谁搭建过个人博客，只有了了几个大佬有过类似经验，正好有这个机会何不搭建一个属于自己的网站呢？</p>
<h4 id="二、为什么选WordPress搭建博客？"><a href="#二、为什么选WordPress搭建博客？" class="headerlink" title="二、为什么选WordPress搭建博客？"></a>二、为什么选WordPress搭建博客？</h4><ol>
<li>简单 ：官方号称“五分钟建站”。WordPress 发源于免费开源平台，是世界上使用最广泛的博客系统。WordPress 用户界面也十分友好，很快就能上手使用。</li>
<li>免费：当然这也是最重要的一点。网上有很多功能强大的建站程序，但是是收费的，而且贵的惊人，而WordPress是免费的</li>
<li>扩展性强：主题和插件极其丰富，主题就不用多说，随便在百度搜个WordPress主题会冒出一堆的东西。绝对有你爱上的一个。而插件呢，很多功能都是可以通过插件来实现的，基本上有什么问题一个插件就搞定了。例如我想加一个酷炫的看板娘在网站上，你可能需要手写js代码后慢慢插入到项目中，而WordPress一个插件就够了。</li>
<li>支持中文：虽然WordPress主要开发者是美国人，但是官方对他进行了本土化，支持中文，因此完全不用考虑看不懂的问题。</li>
<li>WordPress社区：WordPress社区非常活跃，如果你有什么问题，只要去搜索，肯定可以找到相关的答案，并且国内也有很多相关的社区和论坛，像阿里也有关于WordPress的社区支持。<br><strong>如果还是对WordPress搭建博客抱有疑问的话推荐去看看这篇文章：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/325d269cfe37">初识WordPress</a></strong></li>
</ol>
<h4 id="三、具体搭建步骤"><a href="#三、具体搭建步骤" class="headerlink" title="三、具体搭建步骤"></a>三、具体搭建步骤</h4><p><strong>文章具体步骤如下：<br>云服务器—–域名—–环境搭建—–部署源码</strong></p>
<h5 id="1、云服务器"><a href="#1、云服务器" class="headerlink" title="1、云服务器"></a>1、云服务器</h5><h6 id="1）购买"><a href="#1）购买" class="headerlink" title="1）购买"></a>1）购买</h6><p>相信你一定在微信或者QQ空间看过腾讯的广告10块钱建站，一分钱购买域名。这就是我们要购买的云服务器。虽然我看过很多腾讯的广告，但我还是推荐阿里的服务器。IDC数据显示阿里云公有云市场份额达到48%，稳居中国市场第一。而且就我体验来看阿里云的各方面服务安全都有很好的保证与帮助。<br>直接去<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=%5Bhttps://www.aliyun.com/product/ecs?spm=5176.8142029.cloudEssentials.1.e9396d3eol8NL0%5D(https://www.aliyun.com/product/ecs?spm=5176.8142029.cloudEssentials.1.e9396d3eol8NL0)">阿里云服务器ECS</a>购买，如果是学生的话可以享受到阿里的<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=%5Bhttps://promotion.aliyun.com/ntms/act/campus2018.html%5D(https://promotion.aliyun.com/ntms/act/campus2018.html)">云翼计划</a>10块钱一个月的主机价格。这对于服务器的价格来说是相当优惠的！</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/15326127-bb79569e0c9e2053.png" alt="img"></p>
<p>云翼计划</p>
<ul>
<li>小白用户推荐轻量应用服务器，应用镜像，宝塔Linux面板，至于为什么不选WordPress呢？因为宝塔可以对项目内部代码进行管理，且进入宝塔也可以一键部署WordPress源码项目的。各项配置也都更好。</li>
<li>稍微有点计算机基础的选择ECS主机，Centos（Linux的一种）操作系统，不要担心自己不懂Linux，因为只要你输入一行命令就可以很好的管理系统了。</li>
<li>位置都选离你所在城市最近的一项。</li>
</ul>
<h6 id="2）第一次连接"><a href="#2）第一次连接" class="headerlink" title="2）第一次连接"></a>2）第一次连接</h6><p>购买好了后呢阿里会给你一个ssh密码，记好这个密码。<br>你可以在阿里控制台的右上角点击云命令行连接自己的主机（就是这个橙色的标志）</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115943.png" alt="img"></p>
<p>控制台命令行</p>
<p>点击后输入：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ssh</span> <span class="selector-tag">root</span><span class="keyword">@47</span>.100.114.250(这里是刚刚分给你的公网IP)</span><br></pre></td></tr></table></figure>
<p>回车后输入刚刚给你的密码就能连上主机了</p>
<h5 id="2、域名"><a href="#2、域名" class="headerlink" title="2、域名"></a>2、域名</h5><p><strong>可选读，因为可以直接通过公网IP访问</strong><br>别的教程都说域名很重要，一定要选，实际上你可以直接拿自己的<strong>公网IP</strong>当做访问地址进入系统。而且购买了域名就得对域名进行备案，这需要特别麻烦的步骤，时间也至少<strong>10-20天</strong>。不过这里我还是说说吧，毕竟有一个好的域名进入比直接用IP酷很多。</p>
<h6 id="1）购买域名"><a href="#1）购买域名" class="headerlink" title="1）购买域名"></a>1）购买域名</h6><p>购买域名很简单，一般的域名也很便宜一般7 8 块钱就可以买一年了，当然也有特别贵的溢价域名就别购买了。<br>直接去<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://wanwang.aliyun.com/">阿里云万网</a>购买就行。直接输入你想要的域名，选个便宜的购买，当然也是你可以接受的，需要注意的是首次购买域名是有优惠的，所以要选择合适的购买时长。购买完后需要域名的实名认证（这也挺麻烦的不，不过最麻烦的还在后面一步域名备案）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115950.png" alt="img"></p>
<p>域名购买</p>
<h6 id="2）域名备案"><a href="#2）域名备案" class="headerlink" title="2）域名备案"></a>2）域名备案</h6><p>（耗时10-20天左右）<br>这是我最想吐槽的地方了，因为中国工信部的原因你购买的域名必须要备案，不然就无法通过域名访问阿里的服务器，不过阿里还是很好了，只要你购买的服务器有<strong>三个月</strong>就可以享受阿里备案一条龙服务，别问我为啥要三个月，因为你在某讯家要运行三个月才能备案。（工信部备案需求是你要三个月运行，阿里默认你买了三个月就给你提前了）<br>在控制台下，右上角的备案进入备案系统。选择你的服务器进行备案申请。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115956.png" alt="img"></p>
<p>备案系统</p>
<p>然后在<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://beian.aliyun.com/">阿里云备案</a>进行域名的备案</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120005.png" alt="img"></p>
<p>域名备案</p>
<p>这里你可以按照流程一步步来，真的很麻烦。其中的资料需要阿里给你寄一个拍照的幕布让你拍照后上传，要有所准备。之后完成后又需要几天的等待，我还好只要了三四天的等到就完成了备案。但总的时间还是花去了10多天。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120121.png" alt="img"></p>
<p>幕布</p>
<h6 id="3）域名解析"><a href="#3）域名解析" class="headerlink" title="3）域名解析"></a>3）域名解析</h6><p>你的域名需要解析到你的服务器才可以将这域名指向你的网站，直接在控制台的域名管理下面解析即可。要填的直接对照下面这张图添加就行，A默认，主机记录就是你前面的www,也可以是@，解析线路默认，记录值就是你的公网IP这里我的博客是<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=http://www.jianqiang.online">www.jianqiang.online</a>,公网IP是47.100.114.250。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120131.png" alt="img"></p>
<p>域名解析</p>
<p><strong>Ok,到现在为止，域名这方面就大功告成了，以后就有了专属域名。如果觉得这太麻烦了也可以直接通过IP访问，但如果购买了域名就必须得走到底，不然就浪费了</strong></p>
<h5 id="3、搭建服务器环境"><a href="#3、搭建服务器环境" class="headerlink" title="3、搭建服务器环境"></a>3、搭建服务器环境</h5><p>现在就需要接着前面连接主机后的操作了。有技术的可以直接操作Linux，这里因为是推荐给小白的教程所以选择搭建宝塔Linux管理系统。</p>
<h6 id="1）宝塔面板是什么"><a href="#1）宝塔面板是什么" class="headerlink" title="1）宝塔面板是什么"></a>1）宝塔面板是什么</h6><p>宝塔面板是一款很优秀的Web环境面板，宝塔面板支持Linux和Windows系统，可以一键安装LNMP和LAMP环境(这是啥之后介绍)，是新手站长最好的管理界面。</p>
<h6 id="2）宝塔面板安装命令"><a href="#2）宝塔面板安装命令" class="headerlink" title="2）宝塔面板安装命令"></a>2）宝塔面板安装命令</h6><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y wget &amp;&amp; wget -O install.sh http:<span class="comment">//download.bt.cn/install/install.sh &amp;&amp; sh install.sh</span></span><br></pre></td></tr></table></figure>
<p>Enter后系统会自动安装宝塔，运行期间需要输入y确认安装。等待大概2分钟左右，显示“Complete!”，即安装完毕！此时要记住控制台显示的密码，后面登录需要。</p>
<h5 id="4、控制台开启端口"><a href="#4、控制台开启端口" class="headerlink" title="4、控制台开启端口"></a>4、控制台开启端口</h5><p>阿里云服务器需要开放下端口，因为阿里云为每台ECS服务器默认配置的安全组禁用了宝塔面板需要的端口，宝塔面板依赖的端口号有：<strong>8888|888|80|443|20|21</strong>，所以需要登录到服务器控制台，开启这6个端口。可以去这里 <a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.xinshouzhanzhang.com/wp-content/themes/zhanzhang/inc/go.php?url=https://www.aliyunbaike.com/ecs/368/">阿里云ECS怎么开放端口自定义安全组规则</a>查看怎么开发端口。下面我也简述一下。</p>
<ol>
<li><p>在你的实例列表里点击这里安全组配置去开启端口。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120140.png" alt="img"></p>
<p>安全组配置</p>
</li>
<li><p>配置规则，添加安全组规则</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120148.png" alt="img"></p>
<p>添加安全组规则</p>
<p>3.端口范围填：8888/8888授权对象填：0.0.0.0/0</p>
</li>
</ol>
<h5 id="5、一键安装LNMP或者LAMP环境"><a href="#5、一键安装LNMP或者LAMP环境" class="headerlink" title="5、一键安装LNMP或者LAMP环境"></a>5、一键安装LNMP或者LAMP环境</h5><p>但你端口打开后就可以通过网站url访问宝塔面板了</p>
<p>登录地址为：http://你的服务器IP:8888<br>用户名：admin<br>密码：前面安装完成后你记下的密码</p>
<p>登录宝塔后台后，会弹出一键安装web环境的界面，我们按照自身需求安装适合自己的LNMP环境或者LAMP环境。你熟悉什么开发环境就用什么开发环境，都不熟悉推荐LNMP.</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120158.png" alt="img"></p>
<p>环境安装</p>
<p>这个宝塔安装我也是从网上找的，这里把原博主文章发一下<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://www.xinshouzhanzhang.com/anzhuangbaota.html">https://www.xinshouzhanzhang.com/anzhuangbaota.html</a></p>
<h4 id="6、安装WordPress程序"><a href="#6、安装WordPress程序" class="headerlink" title="6、安装WordPress程序"></a>6、安装WordPress程序</h4><h5 id="1）部署安装源码"><a href="#1）部署安装源码" class="headerlink" title="1）部署安装源码"></a>1）部署安装源码</h5><p>宝塔面板支持一键部署源码，因此我们无需到WordPress网站下安装包。如下图。<br>注：如果软件中没有这选项就去侧边的软件管理里找。<br>这也就是我为什么前面云服务器推荐宝塔的原因，他甚至可以让你部署其他项目</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120206.png" alt="img"></p>
<p>一键部署源码</p>
<ul>
<li>域名：公网IP或者你拥有的域名</li>
<li>备注：不填</li>
<li>根目录：默认</li>
<li>数据库:myblog 密码：自己填的记好</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120212.png" alt="img"></p>
<p>网站部署</p>
<p>部署完成后会出现下图提示，记住这些资料点击站点去访问进入WordPress安装操作。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120219.png" alt="img"></p>
<p>部署完成</p>
<h5 id="2）安装WordPress"><a href="#2）安装WordPress" class="headerlink" title="2）安装WordPress"></a>2）安装WordPress</h5><p>接下来进入到WordPress安装界面，基本上就是傻瓜操作了，只要填上面记下的资料就行。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120244.png" alt="img"></p>
<p>安装WordPress</p>
<p>接下来的站点配置界面就需要填写你自己的信息！</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120253.png" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Wordpress%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/%E5%9F%BA%E4%BA%8Ealiyun%E4%BA%91%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BAwordpress%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" data-id="ckk2gq3to0016z8pq1l3r33vl" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Windows/Windows家庭中文版安装wsl2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Windows/Windows%E5%AE%B6%E5%BA%AD%E4%B8%AD%E6%96%87%E7%89%88%E5%AE%89%E8%A3%85wsl2/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.777Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="Windows10家庭中文版wsl2安装linux"><a href="#Windows10家庭中文版wsl2安装linux" class="headerlink" title="Windows10家庭中文版wsl2安装linux"></a><strong>Windows10家庭中文版wsl2安装linux</strong></h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/144583887">操作参考地址</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/windows/wsl/install-win10">微软官方指导地址</a></p>
<h4 id="1、-安装WSL2功能模块"><a href="#1、-安装WSL2功能模块" class="headerlink" title="1、 安装WSL2功能模块"></a><strong>1、 安装WSL2功能模块</strong></h4><p>下面的所有命令均需在有管理员权限的 PowerShell 中执行</p>
<h5 id="1）首先需要安装-Windows-10-的-WSL-功能："><a href="#1）首先需要安装-Windows-10-的-WSL-功能：" class="headerlink" title="1）首先需要安装 Windows 10 的 WSL 功能："></a>1）首先需要安装 Windows 10 的 WSL 功能：</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe /online /<span class="built_in">enable-feature</span> /featurename:Microsoft<span class="literal">-Windows</span><span class="literal">-Subsystem</span><span class="literal">-Linux</span> /all /norestart</span><br></pre></td></tr></table></figure>
<h5 id="2）安装-WSL2-功能模块："><a href="#2）安装-WSL2-功能模块：" class="headerlink" title="2）安装 WSL2 功能模块："></a>2）安装 WSL2 功能模块：</h5><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dism.exe /online /<span class="built_in">enable-feature</span> /featurename:VirtualMachinePlatform /all /norestart</span><br></pre></td></tr></table></figure>
<h4 id="2、安装linux内核"><a href="#2、安装linux内核" class="headerlink" title="2、安装linux内核"></a>2、安装linux内核</h4><h5 id="1）下载并安装linux内核"><a href="#1）下载并安装linux内核" class="headerlink" title="1）下载并安装linux内核"></a>1）下载并安装linux内核</h5><p>按照<a href="https://link.zhihu.com/?target=https://docs.microsoft.com/en-us/windows/wsl/wsl2-kernel">官方文档</a>中的说明下载并安装对应软件包，我使用centos，镜像下载地址<a target="_blank" rel="noopener" href="https://developer.aliyun.com/mirror/%EF%BC%8C%E4%B8%8B%E8%BD%BDIndex">https://developer.aliyun.com/mirror/，下载Index</a> of /centos/7.8.2003/isos/x86_64/CentOS-7-x86_64-Minimal-2003.iso </p>
<h5 id="2）设置WSL默认版本为2"><a href="#2）设置WSL默认版本为2" class="headerlink" title="2）设置WSL默认版本为2"></a>2）设置WSL默认版本为2</h5><p>在 PowerShell 中，将 WSL 默认版本设置为<code>2</code>，这样之后安装的 Linux 发行版才会都安装在 WSL2 中</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl -<span class="literal">-set</span><span class="literal">-default</span><span class="literal">-version</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<h4 id="3、安装Linux发行版"><a href="#3、安装Linux发行版" class="headerlink" title="3、安装Linux发行版"></a>3、安装Linux发行版</h4><h5 id="1）卸载旧版-Linux-发行版，然后从-Microsoft-Store-中重新下载安装-Linux-发行版，-比如-Ubuntu-18-04"><a href="#1）卸载旧版-Linux-发行版，然后从-Microsoft-Store-中重新下载安装-Linux-发行版，-比如-Ubuntu-18-04" class="headerlink" title="1）卸载旧版 Linux 发行版，然后从 Microsoft Store 中重新下载安装 Linux 发行版， 比如 Ubuntu 18.04"></a>1）卸载旧版 Linux 发行版，然后从 Microsoft Store 中<strong>重新下载安装</strong> Linux 发行版， 比如 Ubuntu 18.04</h5><h5 id="2）wsl命令启动-WSL2"><a href="#2）wsl命令启动-WSL2" class="headerlink" title="2）wsl命令启动 WSL2"></a>2）<code>wsl</code>命令启动 WSL2</h5><p>在 PowerShell 中使用如下命令可以检查是否安装成功：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wsl -<span class="literal">-list</span> -<span class="literal">-verbose</span></span><br></pre></td></tr></table></figure>
<h4 id="4、安装Docker-Desktop"><a href="#4、安装Docker-Desktop" class="headerlink" title="4、安装Docker Desktop"></a>4、安装Docker Desktop</h4><p>如果你之前一直在用 Docker Desktop 并设置了开机启动的话，会发现在安装 WSL2 并重启电脑后，Docker Desktop 会 自动弹出一个提示框，告诉你监测到系统中已安装了 WSL2，询问是否开启 WSL2 后端引擎。此时可以点 <code>Enable</code> 直接启用。</p>
<p>如果没有在上面的情况下启用，也可以打开 Docker Desktop 的设置界面，并在左侧导航栏中进入<code>Resources</code>&gt;<code>WSL INTEGRATION</code> 面板，然后开启界面中的开关，如下图所示：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115910.jpg" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Windows/Windows%E5%AE%B6%E5%BA%AD%E4%B8%AD%E6%96%87%E7%89%88%E5%AE%89%E8%A3%85wsl2/" data-id="ckk2gq3tf000mz8pq2ce7byyb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>