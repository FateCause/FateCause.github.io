<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、xxl-job是什么？​    XXL-JOB是一个开源的分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展，可以达到开箱即用的程度。 官方学习指导文档地址 二、XXL-JOB源码下载XXL-JOB下载地址 123456789101112maven中央仓库地址&lt;!-- http:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;com&#x2F;xuxueli&#x2F;xxl-job-">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、xxl-job是什么？​    XXL-JOB是一个开源的分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展，可以达到开箱即用的程度。 官方学习指导文档地址 二、XXL-JOB源码下载XXL-JOB下载地址 123456789101112maven中央仓库地址&lt;!-- http:&#x2F;&#x2F;repo1.maven.org&#x2F;maven2&#x2F;com&#x2F;xuxueli&#x2F;xxl-job-">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120321.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120330.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120334.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120339.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120345.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120353.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120359.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120407.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120416.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120419.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120428.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120433.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120440.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120447.png">
<meta property="article:published_time" content="2021-01-18T11:01:37.872Z">
<meta property="article:modified_time" content="2021-01-11T04:05:03.278Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120321.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-XXL-JOB分布式调度/XXL-JOB任务调度笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.872Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、xxl-job是什么？"><a href="#一、xxl-job是什么？" class="headerlink" title="一、xxl-job是什么？"></a>一、xxl-job是什么？</h4><p>​    XXL-JOB是一个开源的分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展，可以达到开箱即用的程度。</p>
<p><a target="_blank" rel="noopener" href="https://www.xuxueli.com/xxl-job/">官方学习指导文档地址</a></p>
<h4 id="二、XXL-JOB源码下载"><a href="#二、XXL-JOB源码下载" class="headerlink" title="二、XXL-JOB源码下载"></a>二、XXL-JOB源码下载</h4><p><a target="_blank" rel="noopener" href="https://github.com/xuxueli/xxl-job">XXL-JOB下载地址</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">maven中央仓库地址</span><br><span class="line"><span class="comment">&lt;!-- http://repo1.maven.org/maven2/com/xuxueli/xxl-job-core/ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.xuxueli<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xxl-job-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;最新稳定版本&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">环境要求：</span><br><span class="line">Maven3+</span><br><span class="line">Jdk1.8+</span><br><span class="line">Mysql5.7+</span><br></pre></td></tr></table></figure>
<h4 id="三、快速入门"><a href="#三、快速入门" class="headerlink" title="三、快速入门"></a>三、快速入门</h4><h5 id="1）创建xxl-job调度需要的数据库表"><a href="#1）创建xxl-job调度需要的数据库表" class="headerlink" title="1）创建xxl-job调度需要的数据库表"></a>1）创建xxl-job调度需要的数据库表</h5><p>​    执行“调度数据库初始化SQL脚本” 需要的表，位置为:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/doc/db/tables_xxl_job.sql</span><br><span class="line"></span><br><span class="line">调度中心支持集群部署，集群情况下各节点务必连接同一个mysql实例;</span><br><span class="line">如果mysql做主从,调度中心集群节点务必强制走主库;</span><br></pre></td></tr></table></figure>
<h5 id="2）编译源码"><a href="#2）编译源码" class="headerlink" title="2）编译源码"></a>2）编译源码</h5><p>解压源码,按照maven格式将源码导入IDE, 使用maven进行编译即可，源码结构如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xxl-job-admin：调度中心</span><br><span class="line">xxl-job-core：公共依赖</span><br><span class="line">xxl-job-executor-samples：执行器Sample示例（选择合适的版本执行器，可直接使用，也可以参考其并将现有项目改造成执行器）</span><br><span class="line">    ：xxl-job-executor-sample-springboot：Springboot版本，通过Springboot管理执行器，推荐这种方式；</span><br><span class="line">    ：xxl-job-executor-sample-spring：Spring版本，通过Spring容器管理执行器，比较通用；</span><br><span class="line">    ：xxl-job-executor-sample-frameless：无框架版本；</span><br><span class="line">    ：xxl-job-executor-sample-jfinal：JFinal版本，通过JFinal管理执行器；</span><br><span class="line">    ：xxl-job-executor-sample-nutz：Nutz版本，通过Nutz管理执行器；</span><br><span class="line">    ：xxl-job-executor-sample-jboot：jboot版本，通过jboot管理执行器；</span><br></pre></td></tr></table></figure>
<h5 id="3-配置部署调度中心"><a href="#3-配置部署调度中心" class="headerlink" title="3)配置部署调度中心"></a>3)配置部署调度中心</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度中心配置文件地址：</span></span><br><span class="line"><span class="attr">/xxl-job/xxl-job-admin/src/main/resources/application.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">调度中心配置内容说明：</span></span><br><span class="line"><span class="comment">### 调度中心JDBC链接：链接地址请保持和 2.1章节 所创建的调度数据库的地址一致</span></span><br><span class="line"><span class="meta">spring.datasource.url</span>=<span class="string">jdbc:mysql://127.0.0.1:3306/xxl_job?useUnicode=true&amp;characterEncoding=UTF-8&amp;autoReconnect=true&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line"><span class="meta">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="meta">spring.datasource.password</span>=<span class="string">root_pwd</span></span><br><span class="line"><span class="meta">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="comment">### 报警邮箱</span></span><br><span class="line"><span class="meta">spring.mail.host</span>=<span class="string">smtp.qq.com</span></span><br><span class="line"><span class="meta">spring.mail.port</span>=<span class="string">25</span></span><br><span class="line"><span class="meta">spring.mail.username</span>=<span class="string">xxx@qq.com</span></span><br><span class="line"><span class="meta">spring.mail.password</span>=<span class="string">xxx</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.auth</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.enable</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.starttls.required</span>=<span class="string">true</span></span><br><span class="line"><span class="meta">spring.mail.properties.mail.smtp.socketFactory.class</span>=<span class="string">javax.net.ssl.SSLSocketFactory</span></span><br><span class="line"><span class="comment">### 调度中心通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 调度中心国际化配置 [必填]： 默认为 &quot;zh_CN&quot;/中文简体, 可选范围为 &quot;zh_CN&quot;/中文简体, &quot;zh_TC&quot;/中文繁体 and &quot;en&quot;/英文；</span></span><br><span class="line"><span class="meta">xxl.job.i18n</span>=<span class="string">zh_CN</span></span><br><span class="line"><span class="comment">## 调度线程池最大线程配置【必填】</span></span><br><span class="line"><span class="meta">xxl.job.triggerpool.fast.max</span>=<span class="string">200</span></span><br><span class="line"><span class="meta">xxl.job.triggerpool.slow.max</span>=<span class="string">100</span></span><br><span class="line"><span class="comment">### 调度中心日志表数据保存天数 [必填]：过期日志自动清理；限制大于等于7时生效，否则, 如-1，关闭自动清理功能；</span></span><br><span class="line"><span class="meta">xxl.job.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<p>如果已经正确进行上述配置，可将项目编译打包部署。</p>
<p>调度中心访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/xxl-job-admin">http://localhost:8080/xxl-job-admin</a> (该地址执行器将会使用到，作为回调地址)</p>
<p>==默认登录账号 “admin/123456”, 登录后即可查看运行界面。==</p>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><p>调度中心支持集群部署，提升调度系统容灾和可用性。</p>
<p>==调度中心集群部署时，几点要求和建议：==</p>
<ul>
<li>==DB配置保持一致；==</li>
<li>==集群机器时钟保持一致（单机集群忽视）；==</li>
<li>==建议：推荐通过nginx为调度中心集群做负载均衡，分配域名。调度中心访问、执行器回调配置、调用API服务等操作均通过该域名进行。==</li>
</ul>
<h5 id="4）配置部署执行器项目"><a href="#4）配置部署执行器项目" class="headerlink" title="4）配置部署执行器项目"></a>4）配置部署执行器项目</h5><h6 id="①确认pom文件中引入了-“xxl-job-core”-的maven依赖；"><a href="#①确认pom文件中引入了-“xxl-job-core”-的maven依赖；" class="headerlink" title="①确认pom文件中引入了 “xxl-job-core” 的maven依赖；"></a>①确认pom文件中引入了 “xxl-job-core” 的maven依赖；</h6><h6 id="②执行器配置"><a href="#②执行器配置" class="headerlink" title="②执行器配置"></a>②执行器配置</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">执行器配置，配置文件地址：</span></span><br><span class="line"><span class="attr">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/resources/application.properties</span></span><br><span class="line"></span><br><span class="line"><span class="attr">执行器配置，配置内容说明：</span></span><br><span class="line"><span class="comment">### 调度中心部署跟地址 [选填]：如调度中心集群部署存在多个地址则用逗号分隔。执行器将会使用该地址进行&quot;执行器心跳注册&quot;和&quot;任务结果回调&quot;；为空则关闭自动注册；</span></span><br><span class="line"><span class="meta">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"><span class="comment">### 执行器通讯TOKEN [选填]：非空时启用；</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器AppName [选填]：执行器心跳注册分组依据；为空则关闭自动注册</span></span><br><span class="line"><span class="meta">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### 执行器注册 [选填]：优先使用该配置作为注册地址，为空时使用内嵌服务 ”IP:PORT“ 作为注册地址。从而更灵活的支持容器类型执行器动态IP和动态映射端口问题。</span></span><br><span class="line"><span class="meta">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器IP [选填]：默认为空表示自动获取IP，多网卡时可手动设置指定IP，该IP不会绑定Host仅作为通讯实用；地址信息用于 &quot;执行器注册&quot; 和 &quot;调度中心请求并触发任务&quot;；</span></span><br><span class="line"><span class="meta">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### 执行器端口号 [选填]：小于等于0则自动获取；默认端口为9999，单机部署多个执行器时，注意要配置不同执行器端口；</span></span><br><span class="line"><span class="meta">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### 执行器运行日志文件存储磁盘路径 [选填] ：需要对该路径拥有读写权限；为空则使用默认路径；</span></span><br><span class="line"><span class="meta">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### 执行器日志文件保存天数 [选填] ： 过期日志自动清理, 限制值大于等于3时生效; 否则, 如-1, 关闭自动清理功能；</span></span><br><span class="line"><span class="meta">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<h6 id="③执行器组件配置"><a href="#③执行器组件配置" class="headerlink" title="③执行器组件配置"></a>③执行器组件配置</h6><p>执行器组件，配置文件地址：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot/src/main/java/com/xxl/job/executor/core/config/XxlJobConfig.java</span><br></pre></td></tr></table></figure>
<p>执行器组件，配置内容说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">    XxlJobSpringExecutor xxlJobSpringExecutor = <span class="keyword">new</span> XxlJobSpringExecutor();</span><br><span class="line">    xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">    xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">    xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">    xxlJobSpringExecutor.setPort(port);</span><br><span class="line">    xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">    xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">    xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line">    <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="④部署执行器项目："><a href="#④部署执行器项目：" class="headerlink" title="④部署执行器项目："></a>④部署执行器项目：</h6><p>如果已经正确进行上述配置，可将执行器项目编译打部署</p>
<h6 id="⑤执行器集群（可选）："><a href="#⑤执行器集群（可选）：" class="headerlink" title="⑤执行器集群（可选）："></a>⑤执行器集群（可选）：</h6><p>执行器支持集群部署，提升调度系统可用性，同时提升任务处理能力。</p>
<p>执行器集群部署时，几点要求和建议：</p>
<ul>
<li>执行器回调地址（xxl.job.admin.addresses）需要保持一致；执行器根据该配置进行执行器自动注册等操作。</li>
<li>同一个执行器集群内AppName（xxl.job.executor.appname）需要保持一致；调度中心根据该配置动态发现不同集群的在线执行器列表。</li>
</ul>
<h5 id="5）开发第一个Hello-World"><a href="#5）开发第一个Hello-World" class="headerlink" title="5）开发第一个Hello World"></a>5）开发第一个Hello World</h5><p>示例以新建一个 “GLUE模式(Java)” 运行模式的任务为例</p>
<h6 id="①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"><a href="#①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务" class="headerlink" title="①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务"></a>①登录调度中心，点击下图所示“新建任务”按钮，新建示例任务</h6><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120321.png" alt="输入图片说明"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120330.png" alt="image-20201026134526501"></p>
<h6 id="②GLUE模式-Java-”-任务开发："><a href="#②GLUE模式-Java-”-任务开发：" class="headerlink" title="②GLUE模式(Java)” 任务开发："></a>②GLUE模式(Java)” 任务开发：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xxl.job.service.handler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.log.XxlJobLogger;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.biz.model.ReturnT;</span><br><span class="line"><span class="keyword">import</span> com.xxl.job.core.handler.IJobHandler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoGlueJobHandler</span> <span class="keyword">extends</span> <span class="title">IJobHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">execute</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="③触发执行："><a href="#③触发执行：" class="headerlink" title="③触发执行："></a>③触发执行：</h6><p>点击任务右侧 “执行” 按钮，可手动触发一次任务执行（通常情况下，通过配置Cron表达式进行任务调度触发）</p>
<h6 id="④查看日志："><a href="#④查看日志：" class="headerlink" title="④查看日志："></a>④查看日志：</h6><p>点击任务右侧 “日志” 按钮，可前往任务日志界面查看任务日志。<br>在任务日志界面中，可查看该任务的历史调度记录以及每一次调度的任务调度信息、执行参数和执行信息。运行中的任务点击右侧的“执行日志”按钮，可进入日志控制台查看实时执行日志。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120334.png" alt="image-20201026134959200"></p>
<p>在日志控制台，可以Rolling方式实时查看任务在执行器一侧运行输出的日志信息，实时监控任务进度；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120339.png" alt="image-20201026135028147"></p>
<h4 id="四、任务详解"><a href="#四、任务详解" class="headerlink" title="四、任务详解"></a>四、任务详解</h4><p>配置属性详细说明：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">执行器：任务的绑定的执行器，任务触发调度时将会自动发现注册成功的执行器, 实现任务自动发现功能; 另一方面也可以方便的进行任务分组。每个任务必须绑定一个执行器, 可在 &quot;执行器管理&quot; 进行设置;</span></span><br><span class="line"><span class="meta">-</span> <span class="string">任务描述：任务的描述信息，便于任务管理；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">路由策略：当执行器集群部署时，提供丰富的路由策略，包括；</span></span><br><span class="line">    <span class="attr">FIRST（第一个）：固定选择第一个机器；</span></span><br><span class="line">    <span class="attr">LAST（最后一个）：固定选择最后一个机器；</span></span><br><span class="line">    <span class="attr">ROUND（轮询）：；</span></span><br><span class="line">    <span class="attr">RANDOM（随机）：随机选择在线的机器；</span></span><br><span class="line">    <span class="attr">CONSISTENT_HASH（一致性HASH）：每个任务按照Hash算法固定选择某一台机器，且所有任务均匀散列在不同机器上。</span></span><br><span class="line">    <span class="attr">LEAST_FREQUENTLY_USED（最不经常使用）：使用频率最低的机器优先被选举；</span></span><br><span class="line">    <span class="attr">LEAST_RECENTLY_USED（最近最久未使用）：最久未使用的机器优先被选举；</span></span><br><span class="line">    <span class="attr">FAILOVER（故障转移）：按照顺序依次进行心跳检测，第一个心跳检测成功的机器选定为目标执行器并发起调度；</span></span><br><span class="line">    <span class="attr">BUSYOVER（忙碌转移）：按照顺序依次进行空闲检测，第一个空闲检测成功的机器选定为目标执行器并发起调度；</span></span><br><span class="line">    <span class="attr">SHARDING_BROADCAST(分片广播)：广播触发对应集群中所有机器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">Cron：触发任务执行的Cron表达式；</span></span><br><span class="line">	<span class="attr">与spring的定时任务表达式区别，最后多一个，表示年</span></span><br><span class="line">	<span class="meta">如：0</span> <span class="string">0 * * * ？ * 表示每小时0分0秒触发一次</span></span><br><span class="line"><span class="meta">-</span> <span class="string">运行模式：</span></span><br><span class="line">    <span class="meta">BEAN模式：任务以JobHandler方式维护在执行器端；需要结合</span> <span class="string">&quot;JobHandler&quot; 属性匹配执行器中任务；</span></span><br><span class="line">    <span class="meta">GLUE模式(Java)：任务以源码方式维护在调度中心；该模式的任务实际上是一段继承自IJobHandler的Java类代码并</span> <span class="string">&quot;groovy&quot; 源码方式维护，它在执行器项目中运行，可使用@Resource/@Autowire注入执行器里中的其他服务；</span></span><br><span class="line">    <span class="meta">GLUE模式(Shell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;shell&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(Python)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;python&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(PHP)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;php&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(NodeJS)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;nodejs&quot; 脚本；</span></span><br><span class="line">    <span class="meta">GLUE模式(PowerShell)：任务以源码方式维护在调度中心；该模式的任务实际上是一段</span> <span class="string">&quot;PowerShell&quot; 脚本；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">JobHandler：运行模式为 &quot;BEAN模式&quot; 时生效，对应执行器中新开发的JobHandler类“@JobHandler”注解自定义的value值；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">阻塞处理策略：调度过于密集执行器来不及处理时的处理策略；</span></span><br><span class="line">    <span class="attr">单机串行（默认）：调度请求进入单机执行器后，调度请求进入FIFO队列并以串行方式运行；</span></span><br><span class="line">    <span class="attr">丢弃后续调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，本次请求将会被丢弃并标记为失败；</span></span><br><span class="line">    <span class="attr">覆盖之前调度：调度请求进入单机执行器后，发现执行器存在运行的调度任务，将会终止运行中的调度任务并清空队列，然后运行本地调度任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">子任务：每个任务都拥有一个唯一的任务ID(任务ID可以从任务列表获取)，当本任务执行结束并且执行成功时，将会触发子任务ID所对应的任务的一次主动调度。</span></span><br><span class="line"><span class="meta">-</span> <span class="string">任务超时时间：支持自定义任务超时时间，任务运行超时将会主动中断任务；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">失败重试次数；支持自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">报警邮件：任务调度失败时邮件通知的邮箱地址，支持配置多邮箱地址，配置多个邮箱地址时用逗号分隔；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">负责人：任务的负责人；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">执行参数：任务执行所需的参数；</span></span><br></pre></td></tr></table></figure>
<h5 id="1）BEAN模式（类形式）"><a href="#1）BEAN模式（类形式）" class="headerlink" title="1）BEAN模式（类形式）"></a>1）BEAN模式（类形式）</h5><p>Bean模式任务，支持基于类的开发方式，每个任务对应一个Java类。</p>
<ul>
<li>优点：不限制项目环境，兼容性好。即使是无框架项目，如main方法直接启动的项目也可以提供支持，可以参考示例项目 “xxl-job-executor-sample-frameless”；</li>
<li>缺点：<ul>
<li>每个任务需要占用一个Java类，造成类的浪费；</li>
<li>不支持自动扫描任务并注入到执行器容器，需要手动注入。</li>
</ul>
</li>
</ul>
<h6 id="①执行器项目中，开发Job类："><a href="#①执行器项目中，开发Job类：" class="headerlink" title="①执行器项目中，开发Job类："></a>①执行器项目中，开发Job类：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、开发一个继承自<span class="string">&quot;com.xxl.job.core.handler.IJobHandler&quot;</span>的JobHandler类，实现其中任务方法。</span><br><span class="line"><span class="number">2</span>、手动通过如下方式注入到执行器容器。</span><br><span class="line">​```</span><br><span class="line">XxlJobExecutor.registJobHandler(<span class="string">&quot;demoJobHandler&quot;</span>, <span class="keyword">new</span> DemoJobHandler());</span><br><span class="line">​```</span><br></pre></td></tr></table></figure>
<h6 id="②调度中心，新建调度任务"><a href="#②调度中心，新建调度任务" class="headerlink" title="②调度中心，新建调度任务"></a>②调度中心，新建调度任务</h6><h5 id="2）BEAN模式（方法形式）"><a href="#2）BEAN模式（方法形式）" class="headerlink" title="2）BEAN模式（方法形式）"></a>2）BEAN模式（方法形式）</h5><p>Bean模式任务，支持基于方法的开发方式，每个任务对应一个方法。</p>
<ul>
<li><p>优点：</p>
<ul>
<li>每个任务只需要开发一个方法，并添加”<a target="_blank" rel="noopener" href="https://github.com/XxlJob">@XxlJob</a>”注解即可，更加方便、快速。</li>
<li>支持自动扫描任务并注入到执行器容器。</li>
</ul>
</li>
<li><p>缺点：要求Spring容器环境；</p>
<p><em>基于方法开发的任务，底层会生成JobHandler代理，和基于类的方式一样，任务也会以JobHandler的形式存在于执行器任务容器中。</em></p>
</li>
</ul>
<h6 id="①执行器项目中，开发Job方法："><a href="#①执行器项目中，开发Job方法：" class="headerlink" title="①执行器项目中，开发Job方法："></a>①执行器项目中，开发Job方法：</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>、在Spring Bean实例中，开发Job方法，方式格式要求为 <span class="string">&quot;public ReturnT&lt;String&gt; execute(String param)&quot;</span></span><br><span class="line"><span class="number">2</span>、为Job方法添加注解 <span class="string">&quot;@XxlJob(value=&quot;</span>自定义jobhandler名称<span class="string">&quot;, init = &quot;</span>JobHandler初始化方法<span class="string">&quot;, destroy = &quot;</span>JobHandler销毁方法<span class="string">&quot;)&quot;</span>，注解value值对应的是调度中心新建任务的JobHandler属性的值。</span><br><span class="line"><span class="number">3</span>、执行日志：需要通过 <span class="string">&quot;XxlJobLogger.log&quot;</span> 打印执行日志；</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 可参考Sample示例执行器中的 &quot;com.xxl.job.executor.service.jobhandler.SampleXxlJob&quot; ，如下：</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">execute</span><span class="params">(String param)</span> </span>&#123;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;hello world.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==注意：执行日志，需要通过 “XxlJobLogger.log” 打印执行日志；==</p>
<h6 id="②调度中心，新建调度任务-1"><a href="#②调度中心，新建调度任务-1" class="headerlink" title="②调度中心，新建调度任务"></a>②调度中心，新建调度任务</h6><p>对新建的任务进行参数配置，运行模式选中 “BEAN模式”，JobHandler属性填写任务注解“<a target="_blank" rel="noopener" href="https://github.com/XxlJob">@XxlJob</a>”中定义的值</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120345.png" alt="输入图片说明"></p>
<h6 id="③原生内置Bean模式任务"><a href="#③原生内置Bean模式任务" class="headerlink" title="③原生内置Bean模式任务"></a>③原生内置Bean模式任务</h6><p>为方便用户参考与快速实用，示例执行器内原生提供多个Bean模式任务Handler，可以直接配置实用，如下：</p>
<ul>
<li><p>demoJobHandler：简单示例任务，任务内部模拟耗时任务逻辑，用户可在线体验Rolling Log等功能；</p>
</li>
<li><p>shardingJobHandler：分片示例任务，任务内部模拟处理分片参数，可参考熟悉分片任务；</p>
</li>
<li><p>httpJobHandler：通用HTTP任务Handler；业务方只需要提供HTTP链接等信息即可，不限制语言、平台。示例任务入参如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url: http:<span class="comment">//www.xxx.com</span></span><br><span class="line">method: get 或 post</span><br><span class="line">data: post-data</span><br></pre></td></tr></table></figure>
<h5 id="3）GLUE模式-Java"><a href="#3）GLUE模式-Java" class="headerlink" title="3）GLUE模式(Java)"></a>3）GLUE模式(Java)</h5></li>
</ul>
<p>任务以源码方式维护在调度中心，支持通过Web IDE在线更新，实时编译和生效，因此不需要指定JobHandler。开发流程如下：</p>
<h6 id="①调度中心，新建调度任务："><a href="#①调度中心，新建调度任务：" class="headerlink" title="①调度中心，新建调度任务："></a>①调度中心，新建调度任务：</h6><p>参考上文“配置属性详细说明”对新建的任务进行参数配置，运行模式选中 “GLUE模式(Java)”；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120353.png" alt="输入图片说明"></p>
<p>②开发任务代码：</p>
<p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p>
<p>版本回溯功能（支持30个版本的版本回溯）：在GLUE任务的Web IDE界面，选择右上角下拉框“版本回溯”，会列出该GLUE的更新历史，选择相应版本即可显示该版本代码，保存后GLUE代码即回退到对应的历史版本；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120359.png" alt="输入图片说明"></p>
<h5 id="4）GLUE模式-Shell"><a href="#4）GLUE模式-Shell" class="headerlink" title="4）GLUE模式(Shell)"></a>4）GLUE模式(Shell)</h5><p>①调度中心，新建调度任务</p>
<p>新建的任务进行参数配置，运行模式选中 “GLUE模式(Shell)”；</p>
<p>②开发任务代码：</p>
<p>选中指定任务，点击该任务右侧“GLUE”按钮，将会前往GLUE任务的Web IDE界面，在该界面支持对任务代码进行开发（也可以在IDE中开发完成后，复制粘贴到编辑中）。</p>
<p>该模式的任务实际上是一段 “shell” 脚本；</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120407.png" alt="输入图片说明"></p>
<h4 id="五、操作指南："><a href="#五、操作指南：" class="headerlink" title="五、操作指南："></a>五、操作指南：</h4><h5 id="1-配置执行器"><a href="#1-配置执行器" class="headerlink" title="1)配置执行器"></a>1)配置执行器</h5><p>点击进入”执行器管理”界面, 如下图:</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120416.png" alt="输入图片说明"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">1、&quot;调度中心OnLine</span>:<span class="string">&quot;右侧显示在线的&quot;调度中心&quot;列表, 任务执行结束后, 将会以failover的模式进行回调调度中心通知执行结果, 避免回调的单点风险;</span></span><br><span class="line"><span class="meta">2、&quot;执行器列表&quot;</span> <span class="string">中显示在线的执行器列表, 可通过&quot;OnLine 机器&quot;查看对应执行器的集群机器。</span></span><br></pre></td></tr></table></figure>
<p>点击按钮 “+新增执行器” 弹框如下图, 可新增执行器配置:</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120419.png" alt="输入图片说明"></p>
<p>执行器属性说明:</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AppName</span>: <span class="string">是每个执行器集群的唯一标示AppName, 执行器会周期性以AppName为对象进行自动注册。可通过该配置自动发现注册成功的执行器, 供任务调度时使用;</span></span><br><span class="line"><span class="meta">名称</span>: <span class="string">执行器的名称, 因为AppName限制字母数字等组成,可读性不强, 名称为了提高执行器的可读性;</span></span><br><span class="line"><span class="meta">排序</span>: <span class="string">执行器的排序, 系统中需要执行器的地方,如任务新增, 将会按照该排序读取可用的执行器列表;</span></span><br><span class="line"><span class="attr">注册方式：调度中心获取执行器地址的方式；</span></span><br><span class="line">    <span class="attr">自动注册：执行器自动进行执行器注册，调度中心通过底层注册表可以动态发现执行器机器地址；</span></span><br><span class="line">    <span class="attr">手动录入：人工手动录入执行器的地址信息，多地址逗号分隔，供调度中心使用；</span></span><br><span class="line"><span class="attr">机器地址：&quot;注册方式&quot;为&quot;手动录入&quot;时有效，支持人工维护执行器的地址信息；</span></span><br></pre></td></tr></table></figure>
<h5 id="2）启动-停止任务"><a href="#2）启动-停止任务" class="headerlink" title="2）启动/停止任务"></a>2）启动/停止任务</h5><p>可对任务进行“启动”和“停止”操作。<br>需要注意的是，此处的启动/停止仅针对任务的后续调度触发行为，不会影响到已经触发的调度任务，如需终止已经触发的调度任务，可查看“终止运行中的任务”</p>
<h5 id="3-手动触发一次调度"><a href="#3-手动触发一次调度" class="headerlink" title="3)手动触发一次调度"></a>3)手动触发一次调度</h5><p>点击“执行”按钮，可手动触发一次任务调度，不影响原有调度规则。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120428.png" alt="输入图片说明"></p>
<h5 id="4-查看调度日志"><a href="#4-查看调度日志" class="headerlink" title="4)查看调度日志"></a>4)查看调度日志</h5><p>点击“日志”按钮，可以查看任务历史调度日志。在历史调入日志界面可查看每次任务调度的调度结果、执行结果等，点击“执行日志”按钮可查看执行器完整日志。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120433.png" alt="输入图片说明"></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">调度时间：&quot;调度中心&quot;触发本次调度并向&quot;执行器&quot;发送任务执行信号的时间；</span></span><br><span class="line"><span class="attr">调度结果：&quot;调度中心&quot;触发本次调度的结果，200表示成功，500或其他表示失败；</span></span><br><span class="line"><span class="attr">调度备注：&quot;调度中心&quot;触发本次调度的日志信息；</span></span><br><span class="line"><span class="attr">执行器地址：本次任务执行的机器地址</span></span><br><span class="line"><span class="meta">运行模式：触发调度时任务的运行模式，运行模式可参考章节</span> <span class="string">”任务详解&quot;；</span></span><br><span class="line"><span class="attr">任务参数：本地任务执行的入参</span></span><br><span class="line"><span class="attr">执行时间：&quot;执行器&quot;中本次任务执行结束后回调的时间；</span></span><br><span class="line"><span class="attr">执行结果：&quot;执行器&quot;中本次任务执行的结果，200表示成功，500或其他表示失败；</span></span><br><span class="line"><span class="attr">执行备注：&quot;执行器&quot;中本次任务执行的日志信息；</span></span><br><span class="line"><span class="attr">操作：</span></span><br><span class="line">    <span class="attr">&quot;执行日志&quot;按钮：点击可查看本地任务执行的详细日志信息；详见“查看执行日志”；</span></span><br><span class="line">    <span class="attr">&quot;终止任务&quot;按钮：点击可终止本地调度对应执行器上本任务的执行线程，包括未执行的阻塞任务一并被终止；</span></span><br></pre></td></tr></table></figure>
<h5 id="5-终止运行中的任务"><a href="#5-终止运行中的任务" class="headerlink" title="5)终止运行中的任务"></a>5)终止运行中的任务</h5><p>仅针对执行中的任务。<br>在任务日志界面，点击右侧的“终止任务”按钮，将会向本次任务对应的执行器发送任务终止请求，将会终止掉本次任务，同时会清空掉整个任务执行队列。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120440.png" alt="输入图片说明"></p>
<p>==任务终止时通过 “interrupt” 执行线程的方式实现, 将会触发 “InterruptedException” 异常。因此如果JobHandler内部catch到了该异常并消化掉的话, 任务终止功能将不可用。==</p>
<p>因此, 如果遇到上述任务终止不可用的情况, 需要在JobHandler中应该针对 “InterruptedException” 异常进行特殊处理 (向上抛出) , 正确逻辑如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">    logger.warn(<span class="string">&quot;&#123;&#125;&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>==而且，在JobHandler中开启子线程时，子线程也不可catch处理”InterruptedException”，应该主动向上抛出。==</p>
<p>==任务终止时会执行对应JobHandler的”destroy()”方法，可以借助该方法处理一些资源回收的逻辑。==</p>
<h5 id="6-用户管理"><a href="#6-用户管理" class="headerlink" title="6)用户管理"></a>6)用户管理</h5><p>进入 “用户管理” 界面，可查看和管理用户信息；</p>
<p>目前用户分为两种角色：</p>
<ul>
<li>管理员：拥有全量权限，支持在线管理用户信息，为用户分配权限，权限分配粒度为执行器；</li>
<li>普通用户：仅拥有被分配权限的执行器，及相关任务的操作权限；</li>
</ul>
<h4 id="六、总体设计"><a href="#六、总体设计" class="headerlink" title="六、总体设计"></a>六、总体设计</h4><h5 id="1-源码目录"><a href="#1-源码目录" class="headerlink" title="1)源码目录"></a>1)源码目录</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">/doc :文档资料</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/db :“调度数据库”建表脚本</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-admin :调度中心，项目源码</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-core :公共Jar依赖</span></span><br><span class="line"><span class="meta">-</span> <span class="string">/xxl-job-executor-samples :执行器，Sample示例项目（大家可以在该项目上进行开发，也可以将现有项目改造生成执行器项目）</span></span><br></pre></td></tr></table></figure>
<h5 id="2-调度数据库配置"><a href="#2-调度数据库配置" class="headerlink" title="2)调度数据库配置"></a>2)调度数据库配置</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">-</span> <span class="string">xxl_job_lock：任务调度锁表；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_group：执行器信息表，维护任务执行器信息；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_info：调度扩展信息表： 用于保存XXL-JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_log：调度日志表： 用于保存XXL-JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_log_report：调度日志报表：用户存储XXL-JOB任务调度日志的报表，调度中心报表功能页面会用到；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</span></span><br><span class="line"><span class="meta">-</span> <span class="string">xxl_job_user：系统用户表；</span></span><br></pre></td></tr></table></figure>
<h5 id="3-架构设计"><a href="#3-架构设计" class="headerlink" title="3)架构设计"></a>3)架构设计</h5><h6 id="①设计思想"><a href="#①设计思想" class="headerlink" title="①设计思想"></a>①设计思想</h6><p>将调度行为抽象形成“调度中心”公共平台，而平台自身并不承担业务逻辑，“调度中心”负责发起调度请求。</p>
<p>将任务抽象成分散的JobHandler，交由“执行器”统一管理，“执行器”负责接收调度请求并执行对应的JobHandler中业务逻辑。</p>
<p>因此，“调度”和“任务”两部分可以相互解耦，提高系统整体稳定性和扩展性；</p>
<h6 id="②系统组成"><a href="#②系统组成" class="headerlink" title="②系统组成"></a>②系统组成</h6><ul>
<li><strong>调度模块（调度中心）</strong>：<br>负责管理调度信息，按照调度配置发出调度请求，自身不承担业务代码。调度系统与任务解耦，提高了系统可用性和稳定性，同时调度系统性能不再受限于任务模块；<br>支持可视化、简单且动态的管理调度信息，包括任务新建，更新，删除，GLUE开发和任务报警等，所有上述操作都会实时生效，同时支持监控调度结果以及执行日志，支持执行器Failover。</li>
<li><strong>执行模块（执行器）</strong>：<br>负责接收调度请求并执行任务逻辑。任务模块专注于任务的执行等操作，开发和维护更加简单和高效；<br>接收“调度中心”的执行请求、终止请求和日志请求等。</li>
</ul>
<h6 id="③架构图"><a href="#③架构图" class="headerlink" title="③架构图"></a>③架构图</h6><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120447.png" alt="输入图片说明"></p>
<h5 id="4）调度模块剖析"><a href="#4）调度模块剖析" class="headerlink" title="4）调度模块剖析"></a>4）调度模块剖析</h5><h6 id="①自研调度模块"><a href="#①自研调度模块" class="headerlink" title="①自研调度模块"></a>①自研调度模块</h6><p>XXL-JOB中“调度模块”和“任务模块”完全解耦，调度模块进行任务调度时，将会解析不同的任务参数发起远程调用，调用各自的远程执行器服务。这种调用模型类似RPC调用，调度中心提供调用代理的功能，而执行器提供远程服务的功能。</p>
<h6 id="②调度中心HA（集群）"><a href="#②调度中心HA（集群）" class="headerlink" title="②调度中心HA（集群）"></a>②调度中心HA（集群）</h6><p>基于数据库的集群方案，数据库选用Mysql；集群分布式并发环境中进行定时任务调度时，会在各个节点会上报任务，存到数据库中，执行时会从数据库中取出触发器来执行，如果触发器的名称和执行时间相同，则只有一个节点去执行此任务。</p>
<h6 id="③调度线程池"><a href="#③调度线程池" class="headerlink" title="③调度线程池"></a>③调度线程池</h6><p>调度采用线程池方式实现，避免单线程因阻塞而引起任务调度延迟。</p>
<h6 id="④并行调度"><a href="#④并行调度" class="headerlink" title="④并行调度"></a>④并行调度</h6><p>XXL-JOB调度模块默认采用并行机制，在多线程调度的情况下，调度模块被阻塞的几率很低，大大提高了调度系统的承载量。</p>
<p>XXL-JOB的每个调度任务虽然在调度模块是并行调度执行的，但是任务调度传递到任务模块的“执行器”确实串行执行的，同时支持任务终止。</p>
<h6 id="⑤过期处理策略"><a href="#⑤过期处理策略" class="headerlink" title="⑤过期处理策略"></a>⑤过期处理策略</h6><p>任务调度错过触发时间时的处理策略：</p>
<ul>
<li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li>
<li>==处理策略：==<ul>
<li>==过期超5s：本次忽略，当前时间开始计算下次触发时间==</li>
<li>==过期5s内：立即触发一次，当前时间开始计算下次触发时间==</li>
</ul>
</li>
</ul>
<h6 id="⑥日志回调服务"><a href="#⑥日志回调服务" class="headerlink" title="⑥日志回调服务"></a>⑥日志回调服务</h6><p>调度模块的“调度中心”作为Web服务部署时，一方面承担调度中心功能，另一方面也为执行器提供API服务。</p>
<p>调度中心提供的”日志回调服务API服务”代码位置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">xxl-job-admin#com.xxl.job.admin.controller.JobApiController.callback</span></span><br></pre></td></tr></table></figure>
<p>“执行器”在接收到任务执行请求后，执行任务，在执行结束之后会将执行结果回调通知“调度中心”：</p>
<h6 id="⑦任务HA（Failover）"><a href="#⑦任务HA（Failover）" class="headerlink" title="⑦任务HA（Failover）"></a>⑦任务HA（Failover）</h6><p>执行器如若集群部署，调度中心将会感知到在线的所有执行器，如“127.0.0.1:9997, 127.0.0.1:9998, 127.0.0.1:9999”。</p>
<p>当任务”路由策略”选择”故障转移(FAILOVER)”时，当调度中心每次发起调度请求时，会按照顺序对执行器发出心跳检测请求，第一个检测为存活状态的执行器将会被选定并发送调度请求。</p>
<p>调度成功后，可在日志监控界面查看“调度备注”；</p>
<p>“调度备注”可以看出本地调度运行轨迹，执行器的”注册方式”、”地址列表”和任务的”路由策略”。”故障转移(FAILOVER)”路由策略下，调度中心首先对第一个地址进行心跳检测，心跳失败因此自动跳过，第二个依然心跳检测失败……<br>直至心跳检测第三个地址“127.0.0.1:9999”成功，选定为“目标执行器”；然后对“目标执行器”发送调度请求，调度流程结束，等待执行器回调执行结果。；</p>
<h6 id="⑧调度日志"><a href="#⑧调度日志" class="headerlink" title="⑧调度日志"></a>⑧调度日志</h6><p>调度中心每次进行任务调度，都会记录一条任务日志，任务日志主要包括以下三部分内容：</p>
<ul>
<li>任务信息：包括“执行器地址”、“JobHandler”和“执行参数”等属性，点击任务ID按钮可查看，根据这些参数，可以精确的定位任务执行的具体机器和任务代码；</li>
<li>调度信息：包括“调度时间”、“调度结果”和“调度日志”等，根据这些参数，可以了解“调度中心”发起调度请求时具体情况。</li>
<li>执行信息：包括“执行时间”、“执行结果”和“执行日志”等，根据这些参数，可以了解在“执行器”端任务执行的具体情况；</li>
</ul>
<p>调度日志，针对单次调度，属性说明如下：</p>
<ul>
<li>执行器地址：任务执行的机器地址；</li>
<li>JobHandler：Bean模式表示任务执行的JobHandler名称；</li>
<li>任务参数：任务执行的入参；</li>
<li>调度时间：调度中心，发起调度的时间；</li>
<li>调度结果：调度中心，发起调度的结果，SUCCESS或FAIL；</li>
<li>调度备注：调度中心，发起调度的备注信息，如地址心跳检测日志等；</li>
<li>执行时间：执行器，任务执行结束后回调的时间；</li>
<li>执行结果：执行器，任务执行的结果，SUCCESS或FAIL；</li>
<li>执行备注：执行器，任务执行的备注信息，如异常日志等；</li>
<li>执行日志：任务执行过程中，业务代码中打印的完整执行日志，见“查看执行日志”；</li>
</ul>
<h6 id="⑨任务依赖"><a href="#⑨任务依赖" class="headerlink" title="⑨任务依赖"></a>⑨任务依赖</h6><p>原理：XXL-JOB中每个任务都对应有一个任务ID，同时，每个任务支持设置属性“子任务ID”，因此，通过“任务ID”可以匹配任务依赖关系。</p>
<p>当父任务执行结束并且执行成功时，将会根据“子任务ID”匹配子任务依赖，如果匹配到子任务，将会主动触发一次子任务的执行。</p>
<p>在任务日志界面，点击任务的“执行备注”的“查看”按钮，可以看到匹配子任务以及触发子任务执行的日志信息，如无信息则表示未触发子任务执行，可参考下图。</p>
<h6 id="⑩全异步化-amp-轻量级"><a href="#⑩全异步化-amp-轻量级" class="headerlink" title="⑩全异步化 &amp; 轻量级"></a>⑩全异步化 &amp; 轻量级</h6><ul>
<li>全异步化设计：XXL-JOB系统中业务逻辑在远程执行器执行，触发流程全异步化设计。相比直接在调度中心内部执行业务逻辑，极大的降低了调度线程占用时间；<ul>
<li>异步调度：调度中心每次任务触发时仅发送一次调度请求，该调度请求首先推送“异步调度队列”，然后异步推送给远程执行器</li>
<li>异步执行：执行器会将请求存入“异步执行队列”并且立即响应调度中心，异步运行。</li>
</ul>
</li>
<li>轻量级设计：XXL-JOB调度中心中每个JOB逻辑非常 “轻”，在全异步化的基础上，单个JOB一次运行平均耗时基本在 “10ms” 之内（基本为一次请求的网络开销）；因此，可以保证使用有限的线程支撑大量的JOB并发运行；</li>
</ul>
<p>得益于上述两点优化，理论上默认配置下的调度中心，单机能够支撑 5000 任务并发运行稳定运行；</p>
<p>实际场景中，由于调度中心与执行器网络ping延迟不同、DB读写耗时不同、任务调度密集程度不同，会导致任务量上限会上下波动。</p>
<p>如若需要支撑更多的任务量，可以通过 “调大调度线程数” 、”降低调度中心与执行器ping延迟” 和 “提升机器配置” 几种方式优化。</p>
<h6 id="⑩①均衡调度"><a href="#⑩①均衡调度" class="headerlink" title="⑩①均衡调度"></a>⑩①均衡调度</h6><p>调度中心在集群部署时会自动进行任务平均分配，触发组件每次获取与线程池数量（调度中心支持自定义调度线程池大小）相关数量的任务，避免大量任务集中在单个调度中心集群节点；</p>
<h5 id="5）任务-“运行模式”-剖析"><a href="#5）任务-“运行模式”-剖析" class="headerlink" title="5）任务 “运行模式” 剖析"></a>5）任务 “运行模式” 剖析</h5><h6 id="①“Bean模式”-任务"><a href="#①“Bean模式”-任务" class="headerlink" title="①“Bean模式” 任务"></a>①“Bean模式” 任务</h6><p>原理：每个Bean模式任务都是一个Spring的Bean类实例，它被维护在“执行器”项目的Spring容器中。任务类需要加“<a target="_blank" rel="noopener" href="https://github.com/JobHandler">@JobHandler</a>(value=”名称”)”注解，因为“执行器”会根据该注解识别Spring容器中的任务。任务类需要继承统一接口“IJobHandler”，任务逻辑在execute方法中开发，因为“执行器”在接收到调度中心的调度请求时，将会调用“IJobHandler”的execute方法，执行任务逻辑。</p>
<h6 id="②“GLUE模式-Java-”-任务"><a href="#②“GLUE模式-Java-”-任务" class="headerlink" title="②“GLUE模式(Java)” 任务"></a>②“GLUE模式(Java)” 任务</h6><p>原理：每个 “GLUE模式(Java)” 任务的代码，实际上是“一个继承自“IJobHandler”的实现类的类代码”，“执行器”接收到“调度中心”的调度请求时，会通过Groovy类加载器加载此代码，实例化成Java对象，同时注入此代码中声明的Spring服务（请确保Glue代码中的服务和类引用在“执行器”项目中存在），然后调用该对象的execute方法，执行任务逻辑。</p>
<h6 id="③执行器"><a href="#③执行器" class="headerlink" title="③执行器"></a>③执行器</h6><p>执行器实际上是一个内嵌的Server，默认端口9999（配置项：xxl.job.executor.port）。</p>
<p>在项目启动时，执行器会通过“<a target="_blank" rel="noopener" href="https://github.com/JobHandler">@JobHandler</a>”识别Spring容器中“Bean模式任务”，以注解的value属性为key管理起来。</p>
<p>“执行器”接收到“调度中心”的调度请求时，如果任务类型为“Bean模式”，将会匹配Spring容器中的“Bean模式任务”，然后调用其execute方法，执行任务逻辑。如果任务类型为“GLUE模式”，将会加载GLue代码，实例化Java对象，注入依赖的Spring服务（注意：Glue代码中注入的Spring服务，必须存在与该“执行器”项目的Spring容器中），然后调用execute方法，执行任务逻辑。</p>
<h6 id="④任务日志"><a href="#④任务日志" class="headerlink" title="④任务日志"></a>④任务日志</h6><p>XXL-JOB会为每次调度请求生成一个单独的日志文件，需要通过 “XxlJobLogger.log” 打印执行日志，“调度中心”查看执行日志时将会加载对应的日志文件。</p>
<p>(历史版本通过重写LOG4J的Appender实现，存在依赖限制，该方式在新版本已经被抛弃)</p>
<p>日志文件存放的位置可在“执行器”配置文件进行自定义，默认目录格式为：/data/applogs/xxl-job/jobhandler/“格式化日期”/“数据库调度日志记录的主键ID.log”。</p>
<p>在JobHandler中开启子线程时，子线程将会将会把日志打印在父线程即JobHandler的执行日志中，方便日志追踪。</p>
<h5 id="6）通讯模块剖析"><a href="#6）通讯模块剖析" class="headerlink" title="6）通讯模块剖析"></a>6）通讯模块剖析</h5><h6 id="①一次完整的任务调度通讯流程"><a href="#①一次完整的任务调度通讯流程" class="headerlink" title="①一次完整的任务调度通讯流程"></a>①一次完整的任务调度通讯流程</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- <span class="number">1</span>、“调度中心”向“执行器”发送http调度请求: “执行器”中接收请求的服务，实际上是一台内嵌Server，默认端口<span class="number">9999</span>;</span><br><span class="line">- <span class="number">2</span>、“执行器”执行任务逻辑；</span><br><span class="line">- <span class="number">3</span>、“执行器”http回调“调度中心”调度结果: “调度中心”中接收回调的服务，是针对执行器开放一套API服务;</span><br></pre></td></tr></table></figure>
<h6 id="②通讯数据加密"><a href="#②通讯数据加密" class="headerlink" title="②通讯数据加密"></a>②通讯数据加密</h6><p>调度中心向执行器发送的调度请求时使用RequestModel和ResponseModel两个对象封装调度请求参数和响应数据, 在进行通讯之前底层会将上述两个对象对象序列化，并进行数据协议以及时间戳检验,从而达到数据加密的功能;</p>
<h5 id="7）任务注册-任务自动发现"><a href="#7）任务注册-任务自动发现" class="headerlink" title="7）任务注册, 任务自动发现"></a>7）任务注册, 任务自动发现</h5><p>自v1.5版本之后, 任务取消了”任务执行机器”属性, 改为通过任务注册和自动发现的方式, 动态获取远程执行器地址并执行。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">AppName</span>: <span class="string">每个执行器机器集群的唯一标示, 任务注册以 &quot;执行器&quot; 为最小粒度进行注册; 每个任务通过其绑定的执行器可感知对应的执行器机器列表;</span></span><br><span class="line"><span class="meta">注册表</span>: <span class="string">见&quot;xxl_job_registry&quot;表, &quot;执行器&quot; 在进行任务注册时将会周期性维护一条注册记录，即机器地址和AppName的绑定关系; &quot;调度中心&quot; 从而可以动态感知每个AppName在线的机器列表;</span></span><br><span class="line"><span class="meta">执行器注册</span>: <span class="string">任务注册Beat周期默认30s; 执行器以一倍Beat进行执行器注册, 调度中心以一倍Beat进行动态任务发现; 注册信息的失效时间为三倍Beat; </span></span><br><span class="line"><span class="attr">执行器注册摘除：执行器销毁时，将会主动上报调度中心并摘除对应的执行器机器信息，提高心跳注册的实时性</span></span><br></pre></td></tr></table></figure>
<h5 id="8）任务执行结果"><a href="#8）任务执行结果" class="headerlink" title="8）任务执行结果"></a>8）任务执行结果</h5><p>自v1.6.2之后，任务执行结果通过 “IJobHandler” 的返回值 “ReturnT” 进行判断；<br>当返回值符合 “ReturnT.code == ReturnT.SUCCESS_CODE” 时表示任务执行成功，否则表示任务执行失败，而且可以通过 “ReturnT.msg” 回调错误信息给调度中心；<br>从而，在任务逻辑中可以方便的控制任务执行结果；</p>
<h5 id="9）分片广播-amp-动态分片"><a href="#9）分片广播-amp-动态分片" class="headerlink" title="9）分片广播 &amp; 动态分片"></a>9）分片广播 &amp; 动态分片</h5><p>执行器集群部署时，任务路由策略选择”分片广播”情况下，一次任务调度将会广播触发对应集群中所有执行器执行一次任务，同时系统自动传递分片参数；可根据分片参数开发分片任务；</p>
<p>“分片广播” 以执行器为维度进行分片，支持动态扩容执行器集群从而动态增加分片数量，协同进行业务处理；在进行大数据量业务操作时可显著提升任务处理能力和速度。</p>
<p>“分片广播” 和普通任务开发流程一致，不同之处在于可以获取分片参数，获取分片参数进行分片业务处理。</p>
<ul>
<li><p>Java语言任务获取分片参数方式：BEAN、GLUE模式(Java)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可参考Sample示例执行器中的示例任务&quot;ShardingJobHandler&quot;了解试用 </span></span><br><span class="line">ShardingUtil.ShardingVO shardingVO = ShardingUtil.getShardingVo();</span><br></pre></td></tr></table></figure>
<p>脚本语言任务获取分片参数方式：GLUE模式(Shell)、GLUE模式(Python)、GLUE模式(Nodejs)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// 脚本任务入参固定为三个，依次为：任务传参、分片序号、分片总数。以Shell模式任务为例，获取分片参数代码如下</span><br><span class="line">echo &quot;分片序号 index = $2&quot;</span><br><span class="line">echo &quot;分片总数 total = $3&quot;</span><br></pre></td></tr></table></figure>
<p>分片参数属性说明：</p>
</li>
</ul>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">index：当前分片序号(从0开始)，执行器集群列表中当前执行器的序号；</span></span><br><span class="line"><span class="attr">total：总分片数，执行器集群的总机器数量；</span></span><br></pre></td></tr></table></figure>
<p>==该特性适用场景如：==</p>
<ul>
<li>==1、分片任务场景：10个执行器的集群来处理10w条数据，每台机器只需要处理1w条数据，耗时降低10倍；==</li>
<li>==2、广播任务场景：广播执行器机器运行shell脚本、广播集群节点进行缓存更新等==</li>
</ul>
<h5 id="10-访问令牌（AccessToken）"><a href="#10-访问令牌（AccessToken）" class="headerlink" title="10)访问令牌（AccessToken）"></a>10)访问令牌（AccessToken）</h5><p>为提升系统安全性，调度中心和执行器进行安全性校验，双方AccessToken匹配才允许通讯；</p>
<p>调度中心和执行器，可通过配置项 “xxl.job.accessToken” 进行AccessToken的设置。</p>
<p>调度中心和执行器，如果需要正常通讯，只有两种设置；</p>
<ul>
<li>设置一：调度中心和执行器，均不设置AccessToken；关闭安全性校验；</li>
<li>设置二：调度中心和执行器，设置了相同的AccessToken；</li>
</ul>
<h5 id="11-故障转移-amp-失败重试"><a href="#11-故障转移-amp-失败重试" class="headerlink" title="11)故障转移 &amp; 失败重试"></a>11)故障转移 &amp; 失败重试</h5><p>一次完整任务流程包括”调度（调度中心） + 执行（执行器）”两个阶段。</p>
<ul>
<li>“故障转移”发生在调度阶段，在执行器集群部署时，如果某一台执行器发生故障，该策略支持自动进行Failover切换到一台正常的执行器机器并且完成调度请求流程。</li>
<li>“失败重试”发生在”调度 + 执行”两个阶段，支持通过自定义任务失败重试次数，当任务失败时将会按照预设的失败重试次数主动进行重试；</li>
</ul>
<h5 id="12-执行器灰度上线"><a href="#12-执行器灰度上线" class="headerlink" title="12)执行器灰度上线"></a>12)执行器灰度上线</h5><p>调度中心与业务解耦，只需部署一次后常年不需要维护。但是，执行器中托管运行着业务作业，作业上线和变更需要重启执行器，尤其是Bean模式任务。<br>执行器重启可能会中断运行中的任务。但是，XXL-JOB得益于自建执行器与自建注册中心，可以通过灰度上线的方式，避免因重启导致的任务中断的问题。</p>
<p>步骤如下：</p>
<ul>
<li>1、执行器改为手动注册，下线一半机器列表（A组），线上运行另一半机器列表（B组）；</li>
<li>2、等待A组机器任务运行结束并编译上线；执行器注册地址替换为A组；</li>
<li>3、等待B组机器任务运行结束并编译上线；执行器注册地址替换为A组+B组；<br>操作结束；</li>
</ul>
<h5 id="13-任务执行结果说明"><a href="#13-任务执行结果说明" class="headerlink" title="13)任务执行结果说明"></a>13)任务执行结果说明</h5><p>系统根据以下标准判断任务执行结果，可参考之。</p>
<table>
<thead>
<tr>
<th align="left">—</th>
<th align="left">Bean/Glue(Java)</th>
<th align="left">Glue(Shell) 等脚本任务</th>
</tr>
</thead>
<tbody><tr>
<td align="left">成功</td>
<td align="left">IJobHandler.SUCCESS</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">失败</td>
<td align="left">IJobHandler.FAIL</td>
<td align="left">-1（非0状态码）</td>
</tr>
</tbody></table>
<h5 id="14-任务超时控制"><a href="#14-任务超时控制" class="headerlink" title="14)任务超时控制"></a>14)任务超时控制</h5><p>支持设置任务超时时间，任务运行超时的情况下，将会主动中断任务；</p>
<p>需要注意的是，任务超时中断时与任务终止机制（可查看“4.9 终止运行中的任务”）类似，也是通过 “interrupt” 中断任务，因此业务代码需要将 “InterruptedException” 外抛，否则功能不可用。</p>
<h5 id="15-跨语言"><a href="#15-跨语言" class="headerlink" title="15) 跨语言"></a>15) 跨语言</h5><p>XXL-JOB是一个跨语言的任务调度平台，主要体现在如下几个方面：</p>
<ul>
<li>1、RESTful API：调度中心与执行器提供语言无关的 RESTful API 服务，第三方任意语言可据此对接调度中心或者实现执行器。（可参考章节 “调度中心/执行器 RESTful API” ）</li>
<li>2、多任务模式：提供Java、Python、PHP……等十来种任务模式，可参考章节 “5.5 任务 “运行模式” ”；理论上可扩展任意语言任务模式；</li>
<li>2、提供基于HTTP的任务Handler（Bean任务，JobHandler=”httpJobHandler”）；业务方只需要提供HTTP链接等相关信息即可，不限制语言、平台；（可参考章节 “原生内置Bean模式任务” ）</li>
</ul>
<h5 id="16-任务失败告警"><a href="#16-任务失败告警" class="headerlink" title="16) 任务失败告警"></a>16) 任务失败告警</h5><p>默认提供邮件失败告警，可扩展短信、钉钉等方式。如果需要新增一种告警方式，只需要新增一个实现 “com.xxl.job.admin.core.alarm.JobAlarm” 接口的告警实现即可。可以参考默认提供邮箱告警实现 “EmailJobAlarm”。</p>
<h5 id="17-调度中心Docker镜像构建"><a href="#17-调度中心Docker镜像构建" class="headerlink" title="17 调度中心Docker镜像构建"></a>17 调度中心Docker镜像构建</h5><p>可以通过以下命令快速构建调度中心，并启动运行；</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean packagedocker build -t xuxueli&#x2F;xxl-job-admin .&#x2F;xxl-job-admindocker run --name xxl-job-admin -p 8080:8080 -d xuxueli&#x2F;xxl-job-admin</span><br></pre></td></tr></table></figure>
<h5 id="18-避免任务重复执行"><a href="#18-避免任务重复执行" class="headerlink" title="18)避免任务重复执行"></a>18)避免任务重复执行</h5><p>调度密集或者耗时任务可能会导致任务阻塞，集群情况下调度组件小概率情况下会重复触发；<br>针对上述情况，可以通过结合 “单机路由策略（如：第一台、一致性哈希）” + “阻塞策略（如：单机串行、丢弃后续调度）” 来规避，最终避免任务重复执行。</p>
<h5 id="19-命令行任务"><a href="#19-命令行任务" class="headerlink" title="19) 命令行任务"></a>19) 命令行任务</h5><p>原生提供通用命令行任务Handler（Bean任务，”CommandJobHandler”）；业务方只需要提供命令行即可；<br>如任务参数 “pwd” 将会执行命令并输出数据；</p>
<h5 id="20-日志自动清理"><a href="#20-日志自动清理" class="headerlink" title="20) 日志自动清理"></a>20) 日志自动清理</h5><p>XXL-JOB日志主要包含如下两部分，均支持日志自动清理，说明如下：</p>
<ul>
<li>调度中心日志表数据：可借助配置项 “xxl.job.logretentiondays” 设置日志表数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li>
<li>执行器日志文件数据：可借助配置项 “xxl.job.executor.logretentiondays” 设置日志文件数据保存天数，过期日志自动清理；详情可查看上文配置说明；</li>
</ul>
<h5 id="21-调度结果丢失处理"><a href="#21-调度结果丢失处理" class="headerlink" title="21) 调度结果丢失处理"></a>21) 调度结果丢失处理</h5><p>执行器因网络抖动回调失败或宕机等异常情况，会导致任务调度结果丢失。由于调度中心依赖执行器回调来感知调度结果，因此会导致调度日志永远处于 “运行中” 状态。</p>
<p>针对该问题，调度中心提供内置组件进行处理，逻辑为：调度记录停留在 “运行中” 状态超过10min，且对应执行器心跳注册失败不在线，则将本地调度主动标记失败；</p>
<h4 id="七、调度中心-执行器-RESTful-API（暂不关注）"><a href="#七、调度中心-执行器-RESTful-API（暂不关注）" class="headerlink" title="七、调度中心/执行器 RESTful API（暂不关注）"></a>七、调度中心/执行器 RESTful API（暂不关注）</h4><p>XXL-JOB 目标是一种跨平台、跨语言的任务调度规范和协议。</p>
<p>针对Java应用，可以直接通过官方提供的调度中心与执行器，方便快速的接入和使用调度中心，可以参考上文 “快速入门” 章节。</p>
<p>针对非Java应用，可借助 XXL-JOB 的标准 RESTful API 方便的实现多语言支持。</p>
<ul>
<li>调度中心 RESTful API：<ul>
<li>说明：调度中心提供给执行器使用的API；不局限于官方执行器使用，第三方可使用该API来实现执行器；</li>
<li>API列表：执行器注册、任务结果回调等；</li>
</ul>
</li>
<li>执行器 RESTful API ：<ul>
<li>说明：执行器提供给调度中心使用的API；官方执行器默认已实现，第三方执行器需要实现并对接提供给调度中心；</li>
<li>API列表：任务触发、任务终止、任务日志查询……等；</li>
</ul>
</li>
</ul>
<p>此处 RESTful API 主要用于非Java语言定制个性化执行器使用，实现跨语言。除此之外，如果有需要通过API操作调度中心，可以个性化扩展 “调度中心 RESTful API” 并使用。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/" data-id="ckk2gq3uj001sz8pqcmz8gjhu" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/01/18/Wordpress%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/%E5%9F%BA%E4%BA%8Ealiyun%E4%BA%91%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BAwordpress%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>