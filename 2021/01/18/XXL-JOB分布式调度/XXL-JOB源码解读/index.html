<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="一、xxl-job的Bean模式开发步骤：xxl-job调度任务的开发主要执行器的开发，按照业务需求创建处理不同业务逻辑的执行器后，在调度中心创建任务、设置调度规则，绑定相应的执行后，当满足调度规则的条件时即可调起执行器完成调度处理 1）创建项目和配置创建执行器项目，在配置文件中做相应配置，注册到注册中心、指定执行器名 1234567891011121314151617### xxl-job ad">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="一、xxl-job的Bean模式开发步骤：xxl-job调度任务的开发主要执行器的开发，按照业务需求创建处理不同业务逻辑的执行器后，在调度中心创建任务、设置调度规则，绑定相应的执行后，当满足调度规则的条件时即可调起执行器完成调度处理 1）创建项目和配置创建执行器项目，在配置文件中做相应配置，注册到注册中心、指定执行器名 1234567891011121314151617### xxl-job ad">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120507.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120547.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120555.png">
<meta property="article:published_time" content="2021-01-18T11:01:37.873Z">
<meta property="article:modified_time" content="2021-01-11T04:06:03.771Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120507.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-XXL-JOB分布式调度/XXL-JOB源码解读" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.873Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、xxl-job的Bean模式开发步骤："><a href="#一、xxl-job的Bean模式开发步骤：" class="headerlink" title="一、xxl-job的Bean模式开发步骤："></a>一、xxl-job的Bean模式开发步骤：</h4><p>xxl-job调度任务的开发主要执行器的开发，按照业务需求创建处理不同业务逻辑的执行器后，在调度中心创建任务、设置调度规则，绑定相应的执行后，当满足调度规则的条件时即可调起执行器完成调度处理</p>
<h5 id="1）创建项目和配置"><a href="#1）创建项目和配置" class="headerlink" title="1）创建项目和配置"></a>1）创建项目和配置</h5><p>创建执行器项目，在配置文件中做相应配置，注册到注册中心、指定执行器名</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### xxl-job admin address list, such as &quot;http://address&quot; or &quot;http://address01,http://address02&quot;</span></span><br><span class="line"><span class="meta">xxl.job.admin.addresses</span>=<span class="string">http://127.0.0.1:8080/xxl-job-admin</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### xxl-job, access token</span></span><br><span class="line"><span class="meta">xxl.job.accessToken</span>=<span class="string"></span></span><br><span class="line"></span><br><span class="line"><span class="comment">### xxl-job executor appname</span></span><br><span class="line"><span class="meta">xxl.job.executor.appname</span>=<span class="string">xxl-job-executor-sample</span></span><br><span class="line"><span class="comment">### xxl-job executor registry-address: default use address to registry , otherwise use ip:port if address is null</span></span><br><span class="line"><span class="meta">xxl.job.executor.address</span>=<span class="string"></span></span><br><span class="line"><span class="comment">### xxl-job executor server-info</span></span><br><span class="line"><span class="meta">xxl.job.executor.ip</span>=<span class="string"></span></span><br><span class="line"><span class="meta">xxl.job.executor.port</span>=<span class="string">9999</span></span><br><span class="line"><span class="comment">### xxl-job executor log-path</span></span><br><span class="line"><span class="meta">xxl.job.executor.logpath</span>=<span class="string">/data/applogs/xxl-job/jobhandler</span></span><br><span class="line"><span class="comment">### xxl-job executor log-retention-days</span></span><br><span class="line"><span class="meta">xxl.job.executor.logretentiondays</span>=<span class="string">30</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="operator">-</span> xxl_job_lock：任务调度锁表；</span><br><span class="line"><span class="operator">-</span> xxl_job_group：执行器信息表，维护任务执行器信息；</span><br><span class="line"><span class="operator">-</span> xxl_job_info：调度扩展信息表： 用于保存XXL<span class="operator">-</span>JOB调度任务的扩展信息，如任务分组、任务名、机器地址、执行器、执行入参和报警邮件等等；</span><br><span class="line"><span class="operator">-</span> xxl_job_log：调度日志表： 用于保存XXL<span class="operator">-</span>JOB任务调度的历史信息，如调度结果、执行结果、调度入参、调度机器和执行器等等；</span><br><span class="line"><span class="operator">-</span> xxl_job_log_report：调度日志报表：用户存储XXL<span class="operator">-</span>JOB任务调度日志的报表，调度中心报表功能页面会用到；</span><br><span class="line"><span class="operator">-</span> xxl_job_logglue：任务GLUE日志：用于保存GLUE更新历史，用于支持GLUE的版本回溯功能；</span><br><span class="line"><span class="operator">-</span> xxl_job_registry：执行器注册表，维护在线的执行器和调度中心机器地址信息；</span><br><span class="line"><span class="operator">-</span> xxl_job_user：系统用户表；</span><br></pre></td></tr></table></figure>


<h5 id="2）创建执行器类和handler方法"><a href="#2）创建执行器类和handler方法" class="headerlink" title="2）创建执行器类和handler方法"></a>2）创建执行器类和handler方法</h5><p>创建一个类SampleXxlJob并注入到spring容器中，类中创建JobHandler方法，加上注解@XxlJob(“demoJobHandler”)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleXxlJob</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）注册中心创建任务并绑定JobHandler"><a href="#3）注册中心创建任务并绑定JobHandler" class="headerlink" title="3）注册中心创建任务并绑定JobHandler"></a>3）注册中心创建任务并绑定JobHandler</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120507.png" alt="image-20201026170023820"></p>
<p>JobHandler需与执行器方法的@XxlJob注解一致，当满足Cron配置的条件时即可调起执行器中对应的JobHandler</p>
<h4 id="二、xxl-job-admin的原理："><a href="#二、xxl-job-admin的原理：" class="headerlink" title="二、xxl-job-admin的原理："></a>二、xxl-job-admin的原理：</h4><h5 id="1）xxl-job-admin项目的启动与初始化"><a href="#1）xxl-job-admin项目的启动与初始化" class="headerlink" title="1）xxl-job-admin项目的启动与初始化"></a>1）xxl-job-admin项目的启动与初始化</h5><p>xxl-job-admin是xxl-job工具的调度中心，启动运行时加载配置项和初始化类，其中除了初始化绑定了application.properties中配置的参数外，重要的一点是初始化xxl-job重要调度者com.xxl.job.admin.core.scheduler.XxlJobScheduler类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobAdminConfig</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> XxlJobAdminConfig adminConfig = <span class="keyword">null</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> XxlJobAdminConfig <span class="title">getAdminConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adminConfig;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- XxlJobScheduler ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XxlJobScheduler xxlJobScheduler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        adminConfig = <span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//xxl-job重要调度者</span></span><br><span class="line">        xxlJobScheduler = <span class="keyword">new</span> XxlJobScheduler();</span><br><span class="line">        xxlJobScheduler.init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        xxlJobScheduler.destroy();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- XxlJobScheduler ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// conf</span></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.i18n&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String i18n;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;spring.mail.from&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String emailFrom;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.triggerpool.fast.max&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> triggerPoolFastMax;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.triggerpool.slow.max&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> triggerPoolSlowMax;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> logretentiondays;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// dao, service</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogDao xxlJobLogDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobInfoDao xxlJobInfoDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobRegistryDao xxlJobRegistryDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobGroupDao xxlJobGroupDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> XxlJobLogReportDao xxlJobLogReportDao;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JavaMailSender mailSender;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> JobAlarmer jobAlarmer;</span><br></pre></td></tr></table></figure>


<h5 id="2）xxl-job-admin中的调度者XxlJobScheduler"><a href="#2）xxl-job-admin中的调度者XxlJobScheduler" class="headerlink" title="2）xxl-job-admin中的调度者XxlJobScheduler"></a>2）xxl-job-admin中的调度者XxlJobScheduler</h5><p>xxl-job-admin启动后初始化的的调度者com.xxl.job.admin.core.scheduler.XxlJobScheduler，调度者主要包含两个重要作用：</p>
<p>①初始化xxl-job调度中心的重要各种助手类JobXXXHelper，并执行相应start()方法启动运行，这些助手类支撑了调度中心运行和各种重要功能，</p>
<p>②初始化执行客户端的仓库executorBizRepository，可以通过仓库的get方法获取执行器客户端ExecutorBizClient，通过客户端远程调用执行器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobScheduler</span>  </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(XxlJobScheduler.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// init i18n</span></span><br><span class="line">        initI18n();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化多种JobXXXHelper助手类，并调用运行方法启动</span></span><br><span class="line">        <span class="comment">// admin registry monitor run</span></span><br><span class="line">        JobRegistryMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin fail-monitor run</span></span><br><span class="line">        JobFailMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin lose-monitor run</span></span><br><span class="line">        JobLosedMonitorHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin trigger pool start</span></span><br><span class="line">        JobTriggerPoolHelper.toStart();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// admin log report start</span></span><br><span class="line">        JobLogReportHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start-schedule</span></span><br><span class="line">        JobScheduleHelper.getInstance().start();</span><br><span class="line"></span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; init xxl-job admin success.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化执行器客户端仓库executorBizRepository，并可通过get方法获取仓库中的执行器客户端ExecutorBizClient</span></span><br><span class="line">     <span class="comment">// ---------------------- executor-client ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, ExecutorBiz&gt; executorBizRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, ExecutorBiz&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorBiz <span class="title">getExecutorBiz</span><span class="params">(String address)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (address==<span class="keyword">null</span> || address.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load-cache</span></span><br><span class="line">        address = address.trim();</span><br><span class="line">        ExecutorBiz executorBiz = executorBizRepository.get(address);</span><br><span class="line">        <span class="keyword">if</span> (executorBiz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> executorBiz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// set-cache</span></span><br><span class="line">        executorBiz = <span class="keyword">new</span> ExecutorBizClient(address, XxlJobAdminConfig.getAdminConfig().getAccessToken());</span><br><span class="line"></span><br><span class="line">        executorBizRepository.put(address, executorBiz);</span><br><span class="line">        <span class="keyword">return</span> executorBiz;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）xxl-job-admin的调度助手JobScheduleHelper"><a href="#3）xxl-job-admin的调度助手JobScheduleHelper" class="headerlink" title="3）xxl-job-admin的调度助手JobScheduleHelper"></a>3）xxl-job-admin的调度助手JobScheduleHelper</h5><p>xxl-job-admin的调度助手类com.xxl.job.admin.core.thread.JobScheduleHelper,用于管理调度中心的任务和触发，使用到xxl_job_info表</p>
<p>⑤过期处理策略</p>
<p>任务调度错过触发时间时的处理策略：</p>
<ul>
<li>可能原因：服务重启；调度线程被阻塞，线程被耗尽；上次调度持续阻塞，下次调度被错过；</li>
<li>==处理策略：==<ul>
<li>==过期超5s：本次忽略，当前时间开始计算下次触发时间==</li>
<li>==过期5s内：立即触发一次，当前时间开始计算下次触发时间==</li>
</ul>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobScheduleHelper</span> </span>&#123; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// schedule thread</span></span><br><span class="line">        scheduleThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    TimeUnit.MILLISECONDS.sleep(<span class="number">5000</span> - System.currentTimeMillis()%<span class="number">1000</span> );</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!scheduleThreadToStop) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; init xxl-job admin scheduler success.&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// pre-read count: treadpool-size * trigger-qps (each trigger cost 50ms, qps = 1000/50 = 20)</span></span><br><span class="line">                <span class="keyword">int</span> preReadCount = (XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax() + XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax()) * <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span> (!scheduleThreadToStop) &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Scan Job</span></span><br><span class="line">                    <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                    Connection conn = <span class="keyword">null</span>;</span><br><span class="line">                    Boolean connAutoCommit = <span class="keyword">null</span>;</span><br><span class="line">                    PreparedStatement preparedStatement = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">boolean</span> preReadSuc = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">                        conn = XxlJobAdminConfig.getAdminConfig().getDataSource().getConnection();</span><br><span class="line">                        connAutoCommit = conn.getAutoCommit();</span><br><span class="line">                        conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="comment">//1、获取调度锁，因为调度中心是支持集群，所以使用数据库xxl_job_lock表作为分布式锁</span></span><br><span class="line">                        preparedStatement = conn.prepareStatement(  <span class="string">&quot;select * from xxl_job_lock where lock_name = &#x27;schedule_lock&#x27; for update&quot;</span> );</span><br><span class="line">                        preparedStatement.execute();</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// tx start</span></span><br><span class="line"></span><br><span class="line">                        <span class="comment">// 1、pre read</span></span><br><span class="line">                        <span class="keyword">long</span> nowTime = System.currentTimeMillis();</span><br><span class="line">                        <span class="comment">//2、查询所有正在运行中的任务列表</span></span><br><span class="line">                        List&lt;XxlJobInfo&gt; scheduleList = XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().scheduleJobQuery(nowTime + PRE_READ_MS, preReadCount);</span><br><span class="line">                        <span class="keyword">if</span> (scheduleList!=<span class="keyword">null</span> &amp;&amp; scheduleList.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="comment">// 2、push time-ring</span></span><br><span class="line">                            <span class="keyword">for</span> (XxlJobInfo jobInfo: scheduleList) &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="comment">// time-ring jump</span></span><br><span class="line">                                <span class="comment">//3、如果任务过期超过5秒，则根据当前时间刷新下次触发时间</span></span><br><span class="line">                                <span class="keyword">if</span> (nowTime &gt; jobInfo.getTriggerNextTime() + PRE_READ_MS) &#123;</span><br><span class="line">                                    <span class="comment">// 2.1、trigger-  &gt; 5s：pass &amp;&amp; make next-trigger-time</span></span><br><span class="line">                                    logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, schedule misfire, jobId = &quot;</span> + jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nowTime &gt; jobInfo.getTriggerNextTime()) &#123;</span><br><span class="line">                                    <span class="comment">// 2.2、trigger-expire &lt; 5s：direct-trigger &amp;&amp; make next-trigger-time</span></span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 1、trigger</span></span><br><span class="line">                                    <span class="comment">//4、任务过期不超过5秒，调用触发池助手的方法触发任务</span></span><br><span class="line">                                    JobTriggerPoolHelper.trigger(jobInfo.getId(), TriggerTypeEnum.CRON, -<span class="number">1</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                                    logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, schedule push trigger : jobId = &quot;</span> + jobInfo.getId() );</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 2、fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// next-trigger-time in 5s, pre-read again</span></span><br><span class="line">                                    <span class="keyword">if</span> (jobInfo.getTriggerStatus()==<span class="number">1</span> &amp;&amp; nowTime + PRE_READ_MS &gt; jobInfo.getTriggerNextTime()) &#123;</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 1、make ring second</span></span><br><span class="line">                                        <span class="keyword">int</span> ringSecond = (<span class="keyword">int</span>)((jobInfo.getTriggerNextTime()/<span class="number">1000</span>)%<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 2、push time ring</span></span><br><span class="line">                                        pushTimeRing(ringSecond, jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                        <span class="comment">// 3、fresh next</span></span><br><span class="line">                                        refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date(jobInfo.getTriggerNextTime()));</span><br><span class="line"></span><br><span class="line">                                    &#125;</span><br><span class="line"></span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    <span class="comment">// 2.3、trigger-pre-read：time-ring trigger &amp;&amp; make next-trigger-time</span></span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 1、make ring second</span></span><br><span class="line">                                    <span class="keyword">int</span> ringSecond = (<span class="keyword">int</span>)((jobInfo.getTriggerNextTime()/<span class="number">1000</span>)%<span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 2、push time ring</span></span><br><span class="line">                                    pushTimeRing(ringSecond, jobInfo.getId());</span><br><span class="line"></span><br><span class="line">                                    <span class="comment">// 3、fresh next</span></span><br><span class="line">                                    refreshNextValidTime(jobInfo, <span class="keyword">new</span> Date(jobInfo.getTriggerNextTime()));</span><br><span class="line"></span><br><span class="line">                                &#125;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="comment">// 3、update trigger info</span></span><br><span class="line">                            <span class="keyword">for</span> (XxlJobInfo jobInfo: scheduleList) &#123;</span><br><span class="line">                                XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().scheduleUpdate(jobInfo);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="4）xxl-job-admin触发池助手JobTriggerPoolHelper"><a href="#4）xxl-job-admin触发池助手JobTriggerPoolHelper" class="headerlink" title="4）xxl-job-admin触发池助手JobTriggerPoolHelper"></a>4）xxl-job-admin触发池助手JobTriggerPoolHelper</h5><p>xxl-job-admin中的com.xxl.job.admin.core.thread.JobTriggerPoolHelper任务触发池助手类，可以实例化任务触发池,创建了trigger方法触发任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobTriggerPoolHelper</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(JobTriggerPoolHelper.class);</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">         <span class="comment">//初始化触发池</span></span><br><span class="line">        fastTriggerPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">10</span>,</span><br><span class="line">                XxlJobAdminConfig.getAdminConfig().getTriggerPoolFastMax(),</span><br><span class="line">                <span class="number">60L</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">1000</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-fastTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line">        slowTriggerPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                <span class="number">10</span>,</span><br><span class="line">                XxlJobAdminConfig.getAdminConfig().getTriggerPoolSlowMax(),</span><br><span class="line">                <span class="number">60L</span>,</span><br><span class="line">                TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">2000</span>),</span><br><span class="line">                <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-job, admin JobTriggerPoolHelper-slowTriggerPool-&quot;</span> + r.hashCode());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">int</span> jobId, TriggerTypeEnum triggerType, <span class="keyword">int</span> failRetryCount, String executorShardingParam, String executorParam, String addressList)</span> </span>&#123;</span><br><span class="line">        helper.addTrigger(jobId, triggerType, failRetryCount, executorShardingParam, executorParam, addressList);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">       	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addTrigger</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> jobId,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> TriggerTypeEnum triggerType,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> <span class="keyword">int</span> failRetryCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String executorShardingParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String executorParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                           <span class="keyword">final</span> String addressList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// choose thread pool</span></span><br><span class="line">        ThreadPoolExecutor triggerPool_ = fastTriggerPool;</span><br><span class="line">        AtomicInteger jobTimeoutCount = jobTimeoutCountMap.get(jobId);</span><br><span class="line">        <span class="keyword">if</span> (jobTimeoutCount!=<span class="keyword">null</span> &amp;&amp; jobTimeoutCount.get() &gt; <span class="number">10</span>) &#123;      <span class="comment">// job-timeout 10 times in 1 min</span></span><br><span class="line">            triggerPool_ = slowTriggerPool;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// trigger</span></span><br><span class="line">        triggerPool_.execute(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// do trigger</span></span><br><span class="line">                    <span class="comment">//调用触发器触发任务</span></span><br><span class="line">                    XxlJobTrigger.trigger(jobId, triggerType, failRetryCount, executorShardingParam, executorParam, addressList);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                    logger.error(e.getMessage(), e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// check timeout-count-map</span></span><br><span class="line">                    <span class="keyword">long</span> minTim_now = System.currentTimeMillis()/<span class="number">60000</span>;</span><br><span class="line">                    <span class="keyword">if</span> (minTim != minTim_now) &#123;</span><br><span class="line">                        minTim = minTim_now;</span><br><span class="line">                        jobTimeoutCountMap.clear();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// incr timeout-count-map</span></span><br><span class="line">                    <span class="keyword">long</span> cost = System.currentTimeMillis()-start;</span><br><span class="line">                    <span class="keyword">if</span> (cost &gt; <span class="number">500</span>) &#123;       <span class="comment">// ob-timeout threshold 500ms</span></span><br><span class="line">                        AtomicInteger timeoutCount = jobTimeoutCountMap.putIfAbsent(jobId, <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>));</span><br><span class="line">                        <span class="keyword">if</span> (timeoutCount != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            timeoutCount.incrementAndGet();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5）xxl-job-admin任务触发器XxlJobTrigger"><a href="#5）xxl-job-admin任务触发器XxlJobTrigger" class="headerlink" title="5）xxl-job-admin任务触发器XxlJobTrigger"></a>5）xxl-job-admin任务触发器XxlJobTrigger</h5><p>xxl-job-admin中的com.xxl.job.admin.core.trigger.XxlJobTrigger提供了调起任务的方法，向执行器发起任务调度</p>
<p>==在processTrigger方法中实例化XxlJobLog类，用于记录xxl-job调度日志==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobTrigger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(XxlJobTrigger.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * trigger job</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> failRetryCount</span></span><br><span class="line"><span class="comment">     * 			&gt;=0: use this param</span></span><br><span class="line"><span class="comment">     * 			&lt;0: use param from job info config</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executorShardingParam</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executorParam</span></span><br><span class="line"><span class="comment">     *          null: use job param</span></span><br><span class="line"><span class="comment">     *          not null: cover job param</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> addressList</span></span><br><span class="line"><span class="comment">     *          null: use executor addressList</span></span><br><span class="line"><span class="comment">     *          not null: cover</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">trigger</span><span class="params">(<span class="keyword">int</span> jobId,</span></span></span><br><span class="line"><span class="function"><span class="params">                               TriggerTypeEnum triggerType,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="keyword">int</span> failRetryCount,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String executorShardingParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String executorParam,</span></span></span><br><span class="line"><span class="function"><span class="params">                               String addressList)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// load data</span></span><br><span class="line">        <span class="comment">//1、加载任务信息xxl_job_info表中</span></span><br><span class="line">        XxlJobInfo jobInfo = XxlJobAdminConfig.getAdminConfig().getXxlJobInfoDao().loadById(jobId);</span><br><span class="line">        <span class="keyword">if</span> (jobInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; trigger fail, jobId invalid，jobId=&#123;&#125;&quot;</span>, jobId);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (executorParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobInfo.setExecutorParam(executorParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> finalFailRetryCount = failRetryCount&gt;=<span class="number">0</span>?failRetryCount:jobInfo.getExecutorFailRetryCount();</span><br><span class="line">        <span class="comment">//2.查询支持该任务的集群xxl_job_registry</span></span><br><span class="line">        XxlJobGroup group = XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().load(jobInfo.getJobGroup());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// cover addressList</span></span><br><span class="line">        <span class="keyword">if</span> (addressList!=<span class="keyword">null</span> &amp;&amp; addressList.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            group.setAddressType(<span class="number">1</span>);</span><br><span class="line">            group.setAddressList(addressList.trim());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// sharding param</span></span><br><span class="line">        <span class="keyword">int</span>[] shardingParam = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (executorShardingParam!=<span class="keyword">null</span>)&#123;</span><br><span class="line">            String[] shardingArr = executorShardingParam.split(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (shardingArr.length==<span class="number">2</span> &amp;&amp; isNumeric(shardingArr[<span class="number">0</span>]) &amp;&amp; isNumeric(shardingArr[<span class="number">1</span>])) &#123;</span><br><span class="line">                shardingParam = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">                shardingParam[<span class="number">0</span>] = Integer.valueOf(shardingArr[<span class="number">0</span>]);</span><br><span class="line">                shardingParam[<span class="number">1</span>] = Integer.valueOf(shardingArr[<span class="number">1</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (ExecutorRouteStrategyEnum.SHARDING_BROADCAST==ExecutorRouteStrategyEnum.match(jobInfo.getExecutorRouteStrategy(), <span class="keyword">null</span>)</span><br><span class="line">                &amp;&amp; group.getRegistryList()!=<span class="keyword">null</span> &amp;&amp; !group.getRegistryList().isEmpty()</span><br><span class="line">                &amp;&amp; shardingParam==<span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; group.getRegistryList().size(); i++) &#123;</span><br><span class="line">                processTrigger(group, jobInfo, finalFailRetryCount, triggerType, i, group.getRegistryList().size());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (shardingParam == <span class="keyword">null</span>) &#123;</span><br><span class="line">                shardingParam = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;<span class="number">0</span>, <span class="number">1</span>&#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//3.进程触发方法</span></span><br><span class="line">            processTrigger(group, jobInfo, finalFailRetryCount, triggerType, shardingParam[<span class="number">0</span>], shardingParam[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> group                     job group, registry list may be empty</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> jobInfo</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> finalFailRetryCount</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerType</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> index                     sharding index</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> total                     sharding index</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">processTrigger</span><span class="params">(XxlJobGroup group, XxlJobInfo jobInfo, <span class="keyword">int</span> finalFailRetryCount, TriggerTypeEnum triggerType, <span class="keyword">int</span> index, <span class="keyword">int</span> total)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1、设置并行策略</span></span><br><span class="line">        ExecutorBlockStrategyEnum blockStrategy = ExecutorBlockStrategyEnum.match(jobInfo.getExecutorBlockStrategy(), ExecutorBlockStrategyEnum.SERIAL_EXECUTION);  <span class="comment">// block strategy</span></span><br><span class="line">        <span class="comment">//2.路由策略</span></span><br><span class="line">        ExecutorRouteStrategyEnum executorRouteStrategyEnum = ExecutorRouteStrategyEnum.match(jobInfo.getExecutorRouteStrategy(), <span class="keyword">null</span>);    <span class="comment">// route strategy</span></span><br><span class="line">        <span class="comment">//3.分片参数</span></span><br><span class="line">        String shardingParam = (ExecutorRouteStrategyEnum.SHARDING_BROADCAST==executorRouteStrategyEnum)?String.valueOf(index).concat(<span class="string">&quot;/&quot;</span>).concat(String.valueOf(total)):<span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//4.化XxlJobLog日志记录对象，只用使用该日志对象打印日志才会出现在执行日志中</span></span><br><span class="line">        XxlJobLog jobLog = <span class="keyword">new</span> XxlJobLog();</span><br><span class="line">        jobLog.setJobGroup(jobInfo.getJobGroup());</span><br><span class="line">        jobLog.setJobId(jobInfo.getId());</span><br><span class="line">        jobLog.setTriggerTime(<span class="keyword">new</span> Date());</span><br><span class="line">        <span class="comment">//5.保存日志到xxl_job_log表中，记录日志，后续可查询、修改</span></span><br><span class="line">        XxlJobAdminConfig.getAdminConfig().getXxlJobLogDao().save(jobLog);</span><br><span class="line">        logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger start, jobId:&#123;&#125;&quot;</span>, jobLog.getId());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//6.设置触发参数</span></span><br><span class="line">        TriggerParam triggerParam = <span class="keyword">new</span> TriggerParam();</span><br><span class="line">        triggerParam.setJobId(jobInfo.getId());</span><br><span class="line">        triggerParam.setExecutorHandler(jobInfo.getExecutorHandler());</span><br><span class="line">        triggerParam.setExecutorParams(jobInfo.getExecutorParam());</span><br><span class="line">        triggerParam.setExecutorBlockStrategy(jobInfo.getExecutorBlockStrategy());</span><br><span class="line">        triggerParam.setExecutorTimeout(jobInfo.getExecutorTimeout());</span><br><span class="line">        triggerParam.setLogId(jobLog.getId());</span><br><span class="line">        triggerParam.setLogDateTime(jobLog.getTriggerTime().getTime());</span><br><span class="line">        triggerParam.setGlueType(jobInfo.getGlueType());</span><br><span class="line">        triggerParam.setGlueSource(jobInfo.getGlueSource());</span><br><span class="line">        triggerParam.setGlueUpdatetime(jobInfo.getGlueUpdatetime().getTime());</span><br><span class="line">        triggerParam.setBroadcastIndex(index);</span><br><span class="line">        triggerParam.setBroadcastTotal(total);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3、init address</span></span><br><span class="line">        String address = <span class="keyword">null</span>;</span><br><span class="line">        ReturnT&lt;String&gt; routeAddressResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (group.getRegistryList()!=<span class="keyword">null</span> &amp;&amp; !group.getRegistryList().isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ExecutorRouteStrategyEnum.SHARDING_BROADCAST == executorRouteStrategyEnum) &#123;</span><br><span class="line">                <span class="keyword">if</span> (index &lt; group.getRegistryList().size()) &#123;</span><br><span class="line">                    address = group.getRegistryList().get(index);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    address = group.getRegistryList().get(<span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">//7.根据路由参数设置路由地址,从集群中选取合适的执行器机器</span></span><br><span class="line">                routeAddressResult = executorRouteStrategyEnum.getRouter().route(triggerParam, group.getRegistryList());</span><br><span class="line">                <span class="keyword">if</span> (routeAddressResult.getCode() == ReturnT.SUCCESS_CODE) &#123;</span><br><span class="line">                    address = routeAddressResult.getContent();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            routeAddressResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, I18nUtil.getString(<span class="string">&quot;jobconf_trigger_address_empty&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ReturnT&lt;String&gt; triggerResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (address != <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="comment">//8.调用runExecutor运行执行器，并获取执行结果</span></span><br><span class="line">            triggerResult = runExecutor(triggerParam, address);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            triggerResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 9、设置任务执行信息</span></span><br><span class="line">        StringBuffer triggerMsgSb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        triggerMsgSb.append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_type&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(triggerType.getTitle());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_admin_adress&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(IpUtil.getIp());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_exe_regtype&quot;</span>)).append(<span class="string">&quot;：&quot;</span>)</span><br><span class="line">                .append( (group.getAddressType() == <span class="number">0</span>)?I18nUtil.getString(<span class="string">&quot;jobgroup_field_addressType_0&quot;</span>):I18nUtil.getString(<span class="string">&quot;jobgroup_field_addressType_1&quot;</span>) );</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_exe_regaddress&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(group.getRegistryList());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorRouteStrategy&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(executorRouteStrategyEnum.getTitle());</span><br><span class="line">        <span class="keyword">if</span> (shardingParam != <span class="keyword">null</span>) &#123;</span><br><span class="line">            triggerMsgSb.append(<span class="string">&quot;(&quot;</span>+shardingParam+<span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorBlockStrategy&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(blockStrategy.getTitle());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_timeout&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(jobInfo.getExecutorTimeout());</span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&quot;</span>).append(I18nUtil.getString(<span class="string">&quot;jobinfo_field_executorFailRetryCount&quot;</span>)).append(<span class="string">&quot;：&quot;</span>).append(finalFailRetryCount);</span><br><span class="line"></span><br><span class="line">        triggerMsgSb.append(<span class="string">&quot;&lt;br&gt;&lt;br&gt;&lt;span style=\&quot;color:#00c0ef;\&quot; &gt; &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;</span>+ I18nUtil.getString(<span class="string">&quot;jobconf_trigger_run&quot;</span>) +<span class="string">&quot;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt; &lt;/span&gt;&lt;br&gt;&quot;</span>)</span><br><span class="line">                .append((routeAddressResult!=<span class="keyword">null</span>&amp;&amp;routeAddressResult.getMsg()!=<span class="keyword">null</span>)?routeAddressResult.getMsg()+<span class="string">&quot;&lt;br&gt;&lt;br&gt;&quot;</span>:<span class="string">&quot;&quot;</span>).append(triggerResult.getMsg()!=<span class="keyword">null</span>?triggerResult.getMsg():<span class="string">&quot;&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 10、设置任务执行结果等信息</span></span><br><span class="line">        jobLog.setExecutorAddress(address);</span><br><span class="line">        jobLog.setExecutorHandler(jobInfo.getExecutorHandler());</span><br><span class="line">        jobLog.setExecutorParam(jobInfo.getExecutorParam());</span><br><span class="line">        jobLog.setExecutorShardingParam(shardingParam);</span><br><span class="line">        jobLog.setExecutorFailRetryCount(finalFailRetryCount);</span><br><span class="line">        <span class="comment">//jobLog.setTriggerTime();</span></span><br><span class="line">        jobLog.setTriggerCode(triggerResult.getCode());</span><br><span class="line">        jobLog.setTriggerMsg(triggerMsgSb.toString());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 11、更新xxl_job_log表中日志信息</span></span><br><span class="line">        XxlJobAdminConfig.getAdminConfig().getXxlJobLogDao().updateTriggerInfo(jobLog);</span><br><span class="line"></span><br><span class="line">        logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger end, jobId:&#123;&#125;&quot;</span>, jobLog.getId());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * run executor</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> triggerParam</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> address</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReturnT&lt;String&gt; <span class="title">runExecutor</span><span class="params">(TriggerParam triggerParam, String address)</span></span>&#123;</span><br><span class="line">        ReturnT&lt;String&gt; runResult = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//8.1调用XxlJobScheduler的get方法获取执行器客户端ExecutorBizClient</span></span><br><span class="line">            ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(address);</span><br><span class="line">            runResult = executorBiz.run(triggerParam);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job trigger error, please check if the executor[&#123;&#125;] is running.&quot;</span>, address, e);</span><br><span class="line">            runResult = <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, ThrowableUtil.toString(e));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        StringBuffer runResultSB = <span class="keyword">new</span> StringBuffer(I18nUtil.getString(<span class="string">&quot;jobconf_trigger_run&quot;</span>) + <span class="string">&quot;：&quot;</span>);</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;address：&quot;</span>).append(address);</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;code：&quot;</span>).append(runResult.getCode());</span><br><span class="line">        runResultSB.append(<span class="string">&quot;&lt;br&gt;msg：&quot;</span>).append(runResult.getMsg());</span><br><span class="line"></span><br><span class="line">        runResult.setMsg(runResultSB.toString());</span><br><span class="line">        <span class="keyword">return</span> runResult;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="6）xxl-job-core执行器客户端ExecutorBizClient"><a href="#6）xxl-job-core执行器客户端ExecutorBizClient" class="headerlink" title="6）xxl-job-core执行器客户端ExecutorBizClient"></a>6）xxl-job-core执行器客户端ExecutorBizClient</h5><p>xxl-job-admin执行器客户端调用XxlJobRemotingUtil远程调用工具，通过http请求远程调用指定地址的执行器，并接受返回结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizClient</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//8.1.1调用xxml远程连接工具类rpc调用执行器</span></span><br><span class="line">        <span class="keyword">return</span> XxlJobRemotingUtil.postBody(addressUrl + <span class="string">&quot;run&quot;</span>, accessToken, timeout, triggerParam, String.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobRemotingUtil</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ReturnT <span class="title">postBody</span><span class="params">(String url, String accessToken, <span class="keyword">int</span> timeout, Object requestObj, Class returnTargClassOfT)</span></span>&#123;</span><br><span class="line">        HttpURLConnection connection = <span class="keyword">null</span>;</span><br><span class="line">        BufferedReader bufferedReader = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// connection</span></span><br><span class="line">            URL realUrl = <span class="keyword">new</span> URL(url);</span><br><span class="line">            connection = (HttpURLConnection) realUrl.openConnection();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// trust-https</span></span><br><span class="line">            <span class="keyword">boolean</span> useHttps = url.startsWith(<span class="string">&quot;https&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (useHttps) &#123;</span><br><span class="line">                HttpsURLConnection https = (HttpsURLConnection) connection;</span><br><span class="line">                trustAllHosts(https);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// connection setting</span></span><br><span class="line">            connection.setRequestMethod(<span class="string">&quot;POST&quot;</span>);</span><br><span class="line">            connection.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">            connection.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">            connection.setUseCaches(<span class="keyword">false</span>);</span><br><span class="line">            connection.setReadTimeout(timeout * <span class="number">1000</span>);</span><br><span class="line">            connection.setConnectTimeout(<span class="number">3</span> * <span class="number">1000</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;connection&quot;</span>, <span class="string">&quot;Keep-Alive&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            connection.setRequestProperty(<span class="string">&quot;Accept-Charset&quot;</span>, <span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(accessToken!=<span class="keyword">null</span> &amp;&amp; accessToken.trim().length()&gt;<span class="number">0</span>)&#123;</span><br><span class="line">                connection.setRequestProperty(XXL_JOB_ACCESS_TOKEN, accessToken);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// do connection</span></span><br><span class="line">            connection.connect();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// write requestBody</span></span><br><span class="line">            <span class="keyword">if</span> (requestObj != <span class="keyword">null</span>) &#123;</span><br><span class="line">                String requestBody = GsonTool.toJson(requestObj);</span><br><span class="line"></span><br><span class="line">                DataOutputStream dataOutputStream = <span class="keyword">new</span> DataOutputStream(connection.getOutputStream());</span><br><span class="line">                dataOutputStream.write(requestBody.getBytes(<span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                dataOutputStream.flush();</span><br><span class="line">                dataOutputStream.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/*byte[] requestBodyBytes = requestBody.getBytes(&quot;UTF-8&quot;);</span></span><br><span class="line"><span class="comment">            connection.setRequestProperty(&quot;Content-Length&quot;, String.valueOf(requestBodyBytes.length));</span></span><br><span class="line"><span class="comment">            OutputStream outwritestream = connection.getOutputStream();</span></span><br><span class="line"><span class="comment">            outwritestream.write(requestBodyBytes);</span></span><br><span class="line"><span class="comment">            outwritestream.flush();</span></span><br><span class="line"><span class="comment">            outwritestream.close();*/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid StatusCode</span></span><br><span class="line">            <span class="keyword">int</span> statusCode = connection.getResponseCode();</span><br><span class="line">            <span class="keyword">if</span> (statusCode != <span class="number">200</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;xxl-rpc remoting fail, StatusCode(&quot;</span>+ statusCode +<span class="string">&quot;) invalid. for url : &quot;</span> + url);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// result</span></span><br><span class="line">            bufferedReader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(connection.getInputStream()));</span><br><span class="line">            StringBuilder result = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">            String line;</span><br><span class="line">            <span class="keyword">while</span> ((line = bufferedReader.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                result.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            String resultJson = result.toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// parse returnT</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//8.1.1.1发送http请求到执行器服务器</span></span><br><span class="line">                ReturnT returnT = GsonTool.fromJson(resultJson, ReturnT.class, returnTargClassOfT);</span><br><span class="line">                <span class="keyword">return</span> returnT;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper"><a href="#7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper" class="headerlink" title="7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper"></a>7）xxl-job-admin中注册监控助手JobRegistryMonitorHelper</h5><p>xxl-job-admin中机器注册监控助手：com.xxl.job.admin.core.thread.JobRegistryMonitorHelper注册集群中所有正常状态的机器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span></span>&#123;</span><br><span class="line">		registryThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="comment">//除非调度中心停止，否则秩序执行</span></span><br><span class="line">				<span class="keyword">while</span> (!toStop) &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// auto registry group</span></span><br><span class="line">                        <span class="comment">//1.查询数据库xxl_job_group表中的所有的执行器集群</span></span><br><span class="line">						List&lt;XxlJobGroup&gt; groupList = XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().findByAddressType(<span class="number">0</span>);</span><br><span class="line">						<span class="keyword">if</span> (groupList!=<span class="keyword">null</span> &amp;&amp; !groupList.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                            </span><br><span class="line">							<span class="comment">// remove dead address (admin/executor)</span></span><br><span class="line">                            <span class="comment">//2.所有集群循环删除xxl_job_registry表中注册的所有死亡的机器</span></span><br><span class="line">							List&lt;Integer&gt; ids = XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().findDead(RegistryConfig.DEAD_TIMEOUT, <span class="keyword">new</span> Date());</span><br><span class="line">							<span class="keyword">if</span> (ids!=<span class="keyword">null</span> &amp;&amp; ids.size()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">								XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().removeDead(ids);</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="comment">// fresh online address (admin/executor)</span></span><br><span class="line">                        	<span class="comment">//3.查询出xxl_job_registry表中注册的所有在线的注册机器，并存入容器appAddressMap中</span></span><br><span class="line">							HashMap&lt;String, List&lt;String&gt;&gt; appAddressMap = <span class="keyword">new</span> HashMap&lt;String, List&lt;String&gt;&gt;();</span><br><span class="line">							List&lt;XxlJobRegistry&gt; list = XxlJobAdminConfig.getAdminConfig().getXxlJobRegistryDao().findAll(RegistryConfig.DEAD_TIMEOUT, <span class="keyword">new</span> Date());</span><br><span class="line">							<span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">								<span class="keyword">for</span> (XxlJobRegistry item: list) &#123;</span><br><span class="line">									<span class="keyword">if</span> (RegistryConfig.RegistType.EXECUTOR.name().equals(item.getRegistryGroup())) &#123;</span><br><span class="line">										String appname = item.getRegistryKey();</span><br><span class="line">										List&lt;String&gt; registryList = appAddressMap.get(appname);</span><br><span class="line">										<span class="keyword">if</span> (registryList == <span class="keyword">null</span>) &#123;</span><br><span class="line">											registryList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">										&#125;</span><br><span class="line"></span><br><span class="line">										<span class="keyword">if</span> (!registryList.contains(item.getRegistryValue())) &#123;</span><br><span class="line">											registryList.add(item.getRegistryValue());</span><br><span class="line">										&#125;</span><br><span class="line">										appAddressMap.put(appname, registryList);</span><br><span class="line">									&#125;</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;</span><br><span class="line"></span><br><span class="line">							<span class="comment">// fresh group address</span></span><br><span class="line">                            <span class="comment">//4.更新数据库xxl_job_group表中的集群的机器列表</span></span><br><span class="line">							<span class="keyword">for</span> (XxlJobGroup group: groupList) &#123;</span><br><span class="line">								List&lt;String&gt; registryList = appAddressMap.get(group.getAppname());</span><br><span class="line">								String addressListStr = <span class="keyword">null</span>;</span><br><span class="line">								<span class="keyword">if</span> (registryList!=<span class="keyword">null</span> &amp;&amp; !registryList.isEmpty()) &#123;</span><br><span class="line">									Collections.sort(registryList);</span><br><span class="line">									StringBuilder addressListSB = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">									<span class="keyword">for</span> (String item:registryList) &#123;</span><br><span class="line">										addressListSB.append(item).append(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">									&#125;</span><br><span class="line">									addressListStr = addressListSB.toString();</span><br><span class="line">									addressListStr = addressListStr.substring(<span class="number">0</span>, addressListStr.length()-<span class="number">1</span>);</span><br><span class="line">								&#125;</span><br><span class="line">								group.setAddressList(addressListStr);</span><br><span class="line">								XxlJobAdminConfig.getAdminConfig().getXxlJobGroupDao().update(group);</span><br><span class="line">							&#125;</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">						<span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">							logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread error:&#123;&#125;&quot;</span>, e);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						TimeUnit.SECONDS.sleep(RegistryConfig.BEAT_TIMEOUT);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">						<span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">							logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread error:&#123;&#125;&quot;</span>, e);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, job registry monitor thread stop&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		registryThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">		registryThread.setName(<span class="string">&quot;xxl-job, admin JobRegistryMonitorHelper&quot;</span>);</span><br><span class="line">		registryThread.start();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<h5 id=""><a href="#" class="headerlink" title=""></a></h5><h4 id="三、xxl-job-executor的原理："><a href="#三、xxl-job-executor的原理：" class="headerlink" title="三、xxl-job-executor的原理："></a>三、xxl-job-executor的原理：</h4><h5 id="1）xxl-job-executor项目启动与初始化"><a href="#1）xxl-job-executor项目启动与初始化" class="headerlink" title="1）xxl-job-executor项目启动与初始化"></a>1）xxl-job-executor项目启动与初始化</h5><p>xxl-job-executor是xxl-job工具调度中心，启动运行时加载配置项和初始化类，其中除了初始化绑定了application.properties中配置的参数外，重要的一点是初始化xxl-job-executor的执行者com.xxl.job.core.executor.XxlJobExecutor(springboot的bean模式初始化的是继承的子类XxlJobSpringExecutor)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(XxlJobConfig.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.admin.addresses&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String adminAddresses;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.accessToken&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String accessToken;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.appname&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String appname;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.address&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.ip&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.port&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logpath&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String logPath;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;xxl.job.executor.logretentiondays&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> logRetentionDays;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化XxlJobExecutor类</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> XxlJobSpringExecutor <span class="title">xxlJobExecutor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job config init.&quot;</span>);</span><br><span class="line">        XxlJobSpringExecutor xxlJobSpringExecutor = <span class="keyword">new</span> XxlJobSpringExecutor();</span><br><span class="line">        xxlJobSpringExecutor.setAdminAddresses(adminAddresses);</span><br><span class="line">        xxlJobSpringExecutor.setAppname(appname);</span><br><span class="line">        xxlJobSpringExecutor.setAddress(address);</span><br><span class="line">        xxlJobSpringExecutor.setIp(ip);</span><br><span class="line">        xxlJobSpringExecutor.setPort(port);</span><br><span class="line">        xxlJobSpringExecutor.setAccessToken(accessToken);</span><br><span class="line">        xxlJobSpringExecutor.setLogPath(logPath);</span><br><span class="line">        xxlJobSpringExecutor.setLogRetentionDays(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> xxlJobSpringExecutor;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="2-xxl-job-core执行者XxlJobExecutor"><a href="#2-xxl-job-core执行者XxlJobExecutor" class="headerlink" title="2)xxl-job-core执行者XxlJobExecutor"></a>2)xxl-job-core执行者XxlJobExecutor</h5><p>xxl-job工作依赖于核心模块xxl-job-core，在该项目执行者com.xxl.job.core.executor.XxlJobExecutor做了两个重要作用：</p>
<p>①将xxl-job-exector中编写handler注册到jobHandlerRepository仓库中，将工作线程注册到jobThreadRepository仓库中</p>
<p>②调用父类start方法实例化并启动支撑xxl-job-core功能的重要工具==XxlJobFileAppender==、initAdminBizList、JobLogFileCleanThread、TriggerCallbackThread、==initEmbedServer==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobSpringExecutor</span> <span class="keyword">extends</span> <span class="title">XxlJobExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobSpringExecutor</span> <span class="keyword">extends</span> <span class="title">XxlJobExecutor</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>, <span class="title">SmartInitializingSingleton</span>, <span class="title">DisposableBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(XxlJobSpringExecutor.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// start</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterSingletonsInstantiated</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// init JobHandler Repository</span></span><br><span class="line">        <span class="comment">/*initJobHandlerRepository(applicationContext);*/</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// init JobHandler Repository (for method)</span></span><br><span class="line">        initJobHandlerMethodRepository(applicationContext);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// refresh GlueFactory</span></span><br><span class="line">        GlueFactory.refreshInstance(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// super start</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initJobHandlerMethodRepository</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (applicationContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//1.获取spring容器中所有的类名的数组,所以执行器的类必须注入spring否则获取不到</span></span><br><span class="line">        <span class="comment">// init job handler from method</span></span><br><span class="line">        String[] beanDefinitionNames = applicationContext.getBeanNamesForType(Object.class, <span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">for</span> (String beanDefinitionName : beanDefinitionNames) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//2.循环通过类名获取容器中的类</span></span><br><span class="line">            Object bean = applicationContext.getBean(beanDefinitionName);</span><br><span class="line"></span><br><span class="line">            Map&lt;Method, XxlJob&gt; annotatedMethods = <span class="keyword">null</span>;   <span class="comment">// referred to ：org.springframework.context.event.EventListenerMethodProcessor.processBean</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">				</span><br><span class="line">                <span class="comment">//3.通过MethodIntrospector获取类的方法</span></span><br><span class="line">                annotatedMethods = MethodIntrospector.selectMethods(bean.getClass(),</span><br><span class="line">                        <span class="keyword">new</span> MethodIntrospector.MetadataLookup&lt;XxlJob&gt;() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> XxlJob <span class="title">inspect</span><span class="params">(Method method)</span> </span>&#123;</span><br><span class="line">                                <span class="comment">//4.获取方法上所有的注解</span></span><br><span class="line">                                <span class="keyword">return</span> AnnotatedElementUtils.findMergedAnnotation(method, XxlJob.class);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                logger.error(<span class="string">&quot;xxl-job method-jobhandler resolve error for bean[&quot;</span> + beanDefinitionName + <span class="string">&quot;].&quot;</span>, ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (annotatedMethods==<span class="keyword">null</span> || annotatedMethods.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;Method, XxlJob&gt; methodXxlJobEntry : annotatedMethods.entrySet()) &#123;</span><br><span class="line">                Method method = methodXxlJobEntry.getKey();</span><br><span class="line">                XxlJob xxlJob = methodXxlJobEntry.getValue();</span><br><span class="line">                <span class="keyword">if</span> (xxlJob == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//5.获取注解中的属性值</span></span><br><span class="line">                String name = xxlJob.value();</span><br><span class="line">                <span class="keyword">if</span> (name.trim().length() == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler name invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">//6.注解值为空或者handler的存放容器jobHandlerRepository中已存在该jobHandler时抛出异常，jobHandler是一个			  ConcurrentHashMap</span></span><br><span class="line">                <span class="keyword">if</span> (loadJobHandler(name) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job jobhandler[&quot;</span> + name + <span class="string">&quot;] naming conflicts.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// execute method</span></span><br><span class="line">                <span class="keyword">if</span> (!(method.getParameterTypes().length == <span class="number">1</span> &amp;&amp; method.getParameterTypes()[<span class="number">0</span>].isAssignableFrom(String.class))) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler param-classtype invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] , &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;The correct method format like \&quot; public ReturnT&lt;String&gt; execute(String param) \&quot; .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (!method.getReturnType().isAssignableFrom(ReturnT.class)) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler return-classtype invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] , &quot;</span> +</span><br><span class="line">                            <span class="string">&quot;The correct method format like \&quot; public ReturnT&lt;String&gt; execute(String param) \&quot; .&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// init and destory</span></span><br><span class="line">                Method initMethod = <span class="keyword">null</span>;</span><br><span class="line">                Method destroyMethod = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (xxlJob.init().trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        initMethod = bean.getClass().getDeclaredMethod(xxlJob.init());</span><br><span class="line">                        initMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler initMethod invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (xxlJob.destroy().trim().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        destroyMethod = bean.getClass().getDeclaredMethod(xxlJob.destroy());</span><br><span class="line">                        destroyMethod.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (NoSuchMethodException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job method-jobhandler destroyMethod invalid, for[&quot;</span> + bean.getClass() + <span class="string">&quot;#&quot;</span> + method.getName() + <span class="string">&quot;] .&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// registry jobhandler</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">//7.注册到handler存放的容器jobHandlerRepository中</span></span><br><span class="line">                registJobHandler(name, <span class="keyword">new</span> MethodJobHandler(bean, method, initMethod, destroyMethod));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job handler repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, IJobHandler&gt; jobHandlerRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IJobHandler&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">registJobHandler</span><span class="params">(String name, IJobHandler jobHandler)</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job register jobhandler success, name:&#123;&#125;, jobHandler:&#123;&#125;&quot;</span>, name, jobHandler);</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.put(name, jobHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">loadJobHandler</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.get(name);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ---------------------- job thread repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;Integer, JobThread&gt; jobThreadRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, JobThread&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">registJobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler, String removeOldReason)</span></span>&#123;</span><br><span class="line">        JobThread newJobThread = <span class="keyword">new</span> JobThread(jobId, handler);</span><br><span class="line">        newJobThread.start();</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job regist JobThread success, jobId:&#123;&#125;, handler:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;jobId, handler&#125;);</span><br><span class="line"></span><br><span class="line">        JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);	<span class="comment">// putIfAbsent | oh my god, map&#x27;s put method return the old value!!!</span></span><br><span class="line">        <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldJobThread.toStop(removeOldReason);</span><br><span class="line">            oldJobThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newJobThread;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>==xxl-job执行器handler注册入jobHandlerRepository仓库容器条件：==</p>
<p>==开发xxl-job执行器时要求我们必须==</p>
<p>==1、创建类注入到spring中==</p>
<p>==2、创建JobHandler方法并加上注解@XxlJob(“demoJobHandler”)==</p>
<p>==3、如果是java原生的Bean模式，需要在XxlJobConfig的初始化方法中手动注册handler==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleXxlJob</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Logger logger = LoggerFactory.getLogger(SampleXxlJob.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">            TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>XxlJobSpringExecutor调用父类的start方法实例化XxlJobFileAppender、initAdminBizList、JobLogFileCleanThread、TriggerCallbackThread、initEmbedServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobExecutor</span>  </span>&#123;</span><br><span class="line">	<span class="comment">// ---------------------- start + stop ----------------------</span></span><br><span class="line">    <span class="comment">//初始化xxl-core重要功能模块</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化创建日志路径</span></span><br><span class="line">        XxlJobFileAppender.initLogPath(logPath);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化调度中心列表</span></span><br><span class="line">        initAdminBizList(adminAddresses, accessToken);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化日志清理线程</span></span><br><span class="line">        JobLogFileCleanThread.getInstance().start(logRetentionDays);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化触发回调线程</span></span><br><span class="line">        TriggerCallbackThread.getInstance().start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化嵌入服务</span></span><br><span class="line">        initEmbedServer(address, ip, port, appname, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// ---------------------- admin-client (rpc invoker) ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; adminBizList;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAdminBizList</span><span class="params">(String adminAddresses, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (adminAddresses!=<span class="keyword">null</span> &amp;&amp; adminAddresses.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String address: adminAddresses.trim().split(<span class="string">&quot;,&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (address!=<span class="keyword">null</span> &amp;&amp; address.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">                    AdminBiz adminBiz = <span class="keyword">new</span> AdminBizClient(address.trim(), accessToken);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (adminBizList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        adminBizList = <span class="keyword">new</span> ArrayList&lt;AdminBiz&gt;();</span><br><span class="line">                    &#125;</span><br><span class="line">                    adminBizList.add(adminBiz);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;AdminBiz&gt; <span class="title">getAdminBizList</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> adminBizList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- executor-server (rpc provider) ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> EmbedServer embedServer = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initEmbedServer</span><span class="params">(String address, String ip, <span class="keyword">int</span> port, String appname, String accessToken)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// fill ip port</span></span><br><span class="line">        port = port&gt;<span class="number">0</span>?port: NetUtil.findAvailablePort(<span class="number">9999</span>);</span><br><span class="line">        ip = (ip!=<span class="keyword">null</span>&amp;&amp;ip.trim().length()&gt;<span class="number">0</span>)?ip: IpUtil.getIp();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// generate address</span></span><br><span class="line">        <span class="keyword">if</span> (address==<span class="keyword">null</span> || address.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            String ip_port_address = IpUtil.getIpPort(ip, port);   <span class="comment">// registry-address：default use address to registry , otherwise use ip:port if address is null</span></span><br><span class="line">            address = <span class="string">&quot;http://&#123;ip_port&#125;/&quot;</span>.replace(<span class="string">&quot;&#123;ip_port&#125;&quot;</span>, ip_port_address);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// start</span></span><br><span class="line">        embedServer = <span class="keyword">new</span> EmbedServer();</span><br><span class="line">        embedServer.start(address, port, appname, accessToken);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job handler repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;String, IJobHandler&gt; jobHandlerRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;String, IJobHandler&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">registJobHandler</span><span class="params">(String name, IJobHandler jobHandler)</span></span>&#123;</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job register jobhandler success, name:&#123;&#125;, jobHandler:&#123;&#125;&quot;</span>, name, jobHandler);</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.put(name, jobHandler);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IJobHandler <span class="title">loadJobHandler</span><span class="params">(String name)</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jobHandlerRepository.get(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ---------------------- job thread repository ----------------------</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentMap&lt;Integer, JobThread&gt; jobThreadRepository = <span class="keyword">new</span> ConcurrentHashMap&lt;Integer, JobThread&gt;();</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">registJobThread</span><span class="params">(<span class="keyword">int</span> jobId, IJobHandler handler, String removeOldReason)</span></span>&#123;</span><br><span class="line">        JobThread newJobThread = <span class="keyword">new</span> JobThread(jobId, handler);</span><br><span class="line">        newJobThread.start();</span><br><span class="line">        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job regist JobThread success, jobId:&#123;&#125;, handler:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;jobId, handler&#125;);</span><br><span class="line"></span><br><span class="line">        JobThread oldJobThread = jobThreadRepository.put(jobId, newJobThread);	<span class="comment">// putIfAbsent | oh my god, map&#x27;s put method return the old value!!!</span></span><br><span class="line">        <span class="keyword">if</span> (oldJobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            oldJobThread.toStop(removeOldReason);</span><br><span class="line">            oldJobThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> newJobThread;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JobThread <span class="title">loadJobThread</span><span class="params">(<span class="keyword">int</span> jobId)</span></span>&#123;</span><br><span class="line">        JobThread jobThread = jobThreadRepository.get(jobId);</span><br><span class="line">        <span class="keyword">return</span> jobThread;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3）xxl-job-core的日志操作类XxlJobFileAppender"><a href="#3）xxl-job-core的日志操作类XxlJobFileAppender" class="headerlink" title="3）xxl-job-core的日志操作类XxlJobFileAppender"></a>3）xxl-job-core的日志操作类XxlJobFileAppender</h5><p>XxlJobFileAppender是xxl-core日志操作的类，可以添加日志的XxlJobLogger即使用该类的方法，XxlJobFileAppender日志是写入application.properties配置中的路径和文件中，不在spring的日志文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XxlJobFileAppender</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//初始化日志路径方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initLogPath</span><span class="params">(String logPath)</span></span>&#123;</span><br><span class="line">		<span class="comment">// init</span></span><br><span class="line">		<span class="keyword">if</span> (logPath!=<span class="keyword">null</span> &amp;&amp; logPath.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">			logBasePath = logPath;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// mk base dir</span></span><br><span class="line">		File logPathDir = <span class="keyword">new</span> File(logBasePath);</span><br><span class="line">		<span class="keyword">if</span> (!logPathDir.exists()) &#123;</span><br><span class="line">			logPathDir.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		logBasePath = logPathDir.getPath();</span><br><span class="line"></span><br><span class="line">		<span class="comment">// mk glue dir</span></span><br><span class="line">		File glueBaseDir = <span class="keyword">new</span> File(logPathDir, <span class="string">&quot;gluesource&quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (!glueBaseDir.exists()) &#123;</span><br><span class="line">			glueBaseDir.mkdirs();</span><br><span class="line">		&#125;</span><br><span class="line">		glueSrcPath = glueBaseDir.getPath();</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">   	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * append log</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> logFileName</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> appendLog</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">    <span class="comment">//添加日志内容方法</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">appendLog</span><span class="params">(String logFileName, String appendLog)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// log file</span></span><br><span class="line">		<span class="keyword">if</span> (logFileName==<span class="keyword">null</span> || logFileName.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		File logFile = <span class="keyword">new</span> File(logFileName);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (!logFile.exists()) &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				logFile.createNewFile();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">				logger.error(e.getMessage(), e);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">        </span><br></pre></td></tr></table></figure>
<h5 id="4）xxl-job-core的嵌入服务EmbedServer"><a href="#4）xxl-job-core的嵌入服务EmbedServer" class="headerlink" title="4）xxl-job-core的嵌入服务EmbedServer"></a>4）xxl-job-core的嵌入服务EmbedServer</h5><p>启动一个内嵌的netty服务，用于处理请求的处理，主要做了以下两点任务：</p>
<p>①实例化一个netty服务并绑定了配置的端口，默认9999，并且指定com.xxl.job.core.biz.ExecutorBiz为netty的http服务处理类</p>
<p>②调用执行器注册线程ExecutorRegistryThread的注册方法，将当前执行器的机器注册到调度中心的xxl_job_registry表中，供调度中心调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbedServer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> String address, <span class="keyword">final</span> <span class="keyword">int</span> port, <span class="keyword">final</span> String appname, <span class="keyword">final</span> String accessToken)</span> </span>&#123;</span><br><span class="line">        executorBiz = <span class="keyword">new</span> ExecutorBizImpl();</span><br><span class="line">        thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// param</span></span><br><span class="line">                EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">                EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">                <span class="comment">//1.创建服务线程池</span></span><br><span class="line">                ThreadPoolExecutor bizThreadPool = <span class="keyword">new</span> ThreadPoolExecutor(</span><br><span class="line">                        <span class="number">0</span>,</span><br><span class="line">                        <span class="number">200</span>,</span><br><span class="line">                        <span class="number">60L</span>,</span><br><span class="line">                        TimeUnit.SECONDS,</span><br><span class="line">                        <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;(<span class="number">2000</span>),</span><br><span class="line">                        <span class="keyword">new</span> ThreadFactory() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> Thread <span class="title">newThread</span><span class="params">(Runnable r)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">return</span> <span class="keyword">new</span> Thread(r, <span class="string">&quot;xxl-rpc, EmbedServer bizThreadPool-&quot;</span> + r.hashCode());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="keyword">new</span> RejectedExecutionHandler() &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">rejectedExecution</span><span class="params">(Runnable r, ThreadPoolExecutor executor)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;xxl-job, EmbedServer bizThreadPool is EXHAUSTED!&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// start server</span></span><br><span class="line">                    <span class="number">2</span>、实例化netty的ServerBootstrap并绑定端口监听客户端请求，指定executorBiz为内嵌的netty服务的http服务处理器</span><br><span class="line">                    ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">                    bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                            .channel(NioServerSocketChannel.class)</span><br><span class="line">                            .childHandler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel channel)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                    channel.pipeline()</span><br><span class="line">                                            .addLast(<span class="keyword">new</span> IdleStateHandler(<span class="number">0</span>, <span class="number">0</span>, <span class="number">30</span> * <span class="number">3</span>, TimeUnit.SECONDS))  <span class="comment">// beat 3N, close if idle</span></span><br><span class="line">                                            .addLast(<span class="keyword">new</span> HttpServerCodec())</span><br><span class="line">                                            .addLast(<span class="keyword">new</span> HttpObjectAggregator(<span class="number">5</span> * <span class="number">1024</span> * <span class="number">1024</span>))  <span class="comment">// merge request &amp; reponse to FULL</span></span><br><span class="line">                                            .addLast(<span class="keyword">new</span> EmbedHttpServerHandler(executorBiz, accessToken, bizThreadPool));</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;)</span><br><span class="line">                            .childOption(ChannelOption.SO_KEEPALIVE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// bind</span></span><br><span class="line">                    ChannelFuture future = bootstrap.bind(port).sync();</span><br><span class="line"></span><br><span class="line">                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server start success, nettype = &#123;&#125;, port = &#123;&#125;&quot;</span>, EmbedServer.class, port);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// start registry</span></span><br><span class="line">                    <span class="comment">//3、调用com.xxl.job.core.thread.ExecutorRegistryThread执行器注册线程将执行器注册到xxl_job_registry表中</span></span><br><span class="line">                    startRegistry(appname, address);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// wait util stop</span></span><br><span class="line">                    future.channel().closeFuture().sync();</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">                        logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server stop.&quot;</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        logger.error(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job remoting server error.&quot;</span>, e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// stop</span></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        workerGroup.shutdownGracefully();</span><br><span class="line">                        bossGroup.shutdownGracefully();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        logger.error(e.getMessage(), e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;);</span><br><span class="line">        thread.setDaemon(<span class="keyword">true</span>);	<span class="comment">// daemon, service jvm, user thread leave &gt;&gt;&gt; daemon leave &gt;&gt;&gt; jvm leave</span></span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// ---------------------- registry ----------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startRegistry</span><span class="params">(<span class="keyword">final</span> String appname, <span class="keyword">final</span> String address)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// start registry</span></span><br><span class="line">        ExecutorRegistryThread.getInstance().start(appname, address);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//4、当netty服务接受到客户端的请求时，进入该方法处理</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">process</span><span class="params">(HttpMethod httpMethod, String uri, String requestData, String accessTokenReq)</span> </span>&#123;</span><br><span class="line">            <span class="comment">// valid</span></span><br><span class="line">            <span class="keyword">if</span> (HttpMethod.POST != httpMethod) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, HttpMethod not support.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (uri==<span class="keyword">null</span> || uri.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, uri-mapping empty.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (accessToken!=<span class="keyword">null</span></span><br><span class="line">                    &amp;&amp; accessToken.trim().length()&gt;<span class="number">0</span></span><br><span class="line">                    &amp;&amp; !accessToken.equals(accessTokenReq)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;The access token is wrong.&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// services mapping</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;/beat&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.beat();</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/idleBeat&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    IdleBeatParam idleBeatParam = GsonTool.fromJson(requestData, IdleBeatParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.idleBeat(idleBeatParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/run&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    TriggerParam triggerParam = GsonTool.fromJson(requestData, TriggerParam.class);</span><br><span class="line">                    <span class="comment">//6、该方法再调用ExecutorBiz处理</span></span><br><span class="line">                    <span class="keyword">return</span> executorBiz.run(triggerParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/kill&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    KillParam killParam = GsonTool.fromJson(requestData, KillParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.kill(killParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;/log&quot;</span>.equals(uri)) &#123;</span><br><span class="line">                    LogParam logParam = GsonTool.fromJson(requestData, LogParam.class);</span><br><span class="line">                    <span class="keyword">return</span> executorBiz.log(logParam);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;invalid request, uri-mapping(&quot;</span>+ uri +<span class="string">&quot;) not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                logger.error(e.getMessage(), e);</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;request error:&quot;</span> + ThrowableUtil.toString(e));</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="5）xxl-job-core的请求处理服务类ExecutorBiz"><a href="#5）xxl-job-core的请求处理服务类ExecutorBiz" class="headerlink" title="5）xxl-job-core的请求处理服务类ExecutorBiz"></a>5）xxl-job-core的请求处理服务类ExecutorBiz</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizImpl</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">run</span><span class="params">(TriggerParam triggerParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// load old：jobHandler + jobThread</span></span><br><span class="line">        <span class="comment">//1、调用XxlJobExecutor的加载线程方法获得jobThreadRepository线程仓库获得线程</span></span><br><span class="line">        JobThread jobThread = XxlJobExecutor.loadJobThread(triggerParam.getJobId());</span><br><span class="line">        <span class="comment">//2、如果线程不为null则从线程获取处理器</span></span><br><span class="line">        IJobHandler jobHandler = jobThread!=<span class="keyword">null</span>?jobThread.getHandler():<span class="keyword">null</span>;</span><br><span class="line">        String removeOldReason = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// valid：jobHandler + jobThread</span></span><br><span class="line">        GlueTypeEnum glueTypeEnum = GlueTypeEnum.match(triggerParam.getGlueType());</span><br><span class="line">        <span class="keyword">if</span> (GlueTypeEnum.BEAN == glueTypeEnum) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// new jobhandler</span></span><br><span class="line">            <span class="comment">//3、如果是Bean模式，则调用执行者registJobThread的方法从jobHandlerRepository执行器仓库获取一个新执行者</span></span><br><span class="line">            IJobHandler newJobHandler = XxlJobExecutor.loadJobHandler(triggerParam.getExecutorHandler());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid old jobThread</span></span><br><span class="line">            <span class="keyword">if</span> (jobThread!=<span class="keyword">null</span> &amp;&amp; jobHandler != newJobHandler) &#123;</span><br><span class="line">                <span class="comment">// change handler, need kill old thread</span></span><br><span class="line">                removeOldReason = <span class="string">&quot;change jobhandler or glue type, and terminate the old job thread.&quot;</span>;</span><br><span class="line"></span><br><span class="line">                jobThread = <span class="keyword">null</span>;</span><br><span class="line">                jobHandler = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// valid handler</span></span><br><span class="line">            <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//4、如果获得handler和线程中旧handler不相等，就替换成新的handler</span></span><br><span class="line">                jobHandler = newJobHandler;</span><br><span class="line">                <span class="keyword">if</span> (jobHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;job handler [&quot;</span> + triggerParam.getExecutorHandler() + <span class="string">&quot;] not found.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// executor block strategy</span></span><br><span class="line">        <span class="comment">//4、如果工作线程不为空</span></span><br><span class="line">        <span class="keyword">if</span> (jobThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">//5、根据触发参数的并行策略决定，是否创建新线程，是否停止旧线程</span></span><br><span class="line">            ExecutorBlockStrategyEnum blockStrategy = ExecutorBlockStrategyEnum.match(triggerParam.getExecutorBlockStrategy(), <span class="keyword">null</span>);</span><br><span class="line">            <span class="comment">//6、如果是丢弃后来的策略，就报错不可执行</span></span><br><span class="line">            <span class="keyword">if</span> (ExecutorBlockStrategyEnum.DISCARD_LATER == blockStrategy) &#123;</span><br><span class="line">                <span class="comment">// discard when running</span></span><br><span class="line">                <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;block strategy effect：&quot;</span>+ExecutorBlockStrategyEnum.DISCARD_LATER.getTitle());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//7、如果是覆盖旧线程的策略，则旧线程清除</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ExecutorBlockStrategyEnum.COVER_EARLY == blockStrategy) &#123;</span><br><span class="line">                <span class="comment">// kill running jobThread</span></span><br><span class="line">                <span class="keyword">if</span> (jobThread.isRunningOrHasQueue()) &#123;</span><br><span class="line">                    removeOldReason = <span class="string">&quot;block strategy effect：&quot;</span> + ExecutorBlockStrategyEnum.COVER_EARLY.getTitle();</span><br><span class="line"></span><br><span class="line">                    jobThread = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// just queue trigger</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// replace thread (new or exists invalid)</span></span><br><span class="line">        <span class="comment">//8、如果当前线程为空，根据触发的任务id和jobhandler注册一个新的线程</span></span><br><span class="line">        <span class="keyword">if</span> (jobThread == <span class="keyword">null</span>) &#123;</span><br><span class="line">            jobThread = XxlJobExecutor.registJobThread(triggerParam.getJobId(), jobHandler, removeOldReason);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// push data to queue</span></span><br><span class="line">        <span class="comment">//9、将新的触发数据，放入线程触发队列中，等待触发执行</span></span><br><span class="line">        ReturnT&lt;String&gt; pushResult = jobThread.pushTriggerQueue(triggerParam);</span><br><span class="line">        <span class="keyword">return</span> pushResult;</span><br></pre></td></tr></table></figure>
<h5 id="6）xxl-job-core中的执行线程JobThread（重要）"><a href="#6）xxl-job-core中的执行线程JobThread（重要）" class="headerlink" title="6）xxl-job-core中的执行线程JobThread（重要）"></a>6）xxl-job-core中的执行线程JobThread（重要）</h5><p>xxl-job-core是执行任务的核心工作模块，调起任务时运行其中的com.xxl.job.core.thread.JobThread类中run方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">public class JobThread extends Thread&#123;</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F;将触发参数放入触发队列中</span><br><span class="line">	public ReturnT&lt;String&gt; pushTriggerQueue(TriggerParam triggerParam) &#123;</span><br><span class="line">		&#x2F;&#x2F; avoid repeat</span><br><span class="line">		if (triggerLogIdSet.contains(triggerParam.getLogId())) &#123;</span><br><span class="line">			logger.info(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; repeate trigger job, logId:&#123;&#125;&quot;, triggerParam.getLogId());</span><br><span class="line">			return new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, &quot;repeate trigger job, logId:&quot; + triggerParam.getLogId());</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		triggerLogIdSet.add(triggerParam.getLogId());</span><br><span class="line">		triggerQueue.add(triggerParam);</span><br><span class="line">        return ReturnT.SUCCESS;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">    @Override</span><br><span class="line">	public void run() &#123;</span><br><span class="line"></span><br><span class="line">    	&#x2F;&#x2F; init</span><br><span class="line">    	try &#123;</span><br><span class="line">			handler.init();</span><br><span class="line">		&#125; catch (Throwable e) &#123;</span><br><span class="line">    		logger.error(e.getMessage(), e);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		&#x2F;&#x2F; execute</span><br><span class="line">		while(!toStop)&#123;</span><br><span class="line">			running &#x3D; false;</span><br><span class="line">			idleTimes++;</span><br><span class="line"></span><br><span class="line">            TriggerParam triggerParam &#x3D; null;</span><br><span class="line">            ReturnT&lt;String&gt; executeResult &#x3D; null;</span><br><span class="line">            try &#123;</span><br><span class="line">				&#x2F;&#x2F; to check toStop signal, we need cycle, so wo cannot use queue.take(), instand of poll(timeout)</span><br><span class="line">				&#x2F;&#x2F;1、每3秒从触发队列里面poll一个触发参数</span><br><span class="line">				triggerParam &#x3D; triggerQueue.poll(3L, TimeUnit.SECONDS);</span><br><span class="line">				if (triggerParam!&#x3D;null) &#123;</span><br><span class="line">					running &#x3D; true;</span><br><span class="line">					idleTimes &#x3D; 0;</span><br><span class="line">					&#x2F;&#x2F;2、如果该触发任务正在进行中，旧删除原触发日志</span><br><span class="line">					triggerLogIdSet.remove(triggerParam.getLogId());</span><br><span class="line"></span><br><span class="line">					&#x2F;&#x2F; log filename, like &quot;logPath&#x2F;yyyy-MM-dd&#x2F;9999.log&quot;</span><br><span class="line">					&#x2F;&#x2F;3、重新创建日志文件，并初始化工作上下文容器的值</span><br><span class="line">					String logFileName &#x3D; XxlJobFileAppender.makeLogFileName(new Date(triggerParam.getLogDateTime()), triggerParam.getLogId());</span><br><span class="line">					XxlJobContext.setXxlJobContext(new XxlJobContext(</span><br><span class="line">							triggerParam.getLogId(),</span><br><span class="line">							logFileName,</span><br><span class="line">							triggerParam.getBroadcastIndex(),</span><br><span class="line">							triggerParam.getBroadcastTotal()));</span><br><span class="line"></span><br><span class="line">					&#x2F;&#x2F; execute</span><br><span class="line">					&#x2F;&#x2F;4、打印线程开始执行日志（熟悉的味道）</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute start -----------&lt;br&gt;----------- Param:&quot; + triggerParam.getExecutorParams());</span><br><span class="line"></span><br><span class="line">					if (triggerParam.getExecutorTimeout() &gt; 0) &#123;</span><br><span class="line">						&#x2F;&#x2F; limit timeout</span><br><span class="line">						Thread futureThread &#x3D; null;</span><br><span class="line">						try &#123;</span><br><span class="line">							final TriggerParam triggerParamTmp &#x3D; triggerParam;</span><br><span class="line">							FutureTask&lt;ReturnT&lt;String&gt;&gt; futureTask &#x3D; new FutureTask&lt;ReturnT&lt;String&gt;&gt;(new Callable&lt;ReturnT&lt;String&gt;&gt;() &#123;</span><br><span class="line">								@Override</span><br><span class="line">								public ReturnT&lt;String&gt; call() throws Exception &#123;</span><br><span class="line">									&#x2F;&#x2F;5.handler执行该任务</span><br><span class="line">									return handler.execute(triggerParamTmp.getExecutorParams());</span><br><span class="line">								&#125;</span><br><span class="line">							&#125;);</span><br><span class="line">							&#x2F;&#x2F;6.开辟新的线程异步获取handler执行结果</span><br><span class="line">							futureThread &#x3D; new Thread(futureTask);</span><br><span class="line">							futureThread.start();</span><br><span class="line"></span><br><span class="line">							executeResult &#x3D; futureTask.get(triggerParam.getExecutorTimeout(), TimeUnit.SECONDS);</span><br><span class="line">						&#125; catch (TimeoutException e) &#123;</span><br><span class="line">							&#x2F;&#x2F;7、如果执行超时打印超时日志，并创建执行超时返回结果</span><br><span class="line">							XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute timeout&quot;);</span><br><span class="line">							XxlJobLogger.log(e);</span><br><span class="line"></span><br><span class="line">							executeResult &#x3D; new ReturnT&lt;String&gt;(IJobHandler.FAIL_TIMEOUT.getCode(), &quot;job execute timeout &quot;);</span><br><span class="line">						&#125; finally &#123;</span><br><span class="line">							futureThread.interrupt();</span><br><span class="line">						&#125;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">					&#x2F;&#x2F;8、执行成功，设置执行信息，打印执行成功日志</span><br><span class="line">						&#x2F;&#x2F; just execute</span><br><span class="line">						executeResult &#x3D; handler.execute(triggerParam.getExecutorParams());</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					if (executeResult &#x3D;&#x3D; null) &#123;</span><br><span class="line">						executeResult &#x3D; IJobHandler.FAIL;</span><br><span class="line">					&#125; else &#123;</span><br><span class="line">						executeResult.setMsg(</span><br><span class="line">								(executeResult!&#x3D;null&amp;&amp;executeResult.getMsg()!&#x3D;null&amp;&amp;executeResult.getMsg().length()&gt;50000)</span><br><span class="line">										?executeResult.getMsg().substring(0, 50000).concat(&quot;...&quot;)</span><br><span class="line">										:executeResult.getMsg());</span><br><span class="line">						executeResult.setContent(null);	&#x2F;&#x2F; limit obj size</span><br><span class="line">					&#125;</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- xxl-job job execute end(finish) -----------&lt;br&gt;----------- ReturnT:&quot; + executeResult);</span><br><span class="line"></span><br><span class="line">				&#125; else &#123;</span><br><span class="line">				&#x2F;&#x2F;9、调度次数超过30次删除该调度任务</span><br><span class="line">					if (idleTimes &gt; 30) &#123;</span><br><span class="line">						if(triggerQueue.size() &#x3D;&#x3D; 0) &#123;	&#x2F;&#x2F; avoid concurrent trigger causes jobId-lost</span><br><span class="line">							XxlJobExecutor.removeJobThread(jobId, &quot;excutor idel times over limit.&quot;);</span><br><span class="line">						&#125;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; catch (Throwable e) &#123;</span><br><span class="line">				if (toStop) &#123;</span><br><span class="line">					XxlJobLogger.log(&quot;&lt;br&gt;----------- JobThread toStop, stopReason:&quot; + stopReason);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				StringWriter stringWriter &#x3D; new StringWriter();</span><br><span class="line">				e.printStackTrace(new PrintWriter(stringWriter));</span><br><span class="line">				String errorMsg &#x3D; stringWriter.toString();</span><br><span class="line">				executeResult &#x3D; new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, errorMsg);</span><br><span class="line"></span><br><span class="line">				XxlJobLogger.log(&quot;&lt;br&gt;----------- JobThread Exception:&quot; + errorMsg + &quot;&lt;br&gt;----------- xxl-job job execute end(error) -----------&quot;);</span><br><span class="line">			&#125; finally &#123;</span><br><span class="line">                if(triggerParam !&#x3D; null) &#123;</span><br><span class="line">                    &#x2F;&#x2F; callback handler info</span><br><span class="line">                    if (!toStop) &#123;</span><br><span class="line">                        &#x2F;&#x2F;10、触发回调线程调用xxl-job的回调接口，将执行结果返回给调度中心</span><br><span class="line">                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(triggerParam.getLogId(), triggerParam.getLogDateTime(), executeResult));</span><br><span class="line">                    &#125; else &#123;</span><br><span class="line">                        &#x2F;&#x2F; is killed</span><br><span class="line">                        ReturnT&lt;String&gt; stopResult &#x3D; new ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, stopReason + &quot; [job running, killed]&quot;);</span><br><span class="line">                        TriggerCallbackThread.pushCallBack(new HandleCallbackParam(triggerParam.getLogId(), triggerParam.getLogDateTime(), stopResult));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>
<h4 id="-1"><a href="#-1" class="headerlink" title=""></a></h4><h5 id="7）xxl-job的执行器注册线程ExecutorRegistryThread"><a href="#7）xxl-job的执行器注册线程ExecutorRegistryThread" class="headerlink" title="7）xxl-job的执行器注册线程ExecutorRegistryThread"></a>7）xxl-job的执行器注册线程ExecutorRegistryThread</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorRegistryThread</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(<span class="keyword">final</span> String appname, <span class="keyword">final</span> String address)</span></span>&#123;</span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (appname==<span class="keyword">null</span> || appname.trim().length()==<span class="number">0</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry config fail, appname is null.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (XxlJobExecutor.getAdminBizList() == <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry config fail, adminAddresses is null.&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        registryThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// registry</span></span><br><span class="line">                <span class="keyword">while</span> (!toStop) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//1、创建一个xxl_job_registry注册表的实体对象</span></span><br><span class="line">                        RegistryParam registryParam = <span class="keyword">new</span> RegistryParam(RegistryConfig.RegistType.EXECUTOR.name(), appname, address);</span><br><span class="line">                        <span class="comment">//2、对调度中心地址列表循环，application.properties中配置的xxl.job.admin.addresses</span></span><br><span class="line">                        <span class="keyword">for</span> (AdminBiz adminBiz: XxlJobExecutor.getAdminBizList()) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="comment">//3、调用AdminBizImpl注册方法，将执行器机器注册到每个调度中心</span></span><br><span class="line">                                ReturnT&lt;String&gt; registryResult = adminBiz.registry(registryParam);</span><br><span class="line">                                <span class="keyword">if</span> (registryResult!=<span class="keyword">null</span> &amp;&amp; ReturnT.SUCCESS_CODE == registryResult.getCode()) &#123;</span><br><span class="line">                                    registryResult = ReturnT.SUCCESS;</span><br><span class="line">                                    logger.debug(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry success, registryParam:&#123;&#125;, registryResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;registryParam, registryResult&#125;);</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry fail, registryParam:&#123;&#125;, registryResult:&#123;&#125;&quot;</span>, <span class="keyword">new</span> Object[]&#123;registryParam, registryResult&#125;);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                logger.info(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job registry error, registryParam:&#123;&#125;&quot;</span>, registryParam, e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            logger.error(e.getMessage(), e);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            TimeUnit.SECONDS.sleep(RegistryConfig.BEAT_TIMEOUT);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!toStop) &#123;</span><br><span class="line">                            logger.warn(<span class="string">&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; xxl-job, executor registry thread interrupted, error msg:&#123;&#125;&quot;</span>, e.getMessage());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AdminBizImpl</span> <span class="keyword">implements</span> <span class="title">AdminBiz</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">registry</span><span class="params">(RegistryParam registryParam)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// valid</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(registryParam.getRegistryGroup())</span><br><span class="line">                || !StringUtils.hasText(registryParam.getRegistryKey())</span><br><span class="line">                || !StringUtils.hasText(registryParam.getRegistryValue())) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;String&gt;(ReturnT.FAIL_CODE, <span class="string">&quot;Illegal Argument.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> ret = xxlJobRegistryDao.registryUpdate(registryParam.getRegistryGroup(), registryParam.getRegistryKey(), registryParam.getRegistryValue(), <span class="keyword">new</span> Date());</span><br><span class="line">        <span class="keyword">if</span> (ret &lt; <span class="number">1</span>) &#123;</span><br><span class="line">            xxlJobRegistryDao.registrySave(registryParam.getRegistryGroup(), registryParam.getRegistryKey(), registryParam.getRegistryValue(), <span class="keyword">new</span> Date());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// fresh</span></span><br><span class="line">            freshGroupRegistryInfo(registryParam);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h4 id="四、xxl-job项目的日志分析"><a href="#四、xxl-job项目的日志分析" class="headerlink" title="四、xxl-job项目的日志分析"></a>四、xxl-job项目的日志分析</h4><h5 id="1-项目的spring日志"><a href="#1-项目的spring日志" class="headerlink" title="1)项目的spring日志"></a>1)项目的spring日志</h5><p>与普通项目spring日志相同查看方式，xxl-job-admin和xxl-job-executor项目的spring日志分别记录项目启动和基本服务的日志</p>
<h5 id="2-调度日志列表"><a href="#2-调度日志列表" class="headerlink" title="2)调度日志列表"></a>2)调度日志列表</h5><p>请求了url：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120547.png" alt="image-20201028091534918"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/pageList&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">pageList</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="meta">@RequestParam(required = false, defaultValue = &quot;0&quot;)</span> <span class="keyword">int</span> start,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="meta">@RequestParam(required = false, defaultValue = &quot;10&quot;)</span> <span class="keyword">int</span> length,</span></span></span><br><span class="line"><span class="function"><span class="params">									<span class="keyword">int</span> jobGroup, <span class="keyword">int</span> jobId, <span class="keyword">int</span> logStatus, String filterTime)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// valid permission</span></span><br><span class="line">	JobInfoController.validPermission(request, jobGroup);	<span class="comment">// 仅管理员支持查询全部；普通用户仅支持查询有权限的 jobGroup</span></span><br><span class="line">	</span><br><span class="line">	<span class="comment">// parse param</span></span><br><span class="line">	Date triggerTimeStart = <span class="keyword">null</span>;</span><br><span class="line">	Date triggerTimeEnd = <span class="keyword">null</span>;</span><br><span class="line">	<span class="keyword">if</span> (filterTime!=<span class="keyword">null</span> &amp;&amp; filterTime.trim().length()&gt;<span class="number">0</span>) &#123;</span><br><span class="line">		String[] temp = filterTime.split(<span class="string">&quot; - &quot;</span>);</span><br><span class="line">		<span class="keyword">if</span> (temp.length == <span class="number">2</span>) &#123;</span><br><span class="line">			triggerTimeStart = DateUtil.parseDateTime(temp[<span class="number">0</span>]);</span><br><span class="line">			triggerTimeEnd = DateUtil.parseDateTime(temp[<span class="number">1</span>]);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// page query</span></span><br><span class="line">	List&lt;XxlJobLog&gt; list = xxlJobLogDao.pageList(start, length, jobGroup, jobId, triggerTimeStart, triggerTimeEnd, logStatus);</span><br><span class="line">	<span class="keyword">int</span> list_count = xxlJobLogDao.pageListCount(start, length, jobGroup, jobId, triggerTimeStart, triggerTimeEnd, logStatus);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// package result</span></span><br><span class="line">	Map&lt;String, Object&gt; maps = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">    maps.put(<span class="string">&quot;recordsTotal&quot;</span>, list_count);		<span class="comment">// 总记录数</span></span><br><span class="line">    maps.put(<span class="string">&quot;recordsFiltered&quot;</span>, list_count);	<span class="comment">// 过滤后的总记录数</span></span><br><span class="line">    maps.put(<span class="string">&quot;data&quot;</span>, list);  					<span class="comment">// 分页列表</span></span><br><span class="line">	<span class="keyword">return</span> maps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;pageList&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;XxlJobLog&quot;</span>&gt;</span></span><br><span class="line">	SELECT <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">&quot;Base_Column_List&quot;</span> /&gt;</span></span><br><span class="line">	FROM xxl_job_log AS t</span><br><span class="line">	<span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">&quot;WHERE&quot;</span> <span class="attr">prefixOverrides</span>=<span class="string">&quot;AND | OR&quot;</span> &gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;jobId==0 and jobGroup gt 0&quot;</span>&gt;</span></span><br><span class="line">			AND t.job_group = #&#123;jobGroup&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;jobId gt 0&quot;</span>&gt;</span></span><br><span class="line">			AND t.job_id = #&#123;jobId&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;triggerTimeStart != null&quot;</span>&gt;</span></span><br><span class="line">			AND t.trigger_time &lt;![CDATA[ &gt;= ]]&gt; #&#123;triggerTimeStart&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;triggerTimeEnd != null&quot;</span>&gt;</span></span><br><span class="line">			AND t.trigger_time &lt;![CDATA[ &lt;= ]]&gt; #&#123;triggerTimeEnd&#125;</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 1&quot;</span> &gt;</span></span><br><span class="line">			AND t.handle_code = 200</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 2&quot;</span> &gt;</span></span><br><span class="line">			AND (</span><br><span class="line">				t.trigger_code NOT IN (0, 200) OR</span><br><span class="line">				t.handle_code NOT IN (0, 200)</span><br><span class="line">			)</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;logStatus == 3&quot;</span> &gt;</span></span><br><span class="line">			AND t.trigger_code = 200</span><br><span class="line">			AND t.handle_code = 0</span><br><span class="line">		<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span><br><span class="line">	ORDER BY t.trigger_time DESC</span><br><span class="line">	LIMIT #&#123;offset&#125;, #&#123;pagesize&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="3-执行日志详情"><a href="#3-执行日志详情" class="headerlink" title="3)执行日志详情"></a>3)执行日志详情</h5><p>请求了url：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111120555.png" alt="image-20201028091927853"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/logDetailCat&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;LogResult&gt; <span class="title">logDetailCat</span><span class="params">(String executorAddress, <span class="keyword">long</span> triggerTime, <span class="keyword">long</span> logId, <span class="keyword">int</span> fromLineNum)</span></span>&#123;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">//通过admin的调度器XxlJobScheduler获取执行器客户端</span></span><br><span class="line">		ExecutorBiz executorBiz = XxlJobScheduler.getExecutorBiz(executorAddress);</span><br><span class="line">           </span><br><span class="line">           <span class="comment">//远程调用获取日志</span></span><br><span class="line">		ReturnT&lt;LogResult&gt; logResult = executorBiz.log(<span class="keyword">new</span> LogParam(triggerTime, logId, fromLineNum));</span><br><span class="line"></span><br><span class="line">		<span class="comment">// is end</span></span><br><span class="line">           <span class="keyword">if</span> (logResult.getContent()!=<span class="keyword">null</span> &amp;&amp; logResult.getContent().getFromLineNum() &gt; logResult.getContent().getToLineNum()) &#123;</span><br><span class="line">               XxlJobLog jobLog = xxlJobLogDao.load(logId);</span><br><span class="line">               <span class="keyword">if</span> (jobLog.getHandleCode() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   logResult.getContent().setEnd(<span class="keyword">true</span>);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> logResult;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		logger.error(e.getMessage(), e);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;LogResult&gt;(ReturnT.FAIL_CODE, e.getMessage());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>xxl-job-core中处理客户端http请求的com.xxl.job.core.biz.impl.ExecutorBizImpl的log方法读取日志内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExecutorBizImpl</span> <span class="keyword">implements</span> <span class="title">ExecutorBiz</span> </span>&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReturnT&lt;LogResult&gt; <span class="title">log</span><span class="params">(LogParam logParam)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// log filename: logPath/yyyy-MM-dd/9999.log</span></span><br><span class="line">        String logFileName = XxlJobFileAppender.makeLogFileName(<span class="keyword">new</span> Date(logParam.getLogDateTim()), logParam.getLogId());</span><br><span class="line"></span><br><span class="line">        LogResult logResult = XxlJobFileAppender.readLog(logFileName, logParam.getFromLineNum());</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ReturnT&lt;LogResult&gt;(logResult);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="五、BCRM项目中xxl-job实际执行问题分析"><a href="#五、BCRM项目中xxl-job实际执行问题分析" class="headerlink" title="五、BCRM项目中xxl-job实际执行问题分析"></a>五、BCRM项目中xxl-job实际执行问题分析</h4><h5 id="问题案例1："><a href="#问题案例1：" class="headerlink" title="问题案例1："></a>问题案例1：</h5><p>问题：近期生产上BCRM项目xxl-job调度中心一个调度任务报表中没有其执行结果，有该任务调度日志，但是没有执行器处理结果和执行日志，无法得知执行流程</p>
<p>解决方法：</p>
<p>xxl-job常规问题排查流程</p>
<p>1）查询数据库xxl_job_log表或调度中心调度日志，查看调度任务步骤、任务id、执行器信息等</p>
<p>2）查看spring日志，查看交易是否调起，线程执行到哪一步</p>
<p>3）xxl-job_executor配置的xxl-job的路径下查看是否有该任务的xxl-job执行器日志</p>
<p>最终得知从xxl-job执行器的日志中查到问题原因，是该执行器中循环拼接30万条数据插入数据库sql语句，导致sql语句长度超过mysql数据库的最大限制，所以插入数据失败，同时因为循环打印日志，导致xxl-job执行器的日志达到17MB，==日志文件过大调度中心通过http请求加载日志加载不出来==</p>
<h5 id="问题案例2："><a href="#问题案例2：" class="headerlink" title="问题案例2："></a>问题案例2：</h5><p>问题：BCRM某执行器执行失败，调度日志显示执行结果code=500，没有报错信息无法指导失败原因</p>
<p>解决方法：</p>
<p>xxl-job-admin调度中心触发执行任务，本质就是向xxl-job-executor执行器的内嵌netty服务发起http协议的请求，远程rpc调用JobHandler,JobHandler最终将执行器处理结果ReturnT通过回调接口返回调度中心，</p>
<p>该问题调度中心收到500的错误码，所以调度中心和执行器之间的请求和回调流程是正常走完的，这属于业务上报错</p>
<p>由于该执行器模块的开发者未注意开发规范，执行器方法中既未使用slf4j日志模块打印spring日志，也未使用XxlJobLogger.log打印xxl-job执行日志，所以造成定位该业务报错困难，==请代码严格遵守开发规范阶段性打印spring和xxl-job日志，方便后期跟踪排查==</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1、简单任务示例（Bean模式）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@XxlJob(&quot;demoJobHandler&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReturnT&lt;String&gt; <span class="title">demoJobHandler</span><span class="params">(String param)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    XxlJobLogger.log(<span class="string">&quot;XXL-JOB, Hello World.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        XxlJobLogger.log(<span class="string">&quot;beat at:&quot;</span> + i);</span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ReturnT.SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Spring Scheduler脚本调度的痛点</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" data-id="ckk2gq3um001vz8pq2axy9qrx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/Github+jsDelivr+PicGo%E5%AE%9E%E7%8E%B0%E5%85%8D%E8%B4%B9%E5%9B%BE%E5%BA%8A/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/01/18/XXL-JOB%E5%88%86%E5%B8%83%E5%BC%8F%E8%B0%83%E5%BA%A6/XXL-JOB%E4%BB%BB%E5%8A%A1%E8%B0%83%E5%BA%A6%E7%AC%94%E8%AE%B0/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>