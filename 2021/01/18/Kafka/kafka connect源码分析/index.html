<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="[toc] 1、安装并启动zookeeperkafka运行依赖zookeeper，下载部署zookeeper后，&#x2F;conf&#x2F;zoo.cfg配置zookeeper 1234567891011121314151617181920212223242526272829# The number of milliseconds of each ticktickTime&#x3D;2000# The number of">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/01/18/Kafka/kafka%20connect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="[toc] 1、安装并启动zookeeperkafka运行依赖zookeeper，下载部署zookeeper后，&#x2F;conf&#x2F;zoo.cfg配置zookeeper 1234567891011121314151617181920212223242526272829# The number of milliseconds of each ticktickTime&#x3D;2000# The number of">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-18T11:01:37.489Z">
<meta property="article:modified_time" content="2021-01-18T01:33:46.862Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Kafka/kafka connect源码分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Kafka/kafka%20connect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.489Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[toc]</p>
<h3 id="1、安装并启动zookeeper"><a href="#1、安装并启动zookeeper" class="headerlink" title="1、安装并启动zookeeper"></a>1、安装并启动zookeeper</h3><p>kafka运行依赖zookeeper，下载部署zookeeper后，/conf/zoo.cfg配置zookeeper</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=D:/WorkSoft/apache-zookeeper-3.5.8-bin/dataDir</span><br><span class="line">dataLogDir=D:/WorkSoft/apache-zookeeper-3.5.8-bin/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximum number of client connections.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Be sure to read the maintenance section of the</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># The number of snapshots to retain in dataDir</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Purge task interval <span class="keyword">in</span> hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to <span class="string">&quot;0&quot;</span> to <span class="built_in">disable</span> auto purge feature</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.purgeInterval=1</span></span><br></pre></td></tr></table></figure>
<p>执行./bin/zkServer.sh启动zookeeper</p>
<h3 id="2、安装并启动kafka"><a href="#2、安装并启动kafka" class="headerlink" title="2、安装并启动kafka"></a>2、安装并启动kafka</h3><p>下载并部署kafka到后，在config/server.properties文件中配置kafka，zookeeper.connect配置zookeeper地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this work <span class="keyword">for</span> additional information regarding copyright ownership.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (the <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> see kafka.server.KafkaConfig <span class="keyword">for</span> additional details and defaults</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The id of the broker. This must be <span class="built_in">set</span> to a unique <span class="built_in">integer</span> <span class="keyword">for</span> each broker.</span></span><br><span class="line">broker.id=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Socket Server Settings #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The address the socket server listens on. It will get the value returned from</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> java.net.InetAddress.getCanonicalHostName() <span class="keyword">if</span> not configured.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   FORMAT:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   EXAMPLE:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line">listeners=PLAINTEXT://0.0.0.0:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Hostname and port the broker will advertise to producers and consumers. If not <span class="built_in">set</span>,</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> it uses the value <span class="keyword">for</span> <span class="string">&quot;listeners&quot;</span> <span class="keyword">if</span> configured.  Otherwise, it will use the value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> returned from java.net.InetAddress.getCanonicalHostName().</span></span><br><span class="line">advertised.listeners=PLAINTEXT://127.0.0.1:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Maps listener names to security protocols, the default is <span class="keyword">for</span> them to be the same. See the config documentation <span class="keyword">for</span> more details</span></span><br><span class="line"><span class="meta">#</span><span class="bash">listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads that the server uses <span class="keyword">for</span> receiving requests from the network and sending responses to the network</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads that the server uses <span class="keyword">for</span> processing requests, <span class="built_in">which</span> may include disk I/O</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The send buffer (SO_SNDBUF) used by the socket server</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The receive buffer (SO_RCVBUF) used by the socket server</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum size of a request that the socket server will accept (protection against OOM)</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Basics #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A comma separated list of directories under <span class="built_in">which</span> to store <span class="built_in">log</span> files</span></span><br><span class="line">log.dirs=/kafka/logs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default number of <span class="built_in">log</span> partitions per topic. More partitions allow greater</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> parallelism <span class="keyword">for</span> consumption, but this will also result <span class="keyword">in</span> more files across</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the brokers.</span></span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads per data directory to be used <span class="keyword">for</span> <span class="built_in">log</span> recovery at startup and flushing at shutdown.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This value is recommended to be increased <span class="keyword">for</span> installations with data <span class="built_in">dirs</span> located <span class="keyword">in</span> RAID array.</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Internal Topic Settings  #############################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The replication factor <span class="keyword">for</span> the group metadata internal topics <span class="string">&quot;__consumer_offsets&quot;</span> and <span class="string">&quot;__transaction_state&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For anything other than development testing, a value greater than 1 is recommended to ensure availability such as 3.</span></span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Flush Policy #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Messages are immediately written to the filesystem but by default we only fsync() to sync</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the OS cache lazily. The following configurations control the flush of data to disk.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> There are a few important trade-offs here:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    1. Durability: Unflushed data may be lost <span class="keyword">if</span> you are not using replication.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The settings below allow one to configure the flush policy to flush data after a period of time or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> every N messages (or both). This can be <span class="keyword">done</span> globally and overridden on a per-topic basis.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.messages=10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum amount of time a message can sit <span class="keyword">in</span> a <span class="built_in">log</span> before we force a flush</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.ms=1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Retention Policy #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following configurations control the disposal of <span class="built_in">log</span> segments. The policy can</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be <span class="built_in">set</span> to delete segments after a period of time, or after a given size has accumulated.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> from the end of the <span class="built_in">log</span>.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The minimum age of a <span class="built_in">log</span> file to be eligible <span class="keyword">for</span> deletion due to age</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A size-based retention policy <span class="keyword">for</span> logs. Segments are pruned from the <span class="built_in">log</span> unless the remaining</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> segments drop below log.retention.bytes. Functions independently of log.retention.hours.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.retention.bytes=1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum size of a <span class="built_in">log</span> segment file. When this size is reached a new <span class="built_in">log</span> segment will be created.</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The interval at <span class="built_in">which</span> <span class="built_in">log</span> segments are checked to see <span class="keyword">if</span> they can be deleted according</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to the retention policies</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Zookeeper #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Zookeeper connection string (see zookeeper docs <span class="keyword">for</span> details).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a comma separated host:port pairs, each corresponding to a zk</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server. e.g. <span class="string">&quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can also append an optional chroot string to the urls to specify the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> root directory <span class="keyword">for</span> all kafka znodes.</span></span><br><span class="line">zookeeper.connect=localhost:2181/kafka</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Timeout <span class="keyword">in</span> ms <span class="keyword">for</span> connecting to zookeeper</span></span><br><span class="line">zookeeper.connection.timeout.ms=18000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Group Coordinator Settings #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following configuration specifies the time, <span class="keyword">in</span> milliseconds, that the GroupCoordinator will delay the initial consumer rebalance.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The rebalance will be further delayed by the value of group.initial.rebalance.delay.ms as new members join the group, up to a maximum of max.poll.interval.ms.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default value <span class="keyword">for</span> this is 3 seconds.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> We override this to 0 here as it makes <span class="keyword">for</span> a better out-of-the-box experience <span class="keyword">for</span> development and testing.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However, <span class="keyword">in</span> production environments the default value of 3 seconds is more suitable as this will <span class="built_in">help</span> to avoid unnecessary, and potentially expensive, rebalances during application startup.</span></span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>
<p>执行命令启动kafka：./bin/kafka-server-start.sh config/server.properties</p>
<h3 id="3、下载并部署debezium-connector-mysql"><a href="#3、下载并部署debezium-connector-mysql" class="headerlink" title="3、下载并部署debezium-connector-mysql"></a>3、下载并部署debezium-connector-mysql</h3><p>debezium-connector-mysql作为kafka connect的一个插件连接mysql数据库，所以下载好debezium-connector-mysql.jar后上传到kafka服务器的插件配置路径下，默认/usr/local/share/java,/usr/local/share/kafka/plugins，也可以在kafka connect配置文件中修改</p>
<h3 id="4、配置并启动kafka-connect"><a href="#4、配置并启动kafka-connect" class="headerlink" title="4、配置并启动kafka connect"></a>4、配置并启动kafka connect</h3><p>kafka connnect启动有两种模式：stanalone独立模式和distributed集群模式</p>
<p>下面主要介绍集群模式启动的方法和步骤</p>
<h4 id="4-1配置kafka-connect"><a href="#4-1配置kafka-connect" class="headerlink" title="4.1配置kafka connect"></a>4.1配置kafka connect</h4><p>在config/connect-distributed.properties配置文件中配置kafka connect，其中bootstrap.servers配置kafka集群列表，plugin.path配置kafka connect插件路径，offset.storage.topic、config.storage.topic、</p>
<p>status.storage.topic分别配置connect存储偏移量、配置、状态主题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this work <span class="keyword">for</span> additional information regarding copyright ownership.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (the <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file contains some of the configurations <span class="keyword">for</span> the Kafka Connect distributed worker. This file is intended</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to be used with the examples, and some settings may differ from those used <span class="keyword">in</span> a production system, especially</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the `bootstrap.servers` and those specifying replication factors.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A list of host/port pairs to use <span class="keyword">for</span> establishing the initial connection to the Kafka cluster.</span></span><br><span class="line">bootstrap.servers=127.0.0.1:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> unique name <span class="keyword">for</span> the cluster, used <span class="keyword">in</span> forming the Connect cluster group. Note that this must not conflict with consumer group IDs</span></span><br><span class="line">group.id=connect-cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The converters specify the format of data <span class="keyword">in</span> Kafka and how to translate it into Connect data. Every Connect user will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> need to configure these based on the format they want their data <span class="keyword">in</span> when loaded from or stored into Kafka</span></span><br><span class="line">key.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">value.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line"><span class="meta">#</span><span class="bash"> Converter-specific settings can be passed <span class="keyword">in</span> by prefixing the Converter<span class="string">&#x27;s setting with the converter we want to apply</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it to</span></span><br><span class="line">key.converter.schemas.enable=true</span><br><span class="line">value.converter.schemas.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing offsets. This topic should have many partitions and be replicated and compacted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">offset.storage.topic=connect-offsets</span><br><span class="line">offset.storage.replication.factor=1</span><br><span class="line"><span class="meta">#</span><span class="bash">offset.storage.partitions=25</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing connector and task configurations; note that this should be a single partition, highly replicated,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and compacted topic. Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">config.storage.topic=connect-configs</span><br><span class="line">config.storage.replication.factor=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing statuses. This topic can have multiple partitions and should be replicated and compacted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">status.storage.topic=connect-status</span><br><span class="line">status.storage.replication.factor=1</span><br><span class="line"><span class="meta">#</span><span class="bash">status.storage.partitions=5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Flush much faster than normal, <span class="built_in">which</span> is useful <span class="keyword">for</span> testing/debugging</span></span><br><span class="line">offset.flush.interval.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These are provided to inform the user about the presence of the REST host and port configs</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> Hostname &amp; Port <span class="keyword">for</span> the REST API to listen on. If this is <span class="built_in">set</span>, it will <span class="built_in">bind</span> to the interface used to listen to requests.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.host.name=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.port=8083</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Hostname &amp; Port that will be given out to other workers to connect to i.e. URLs that are routable from other servers.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.advertised.host.name=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.advertised.port=</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to a list of filesystem paths separated by commas (,) to <span class="built_in">enable</span> class loading isolation <span class="keyword">for</span> plugins</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (connectors, converters, transformations). The list should consist of top level directories that include</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> any combination of:</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> a) directories immediately containing jars with plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> b) uber-jars with plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> c) directories immediately containing the package directory structure of classes of plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Examples:</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.path=/usr/<span class="built_in">local</span>/share/java,/usr/<span class="built_in">local</span>/share/kafka/plugins,/opt/connectors,</span></span><br><span class="line">plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,/opt/connectors,D:/PracticeProjects/plugins</span><br></pre></td></tr></table></figure>
<h4 id="4-2行命令启动kafka-connect"><a href="#4-2行命令启动kafka-connect" class="headerlink" title="4.2行命令启动kafka connect"></a>4.2行命令启动kafka connect</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">执行命令启动kafka connect</span></span><br><span class="line">./bin/connect-distributed.sh config/connect-distributed.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">该shell最后一步执行，调起了kafka connect集群模式启动的main方法</span></span><br><span class="line">exec $(dirname $0)/kafka-run-class.sh $EXTRA_ARGS org.apache.kafka.connect.cli.ConnectDistributed &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<h4 id="4-3kafka-connect启动源码解读"><a href="#4-3kafka-connect启动源码解读" class="headerlink" title="4.3kafka connect启动源码解读"></a>4.3kafka connect启动源码解读</h4><h5 id="4-3-1ConnectDistributed的main方法"><a href="#4-3-1ConnectDistributed的main方法" class="headerlink" title="4.3.1ConnectDistributed的main方法"></a>4.3.1ConnectDistributed的main方法</h5><p>kafka connect启动命令最终调用org.apache.kafka.connect.cli.ConnectDistributed的main方法开始初始化并启动kafka connect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;    <span class="comment">//入参为config\connect-distributed.properties配置文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果入参数量小于1或者包含--help则推出</span></span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">1</span> || Arrays.asList(args).contains(<span class="string">&quot;--help&quot;</span>)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Usage: ConnectDistributed worker.properties&quot;</span>);</span><br><span class="line">        Exit.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//初始化系统运行时环境对象,包含操作系统参数和jvm参数</span></span><br><span class="line">        WorkerInfo initInfo = <span class="keyword">new</span> WorkerInfo();</span><br><span class="line">        initInfo.logAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//赋值config\connect-distributed.properties入参到workerPropsFile</span></span><br><span class="line">        String workerPropsFile = args[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//将配置文件转换为map</span></span><br><span class="line">        Map&lt;String, String&gt; workerProps = !workerPropsFile.isEmpty() ?</span><br><span class="line">                Utils.propsToStringMap(Utils.loadProps(workerPropsFile)) : Collections.emptyMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化connectDistributed对象</span></span><br><span class="line">        ConnectDistributed connectDistributed = <span class="keyword">new</span> ConnectDistributed();</span><br><span class="line">        <span class="comment">//重要方法:调用connectDistributed的startConnect方法启动connect</span></span><br><span class="line">        Connect connect = connectDistributed.startConnect(workerProps);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown will be triggered by Ctrl-C or via HTTP shutdown request</span></span><br><span class="line">        <span class="comment">//等待Ctrl-C或http客户端停止请求</span></span><br><span class="line">        connect.awaitStop();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Stopping due to error&quot;</span>, t);</span><br><span class="line">        Exit.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-2ConnectDistributed的startConnect方法"><a href="#4-3-2ConnectDistributed的startConnect方法" class="headerlink" title="4.3.2ConnectDistributed的startConnect方法"></a>4.3.2ConnectDistributed的startConnect方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Connect <span class="title">startConnect</span><span class="params">(Map&lt;String, String&gt; workerProps)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Scanning for plugin classes. This might take a moment ...&quot;</span>);</span><br><span class="line">    <span class="comment">//从配置文件plugin.path配置路径下所有的插件列表</span></span><br><span class="line">    Plugins plugins = <span class="keyword">new</span> Plugins(workerProps);</span><br><span class="line">    <span class="comment">//切换类加载器</span></span><br><span class="line">    plugins.compareAndSwapWithDelegatingLoader();</span><br><span class="line">    <span class="comment">//从workerProps中实例化DistributedConfig</span></span><br><span class="line">    DistributedConfig config = <span class="keyword">new</span> DistributedConfig(workerProps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过kafka连接客户端请求kafka获取kafka集群id</span></span><br><span class="line">    String kafkaClusterId = ConnectUtils.lookupKafkaClusterId(config);</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化jetty rest服务，如uri、监听器</span></span><br><span class="line">    RestServer rest = <span class="keyword">new</span> RestServer(config);</span><br><span class="line">    <span class="comment">//调用rest方法启动服务</span></span><br><span class="line">    rest.initializeServer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取访问url</span></span><br><span class="line">    URI advertisedUrl = rest.advertisedUrl();</span><br><span class="line">    <span class="comment">//赋值workerId为ip:端口</span></span><br><span class="line">    String workerId = advertisedUrl.getHost() + <span class="string">&quot;:&quot;</span> + advertisedUrl.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化KafkaOffsetBackingStore偏移量存储对象以及其静态属性</span></span><br><span class="line">    KafkaOffsetBackingStore offsetBackingStore = <span class="keyword">new</span> KafkaOffsetBackingStore();</span><br><span class="line">    <span class="comment">//offsetBackingStore调用configure方法初始化生产者、消费者、管理者配置，创建offset日志</span></span><br><span class="line">    offsetBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取connector.client.config.override.policy配置代理类加载插件类</span></span><br><span class="line">    ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy = plugins.newPlugin(</span><br><span class="line">            config.getString(WorkerConfig.CONNECTOR_CLIENT_POLICY_CLASS_CONFIG),</span><br><span class="line">            config, ConnectorClientConfigOverridePolicy.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化kafka的org.apache.kafka.connect.runtime.Worker</span></span><br><span class="line">    Worker worker = <span class="keyword">new</span> Worker(workerId, time, plugins, config, offsetBackingStore, connectorClientConfigOverridePolicy);</span><br><span class="line">    <span class="comment">//获取worker的配置转换者</span></span><br><span class="line">    WorkerConfigTransformer configTransformer = worker.configTransformer();</span><br><span class="line">    <span class="comment">//获取worker的internalValueConverter转换者</span></span><br><span class="line">    Converter internalValueConverter = worker.getInternalValueConverter();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化KafkaStatusBackingStore状态存储对象及其静态属性</span></span><br><span class="line">    StatusBackingStore statusBackingStore = <span class="keyword">new</span> KafkaStatusBackingStore(time, internalValueConverter);</span><br><span class="line">    <span class="comment">//statusBackingStore调用configure方法初始化生产者、消费者、管理者配置，创建status日志</span></span><br><span class="line">    statusBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化ConfigBackingStore,配置存储对象及其静态属性，并初始化生产者、消费者、管理者配置，创建config日志</span></span><br><span class="line">    ConfigBackingStore configBackingStore = <span class="keyword">new</span> KafkaConfigBackingStore(</span><br><span class="line">            internalValueConverter,</span><br><span class="line">            config,</span><br><span class="line">            configTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化集群herder</span></span><br><span class="line">    DistributedHerder herder = <span class="keyword">new</span> DistributedHerder(config, time, worker,</span><br><span class="line">            kafkaClusterId, statusBackingStore, configBackingStore,</span><br><span class="line">            advertisedUrl.toString(), connectorClientConfigOverridePolicy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化Connect</span></span><br><span class="line">    <span class="keyword">final</span> Connect connect = <span class="keyword">new</span> Connect(herder, rest);</span><br><span class="line">    log.info(<span class="string">&quot;Kafka Connect distributed worker initialization took &#123;&#125;ms&quot;</span>, time.hiResClockMs() - initStart);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connect.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Failed to start Connect&quot;</span>, e);</span><br><span class="line">        connect.stop();</span><br><span class="line">        Exit.exit(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> connect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h6 id="4-3-2-1加载所有插件类"><a href="#4-3-2-1加载所有插件类" class="headerlink" title="4.3.2.1加载所有插件类"></a>4.3.2.1加载所有插件类</h6><p>Plugins plugins = new Plugins(workerProps)调用用Plugins的初始化方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Plugins</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从配置文件plugin.path配置获取插件位置</span></span><br><span class="line">    List&lt;String&gt; pluginLocations = WorkerConfig.pluginLocations(props);</span><br><span class="line">    <span class="comment">//创建代理类加载器</span></span><br><span class="line">    delegatingLoader = newDelegatingClassLoader(pluginLocations);</span><br><span class="line">    <span class="comment">//加载classpath中所有的插件类</span></span><br><span class="line">    delegatingLoader.initLoaders();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">pluginLocations</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">    String locationList = props.get(WorkerConfig.PLUGIN_PATH_CONFIG);	<span class="comment">//插件路径配置plugin.path</span></span><br><span class="line">    <span class="keyword">return</span> locationList == <span class="keyword">null</span></span><br><span class="line">                     ? <span class="keyword">new</span> ArrayList&lt;String&gt;()</span><br><span class="line">                     : Arrays.asList(COMMA_WITH_WHITESPACE.split(locationList.trim(), -<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-2初始化DistributedConfig列表对象"><a href="#4-3-2-2初始化DistributedConfig列表对象" class="headerlink" title="4.3.2.2初始化DistributedConfig列表对象"></a>4.3.2.2初始化DistributedConfig列表对象</h6><p>调用plugins的compareAndSwapWithDelegatingLoader方法，切换当前线程的类加载器为代理类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">compareAndSwapWithDelegatingLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前线程的类加载器</span></span><br><span class="line">    ClassLoader current = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">//如果当前线程的类加器和代理加载器不相同，设置当前线程的类加载器为代理类加载器</span></span><br><span class="line">    <span class="keyword">if</span> (!current.equals(delegatingLoader)) &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(delegatingLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-3通过kafka客户端请求kafka获取集群id"><a href="#4-3-2-3通过kafka客户端请求kafka获取集群id" class="headerlink" title="4.3.2.3通过kafka客户端请求kafka获取集群id"></a>4.3.2.3通过kafka客户端请求kafka获取集群id</h6><p>使用ConnectUtils工具类调用lookupKafkaClusterId方法连接kafka获取kafka集群id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//通过kafka连接客户端请求kafka获取kafka集群id</span></span><br><span class="line">    String kafkaClusterId = ConnectUtils.lookupKafkaClusterId(config);</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">lookupKafkaClusterId</span><span class="params">(WorkerConfig config)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Creating Kafka admin client&quot;</span>);</span><br><span class="line">    <span class="comment">//创建kafka连接客户端</span></span><br><span class="line">    <span class="keyword">try</span> (Admin adminClient = Admin.create(config.originals())) &#123;</span><br><span class="line">        <span class="comment">//调用lookupKafkaClusterId方法</span></span><br><span class="line">        <span class="keyword">return</span> lookupKafkaClusterId(adminClient);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">lookupKafkaClusterId</span><span class="params">(Admin adminClient)</span> </span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Looking up Kafka cluster ID&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//请求kafka获取集群id</span></span><br><span class="line">        KafkaFuture&lt;String&gt; clusterIdFuture = adminClient.describeCluster().clusterId();</span><br><span class="line">        <span class="keyword">if</span> (clusterIdFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Kafka cluster version is too old to return cluster ID&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;Fetching Kafka cluster ID&quot;</span>);</span><br><span class="line">        String kafkaClusterId = clusterIdFuture.get();</span><br><span class="line">        log.info(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line">        <span class="keyword">return</span> kafkaClusterId;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unexpectedly interrupted when looking up Kafka cluster info&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Failed to connect to and describe Kafka cluster. &quot;</span></span><br><span class="line">                                   + <span class="string">&quot;Check worker&#x27;s broker connection and security properties.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-4初始化jetty-rest服务"><a href="#4-3-2-4初始化jetty-rest服务" class="headerlink" title="4.3.2.4初始化jetty rest服务"></a>4.3.2.4初始化jetty rest服务</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化jetty rest服务，如uri、监听器</span></span><br><span class="line">RestServer rest = <span class="keyword">new</span> RestServer(config);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RestServer</span><span class="params">(WorkerConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载配置文件获取rest http的uri</span></span><br><span class="line">        List&lt;String&gt; listeners = parseListeners();</span><br><span class="line">        <span class="comment">//获取配置文件admin.listeners配置</span></span><br><span class="line">        List&lt;String&gt; adminListeners = config.getList(WorkerConfig.ADMIN_LISTENERS_CONFIG);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化jetty服务</span></span><br><span class="line">        jettyServer = <span class="keyword">new</span> Server();</span><br><span class="line">        handlers = <span class="keyword">new</span> ContextHandlerCollection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加监听服务</span></span><br><span class="line">        createConnectors(listeners, adminListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">parseListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取配置文件listeners配置信息</span></span><br><span class="line">        List&lt;String&gt; listeners = config.getList(WorkerConfig.LISTENERS_CONFIG);</span><br><span class="line">        <span class="comment">//如果配置为空,获取配置文件rest.host.name配置</span></span><br><span class="line">        <span class="keyword">if</span> (listeners == <span class="keyword">null</span> || listeners.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            String hostname = config.getString(WorkerConfig.REST_HOST_NAME_CONFIG);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hostname == <span class="keyword">null</span>)</span><br><span class="line">                hostname = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取rest.port端口配置，默认8083，拼接为url</span></span><br><span class="line">            listeners = Collections.singletonList(String.format(<span class="string">&quot;%s://%s:%d&quot;</span>, PROTOCOL_HTTP, hostname, config.getInt(WorkerConfig.REST_PORT_CONFIG)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listeners;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-5启动rest服务"><a href="#4-3-2-5启动rest服务" class="headerlink" title="4.3.2.5启动rest服务"></a>4.3.2.5启动rest服务</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用rest方法启动服务</span></span><br><span class="line">rest.initializeServer();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initializing REST server&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Needed for graceful shutdown as per `setStopTimeout` documentation */</span></span><br><span class="line">        StatisticsHandler statsHandler = <span class="keyword">new</span> StatisticsHandler();</span><br><span class="line">        statsHandler.setHandler(handlers);</span><br><span class="line">        jettyServer.setHandler(statsHandler);</span><br><span class="line">        jettyServer.setStopTimeout(GRACEFUL_SHUTDOWN_TIMEOUT_MS);</span><br><span class="line">        jettyServer.setStopAtShutdown(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//启动jettyServer服务</span></span><br><span class="line">            jettyServer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize REST server&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;REST server listening at &quot;</span> + jettyServer.getURI() + <span class="string">&quot;, advertising URL &quot;</span> + advertisedUrl());</span><br><span class="line">        log.info(<span class="string">&quot;REST admin endpoints at &quot;</span> + adminUrl());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-6获取rest服务uri"><a href="#4-3-2-6获取rest服务uri" class="headerlink" title="4.3.2.6获取rest服务uri"></a>4.3.2.6获取rest服务uri</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> URI <span class="title">advertisedUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从rest服务的uri获取UriBuilder，uri为上一步从配置文件生成,若未配置ip取默认的本机ip</span></span><br><span class="line">    UriBuilder builder = UriBuilder.fromUri(jettyServer.getURI());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用方法从rest.advertised.listener或listeners获取请求方式http还是https</span></span><br><span class="line">    String advertisedSecurityProtocol = determineAdvertisedProtocol();</span><br><span class="line">    <span class="comment">//根据url类型获取connector</span></span><br><span class="line">    ServerConnector serverConnector = findConnector(advertisedSecurityProtocol);</span><br><span class="line">    <span class="comment">//构建scheme的请求方式http或https</span></span><br><span class="line">    builder.scheme(advertisedSecurityProtocol);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从配置文件获取rest.advertised.host.name配置,不为空则构建host为配置，否则构建上一步connector的host</span></span><br><span class="line">    String advertisedHostname = config.getString(WorkerConfig.REST_ADVERTISED_HOST_NAME_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (advertisedHostname != <span class="keyword">null</span> &amp;&amp; !advertisedHostname.isEmpty())</span><br><span class="line">        builder.host(advertisedHostname);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (serverConnector != <span class="keyword">null</span> &amp;&amp; serverConnector.getHost() != <span class="keyword">null</span> &amp;&amp; serverConnector.getHost().length() &gt; <span class="number">0</span>)</span><br><span class="line">        builder.host(serverConnector.getHost());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从配置文件获取rest.advertised.port的配置，不为空则构建port为配置，否则构建上一步connector的port</span></span><br><span class="line">    Integer advertisedPort = config.getInt(WorkerConfig.REST_ADVERTISED_PORT_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (advertisedPort != <span class="keyword">null</span>)</span><br><span class="line">        builder.port(advertisedPort);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (serverConnector != <span class="keyword">null</span> &amp;&amp; serverConnector.getPort() &gt; <span class="number">0</span>)</span><br><span class="line">        builder.port(serverConnector.getPort());</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;Advertised URI: &#123;&#125;&quot;</span>, builder.build());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-7初始化并构建KafkaOffsetBackingStore偏移量主题存储"><a href="#4-3-2-7初始化并构建KafkaOffsetBackingStore偏移量主题存储" class="headerlink" title="4.3.2.7初始化并构建KafkaOffsetBackingStore偏移量主题存储"></a>4.3.2.7初始化并构建KafkaOffsetBackingStore偏移量主题存储</h6><p>初始化并创建connect的偏移量topic，并创建kafka日志文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(<span class="keyword">final</span> WorkerConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从配置文件获取offset.storage.topic配置信息，若为空抛出异常</span></span><br><span class="line">    String topic = config.getString(DistributedConfig.OFFSET_STORAGE_TOPIC_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (topic == <span class="keyword">null</span> || topic.trim().length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Offset storage topic must be specified&quot;</span>);</span><br><span class="line"></span><br><span class="line">    data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取connect配置文件originals类配置到originals</span></span><br><span class="line">    Map&lt;String, Object&gt; originals = config.originals();</span><br><span class="line">    <span class="comment">//初始化生产者配置map，存入key.serializer、value.serializer、delivery.timeout.ms序列化配置</span></span><br><span class="line">    Map&lt;String, Object&gt; producerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG, Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化消费者配置map，存入key.deserializer、value.deserializer反序列化配置</span></span><br><span class="line">    Map&lt;String, Object&gt; consumerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化admin管理者map,存入offset.storage.partitions、offset.storage.replication.factor分区和复制因子配置</span></span><br><span class="line">    Map&lt;String, Object&gt; adminProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription = TopicAdmin.defineTopic(topic).</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(config.getInt(DistributedConfig.OFFSET_STORAGE_PARTITIONS_CONFIG)).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.OFFSET_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用当前类createKafkaBasedLog方法,请求kafka创建日志</span></span><br><span class="line">    offsetLog = createKafkaBasedLog(topic, producerProps, consumerProps, consumedCallback, topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-8获取connector-client-config-override-policy配置代理类加载插件类"><a href="#4-3-2-8获取connector-client-config-override-policy配置代理类加载插件类" class="headerlink" title="4.3.2.8获取connector.client.config.override.policy配置代理类加载插件类"></a>4.3.2.8获取connector.client.config.override.policy配置代理类加载插件类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newPlugin</span><span class="params">(String klassName, AbstractConfig config, Class&lt;T&gt; pluginKlass)</span> </span>&#123;</span><br><span class="line">    T plugin;</span><br><span class="line">    Class&lt;? extends T&gt; klass;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//加载class org.apache.kafka.connect.connector.policy.NoneConnectorClientConfigOverridePolicy接口的实现类</span></span><br><span class="line">        klass = pluginClass(delegatingLoader, klassName, pluginKlass);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        String msg = String.format(<span class="string">&quot;Failed to find any class that implements %s and which &quot;</span></span><br><span class="line">                                   + <span class="string">&quot;name matches %s&quot;</span>, pluginKlass, klassName);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取klass的类加载器并切换为当前线程的类加载器</span></span><br><span class="line">    ClassLoader savedLoader = compareAndSwapLoaders(klass.getClassLoader());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//加载插件类</span></span><br><span class="line">        plugin = newPlugin(klass);</span><br><span class="line">        <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Versioned) &#123;</span><br><span class="line">            Versioned versionedPlugin = (Versioned) plugin;</span><br><span class="line">            <span class="keyword">if</span> (versionedPlugin.version() == <span class="keyword">null</span> || versionedPlugin.version().trim()</span><br><span class="line">                .isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Version not defined for &#x27;&quot;</span> + klassName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Configurable) &#123;</span><br><span class="line">            ((Configurable) plugin).configure(config.originals());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//获取savedLoader的类加载器并切换为当前线程的类加载器</span></span><br><span class="line">        compareAndSwapLoaders(savedLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> plugin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-9初始化kafka的Worker"><a href="#4-3-2-9初始化kafka的Worker" class="headerlink" title="4.3.2.9初始化kafka的Worker"></a>4.3.2.9初始化kafka的Worker</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Worker(</span><br><span class="line">        String workerId,</span><br><span class="line">        Time time,</span><br><span class="line">        Plugins plugins,</span><br><span class="line">        WorkerConfig config,</span><br><span class="line">        OffsetBackingStore offsetBackingStore,</span><br><span class="line">        ExecutorService executorService,</span><br><span class="line">        ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">//实例化指标和报表</span></span><br><span class="line">    <span class="keyword">this</span>.metrics = <span class="keyword">new</span> ConnectMetrics(workerId, config, time);</span><br><span class="line">    <span class="comment">//赋值执行线程池</span></span><br><span class="line">    <span class="keyword">this</span>.executor = executorService;</span><br><span class="line">    <span class="keyword">this</span>.workerId = workerId;</span><br><span class="line">    <span class="keyword">this</span>.time = time;</span><br><span class="line">    <span class="keyword">this</span>.plugins = plugins;</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line">    <span class="keyword">this</span>.connectorClientConfigOverridePolicy = connectorClientConfigOverridePolicy;</span><br><span class="line">    <span class="comment">//初始化指标群</span></span><br><span class="line">    <span class="keyword">this</span>.workerMetricsGroup = <span class="keyword">new</span> WorkerMetricsGroup(metrics);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Internal converters are required properties, thus getClass won&#x27;t return null.</span></span><br><span class="line">    <span class="comment">//根据配置internal.key.converter初始化internalKeyConverter</span></span><br><span class="line">    <span class="keyword">this</span>.internalKeyConverter = plugins.newConverter(</span><br><span class="line">            config,</span><br><span class="line">            WorkerConfig.INTERNAL_KEY_CONVERTER_CLASS_CONFIG,</span><br><span class="line">            ClassLoaderUsage.PLUGINS</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据配置internal.value.converter初始化internalValueConverter</span></span><br><span class="line">    <span class="keyword">this</span>.internalValueConverter = plugins.newConverter(</span><br><span class="line">            config,</span><br><span class="line">            WorkerConfig.INTERNAL_VALUE_CONVERTER_CLASS_CONFIG,</span><br><span class="line">            ClassLoaderUsage.PLUGINS</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.offsetBackingStore = offsetBackingStore;</span><br><span class="line">    <span class="keyword">this</span>.offsetBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.workerConfigTransformer = initConfigTransformer();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-10初始化并构建ConfigBackingStore状态主题存储"><a href="#4-3-2-10初始化并构建ConfigBackingStore状态主题存储" class="headerlink" title="4.3.2.10初始化并构建ConfigBackingStore状态主题存储"></a>4.3.2.10初始化并构建ConfigBackingStore状态主题存储</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void configure(final WorkerConfig config) &#123;</span><br><span class="line">    &#x2F;&#x2F;获取配置status.storage.topic状态存储topic配置</span><br><span class="line">    this.statusTopic &#x3D; config.getString(DistributedConfig.STATUS_STORAGE_TOPIC_CONFIG);</span><br><span class="line">    if (this.statusTopic &#x3D;&#x3D; null || this.statusTopic.trim().length() &#x3D;&#x3D; 0)</span><br><span class="line">        throw new ConfigException(&quot;Must specify topic for connector status.&quot;);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; originals &#x3D; config.originals();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化生产者配置参数，存入key.serializer、value.serializer、retries序列化配置和对象类</span><br><span class="line">    Map&lt;String, Object&gt; producerProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.RETRIES_CONFIG, 0); &#x2F;&#x2F; we handle retries in this class</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化消费者配置参数，存入key.deserializer、value.deserializer反序列化配置和对象类</span><br><span class="line">    Map&lt;String, Object&gt; consumerProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化管理者配置参数，根据status.storage.topic、status.storage.partitions、status.storage.replication.factor配置初始化topic对象</span><br><span class="line">    Map&lt;String, Object&gt; adminProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription &#x3D; TopicAdmin.defineTopic(statusTopic).    &#x2F;&#x2F;创建topic创建者</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(config.getInt(DistributedConfig.STATUS_STORAGE_PARTITIONS_CONFIG)).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.STATUS_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    Callback&lt;ConsumerRecord&lt;String, byte[]&gt;&gt; readCallback &#x3D; new Callback&lt;ConsumerRecord&lt;String, byte[]&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onCompletion(Throwable error, ConsumerRecord&lt;String, byte[]&gt; record) &#123;</span><br><span class="line">            read(record);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;实例化org.apache.kafka.connect.util.KafkaBasedLog</span><br><span class="line">    this.kafkaLog &#x3D; createKafkaBasedLog(statusTopic, producerProps, consumerProps, readCallback, topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.3.2.11初始化并构建ConfigBackingStore状态主题存储</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KafkaConfigBackingStore</span><span class="params">(Converter converter, WorkerConfig config, WorkerConfigTransformer configTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">this</span>.started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.converter = converter;</span><br><span class="line">    <span class="keyword">this</span>.offset = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取配置config.storage.topic</span></span><br><span class="line">    <span class="keyword">this</span>.topic = config.getString(DistributedConfig.CONFIG_TOPIC_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.topic == <span class="keyword">null</span> || <span class="keyword">this</span>.topic.trim().length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Must specify topic for connector configuration.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用当前类方法设置并创建configLog</span></span><br><span class="line">    configLog = setupAndCreateKafkaBasedLog(<span class="keyword">this</span>.topic, config);</span><br><span class="line">    <span class="keyword">this</span>.configTransformer = configTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调用当前类的方法创建设置并创建kafka日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">KafkaBasedLog&lt;String, <span class="keyword">byte</span>[]&gt; setupAndCreateKafkaBasedLog(String topic, <span class="keyword">final</span> WorkerConfig config) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; originals = config.originals();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化生产者配置参数，存入key.serializer、value.serializer、delivery.timeout.ms序列化配置和对象类</span></span><br><span class="line">    Map&lt;String, Object&gt; producerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG, Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化消费者配置参数，存入key.deserializer、value.deserializer反序列化配置和对象类</span></span><br><span class="line">    Map&lt;String, Object&gt; consumerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化管理者配置参数，根据config.storage.topic、config.storage.replication.factor配置初始化topic对象</span></span><br><span class="line">    Map&lt;String, Object&gt; adminProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription = TopicAdmin.defineTopic(topic).</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(<span class="number">1</span>).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.CONFIG_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createKafkaBasedLog(topic, producerProps, consumerProps, <span class="keyword">new</span> ConsumeCallback(), topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-11初始化并构建核心调度DistributedHerder"><a href="#4-3-2-11初始化并构建核心调度DistributedHerder" class="headerlink" title="4.3.2.11初始化并构建核心调度DistributedHerder"></a>4.3.2.11初始化并构建核心调度DistributedHerder</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistributedHerder</span><span class="params">(DistributedConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Time time,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Worker worker,</span></span></span><br><span class="line"><span class="function"><span class="params">                         String kafkaClusterId,</span></span></span><br><span class="line"><span class="function"><span class="params">                         StatusBackingStore statusBackingStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                         ConfigBackingStore configBackingStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                         String restUrl,</span></span></span><br><span class="line"><span class="function"><span class="params">                         ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//调用构造函数初始化</span></span><br><span class="line">    <span class="keyword">this</span>(config, worker, worker.workerId(), kafkaClusterId, statusBackingStore, configBackingStore, <span class="keyword">null</span>, restUrl, worker.metrics(),</span><br><span class="line">         time, connectorClientConfigOverridePolicy);</span><br><span class="line">    <span class="comment">//设置configBackingStore的更新监听者</span></span><br><span class="line">    configBackingStore.setUpdateListener(<span class="keyword">new</span> ConfigUpdateListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用重载方法初始化DistributedHerder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">DistributedHerder(DistributedConfig config,</span><br><span class="line">                  Worker worker,</span><br><span class="line">                  String workerId,</span><br><span class="line">                  String kafkaClusterId,</span><br><span class="line">                  StatusBackingStore statusBackingStore,</span><br><span class="line">                  ConfigBackingStore configBackingStore,</span><br><span class="line">                  WorkerGroupMember member,</span><br><span class="line">                  String restUrl,</span><br><span class="line">                  ConnectMetrics metrics,</span><br><span class="line">                  Time time,</span><br><span class="line">                  ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy) &#123;</span><br><span class="line">    <span class="keyword">super</span>(worker, workerId, kafkaClusterId, statusBackingStore, configBackingStore, connectorClientConfigOverridePolicy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.time = time;</span><br><span class="line">    <span class="keyword">this</span>.herderMetrics = <span class="keyword">new</span> HerderMetrics(metrics);</span><br><span class="line">    <span class="keyword">this</span>.workerGroupId = config.getString(DistributedConfig.GROUP_ID_CONFIG);   <span class="comment">//获取配置group.id</span></span><br><span class="line">    <span class="keyword">this</span>.workerSyncTimeoutMs = config.getInt(DistributedConfig.WORKER_SYNC_TIMEOUT_MS_CONFIG);  <span class="comment">//获取配置worker.sync.timeout.ms</span></span><br><span class="line">    <span class="keyword">this</span>.workerTasksShutdownTimeoutMs = config.getLong(DistributedConfig.TASK_SHUTDOWN_GRACEFUL_TIMEOUT_MS_CONFIG); <span class="comment">//获取配置task.shutdown.graceful.timeout.ms</span></span><br><span class="line">    <span class="keyword">this</span>.workerUnsyncBackoffMs = config.getInt(DistributedConfig.WORKER_UNSYNC_BACKOFF_MS_CONFIG);  <span class="comment">//获取配置worker.unsync.backoff.ms</span></span><br><span class="line">    <span class="keyword">this</span>.requestSignatureAlgorithm = config.getString(DistributedConfig.INTER_WORKER_SIGNATURE_ALGORITHM_CONFIG);   <span class="comment">//获取配置inter.worker.signature.algorithm</span></span><br><span class="line">    <span class="keyword">this</span>.keyRotationIntervalMs = config.getInt(DistributedConfig.INTER_WORKER_KEY_TTL_MS_CONFIG);   <span class="comment">//获取配置inter.worker.key.ttl.ms</span></span><br><span class="line">    <span class="keyword">this</span>.keySignatureVerificationAlgorithms = config.getList(DistributedConfig.INTER_WORKER_VERIFICATION_ALGORITHMS_CONFIG);    <span class="comment">//获取配置inter.worker.verification.algorithms</span></span><br><span class="line">    <span class="keyword">this</span>.keyGenerator = config.getInternalRequestKeyGenerator();    <span class="comment">//调用当前类方法根据配置inter.worker.key.generation.algorithm、inter.worker.key.size创建keyGenerator，</span></span><br><span class="line">    <span class="keyword">this</span>.isTopicTrackingEnabled = config.getBoolean(TOPIC_TRACKING_ENABLE_CONFIG);  <span class="comment">//获取配置topic.tracking.enable</span></span><br><span class="line"></span><br><span class="line">    String clientIdConfig = config.getString(CommonClientConfigs.CLIENT_ID_CONFIG); <span class="comment">//获取配置client.id</span></span><br><span class="line">    <span class="comment">//若client.id为空，拼接&quot;connect-&quot;+自动序列，不为空则取配置</span></span><br><span class="line">    String clientId = clientIdConfig.length() &lt;= <span class="number">0</span> ? <span class="string">&quot;connect-&quot;</span> + CONNECT_CLIENT_ID_SEQUENCE.getAndIncrement() : clientIdConfig;</span><br><span class="line">    LogContext logContext = <span class="keyword">new</span> LogContext(<span class="string">&quot;[Worker clientId=&quot;</span> + clientId + <span class="string">&quot;, groupId=&quot;</span> + <span class="keyword">this</span>.workerGroupId + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">    log = logContext.logger(DistributedHerder.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果member为空，则实例化WorkerGroupMember</span></span><br><span class="line">    <span class="keyword">this</span>.member = member != <span class="keyword">null</span></span><br><span class="line">                  ? member</span><br><span class="line">                  : <span class="keyword">new</span> WorkerGroupMember(config, restUrl, <span class="keyword">this</span>.configBackingStore,</span><br><span class="line">                          <span class="keyword">new</span> RebalanceListener(time), time, clientId, logContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化herderExecutor线程池</span></span><br><span class="line">    <span class="keyword">this</span>.herderExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;(<span class="number">1</span>),</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">&quot;-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化转发请求线程池</span></span><br><span class="line">    <span class="keyword">this</span>.forwardRequestExecutor = Executors.newFixedThreadPool(<span class="number">1</span>,</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="string">&quot;ForwardRequestExecutor-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line">    <span class="comment">//实例化启动和停止线程池</span></span><br><span class="line">    <span class="keyword">this</span>.startAndStopExecutor = Executors.newFixedThreadPool(START_STOP_THREAD_POOL_SIZE,</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="string">&quot;StartAndStopExecutor-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line"></span><br><span class="line">    stopping = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">    configState = ClusterConfigState.EMPTY;</span><br><span class="line">    rebalanceResolved = <span class="keyword">true</span>; <span class="comment">// If we still need to follow up after a rebalance occurred, starting up tasks</span></span><br><span class="line">    needsReconfigRebalance = <span class="keyword">false</span>;</span><br><span class="line">    canReadConfigs = <span class="keyword">true</span>; <span class="comment">// We didn&#x27;t try yet, but Configs are readable until proven otherwise</span></span><br><span class="line">    scheduledRebalance = Long.MAX_VALUE;</span><br><span class="line">    keyExpiration = Long.MAX_VALUE;</span><br><span class="line">    sessionKey = <span class="keyword">null</span>;</span><br><span class="line">    backoffRetries = BACKOFF_RETRIES;</span><br><span class="line">    <span class="comment">//获取connect.protocol配置，赋值当前版本</span></span><br><span class="line">    currentProtocolVersion = ConnectProtocolCompatibility.compatibility(</span><br><span class="line">        config.getString(DistributedConfig.CONNECT_PROTOCOL_CONFIG)</span><br><span class="line">    ).protocolVersion();</span><br><span class="line">    <span class="keyword">if</span> (!internalRequestValidationEnabled(currentProtocolVersion)) &#123;</span><br><span class="line">        log.warn(</span><br><span class="line">            <span class="string">&quot;Internal request verification will be disabled for this cluster as this worker&#x27;s &#123;&#125; configuration has been set to &#x27;&#123;&#125;&#x27;. &quot;</span></span><br><span class="line">                + <span class="string">&quot;If this is not intentional, either remove the &#x27;&#123;&#125;&#x27; configuration from the worker config file or change its value &quot;</span></span><br><span class="line">                + <span class="string">&quot;to &#x27;&#123;&#125;&#x27;. If this configuration is left as-is, the cluster will be insecure; for more information, see KIP-507: &quot;</span></span><br><span class="line">                + <span class="string">&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-507%3A+Securing+Internal+Connect+REST+Endpoints&quot;</span>,</span><br><span class="line">            DistributedConfig.CONNECT_PROTOCOL_CONFIG,</span><br><span class="line">            config.getString(DistributedConfig.CONNECT_PROTOCOL_CONFIG),</span><br><span class="line">            DistributedConfig.CONNECT_PROTOCOL_CONFIG,</span><br><span class="line">            ConnectProtocolCompatibility.SESSIONED.name()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.3.2.13初始化connect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connect</span><span class="params">(Herder herder, RestServer rest)</span> </span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka Connect instance created&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.herder = herder;</span><br><span class="line">    <span class="keyword">this</span>.rest = rest;</span><br><span class="line">    shutdownHook = <span class="keyword">new</span> ShutdownHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-12启动connect"><a href="#4-3-2-12启动connect" class="headerlink" title="4.3.2.12启动connect"></a>4.3.2.12启动connect</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Kafka Connect starting&quot;</span>);</span><br><span class="line">        Exit.addShutdownHook(<span class="string">&quot;connect-shutdown-hook&quot;</span>, shutdownHook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动herder线程，并启动守护线程</span></span><br><span class="line">        herder.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化rest服务资源并启动服务</span></span><br><span class="line">        rest.initializeResources(herder);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;Kafka Connect started&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        startLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeResources</span><span class="params">(Herder herder)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initializing REST resources&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化并添加资源配置</span></span><br><span class="line">        ResourceConfig resourceConfig = <span class="keyword">new</span> ResourceConfig();</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> JacksonJsonProvider());</span><br><span class="line"></span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> RootResource(herder));</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> ConnectorsResource(herder, config));</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> ConnectorPluginsResource(herder));</span><br><span class="line"></span><br><span class="line">        resourceConfig.register(ConnectExceptionMapper.class);</span><br><span class="line">        resourceConfig.property(ServerProperties.WADL_FEATURE_DISABLE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        registerRestExtensions(herder, resourceConfig);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; adminListeners = config.getList(WorkerConfig.ADMIN_LISTENERS_CONFIG);  <span class="comment">//获取admin.listeners配置列表</span></span><br><span class="line">        <span class="comment">//初始化管理者监听列表，如果为空，则使用resourceConfig，如果不为空则初始化adminResourceConfig</span></span><br><span class="line">        ResourceConfig adminResourceConfig;</span><br><span class="line">        <span class="keyword">if</span> (adminListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Adding admin resources to main listener&quot;</span>);</span><br><span class="line">            adminResourceConfig = resourceConfig;</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> LoggingResource());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adminListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we need to check if these listeners are same as &#x27;listeners&#x27;</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> the following code assumes that they are different</span></span><br><span class="line">            log.info(<span class="string">&quot;Adding admin resources to admin listener&quot;</span>);</span><br><span class="line">            adminResourceConfig = <span class="keyword">new</span> ResourceConfig();</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> JacksonJsonProvider());</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> LoggingResource());</span><br><span class="line">            adminResourceConfig.register(ConnectExceptionMapper.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Skipping adding admin resources&quot;</span>);</span><br><span class="line">            <span class="comment">// set up adminResource but add no handlers to it</span></span><br><span class="line">            adminResourceConfig = resourceConfig;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ServletContainer servletContainer = <span class="keyword">new</span> ServletContainer(resourceConfig);   <span class="comment">//初始化servlet容器</span></span><br><span class="line">        ServletHolder servletHolder = <span class="keyword">new</span> ServletHolder(servletContainer);  <span class="comment">//实例化servlet持有者</span></span><br><span class="line">        List&lt;Handler&gt; contextHandlers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化servlet上下处理器</span></span><br><span class="line">        ServletContextHandler context = <span class="keyword">new</span> ServletContextHandler(ServletContextHandler.SESSIONS);</span><br><span class="line">        context.setContextPath(<span class="string">&quot;/&quot;</span>);    <span class="comment">//设置根路径</span></span><br><span class="line">        context.addServlet(servletHolder, <span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        contextHandlers.add(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果设置了管理者配置，则实例化管理者上下文处理器</span></span><br><span class="line">        ServletContextHandler adminContext = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (adminResourceConfig != resourceConfig) &#123;</span><br><span class="line">            adminContext = <span class="keyword">new</span> ServletContextHandler(ServletContextHandler.SESSIONS);</span><br><span class="line">            ServletHolder adminServletHolder = <span class="keyword">new</span> ServletHolder(<span class="keyword">new</span> ServletContainer(adminResourceConfig));</span><br><span class="line">            adminContext.setContextPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            adminContext.addServlet(adminServletHolder, <span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            adminContext.setVirtualHosts(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;@&quot;</span> + ADMIN_SERVER_CONNECTOR_NAME&#125;);</span><br><span class="line">            contextHandlers.add(adminContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取配置access.control.allow.origin、allowedOrigins、access.control.allow.methods、allowedMethods，并设置相应过滤规则</span></span><br><span class="line">        String allowedOrigins = config.getString(WorkerConfig.ACCESS_CONTROL_ALLOW_ORIGIN_CONFIG);</span><br><span class="line">        <span class="keyword">if</span> (allowedOrigins != <span class="keyword">null</span> &amp;&amp; !allowedOrigins.trim().isEmpty()) &#123;</span><br><span class="line">            FilterHolder filterHolder = <span class="keyword">new</span> FilterHolder(<span class="keyword">new</span> CrossOriginFilter());</span><br><span class="line">            filterHolder.setName(<span class="string">&quot;cross-origin&quot;</span>);</span><br><span class="line">            filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_ORIGINS_PARAM, allowedOrigins);</span><br><span class="line">            String allowedMethods = config.getString(WorkerConfig.ACCESS_CONTROL_ALLOW_METHODS_CONFIG);</span><br><span class="line">            <span class="keyword">if</span> (allowedMethods != <span class="keyword">null</span> &amp;&amp; !allowedOrigins.trim().isEmpty()) &#123;</span><br><span class="line">                filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_METHODS_PARAM, allowedMethods);</span><br><span class="line">            &#125;</span><br><span class="line">            context.addFilter(filterHolder, <span class="string">&quot;/*&quot;</span>, EnumSet.of(DispatcherType.REQUEST));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化请求日志处理器</span></span><br><span class="line">        RequestLogHandler requestLogHandler = <span class="keyword">new</span> RequestLogHandler();</span><br><span class="line">        Slf4jRequestLogWriter slf4jRequestLogWriter = <span class="keyword">new</span> Slf4jRequestLogWriter();</span><br><span class="line">        slf4jRequestLogWriter.setLoggerName(RestServer.class.getCanonicalName());</span><br><span class="line">        CustomRequestLog requestLog = <span class="keyword">new</span> CustomRequestLog(slf4jRequestLogWriter, CustomRequestLog.EXTENDED_NCSA_FORMAT + <span class="string">&quot; %msT&quot;</span>);</span><br><span class="line">        requestLogHandler.setRequestLog(requestLog);</span><br><span class="line"></span><br><span class="line">        contextHandlers.add(<span class="keyword">new</span> DefaultHandler());</span><br><span class="line">        contextHandlers.add(requestLogHandler);</span><br><span class="line"></span><br><span class="line">        handlers.setHandlers(contextHandlers.toArray(<span class="keyword">new</span> Handler[]&#123;&#125;));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//启动服务</span></span><br><span class="line">            context.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize REST resources&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果Admin配置不为空，启动Admin REST</span></span><br><span class="line">        <span class="keyword">if</span> (adminResourceConfig != resourceConfig) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Starting admin context&quot;</span>);</span><br><span class="line">                adminContext.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize Admin REST resources&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;REST resources initialized; server is started and ready to handle requests&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5、使用crul运行debezium-connector-mysql"><a href="#5、使用crul运行debezium-connector-mysql" class="headerlink" title="5、使用crul运行debezium-connector-mysql"></a>5、使用crul运行debezium-connector-mysql</h3><p>debezium-connector-mysql的配置如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">	<span class="attr">&quot;name&quot;</span> : <span class="string">&quot;debezium-mysql-source-3308&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;config&quot;</span>:</span><br><span class="line">	&#123;</span><br><span class="line">	     <span class="attr">&quot;connector.class&quot;</span> : <span class="string">&quot;io.debezium.connector.mysql.MySqlConnector&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.hostname&quot;</span> : <span class="string">&quot;mysql的IP地址&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.port&quot;</span> : <span class="string">&quot;mysql的端口号&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.user&quot;</span> : <span class="string">&quot;mysql的用户名&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.password&quot;</span> : <span class="string">&quot;mysql用户对应的密码&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.server.id&quot;</span> : <span class="string">&quot;184000&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.server.name&quot;</span> : <span class="string">&quot;mysql服务的逻辑名，例如fullfillment&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.kafka.bootstrap.servers&quot;</span> : <span class="string">&quot;ip1:9092,ip2:9092,ip3:9092&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.kafka.topic&quot;</span> : <span class="string">&quot;dbhistory.fullfillment&quot;</span> ,</span><br><span class="line">	     <span class="attr">&quot;include.schema.changes&quot;</span> : <span class="string">&quot;true&quot;</span> ,</span><br><span class="line">	     <span class="attr">&quot;mode&quot;</span> : <span class="string">&quot;incrementing&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;incrementing.column.name&quot;</span> : <span class="string">&quot;id&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.skip.unparseable.ddl&quot;</span> : <span class="string">&quot;true&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Kafka/kafka%20connect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckk2gq3ul001uz8pqb97hevqe" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/18/Kafka/kafka%E6%BA%90%E7%A0%81/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/01/18/Java/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/Protobuf/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>