<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="# Kafka Connect## 连接器元数据管理机制Kafka Connect 运行部署  1.单机模式  2.集群模式### 任务偏移量### 任务配置### 任务运行状态## Debezium MySQL连接器元数据管理### 源数据库的当前schema？### 源数据库schema历史## 连接器的topic数据读写 io.debezium.connector.mysql.MySqlC">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/01/18/Debezuim/debezuim%E6%BA%90%E7%A0%81/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="# Kafka Connect## 连接器元数据管理机制Kafka Connect 运行部署  1.单机模式  2.集群模式### 任务偏移量### 任务配置### 任务运行状态## Debezium MySQL连接器元数据管理### 源数据库的当前schema？### 源数据库schema历史## 连接器的topic数据读写 io.debezium.connector.mysql.MySqlC">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-01-18T11:01:37.218Z">
<meta property="article:modified_time" content="2021-01-12T08:55:09.723Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-Debezuim/debezuim源码" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Debezuim/debezuim%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.218Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p> # Kafka Connect<br>## 连接器元数据管理机制<br>Kafka Connect 运行部署<br>  1.单机模式<br>  2.集群模式<br>### 任务偏移量<br>### 任务配置<br>### 任务运行状态<br>## Debezium MySQL连接器元数据管理<br>### 源数据库的当前schema？<br>### 源数据库schema历史<br>## 连接器的topic数据读写</p>
<h4 id="io-debezium-connector-mysql-MySqlConnector"><a href="#io-debezium-connector-mysql-MySqlConnector" class="headerlink" title="io.debezium.connector.mysql.MySqlConnector"></a>io.debezium.connector.mysql.MySqlConnector</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlConnector</span> <span class="keyword">extends</span> <span class="title">SourceConnector</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ConfigDef <span class="title">config</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MySqlConnectorConfig.configDef();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-MySqlConnectorConfig"><a href="#io-debezium-connector-mysql-MySqlConnectorConfig" class="headerlink" title="io.debezium.connector.mysql.MySqlConnectorConfig"></a>io.debezium.connector.mysql.MySqlConnectorConfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlConnectorConfig</span> <span class="keyword">extends</span> <span class="title">RelationalDatabaseConnectorConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	    <span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> ConfigDef <span class="title">configDef</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        ConfigDef config = <span class="keyword">new</span> ConfigDef();</span><br><span class="line">        <span class="comment">//调用io.debezium.config.Field的group方法</span></span><br><span class="line">        Field.group(config, <span class="string">&quot;MySQL&quot;</span>, HOSTNAME, PORT, USER, PASSWORD, ON_CONNECT_STATEMENTS, SERVER_NAME, SERVER_ID, SERVER_ID_OFFSET,</span><br><span class="line">                SSL_MODE, SSL_KEYSTORE, SSL_KEYSTORE_PASSWORD, SSL_TRUSTSTORE, SSL_TRUSTSTORE_PASSWORD, JDBC_DRIVER, CommonConnectorConfig.SKIPPED_OPERATIONS);	</span><br><span class="line">        Field.group(config, <span class="string">&quot;History Storage&quot;</span>, KafkaDatabaseHistory.BOOTSTRAP_SERVERS,</span><br><span class="line">                KafkaDatabaseHistory.TOPIC, KafkaDatabaseHistory.RECOVERY_POLL_ATTEMPTS,</span><br><span class="line">                KafkaDatabaseHistory.RECOVERY_POLL_INTERVAL_MS, DATABASE_HISTORY,</span><br><span class="line">                DatabaseHistory.SKIP_UNPARSEABLE_DDL_STATEMENTS, DatabaseHistory.DDL_FILTER,</span><br><span class="line">                DatabaseHistory.STORE_ONLY_MONITORED_TABLES_DDL);</span><br><span class="line">        Field.group(config, <span class="string">&quot;Events&quot;</span>, INCLUDE_SCHEMA_CHANGES, INCLUDE_SQL_QUERY, TABLES_IGNORE_BUILTIN,</span><br><span class="line">                DATABASE_WHITELIST, DATABASE_INCLUDE_LIST, TABLE_WHITELIST, TABLE_INCLUDE_LIST,</span><br><span class="line">                COLUMN_BLACKLIST, COLUMN_EXCLUDE_LIST, COLUMN_INCLUDE_LIST, TABLE_BLACKLIST, TABLE_EXCLUDE_LIST,</span><br><span class="line">                DATABASE_BLACKLIST, DATABASE_EXCLUDE_LIST, MSG_KEY_COLUMNS,</span><br><span class="line">                RelationalDatabaseConnectorConfig.MASK_COLUMN_WITH_HASH,</span><br><span class="line">                RelationalDatabaseConnectorConfig.MASK_COLUMN,</span><br><span class="line">                RelationalDatabaseConnectorConfig.TRUNCATE_COLUMN,</span><br><span class="line">                RelationalDatabaseConnectorConfig.SNAPSHOT_SELECT_STATEMENT_OVERRIDES_BY_TABLE,</span><br><span class="line">                GTID_SOURCE_INCLUDES, GTID_SOURCE_EXCLUDES, GTID_SOURCE_FILTER_DML_EVENTS, GTID_NEW_CHANNEL_POSITION, BUFFER_SIZE_FOR_BINLOG_READER,</span><br><span class="line">                Heartbeat.HEARTBEAT_INTERVAL, Heartbeat.HEARTBEAT_TOPICS_PREFIX, EVENT_DESERIALIZATION_FAILURE_HANDLING_MODE,</span><br><span class="line">                CommonConnectorConfig.EVENT_PROCESSING_FAILURE_HANDLING_MODE, INCONSISTENT_SCHEMA_HANDLING_MODE,</span><br><span class="line">                CommonConnectorConfig.TOMBSTONES_ON_DELETE, CommonConnectorConfig.SOURCE_STRUCT_MAKER_VERSION);</span><br><span class="line">        Field.group(config, <span class="string">&quot;Connector&quot;</span>, CONNECTION_TIMEOUT_MS, KEEP_ALIVE, KEEP_ALIVE_INTERVAL_MS, CommonConnectorConfig.MAX_QUEUE_SIZE,</span><br><span class="line">                CommonConnectorConfig.MAX_BATCH_SIZE, CommonConnectorConfig.POLL_INTERVAL_MS,</span><br><span class="line">                SNAPSHOT_MODE, SNAPSHOT_LOCKING_MODE, SNAPSHOT_NEW_TABLES, SNAPSHOT_EVENTS_AS_INSERTS, TIME_PRECISION_MODE, DECIMAL_HANDLING_MODE,</span><br><span class="line">                BIGINT_UNSIGNED_HANDLING_MODE, SNAPSHOT_DELAY_MS, SNAPSHOT_FETCH_SIZE, ENABLE_TIME_ADJUSTER, BINARY_HANDLING_MODE);</span><br><span class="line">        <span class="keyword">return</span> config;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-config-Field"><a href="#io-debezium-config-Field" class="headerlink" title="io.debezium.config.Field"></a>io.debezium.config.Field</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ConfigDef <span class="title">group</span><span class="params">(ConfigDef configDef, String groupName, Field... fields)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (configDef != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (groupName != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != fields.length; ++i) &#123;</span><br><span class="line">                    Field f = fields[i];</span><br><span class="line">                    <span class="comment">//调用org.apache.kafka.common.config.ConfigDef的define方法,将Field的key存入ConfigDef的map容器configKeys中</span></span><br><span class="line">                    configDef.define(f.name(), f.type(), f.defaultValue(), <span class="keyword">null</span>, f.importance(), f.description(),</span><br><span class="line">                            groupName, i + <span class="number">1</span>, f.width(), f.displayName(), f.dependents(), <span class="keyword">null</span>);	</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i != fields.length; ++i) &#123;</span><br><span class="line">                    Field f = fields[i];</span><br><span class="line">                    configDef.define(f.name(), f.type(), f.defaultValue(), <span class="keyword">null</span>, f.importance(), f.description(),</span><br><span class="line">                            <span class="keyword">null</span>, <span class="number">1</span>, f.width(), f.displayName(), f.dependents(), <span class="keyword">null</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> configDef;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="org-apache-kafka-common-config-ConfigDef"><a href="#org-apache-kafka-common-config-ConfigDef" class="headerlink" title="org.apache.kafka.common.config.ConfigDef"></a>org.apache.kafka.common.config.ConfigDef</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigDef</span> </span>&#123;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> ConfigDef <span class="title">define</span><span class="params">(ConfigDef.ConfigKey key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.configKeys.containsKey(key.name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Configuration &quot;</span> + key.name + <span class="string">&quot; is defined twice.&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.group != <span class="keyword">null</span> &amp;&amp; !<span class="keyword">this</span>.groups.contains(key.group)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.groups.add(key.group);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.configKeys.put(key.name, key);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h4 id="io-debezium-connector-mysql-MySqlConnectorTask"><a href="#io-debezium-connector-mysql-MySqlConnectorTask" class="headerlink" title="io.debezium.connector.mysql.MySqlConnectorTask"></a>io.debezium.connector.mysql.MySqlConnectorTask</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ChangeEventSourceCoordinator <span class="title">start</span><span class="params">(Configuration config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> String serverName = config.getString(MySqlConnectorConfig.SERVER_NAME);</span><br><span class="line">        PreviousContext prevLoggingContext = LoggingContext.forConnector(Module.contextName(), serverName, <span class="string">&quot;task&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Get the offsets for our partition ...</span></span><br><span class="line">            <span class="keyword">boolean</span> startWithSnapshot = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> snapshotEventsAsInserts = config.getBoolean(MySqlConnectorConfig.SNAPSHOT_EVENTS_AS_INSERTS);</span><br><span class="line">            Map&lt;String, String&gt; partition = Collect.hashMapOf(SourceInfo.SERVER_PARTITION_KEY, serverName); <span class="comment">//初始化分区map</span></span><br><span class="line">            Map&lt;String, ?&gt; offsets = getRestartOffset(context.offsetStorageReader().offset(partition)); <span class="comment">//初始化以&quot;RESTART_&quot;开头的偏移量</span></span><br><span class="line">            <span class="keyword">final</span> SourceInfo source;</span><br><span class="line">            <span class="keyword">if</span> (offsets != <span class="keyword">null</span>) &#123;</span><br><span class="line">                Filters filters = SourceInfo.offsetsHaveFilterInfo(offsets) ? getOldFilters(offsets, config) : getAllFilters(config);   <span class="comment">//初始化数据库和表过滤器</span></span><br><span class="line">                <span class="keyword">this</span>.taskContext = createAndStartTaskContext(config, filters);  <span class="comment">//调用初始化和开始任务上下文容器方法</span></span><br><span class="line">                <span class="keyword">this</span>.connectionContext = taskContext.getConnectionContext();    <span class="comment">//获取MySqlJdbcContext连接上下文</span></span><br><span class="line">                source = taskContext.source();  <span class="comment">//获取SourceInfo</span></span><br><span class="line">                <span class="comment">// Set the position in our source info ...</span></span><br><span class="line">                source.setOffset(offsets);  <span class="comment">//设置offset偏移量</span></span><br><span class="line">                logger.info(<span class="string">&quot;Found existing offset: &#123;&#125;&quot;</span>, offsets);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// First check if db history is available</span></span><br><span class="line">                <span class="keyword">if</span> (!taskContext.historyExists()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (taskContext.isSchemaOnlyRecoverySnapshot()) &#123;</span><br><span class="line">                        startWithSnapshot = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// But check to see if the server still has those binlog coordinates ...</span></span><br><span class="line">                        <span class="keyword">if</span> (!isBinlogAvailable()) &#123;</span><br><span class="line">                            String msg = <span class="string">&quot;The connector is trying to read binlog starting at &quot;</span> + source + <span class="string">&quot;, but this is no longer &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;available on the server. Reconfigure the connector to use a snapshot when needed.&quot;</span>;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                        logger.info(<span class="string">&quot;The db-history topic is missing but we are in &#123;&#125; snapshot mode. &quot;</span> +</span><br><span class="line">                                <span class="string">&quot;Attempting to snapshot the current schema and then begin reading the binlog from the last recorded offset.&quot;</span>,</span><br><span class="line">                                SnapshotMode.SCHEMA_ONLY_RECOVERY);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        String msg = <span class="string">&quot;The db history topic is missing. You may attempt to recover it by reconfiguring the connector to &quot;</span></span><br><span class="line">                                + SnapshotMode.SCHEMA_ONLY_RECOVERY;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">                    &#125;</span><br><span class="line">                    taskContext.initializeHistoryStorage();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Before anything else, recover the database history to the specified binlog coordinates ...</span></span><br><span class="line">                    taskContext.loadHistory(source);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (source.isSnapshotInEffect()) &#123;</span><br><span class="line">                        <span class="comment">// The last offset was an incomplete snapshot that we cannot recover from...</span></span><br><span class="line">                        <span class="keyword">if</span> (taskContext.isSnapshotNeverAllowed()) &#123;</span><br><span class="line">                            <span class="comment">// No snapshots are allowed</span></span><br><span class="line">                            String msg = <span class="string">&quot;The connector previously stopped while taking a snapshot, but now the connector is configured &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;to never allow snapshots. Reconfigure the connector to use snapshots initially or when needed.&quot;</span>;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// Otherwise, restart a new snapshot ...</span></span><br><span class="line">                        startWithSnapshot = <span class="keyword">true</span>;</span><br><span class="line">                        logger.info(<span class="string">&quot;Prior execution was an incomplete snapshot, so starting new snapshot&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// No snapshot was in effect, so we should just start reading from the binlog ...</span></span><br><span class="line">                        startWithSnapshot = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">                        <span class="comment">// But check to see if the server still has those binlog coordinates ...</span></span><br><span class="line">                        <span class="keyword">if</span> (!isBinlogAvailable()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (!taskContext.isSnapshotAllowedWhenNeeded()) &#123;</span><br><span class="line">                                String msg = <span class="string">&quot;The connector is trying to read binlog starting at &quot;</span> + source + <span class="string">&quot;, but this is no longer &quot;</span></span><br><span class="line">                                        + <span class="string">&quot;available on the server. Reconfigure the connector to use a snapshot when needed.&quot;</span>;</span><br><span class="line">                                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">                            &#125;</span><br><span class="line">                            startWithSnapshot = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// We have no recorded offsets ...</span></span><br><span class="line">                <span class="keyword">this</span>.taskContext = createAndStartTaskContext(config, getAllFilters(config));</span><br><span class="line">                taskContext.initializeHistoryStorage();</span><br><span class="line">                <span class="keyword">this</span>.connectionContext = taskContext.getConnectionContext();</span><br><span class="line">                source = taskContext.source();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (taskContext.isSnapshotNeverAllowed()) &#123;</span><br><span class="line">                    <span class="comment">// We&#x27;re not allowed to take a snapshot, so instead we have to assume that the binlog contains the</span></span><br><span class="line">                    <span class="comment">// full history of the database.</span></span><br><span class="line">                    logger.info(<span class="string">&quot;Found no existing offset and snapshots disallowed, so starting at beginning of binlog&quot;</span>);</span><br><span class="line">                    source.setBinlogStartPoint(<span class="string">&quot;&quot;</span>, <span class="number">0L</span>); <span class="comment">// start from the beginning of the binlog</span></span><br><span class="line">                    taskContext.initializeHistory();</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// Look to see what the first available binlog file is called, and whether it looks like binlog files have</span></span><br><span class="line">                    <span class="comment">// been purged. If so, then output a warning ...</span></span><br><span class="line">                    String earliestBinlogFilename = earliestBinlogFilename();</span><br><span class="line">                    <span class="keyword">if</span> (earliestBinlogFilename == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        logger.warn(<span class="string">&quot;No binlog appears to be available. Ensure that the MySQL row-level binlog is enabled.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (!earliestBinlogFilename.endsWith(<span class="string">&quot;00001&quot;</span>)) &#123;</span><br><span class="line">                        logger.warn(<span class="string">&quot;It is possible the server has purged some binlogs. If this is the case, then using snapshot mode may be required.&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// We are allowed to use snapshots, and that is the best way to start ...</span></span><br><span class="line">                    startWithSnapshot = <span class="keyword">true</span>;</span><br><span class="line">                    <span class="comment">// The snapshot will determine if GTIDs are set</span></span><br><span class="line">                    logger.info(<span class="string">&quot;Found no existing offset, so preparing to perform a snapshot&quot;</span>);</span><br><span class="line">                    <span class="comment">// The snapshot will also initialize history ...</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!startWithSnapshot &amp;&amp; source.gtidSet() == <span class="keyword">null</span> &amp;&amp; connectionContext.isGtidModeEnabled()) &#123;</span><br><span class="line">                <span class="comment">// The snapshot will properly determine the GTID set, but we&#x27;re not starting with a snapshot and GTIDs were not</span></span><br><span class="line">                <span class="comment">// previously used but the MySQL server has them enabled ...</span></span><br><span class="line">                source.setCompletedGtidSet(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Check whether the row-level binlog is enabled ...</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> binlogFormatRow = isBinlogFormatRow();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> binlogRowImageFull = isBinlogRowImageFull();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">boolean</span> rowBinlogEnabled = binlogFormatRow &amp;&amp; binlogRowImageFull;</span><br><span class="line"></span><br><span class="line">            ChainedReader.Builder chainedReaderBuilder = <span class="keyword">new</span> ChainedReader.Builder();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set up the readers, with a callback to `completeReaders` so that we know when it is finished ...</span></span><br><span class="line">            <span class="keyword">if</span> (startWithSnapshot) &#123;</span><br><span class="line">                <span class="comment">// We&#x27;re supposed to start with a snapshot, so set that up ...</span></span><br><span class="line">                SnapshotReader snapshotReader = <span class="keyword">new</span> SnapshotReader(<span class="string">&quot;snapshot&quot;</span>, taskContext);</span><br><span class="line">                <span class="keyword">if</span> (snapshotEventsAsInserts) &#123;</span><br><span class="line">                    snapshotReader.generateInsertEvents();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!taskContext.getConnectorConfig().getSnapshotDelay().isZero()) &#123;</span><br><span class="line">                    <span class="comment">// Adding a timed blocking reader to delay the snapshot, can help to avoid initial rebalancing interruptions</span></span><br><span class="line">                    chainedReaderBuilder.addReader(<span class="keyword">new</span> TimedBlockingReader(<span class="string">&quot;timed-blocker&quot;</span>, taskContext.getConnectorConfig().getSnapshotDelay()));</span><br><span class="line">                &#125;</span><br><span class="line">                chainedReaderBuilder.addReader(snapshotReader);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (taskContext.isInitialSnapshotOnly()) &#123;</span><br><span class="line">                    logger.warn(<span class="string">&quot;This connector will only perform a snapshot, and will stop after that completes.&quot;</span>);</span><br><span class="line">                    chainedReaderBuilder.addReader(<span class="keyword">new</span> BlockingReader(<span class="string">&quot;blocker&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;Connector has completed all of its work but will continue in the running state. It can be shut down at any time.&quot;</span>));</span><br><span class="line">                    chainedReaderBuilder</span><br><span class="line">                            .completionMessage(<span class="string">&quot;Connector configured to only perform snapshot, and snapshot completed successfully. Connector will terminate.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!rowBinlogEnabled) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!binlogFormatRow) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;The MySQL server is not configured to use a ROW binlog_format, which is &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;required for this connector to work properly. Change the MySQL configuration to use a &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;binlog_format=ROW and restart the connector.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;The MySQL server is not configured to use a FULL binlog_row_image, which is &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;required for this connector to work properly. Change the MySQL configuration to use a &quot;</span></span><br><span class="line">                                    + <span class="string">&quot;binlog_row_image=FULL and restart the connector.&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    BinlogReader binlogReader = <span class="keyword">new</span> BinlogReader(<span class="string">&quot;binlog&quot;</span>, taskContext, <span class="keyword">null</span>);</span><br><span class="line">                    chainedReaderBuilder.addReader(binlogReader);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                source.maybeSetFilterDataFromConfig(config);</span><br><span class="line">                <span class="keyword">if</span> (!rowBinlogEnabled) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(</span><br><span class="line">                            <span class="string">&quot;The MySQL server does not appear to be using a full row-level binlog, which is required for this connector to work properly. Enable this mode and restart the connector.&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// if there are new tables</span></span><br><span class="line">                <span class="keyword">if</span> (newTablesInConfig()) &#123;</span><br><span class="line">                    <span class="comment">// and we are configured to run a parallel snapshot</span></span><br><span class="line">                    <span class="keyword">if</span> (taskContext.getConnectorConfig().getSnapshotNewTables() == MySqlConnectorConfig.SnapshotNewTables.PARALLEL) &#123;</span><br><span class="line">                        ServerIdGenerator serverIdGenerator = <span class="keyword">new</span> ServerIdGenerator(config.getLong(MySqlConnectorConfig.SERVER_ID),</span><br><span class="line">                                config.getLong(MySqlConnectorConfig.SERVER_ID_OFFSET));</span><br><span class="line">                        ParallelSnapshotReader parallelSnapshotReader = <span class="keyword">new</span> ParallelSnapshotReader(config,</span><br><span class="line">                                taskContext,</span><br><span class="line">                                getNewFilters(offsets, config),</span><br><span class="line">                                serverIdGenerator);</span><br><span class="line"></span><br><span class="line">                        MySqlTaskContext unifiedTaskContext = createAndStartTaskContext(config, getAllFilters(config));</span><br><span class="line">                        <span class="comment">// we aren&#x27;t completing a snapshot, but we need to make sure the &quot;snapshot&quot; flag is false for this new context.</span></span><br><span class="line">                        unifiedTaskContext.source().completeSnapshot();</span><br><span class="line">                        BinlogReader unifiedBinlogReader = <span class="keyword">new</span> BinlogReader(<span class="string">&quot;binlog&quot;</span>,</span><br><span class="line">                                unifiedTaskContext,</span><br><span class="line">                                <span class="keyword">null</span>,</span><br><span class="line">                                serverIdGenerator.getConfiguredServerId());</span><br><span class="line">                        ReconcilingBinlogReader reconcilingBinlogReader = parallelSnapshotReader.createReconcilingBinlogReader(unifiedBinlogReader);</span><br><span class="line"></span><br><span class="line">                        chainedReaderBuilder.addReader(parallelSnapshotReader);</span><br><span class="line">                        chainedReaderBuilder.addReader(reconcilingBinlogReader);</span><br><span class="line">                        chainedReaderBuilder.addReader(unifiedBinlogReader);</span><br><span class="line"></span><br><span class="line">                        unifiedBinlogReader.uponCompletion(unifiedTaskContext::shutdown);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// We&#x27;re going to start by reading the binlog ...</span></span><br><span class="line">                    BinlogReader binlogReader = <span class="keyword">new</span> BinlogReader(<span class="string">&quot;binlog&quot;</span>, taskContext, <span class="keyword">null</span>);</span><br><span class="line">                    chainedReaderBuilder.addReader(binlogReader);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            readers = chainedReaderBuilder.build();</span><br><span class="line">            readers.uponCompletion(<span class="keyword">this</span>::completeReaders);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// And finally initialize and start the chain of readers ...</span></span><br><span class="line">            <span class="keyword">this</span>.readers.initialize();</span><br><span class="line">            <span class="keyword">this</span>.readers.start();	<span class="comment">//调用io.debezium.connector.mysql.ChainedReader的start方法</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            <span class="comment">// If we don&#x27;t complete startup, then Kafka Connect will not attempt to stop the connector. So if we</span></span><br><span class="line">            <span class="comment">// run into a problem, we have to stop ourselves ...</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stop();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable s) &#123;</span><br><span class="line">                <span class="comment">// Log, but don&#x27;t propagate ...</span></span><br><span class="line">                logger.error(<span class="string">&quot;Failed to start the connector (see other exception), but got this error while cleaning up&quot;</span>, s);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InterruptedException) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Interrupted while starting the connector&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ConnectException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (ConnectException) e;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">finally</span> &#123;</span><br><span class="line">            prevLoggingContext.restore();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> MySqlTaskContext <span class="title">createAndStartTaskContext</span><span class="params">(Configuration config,Filters filters)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//调用初始化任务io.debezium.connector.mysql.MySqlTaskContext上下文容器方法</span></span><br><span class="line">        MySqlTaskContext taskContext = <span class="keyword">new</span> MySqlTaskContext(config, filters);   </span><br><span class="line">            </span><br><span class="line">         <span class="comment">//启动任务上下文容器</span></span><br><span class="line">        taskContext.start();   </span><br><span class="line">        <span class="keyword">return</span> taskContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-MySqlTaskContext"><a href="#io-debezium-connector-mysql-MySqlTaskContext" class="headerlink" title="io.debezium.connector.mysql.MySqlTaskContext"></a>io.debezium.connector.mysql.MySqlTaskContext</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlTaskContext</span> <span class="keyword">extends</span> <span class="title">CdcSourceTaskContext</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MySqlTaskContext</span><span class="params">(Configuration config, Filters filters, Boolean tableIdCaseInsensitive, Map&lt;String, ?&gt; restartOffset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Module.contextName(), config.getString(MySqlConnectorConfig.SERVER_NAME), Collections::emptyList);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line">        <span class="keyword">this</span>.connectorConfig = <span class="keyword">new</span> MySqlConnectorConfig(config);	<span class="comment">//实例化mysql连接配置</span></span><br><span class="line">        <span class="keyword">this</span>.connectionContext = <span class="keyword">new</span> MySqlJdbcContext(connectorConfig);	<span class="comment">//实例化mysql连接上下文容器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the topic selector ...</span></span><br><span class="line">        <span class="keyword">this</span>.topicSelector = MySqlTopicSelector.defaultSelector(connectorConfig.getLogicalName(), connectorConfig.getHeartbeatTopicsPrefix());	<span class="comment">//设置kafka主题选择器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the source information ...</span></span><br><span class="line">        <span class="keyword">this</span>.source = <span class="keyword">new</span> SourceInfo(connectorConfig);	<span class="comment">//设置原信息</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the GTID filter ...</span></span><br><span class="line">        String gtidSetIncludes = config.getString(MySqlConnectorConfig.GTID_SOURCE_INCLUDES);</span><br><span class="line">        String gtidSetExcludes = config.getString(MySqlConnectorConfig.GTID_SOURCE_EXCLUDES);</span><br><span class="line">        <span class="keyword">this</span>.gtidSourceFilter = gtidSetIncludes != <span class="keyword">null</span> ? Predicates.includesUuids(gtidSetIncludes)</span><br><span class="line">                : (gtidSetExcludes != <span class="keyword">null</span> ? Predicates.excludesUuids(gtidSetExcludes) : <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (tableIdCaseInsensitive == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.tableIdCaseInsensitive = !<span class="string">&quot;0&quot;</span>.equals(connectionContext.readMySqlSystemVariables().get(MySqlSystemVariables.LOWER_CASE_TABLE_NAMES));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.tableIdCaseInsensitive = tableIdCaseInsensitive;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the MySQL schema ...</span></span><br><span class="line">        <span class="keyword">this</span>.dbSchema = <span class="keyword">new</span> MySqlSchema(connectorConfig, <span class="keyword">this</span>.gtidSourceFilter, <span class="keyword">this</span>.tableIdCaseInsensitive, topicSelector, filters);	<span class="comment">//实例化mysql schema</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the record processor ...</span></span><br><span class="line">        <span class="keyword">this</span>.recordProcessor = <span class="keyword">new</span> RecordMakers(dbSchema, source, topicSelector, connectorConfig.isEmitTombstoneOnDelete(), restartOffset);	<span class="comment">//实例化记录创建器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the DDL filter</span></span><br><span class="line">        <span class="keyword">final</span> String ddlFilter = config.getString(DatabaseHistory.DDL_FILTER);</span><br><span class="line">        <span class="keyword">this</span>.ddlFilter = (ddlFilter != <span class="keyword">null</span>) ? Predicates.includes(ddlFilter) : (x -&gt; <span class="keyword">false</span>);	<span class="comment">//设置ddl过滤器</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        connectionContext.start();	<span class="comment">//io.debezium.connector.mysql.MySqlJdbcContext启动</span></span><br><span class="line">        <span class="comment">// Start the MySQL database history, which simply starts up resources but does not recover the history to a specific point</span></span><br><span class="line">        dbSchema().start();	<span class="comment">//io.debezium.connector.mysql.MySqlSchema启动</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-MySqlJdbcContext"><a href="#io-debezium-connector-mysql-MySqlJdbcContext" class="headerlink" title="io.debezium.connector.mysql.MySqlJdbcContext"></a>io.debezium.connector.mysql.MySqlJdbcContext</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlJdbcContext</span> <span class="keyword">implements</span> <span class="title">AutoCloseable</span> </span>&#123;</span><br><span class="line">    <span class="comment">//调用开始方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sslModeEnabled()) &#123;</span><br><span class="line">            originalSystemProperties.clear();</span><br><span class="line">            <span class="comment">// Set the System properties for SSL for the MySQL driver ...</span></span><br><span class="line">            setSystemProperty(<span class="string">&quot;javax.net.ssl.keyStore&quot;</span>, MySqlConnectorConfig.SSL_KEYSTORE, <span class="keyword">true</span>);</span><br><span class="line">            setSystemProperty(<span class="string">&quot;javax.net.ssl.keyStorePassword&quot;</span>, MySqlConnectorConfig.SSL_KEYSTORE_PASSWORD, <span class="keyword">false</span>);</span><br><span class="line">            setSystemProperty(<span class="string">&quot;javax.net.ssl.trustStore&quot;</span>, MySqlConnectorConfig.SSL_TRUSTSTORE, <span class="keyword">true</span>);</span><br><span class="line">            setSystemProperty(<span class="string">&quot;javax.net.ssl.trustStorePassword&quot;</span>, MySqlConnectorConfig.SSL_TRUSTSTORE_PASSWORD, <span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-MySqlSchema"><a href="#io-debezium-connector-mysql-MySqlSchema" class="headerlink" title="io.debezium.connector.mysql.MySqlSchema"></a>io.debezium.connector.mysql.MySqlSchema</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlSchema</span> <span class="keyword">extends</span> <span class="title">RelationalDatabaseSchema</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.dbHistory.start();	<span class="comment">// io.debezium.relational.history.KafkaDatabaseHistory启动</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-relational-history-KafkaDatabaseHistory"><a href="#io-debezium-relational-history-KafkaDatabaseHistory" class="headerlink" title="io.debezium.relational.history.KafkaDatabaseHistory"></a>io.debezium.relational.history.KafkaDatabaseHistory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaDatabaseHistory</span> <span class="keyword">extends</span> <span class="title">AbstractDatabaseHistory</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.start();	<span class="comment">//调用父类io.debezium.relational.history.AbstractDatabaseHistory的start方法</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.producer == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.producer = <span class="keyword">new</span> KafkaProducer&lt;&gt;(<span class="keyword">this</span>.producerConfig.asProperties());	<span class="comment">//创建kafka消息生产者</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-relational-history-AbstractDatabaseHistory"><a href="#io-debezium-relational-history-AbstractDatabaseHistory" class="headerlink" title="io.debezium.relational.history.AbstractDatabaseHistory"></a>io.debezium.relational.history.AbstractDatabaseHistory</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractDatabaseHistory</span> <span class="keyword">implements</span> <span class="title">DatabaseHistory</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        listener.started();	<span class="comment">//调用io.debezium.relational.history.DatabaseHistoryMetrics的启动方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-relational-history-DatabaseHistoryMetrics"><a href="#io-debezium-relational-history-DatabaseHistoryMetrics" class="headerlink" title="io.debezium.relational.history.DatabaseHistoryMetrics"></a>io.debezium.relational.history.DatabaseHistoryMetrics</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseHistoryMetrics</span> <span class="keyword">extends</span> <span class="title">Metrics</span> <span class="keyword">implements</span> <span class="title">DatabaseHistoryListener</span>, <span class="title">DatabaseHistoryMXBean</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">enum</span> <span class="title">DatabaseHistoryStatus</span> </span>&#123;</span><br><span class="line">        STOPPED,</span><br><span class="line">        RECOVERING,</span><br><span class="line">        RUNNING</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">started</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        status = DatabaseHistoryStatus.RUNNING;	<span class="comment">//设置DatabaseHistoryMetrics的状态为RUNNING</span></span><br><span class="line">        register(LOGGER);	</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-BinlogReader"><a href="#io-debezium-connector-mysql-BinlogReader" class="headerlink" title="io.debezium.connector.mysql.BinlogReader"></a>io.debezium.connector.mysql.BinlogReader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinlogReader</span> <span class="keyword">extends</span> <span class="title">AbstractReader</span> </span>&#123;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="title">BinlogReader</span><span class="params">(String name, MySqlTaskContext context, HaltingPredicate acceptAndContinue, <span class="keyword">long</span> serverId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(name, context, acceptAndContinue);</span><br><span class="line"></span><br><span class="line">        connectionContext = context.getConnectionContext();</span><br><span class="line">        source = context.source();</span><br><span class="line">        recordMakers = context.makeRecord();</span><br><span class="line">        recordSchemaChangesInSourceRecords = context.includeSchemaChangeRecords();</span><br><span class="line">        clock = context.getClock();</span><br><span class="line">        eventDeserializationFailureHandlingMode = connectionContext.eventProcessingFailureHandlingMode();</span><br><span class="line">        inconsistentSchemaHandlingMode = connectionContext.inconsistentSchemaHandlingMode();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Use exponential delay to log the progress frequently at first, but the quickly tapering off to once an hour...</span></span><br><span class="line">        pollOutputDelay = ElapsedTimeStrategy.exponential(clock, INITIAL_POLL_PERIOD_IN_MILLIS, MAX_POLL_PERIOD_IN_MILLIS);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the log reader ...</span></span><br><span class="line">        client = <span class="keyword">new</span> BinaryLogClient(connectionContext.hostname(), connectionContext.port(), connectionContext.username(), connectionContext.password());</span><br><span class="line">        <span class="comment">// BinaryLogClient will overwrite thread names later</span></span><br><span class="line">        client.setThreadFactory(</span><br><span class="line">                Threads.threadFactory(MySqlConnector.class, context.getConnectorConfig().getLogicalName(), <span class="string">&quot;binlog-client&quot;</span>, <span class="keyword">false</span>, <span class="keyword">false</span>,</span><br><span class="line">                        x -&gt; binaryLogClientThreads.put(x.getName(), x)));</span><br><span class="line">        client.setServerId(serverId);</span><br><span class="line">        client.setSSLMode(sslModeFor(connectionContext.sslMode()));</span><br><span class="line">        <span class="keyword">if</span> (connectionContext.sslModeEnabled()) &#123;</span><br><span class="line">            SSLSocketFactory sslSocketFactory = getBinlogSslSocketFactory(connectionContext);</span><br><span class="line">            <span class="keyword">if</span> (sslSocketFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">                client.setSslSocketFactory(sslSocketFactory);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Configuration configuration = context.config();</span><br><span class="line">        client.setKeepAlive(configuration.getBoolean(MySqlConnectorConfig.KEEP_ALIVE));</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> keepAliveInterval = configuration.getLong(MySqlConnectorConfig.KEEP_ALIVE_INTERVAL_MS);</span><br><span class="line">        client.setKeepAliveInterval(keepAliveInterval);</span><br><span class="line">        <span class="comment">// Considering heartbeatInterval should be less than keepAliveInterval, we use the heartbeatIntervalFactor</span></span><br><span class="line">        <span class="comment">// multiply by keepAliveInterval and set the result value to heartbeatInterval.The default value of heartbeatIntervalFactor</span></span><br><span class="line">        <span class="comment">// is 0.8, and we believe the left time (0.2 * keepAliveInterval) is enough to process the packet received from the MySQL server.</span></span><br><span class="line">        client.setHeartbeatInterval((<span class="keyword">long</span>) (keepAliveInterval * heartbeatIntervalFactor));</span><br><span class="line">        client.registerEventListener(context.bufferSizeForBinlogReader() == <span class="number">0</span></span><br><span class="line">                ? <span class="keyword">this</span>::handleEvent</span><br><span class="line">                : (<span class="keyword">new</span> EventBuffer(context.bufferSizeForBinlogReader(), <span class="keyword">this</span>))::add);	<span class="comment">//注册事件处理监听器</span></span><br><span class="line"></span><br><span class="line">        client.registerLifecycleListener(<span class="keyword">new</span> ReaderThreadLifecycleListener());</span><br><span class="line">        client.registerEventListener(<span class="keyword">this</span>::onEvent);</span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">            client.registerEventListener(<span class="keyword">this</span>::logEvent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">boolean</span> filterDmlEventsByGtidSource = configuration.getBoolean(MySqlConnectorConfig.GTID_SOURCE_FILTER_DML_EVENTS);</span><br><span class="line">        gtidDmlSourceFilter = filterDmlEventsByGtidSource ? context.gtidSourceFilter() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up the event deserializer with additional type(s) ...</span></span><br><span class="line">        <span class="keyword">final</span> Map&lt;Long, TableMapEventData&gt; tableMapEventByTableId = <span class="keyword">new</span> HashMap&lt;Long, TableMapEventData&gt;();</span><br><span class="line">        EventDeserializer eventDeserializer = <span class="keyword">new</span> EventDeserializer() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Event <span class="title">nextEvent</span><span class="params">(ByteArrayInputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// Delegate to the superclass ...</span></span><br><span class="line">                    Event event = <span class="keyword">super</span>.nextEvent(inputStream);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// We have to record the most recent TableMapEventData for each table number for our custom deserializers ...</span></span><br><span class="line">                    <span class="keyword">if</span> (event.getHeader().getEventType() == EventType.TABLE_MAP) &#123;</span><br><span class="line">                        TableMapEventData tableMapEvent = event.getData();</span><br><span class="line">                        tableMapEventByTableId.put(tableMapEvent.getTableId(), tableMapEvent);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> event;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// DBZ-217 In case an event couldn&#x27;t be read we create a pseudo-event for the sake of logging</span></span><br><span class="line">                <span class="keyword">catch</span> (EventDataDeserializationException edde) &#123;</span><br><span class="line">                    EventHeaderV4 header = <span class="keyword">new</span> EventHeaderV4();</span><br><span class="line">                    header.setEventType(EventType.INCIDENT);</span><br><span class="line">                    header.setTimestamp(edde.getEventHeader().getTimestamp());</span><br><span class="line">                    header.setServerId(edde.getEventHeader().getServerId());</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (edde.getEventHeader() <span class="keyword">instanceof</span> EventHeaderV4) &#123;</span><br><span class="line">                        header.setEventLength(((EventHeaderV4) edde.getEventHeader()).getEventLength());</span><br><span class="line">                        header.setNextPosition(((EventHeaderV4) edde.getEventHeader()).getNextPosition());</span><br><span class="line">                        header.setFlags(((EventHeaderV4) edde.getEventHeader()).getFlags());</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    EventData data = <span class="keyword">new</span> EventDataDeserializationExceptionData(edde);</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">new</span> Event(header, data);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add our custom deserializers ...</span></span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.STOP, <span class="keyword">new</span> StopEventDataDeserializer());</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.GTID, <span class="keyword">new</span> GtidEventDataDeserializer());</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.WRITE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.WriteRowsDeserializer(tableMapEventByTableId));</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.UPDATE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.UpdateRowsDeserializer(tableMapEventByTableId));</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.DELETE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.DeleteRowsDeserializer(tableMapEventByTableId));</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.EXT_WRITE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.WriteRowsDeserializer(</span><br><span class="line">                        tableMapEventByTableId).setMayContainExtraInformation(<span class="keyword">true</span>));</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.EXT_UPDATE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.UpdateRowsDeserializer(</span><br><span class="line">                        tableMapEventByTableId).setMayContainExtraInformation(<span class="keyword">true</span>));</span><br><span class="line">        eventDeserializer.setEventDataDeserializer(EventType.EXT_DELETE_ROWS,</span><br><span class="line">                <span class="keyword">new</span> RowDeserializers.DeleteRowsDeserializer(</span><br><span class="line">                        tableMapEventByTableId).setMayContainExtraInformation(<span class="keyword">true</span>));</span><br><span class="line">        client.setEventDeserializer(eventDeserializer);	<span class="comment">//设置各种事件解析器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set up for JMX ...</span></span><br><span class="line">        metrics = <span class="keyword">new</span> BinlogReaderMetrics(client, context, name, changeEventQueueMetrics);</span><br><span class="line">        heartbeat = Heartbeat.create(configuration.getDuration(Heartbeat.HEARTBEAT_INTERVAL, ChronoUnit.MILLIS),</span><br><span class="line">                context.topicSelector().getHeartbeatTopic(), context.getConnectorConfig().getLogicalName());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doStart</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        context.dbSchema().assureNonEmptySchema();</span><br><span class="line">        Set&lt;Operation&gt; skippedOperations = context.getConnectorConfig().getSkippedOps();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Register our event handlers ...</span></span><br><span class="line">        eventHandlers.put(EventType.STOP, <span class="keyword">this</span>::handleServerStop);</span><br><span class="line">        eventHandlers.put(EventType.HEARTBEAT, <span class="keyword">this</span>::handleServerHeartbeat);</span><br><span class="line">        eventHandlers.put(EventType.INCIDENT, <span class="keyword">this</span>::handleServerIncident);</span><br><span class="line">        eventHandlers.put(EventType.ROTATE, <span class="keyword">this</span>::handleRotateLogsEvent);</span><br><span class="line">        eventHandlers.put(EventType.TABLE_MAP, <span class="keyword">this</span>::handleUpdateTableMetadata);</span><br><span class="line">        eventHandlers.put(EventType.QUERY, <span class="keyword">this</span>::handleQueryEvent);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!skippedOperations.contains(Operation.CREATE)) &#123;</span><br><span class="line">            eventHandlers.put(EventType.WRITE_ROWS, <span class="keyword">this</span>::handleInsert);</span><br><span class="line">            eventHandlers.put(EventType.EXT_WRITE_ROWS, <span class="keyword">this</span>::handleInsert);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!skippedOperations.contains(Operation.UPDATE)) &#123;</span><br><span class="line">            eventHandlers.put(EventType.UPDATE_ROWS, <span class="keyword">this</span>::handleUpdate);</span><br><span class="line">            eventHandlers.put(EventType.EXT_UPDATE_ROWS, <span class="keyword">this</span>::handleUpdate);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!skippedOperations.contains(Operation.DELETE)) &#123;</span><br><span class="line">            eventHandlers.put(EventType.DELETE_ROWS, <span class="keyword">this</span>::handleDelete);</span><br><span class="line">            eventHandlers.put(EventType.EXT_DELETE_ROWS, <span class="keyword">this</span>::handleDelete);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        eventHandlers.put(EventType.VIEW_CHANGE, <span class="keyword">this</span>::viewChange);</span><br><span class="line">        eventHandlers.put(EventType.XA_PREPARE, <span class="keyword">this</span>::prepareTransaction);</span><br><span class="line">        eventHandlers.put(EventType.XID, <span class="keyword">this</span>::handleTransactionCompletion);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Conditionally register ROWS_QUERY handler to parse SQL statements.</span></span><br><span class="line">        <span class="keyword">if</span> (context.includeSqlQuery()) &#123;</span><br><span class="line">            eventHandlers.put(EventType.ROWS_QUERY, <span class="keyword">this</span>::handleRowsQuery);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//MySQL5.6开始增加了强大的GTID（Global Transaction ID，全局事务ID）这个特性，用来强化数据库的主备一致性， 故障恢复， 以及容错能力。用于取代过去传统的主从复制</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">boolean</span> isGtidModeEnabled = connectionContext.isGtidModeEnabled();	</span><br><span class="line">        metrics.setIsGtidModeEnabled(isGtidModeEnabled);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Get the current GtidSet from MySQL so we can get a filtered/merged GtidSet based off of the last Debezium checkpoint.</span></span><br><span class="line">        String availableServerGtidStr = connectionContext.knownGtidSet();</span><br><span class="line">        <span class="keyword">if</span> (isGtidModeEnabled) &#123;</span><br><span class="line">            <span class="comment">// The server is using GTIDs, so enable the handler ...</span></span><br><span class="line">            eventHandlers.put(EventType.GTID, <span class="keyword">this</span>::handleGtidEvent);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Now look at the GTID set from the server and what we&#x27;ve previously seen ...</span></span><br><span class="line">            GtidSet availableServerGtidSet = <span class="keyword">new</span> GtidSet(availableServerGtidStr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// also take into account purged GTID logs</span></span><br><span class="line">            GtidSet purgedServerGtidSet = connectionContext.purgedGtidSet();</span><br><span class="line">            logger.info(<span class="string">&quot;GTID set purged on server: &#123;&#125;&quot;</span>, purgedServerGtidSet);</span><br><span class="line"></span><br><span class="line">            GtidSet filteredGtidSet = context.filterGtidSet(availableServerGtidSet, purgedServerGtidSet);</span><br><span class="line">            <span class="keyword">if</span> (filteredGtidSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// We&#x27;ve seen at least some GTIDs, so start reading from the filtered GTID set ...</span></span><br><span class="line">                logger.info(<span class="string">&quot;Registering binlog reader with GTID set: &#123;&#125;&quot;</span>, filteredGtidSet);</span><br><span class="line">                String filteredGtidSetStr = filteredGtidSet.toString();</span><br><span class="line">                client.setGtidSet(filteredGtidSetStr);</span><br><span class="line">                source.setCompletedGtidSet(filteredGtidSetStr);</span><br><span class="line">                gtidSet = <span class="keyword">new</span> com.github.shyiko.mysql.binlog.GtidSet(filteredGtidSetStr);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// We&#x27;ve not yet seen any GTIDs, so that means we have to start reading the binlog from the beginning ...</span></span><br><span class="line">                client.setBinlogFilename(source.binlogFilename());</span><br><span class="line">                client.setBinlogPosition(source.binlogPosition());</span><br><span class="line">                gtidSet = <span class="keyword">new</span> com.github.shyiko.mysql.binlog.GtidSet(<span class="string">&quot;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The server is not using GTIDs, so start reading the binlog based upon where we last left off ...</span></span><br><span class="line">            client.setBinlogFilename(source.binlogFilename());</span><br><span class="line">            client.setBinlogPosition(source.binlogPosition());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We may be restarting in the middle of a transaction, so see how far into the transaction we have already processed...</span></span><br><span class="line">        initialEventsToSkip = source.eventsToSkipUponRestart();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Set the starting row number, which is the next row number to be read ...</span></span><br><span class="line">        startingRowNumber = source.rowsToSkipUponRestart();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Only when we reach the first BEGIN event will we start to skip events ...</span></span><br><span class="line">        skipEvent = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Initial our poll output delay logic ...</span></span><br><span class="line">        pollOutputDelay.hasElapsed();</span><br><span class="line">        previousOutputMillis = clock.currentTimeInMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Start the log reader, which starts background threads ...</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning()) &#123;</span><br><span class="line">            <span class="keyword">long</span> timeout = context.getConnectorConfig().getConnectionTimeout().toMillis();</span><br><span class="line">            <span class="keyword">long</span> started = context.getClock().currentTimeInMillis();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                logger.debug(<span class="string">&quot;Attempting to establish binlog reader connection with timeout of &#123;&#125; ms&quot;</span>, timeout);</span><br><span class="line">                <span class="comment">//调用com.github.shyiko.mysql.binlog.BinaryLogClient的public void connect(final long timeout)方法</span></span><br><span class="line">                client.connect(timeout);	</span><br><span class="line">                <span class="comment">// Need to wait for keepalive thread to be running, otherwise it can be left orphaned</span></span><br><span class="line">                <span class="comment">// The problem is with timing. When the close is called too early after connect then</span></span><br><span class="line">                <span class="comment">// the keepalive thread is not terminated</span></span><br><span class="line">                <span class="keyword">if</span> (client.isKeepAlive()) &#123;</span><br><span class="line">                    logger.info(<span class="string">&quot;Waiting for keepalive thread to start&quot;</span>);</span><br><span class="line">                    <span class="keyword">final</span> Metronome metronome = Metronome.parker(Duration.ofMillis(<span class="number">100</span>), clock);</span><br><span class="line">                    <span class="keyword">int</span> waitAttempts = <span class="number">50</span>;</span><br><span class="line">                    <span class="keyword">boolean</span> keepAliveThreadRunning = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">while</span> (!keepAliveThreadRunning &amp;&amp; waitAttempts-- &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (Thread t : binaryLogClientThreads.values()) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (t.getName().startsWith(KEEPALIVE_THREAD_NAME) &amp;&amp; t.isAlive()) &#123;</span><br><span class="line">                                logger.info(<span class="string">&quot;Keepalive thread is running&quot;</span>);</span><br><span class="line">                                keepAliveThreadRunning = <span class="keyword">true</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        metronome.pause();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (TimeoutException e) &#123;</span><br><span class="line">                <span class="comment">// If the client thread is interrupted *before* the client could connect, the client throws a timeout exception</span></span><br><span class="line">                <span class="comment">// The only way we can distinguish this is if we get the timeout exception before the specified timeout has</span></span><br><span class="line">                <span class="comment">// elapsed, so we simply check this (within 10%) ...</span></span><br><span class="line">                <span class="keyword">long</span> duration = context.getClock().currentTimeInMillis() - started;</span><br><span class="line">                <span class="keyword">if</span> (duration &gt; (<span class="number">0.9</span> * timeout)) &#123;</span><br><span class="line">                    <span class="keyword">double</span> actualSeconds = TimeUnit.MILLISECONDS.toSeconds(duration);</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Timed out after &quot;</span> + actualSeconds + <span class="string">&quot; seconds while waiting to connect to MySQL at &quot;</span> +</span><br><span class="line">                            connectionContext.hostname() + <span class="string">&quot;:&quot;</span> + connectionContext.port() + <span class="string">&quot; with user &#x27;&quot;</span> + connectionContext.username() + <span class="string">&quot;&#x27;&quot;</span>, e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// Otherwise, we were told to shutdown, so we don&#x27;t care about the timeout exception</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Failed to authenticate to the MySQL database at &quot;</span> +</span><br><span class="line">                        connectionContext.hostname() + <span class="string">&quot;:&quot;</span> + connectionContext.port() + <span class="string">&quot; with user &#x27;&quot;</span> + connectionContext.username() + <span class="string">&quot;&#x27;&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to connect to the MySQL database at &quot;</span> +</span><br><span class="line">                        connectionContext.hostname() + <span class="string">&quot;:&quot;</span> + connectionContext.port() + <span class="string">&quot; with user &#x27;&quot;</span> + connectionContext.username() + <span class="string">&quot;&#x27;: &quot;</span> + e.getMessage(), e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="com-github-shyiko-mysql-binlog-BinaryLogClient"><a href="#com-github-shyiko-mysql-binlog-BinaryLogClient" class="headerlink" title="com.github.shyiko.mysql.binlog.BinaryLogClient"></a>com.github.shyiko.mysql.binlog.BinaryLogClient</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinaryLogClient</span> <span class="keyword">implements</span> <span class="title">BinaryLogClientMXBean</span> </span>&#123;</span><br><span class="line">	    <span class="function"><span class="keyword">public</span> <span class="title">BinaryLogClient</span><span class="params">(String hostname, <span class="keyword">int</span> port, String schema, String username, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.logger = Logger.getLogger(<span class="keyword">this</span>.getClass().getName());</span><br><span class="line">        <span class="keyword">this</span>.blocking = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.serverId = <span class="number">65535L</span>;</span><br><span class="line">        <span class="keyword">this</span>.binlogPosition = <span class="number">4L</span>;</span><br><span class="line">        <span class="keyword">this</span>.sslMode = SSLMode.DISABLED;</span><br><span class="line">        <span class="keyword">this</span>.gtidSetAccessLock = <span class="keyword">new</span> Object();</span><br><span class="line">        <span class="keyword">this</span>.eventDeserializer = <span class="keyword">new</span> EventDeserializer();	<span class="comment">//时间解析器</span></span><br><span class="line">        <span class="keyword">this</span>.eventListeners = <span class="keyword">new</span> CopyOnWriteArrayList();	<span class="comment">//时间监听list</span></span><br><span class="line">        <span class="keyword">this</span>.lifecycleListeners = <span class="keyword">new</span> CopyOnWriteArrayList();</span><br><span class="line">        <span class="keyword">this</span>.masterServerId = -<span class="number">1L</span>;</span><br><span class="line">        <span class="keyword">this</span>.keepAlive = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">this</span>.keepAliveInterval = TimeUnit.MINUTES.toMillis(<span class="number">1L</span>);</span><br><span class="line">        <span class="keyword">this</span>.connectTimeout = TimeUnit.SECONDS.toMillis(<span class="number">3L</span>);</span><br><span class="line">        <span class="keyword">this</span>.connectLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">this</span>.keepAliveThreadExecutorLock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">        <span class="keyword">this</span>.hostname = hostname;	<span class="comment">//主机名</span></span><br><span class="line">        <span class="keyword">this</span>.port = port;	<span class="comment">//数据库端口</span></span><br><span class="line">        <span class="keyword">this</span>.schema = schema;	<span class="comment">//数据库名</span></span><br><span class="line">        <span class="keyword">this</span>.username = username;	<span class="comment">//数据库用户名</span></span><br><span class="line">        <span class="keyword">this</span>.password = password;	<span class="comment">//数据库密码</span></span><br><span class="line"> 	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">connect</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.connectLock.tryLock()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">&quot;BinaryLogClient is already connected&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">boolean</span> notifyWhenDisconnected = <span class="keyword">false</span>;</span><br><span class="line">            <span class="keyword">boolean</span> var22 = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                var22 = <span class="keyword">true</span>;</span><br><span class="line">                Callable cancelDisconnect = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">                        <span class="keyword">this</span>.channel = <span class="keyword">this</span>.openChannel();</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.connectTimeout &gt; <span class="number">0L</span> &amp;&amp; !<span class="keyword">this</span>.isKeepAliveThreadRunning()) &#123;</span><br><span class="line">                            cancelDisconnect = <span class="keyword">this</span>.scheduleDisconnectIn(<span class="keyword">this</span>.connectTimeout - (System.currentTimeMillis() - start));</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.channel.getInputStream().peek() == -<span class="number">1</span>) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException var35) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Failed to connect to MySQL on &quot;</span> + <span class="keyword">this</span>.hostname + <span class="string">&quot;:&quot;</span> + <span class="keyword">this</span>.port + <span class="string">&quot;. Please make sure it&#x27;s running.&quot;</span>, var35);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    GreetingPacket greetingPacket = <span class="keyword">this</span>.receiveGreeting();</span><br><span class="line">                    <span class="keyword">this</span>.tryUpgradeToSSL(greetingPacket);</span><br><span class="line">                    (<span class="keyword">new</span> Authenticator(greetingPacket, <span class="keyword">this</span>.channel, <span class="keyword">this</span>.schema, <span class="keyword">this</span>.username, <span class="keyword">this</span>.password)).authenticate();</span><br><span class="line">                    <span class="keyword">this</span>.channel.authenticationComplete();</span><br><span class="line">                    <span class="keyword">this</span>.connectionId = greetingPacket.getThreadId();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">&quot;&quot;</span>.equals(<span class="keyword">this</span>.binlogFilename)) &#123;</span><br><span class="line">                        <span class="keyword">synchronized</span>(<span class="keyword">this</span>.gtidSetAccessLock) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>.gtidSet != <span class="keyword">null</span> &amp;&amp; <span class="string">&quot;&quot;</span>.equals(<span class="keyword">this</span>.gtidSet.toString()) &amp;&amp; <span class="keyword">this</span>.gtidSetFallbackToPurged) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.gtidSet = <span class="keyword">new</span> GtidSet(<span class="keyword">this</span>.fetchGtidPurged());</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.binlogFilename == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.fetchBinlogFilenameAndPosition();	<span class="comment">//获取binlog文件名和位置</span></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.binlogPosition &lt; <span class="number">4L</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isLoggable(Level.WARNING)) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.logger.warning(<span class="string">&quot;Binary log position adjusted from &quot;</span> + <span class="keyword">this</span>.binlogPosition + <span class="string">&quot; to &quot;</span> + <span class="number">4</span>);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">this</span>.binlogPosition = <span class="number">4L</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    ChecksumType checksumType = <span class="keyword">this</span>.fetchBinlogChecksum();</span><br><span class="line">                    <span class="keyword">if</span> (checksumType != ChecksumType.NONE) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.confirmSupportOfChecksum(checksumType);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.setMasterServerId();</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.heartbeatInterval &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.enableHeartbeat();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.gtid = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">this</span>.tx = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">this</span>.requestBinaryLogStream();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException var36) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.disconnectChannel();</span><br><span class="line">                    <span class="keyword">throw</span> var36;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (cancelDisconnect != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            cancelDisconnect.call();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (Exception var34) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isLoggable(Level.WARNING)) &#123;</span><br><span class="line">                                <span class="keyword">this</span>.logger.warning(<span class="string">&quot;\&quot;&quot;</span> + var34.getMessage() + <span class="string">&quot;\&quot; was thrown while canceling scheduled disconnect call&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.connected = <span class="keyword">true</span>;</span><br><span class="line">                notifyWhenDisconnected = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isLoggable(Level.INFO)) &#123;</span><br><span class="line">                    String position;</span><br><span class="line">                    <span class="keyword">synchronized</span>(<span class="keyword">this</span>.gtidSetAccessLock) &#123;</span><br><span class="line">                        position = <span class="keyword">this</span>.gtidSet != <span class="keyword">null</span> ? <span class="keyword">this</span>.gtidSet.toString() : <span class="keyword">this</span>.binlogFilename + <span class="string">&quot;/&quot;</span> + <span class="keyword">this</span>.binlogPosition;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">this</span>.logger.info(<span class="string">&quot;Connected to &quot;</span> + <span class="keyword">this</span>.hostname + <span class="string">&quot;:&quot;</span> + <span class="keyword">this</span>.port + <span class="string">&quot; at &quot;</span> + position + <span class="string">&quot; (&quot;</span> + (<span class="keyword">this</span>.blocking ? <span class="string">&quot;sid:&quot;</span> + <span class="keyword">this</span>.serverId + <span class="string">&quot;, &quot;</span> : <span class="string">&quot;&quot;</span>) + <span class="string">&quot;cid:&quot;</span> + <span class="keyword">this</span>.connectionId + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Iterator var43 = <span class="keyword">this</span>.lifecycleListeners.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var43.hasNext()) &#123;</span><br><span class="line">                    BinaryLogClient.LifecycleListener lifecycleListener = (BinaryLogClient.LifecycleListener)var43.next();</span><br><span class="line">                    lifecycleListener.onConnect(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.keepAlive &amp;&amp; !<span class="keyword">this</span>.isKeepAliveThreadRunning()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.spawnKeepAliveThread();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.ensureEventDataDeserializer(EventType.ROTATE, RotateEventDataDeserializer.class);</span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="keyword">this</span>.gtidSetAccessLock) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="keyword">this</span>.gtidSet != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="comment">//调用实例化事件解析器方法</span></span><br><span class="line">                        <span class="keyword">this</span>.ensureEventDataDeserializer(EventType.GTID, GtidEventDataDeserializer.class);</span><br><span class="line">                        <span class="keyword">this</span>.ensureEventDataDeserializer(EventType.QUERY, QueryEventDataDeserializer.class);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">this</span>.listenForEventPackets();</span><br><span class="line">                var22 = <span class="keyword">false</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (var22) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.connectLock.unlock();</span><br><span class="line">                    <span class="keyword">if</span> (notifyWhenDisconnected) &#123;</span><br><span class="line">                        Iterator var11 = <span class="keyword">this</span>.lifecycleListeners.iterator();</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">while</span>(var11.hasNext()) &#123;</span><br><span class="line">                            BinaryLogClient.LifecycleListener lifecycleListener = (BinaryLogClient.LifecycleListener)var11.next();</span><br><span class="line">                            lifecycleListener.onDisconnect(<span class="keyword">this</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.connectLock.unlock();</span><br><span class="line">            <span class="keyword">if</span> (notifyWhenDisconnected) &#123;</span><br><span class="line">                Iterator var40 = <span class="keyword">this</span>.lifecycleListeners.iterator();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">while</span>(var40.hasNext()) &#123;</span><br><span class="line">                    BinaryLogClient.LifecycleListener lifecycleListener = (BinaryLogClient.LifecycleListener)var40.next();</span><br><span class="line">                    lifecycleListener.onDisconnect(<span class="keyword">this</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//注册监听器方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerEventListener</span><span class="params">(BinaryLogClient.EventListener eventListener)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.eventListeners.add(eventListener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="com-github-shyiko-mysql-binlog-event-deserialization-EventDeserializer"><a href="#com-github-shyiko-mysql-binlog-event-deserialization-EventDeserializer" class="headerlink" title="com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer"></a>com.github.shyiko.mysql.binlog.event.deserialization.EventDeserializer</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EventDeserializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Deserializer</span> <span class="keyword">implements</span> <span class="title">EventDataDeserializer</span> </span>&#123;</span><br><span class="line">            <span class="keyword">private</span> EventDataDeserializer internal;</span><br><span class="line">            <span class="keyword">private</span> EventDataDeserializer external;</span><br><span class="line"></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="title">Deserializer</span><span class="params">(EventDataDeserializer internal, EventDataDeserializer external)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">this</span>.internal = internal;</span><br><span class="line">                <span class="keyword">this</span>.external = external;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">                </span><br><span class="line">            <span class="comment">//将事件流解析为事件数据对象</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> EventData <span class="title">deserialize</span><span class="params">(ByteArrayInputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = inputStream.read(inputStream.available());</span><br><span class="line">                EventData internalEventData = <span class="keyword">this</span>.internal.deserialize(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                EventData externalEventData = <span class="keyword">this</span>.external.deserialize(<span class="keyword">new</span> ByteArrayInputStream(bytes));</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> EventDeserializer.EventDataWrapper(internalEventData, externalEventData);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    	<span class="comment">//解析数据流为事件</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Event <span class="title">nextEvent</span><span class="params">(ByteArrayInputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (inputStream.peek() == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            EventHeader eventHeader = <span class="keyword">this</span>.eventHeaderDeserializer.deserialize(inputStream);</span><br><span class="line">            EventData eventData;</span><br><span class="line">            <span class="keyword">switch</span>(eventHeader.getEventType()) &#123;</span><br><span class="line">            <span class="keyword">case</span> FORMAT_DESCRIPTION:</span><br><span class="line">                eventData = <span class="keyword">this</span>.deserializeFormatDescriptionEventData(inputStream, eventHeader);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> TABLE_MAP:</span><br><span class="line">                eventData = <span class="keyword">this</span>.deserializeTableMapEventData(inputStream, eventHeader);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                EventDataDeserializer eventDataDeserializer = <span class="keyword">this</span>.getEventDataDeserializer(eventHeader.getEventType());</span><br><span class="line">                eventData = <span class="keyword">this</span>.deserializeEventData(inputStream, eventHeader, eventDataDeserializer);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Event(eventHeader, eventData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-ChainedReader"><a href="#io-debezium-connector-mysql-ChainedReader" class="headerlink" title="io.debezium.connector.mysql.ChainedReader"></a>io.debezium.connector.mysql.ChainedReader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedReader</span> <span class="keyword">implements</span> <span class="title">Reader</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (running.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            completed.set(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Build up the list of readers that need to be called ...</span></span><br><span class="line">            remainingReaders.clear();</span><br><span class="line">            readers.forEach(remainingReaders::add);	<span class="comment">//循环添加进LinkedList&lt;Reader&gt; remainingReaders</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the first reader, if there is one ...</span></span><br><span class="line">            <span class="keyword">if</span> (!startNextReader()) &#123;	<span class="comment">//调用当前类startNextReader方法</span></span><br><span class="line">                <span class="comment">// We couldn&#x27;t start it ...</span></span><br><span class="line">                running.set(<span class="keyword">false</span>);</span><br><span class="line">                completed.set(<span class="keyword">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">startNextReader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Reader reader = remainingReaders.isEmpty() ? <span class="keyword">null</span> : remainingReaders.pop();</span><br><span class="line">        <span class="keyword">if</span> (reader == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// There are no readers, so nothing to do ...</span></span><br><span class="line">            Reader lastReader = currentReader.getAndSet(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (lastReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Make sure it has indeed stopped ...</span></span><br><span class="line">                lastReader.stop();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// There is at least one more reader, so start it ...</span></span><br><span class="line">        Reader lastReader = currentReader.getAndSet(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">if</span> (lastReader != <span class="keyword">null</span>) &#123;</span><br><span class="line">            logger.info(<span class="string">&quot;Transitioning from the &#123;&#125; reader to the &#123;&#125; reader&quot;</span>, lastReader.name(), reader.name());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;Starting the &#123;&#125; reader&quot;</span>, reader.name());</span><br><span class="line">        &#125;</span><br><span class="line">        reader.start();	<span class="comment">//当前reader执行start方法，io.debezium.connector.mysql.AbstractReader</span></span><br><span class="line">        currentReader.set(reader);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="io-debezium-connector-mysql-AbstractReader"><a href="#io-debezium-connector-mysql-AbstractReader" class="headerlink" title="io.debezium.connector.mysql.AbstractReader"></a>io.debezium.connector.mysql.AbstractReader</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractReader</span> <span class="keyword">implements</span> <span class="title">Reader</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.running.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.failure.set(<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">this</span>.success.set(<span class="keyword">false</span>);</span><br><span class="line">            doStart();	<span class="comment">//调用 io.debezium.connector.mysql.BinlogReader的dostart方法</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Debezuim/debezuim%E6%BA%90%E7%A0%81/" data-id="ckk2gq3ul001tz8pqgvvc0jzy" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/01/18/DevOps/DevOps/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/01/18/Debezuim/debezuim_ch/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>