<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/4/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-SpringBoot/06_SpringBoot的日志" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/06_SpringBoot%E7%9A%84%E6%97%A5%E5%BF%97/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.579Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="1-市面上常见日志框架"><a href="#1-市面上常见日志框架" class="headerlink" title="1.市面上常见日志框架"></a>1.市面上常见日志框架</h4><p>JUL,JCL,Jboss-logging,logback,log4j,log4j2,slf4j</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115207.png"></p>
<p>左边选一个门面(抽象层),右边选一个实现       </p>
<p>日志门面:SLF4j       </p>
<p>日志实现:Logback或Log4j2       </p>
<p>SpringBoot:底层是Spring框架,</p>
<p>Spring默认使用JCL,SpringBoot选用SLF4j和logback</p>
<h4 id="2-SLF4j使用"><a href="#2-SLF4j使用" class="headerlink" title="2.SLF4j使用"></a>2.SLF4j使用</h4><h5 id="1-如何使用SLF4j"><a href="#1-如何使用SLF4j" class="headerlink" title="1.如何使用SLF4j"></a>1.如何使用SLF4j</h5><p>以后开发的时候,日志方法的调用,不应该直接调用日志的实现类,而是调用日志抽象层的方法       </p>
<p>应该给系统导入slf4j的jar和logback的实现jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Logger logger = LoggerFactory.getLogger(HelloWorld.class);</span><br><span class="line">    logger.info(<span class="string">&quot;Hello World&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>图示</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115218.png"></p>
<p>每一个日志的实现框架都有自己的配置文件,使用slf4j以后,配置文件还是做成日志实现框架的配置文件</p>
<h5 id="2-遗留问题"><a href="#2-遗留问题" class="headerlink" title="2.遗留问题"></a>2.遗留问题</h5><p>a(slf4j+logback):Spring(commons-logging)   Hibernate(jboss-logging)  MyBatis       </p>
<p>统一日志记录,即使是别的日志框架,统一使用slf4j进行输出</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115232.png"></p>
<h5 id="如何让系统中所有的日志都统一到slf4j"><a href="#如何让系统中所有的日志都统一到slf4j" class="headerlink" title="如何让系统中所有的日志都统一到slf4j:"></a>如何让系统中所有的日志都统一到slf4j:</h5><ol>
<li>先将系统中其他日志框架排除出去         </li>
<li>用中间包来替换原有的日志框架         </li>
<li>导入slf4j其他的实现</li>
</ol>
<h4 id="3-SpringBoot日志关系"><a href="#3-SpringBoot日志关系" class="headerlink" title="3.SpringBoot日志关系"></a>3.SpringBoot日志关系</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SpringBoot使用它来做日志功能</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">scope</span>&gt;</span>compile<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>SpringBoot日志底层依赖关系</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115241.png"></p>
<p>总结:</p>
<ol>
<li>SpringBoot底层也是使用slf4j+logback的方式进行日志</li>
<li>SpringBoot也把日志都替换成slf4j</li>
<li>中间替换包</li>
<li>如果我们要引入其他框架,一定要把这个框架的默认日志文件都移除掉<ul>
<li>如Spring框架使用的是commons-logging </li>
</ul>
</li>
</ol>
<p><strong>==SpringBoot能自动适配所有的日志,而且底层使用slf4j+logback的方式记录日志,引入其他框架,只需要把这个框架依赖的日志框架排除掉==</strong></p>
<h4 id="4-日志使用"><a href="#4-日志使用" class="headerlink" title="4.日志使用"></a>4.日志使用</h4><h5 id="1-默认配置"><a href="#1-默认配置" class="headerlink" title="1.默认配置"></a>1.默认配置</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//记录器</span></span><br><span class="line">    Logger logger = LoggerFactory.getLogger(getClass());</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//        System.out.println();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//日志的级别:</span></span><br><span class="line">        <span class="comment">//日志的界别由低到高trace&lt;debug&lt;info&lt;warn&lt;error</span></span><br><span class="line">        <span class="comment">//可以调整输出的日志界别,日志就只会在这个级别以及以后的高级别生效</span></span><br><span class="line">        logger.trace(<span class="string">&quot;这是trace日志&quot;</span>);</span><br><span class="line">        logger.debug(<span class="string">&quot;这是debug日志&quot;</span>);</span><br><span class="line">        <span class="comment">//SpringBoot默认的日志级别是info,没有指定级别的默认用的就是SpringBoot默认规定的级别,root级别</span></span><br><span class="line">        logger.info(<span class="string">&quot;这是info日志&quot;</span>);</span><br><span class="line">        logger.warn(<span class="string">&quot;这是warn日志&quot;</span>);</span><br><span class="line">        logger.error(<span class="string">&quot;这是error日志&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">日志的输出格式:</span><br><span class="line">	%d表示日期时间</span><br><span class="line">	%thread表示线程名</span><br><span class="line">	%-5level:级别从左显示5个字符宽度</span><br><span class="line">	%loggger&#123;50&#125;表示logger名字最长50个字符,否则按照句点分割</span><br><span class="line">	%msg:日志消息</span><br><span class="line">	%n是换行符</span><br><span class="line">	#指定文件中日志输出的格式</span><br><span class="line">%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; &#x3D;&#x3D;&#x3D; [%thread] &#x3D;&#x3D;&#x3D; %-5level &#x3D;&#x3D;&#x3D; %logger&#123;50&#125; - %msg%n</span><br></pre></td></tr></table></figure>
<p>SpringBoot修改日志的默认配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">logging.level.com.atguigu</span>=<span class="string">trace</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#不指定路径在当前项目下生成springboot.log日志</span></span><br><span class="line"><span class="comment">#可以指定完整的路径</span></span><br><span class="line"><span class="comment">#logging.file.name=C:/springboot.log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在当前磁盘的根路径下创建spring文件夹和里面的log文件夹,使用spring.log作为默认文件</span></span><br><span class="line"><span class="meta">logging.file.path</span>=<span class="string">/spring/log</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在控制台输出的日志的格式</span></span><br><span class="line"><span class="meta">logging.pattern.console</span>=<span class="string">%d&#123;yyyy-MM-dd&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定文件中日志输出的格式</span></span><br><span class="line"><span class="meta">logging.pattern.file</span>=<span class="string">%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; === [%thread] === %-5level === %logger&#123;50&#125; - %msg%n</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="left">logging.file</th>
<th>logging.path</th>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td align="left">(none)</td>
<td>(none)</td>
<td></td>
<td>只在控制台输出</td>
</tr>
<tr>
<td align="left">指定文件名</td>
<td>(none)</td>
<td>my.log</td>
<td>输出日志到my.log文件</td>
</tr>
<tr>
<td align="left">(none)</td>
<td>指定目录</td>
<td>/var/log</td>
<td>输出到指定目录的 spring.log 文件中</td>
</tr>
</tbody></table>
<h5 id="2-指定配置"><a href="#2-指定配置" class="headerlink" title="2.指定配置"></a>2.指定配置</h5><p>给类路径下放上每个日志框架自己的配置文件即可；SpringBoot就不使用他默认配置的了</p>
<table>
<thead>
<tr>
<th align="left">Logging System</th>
<th align="left">Customization</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Logback</td>
<td align="left"><code>logback-spring.xml</code>, <code>logback-spring.groovy</code>, <code>logback.xml</code>, or <code>logback.groovy</code></td>
</tr>
<tr>
<td align="left">Log4j2</td>
<td align="left"><code>log4j2-spring.xml</code> or <code>log4j2.xml</code></td>
</tr>
<tr>
<td align="left">JDK (Java Util Logging)</td>
<td align="left"><code>logging.properties</code></td>
</tr>
</tbody></table>
<p>logback.xml:直接就被日志框架识别了</p>
<p>logback-spring.xml:日志框架就不直接加载日志的配置项,由SpringBoot解析日志配置,可以使用SpringBoot的高级profile功能</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;staging&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configuration to be enabled when the &quot;staging&quot; profile is active --&gt;</span></span><br><span class="line">    可以指定某个配置只在某个环境生效</span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;dev | staging&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configuration to be enabled when the &quot;dev&quot; or &quot;staging&quot; profiles are active --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;!production&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- configuration to be enabled when the &quot;production&quot; profile is not active --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>否则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">no applicable action <span class="keyword">for</span> [springProfile]</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;stdout&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">       <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">       日志输出格式：</span></span><br><span class="line"><span class="comment">		%d表示日期时间，</span></span><br><span class="line"><span class="comment">		%thread表示线程名，</span></span><br><span class="line"><span class="comment">		%-5level：级别从左显示5个字符宽度</span></span><br><span class="line"><span class="comment">		%logger&#123;50&#125; 表示logger名字最长50个字符，否则按照句点分割。 </span></span><br><span class="line"><span class="comment">		%msg：日志消息，</span></span><br><span class="line"><span class="comment">		%n是换行符</span></span><br><span class="line"><span class="comment">       --&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">layout</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.PatternLayout&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;dev&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] ---&gt; %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">springProfile</span> <span class="attr">name</span>=<span class="string">&quot;!dev&quot;</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] === %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">springProfile</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="5-切换日志框架"><a href="#5-切换日志框架" class="headerlink" title="5.切换日志框架"></a>5.切换日志框架</h4><p>可以按照slf4j的日志适配图,进行日志的切换(不推荐)</p>
<p>slf4j+log4j方式:排除logback,引入slf4j-log4j12</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-log4j12<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>slf4j+log4j2方式:排除starter-logging,使用starter-log4j2</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">dependency&gt;</span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/06_SpringBoot%E7%9A%84%E6%97%A5%E5%BF%97/" data-id="ckk2gq3ti000sz8pq4xc3agyb" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SpringBoot/04_SpringBoot的配置文件" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/04_SpringBoot%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.574Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="1-SpringBoot使用一个全局的配置文件"><a href="#1-SpringBoot使用一个全局的配置文件" class="headerlink" title="1.SpringBoot使用一个全局的配置文件"></a>1.SpringBoot使用一个全局的配置文件</h4><p>配置文件名为固定 :</p>
<ul>
<li>application.properties</li>
<li>application.yml     </li>
</ul>
<p>配置文件的作用:修改SpringBoot自动配置的默认值,SpringBoot在底层都给我们配置好了</p>
<h4 id="2-YAML-YAML-Ain’t-Markup-Language"><a href="#2-YAML-YAML-Ain’t-Markup-Language" class="headerlink" title="2.YAML(YAML Ain’t Markup Language)"></a>2.YAML(YAML Ain’t Markup Language)</h4><p>YAML A Markup Language:是一个标记语言       </p>
<p>YAML isn’t Markup Language:不是一个标记语言</p>
<p>标记语言:       </p>
<p>​    以前的标记语言大多使用的是xxx.xml语言       </p>
<p>​    YAML:以数据为中心,比json,xml等更适合做配置文件             </p>
<p>​    YAML配置实例: </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>
<p>​    XML配置:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">server</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">port</span>&gt;</span>8081<span class="tag">&lt;/<span class="name">port</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">server</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="3-YAML的基本语法"><a href="#3-YAML的基本语法" class="headerlink" title="3.YAML的基本语法"></a>3.YAML的基本语法</h4><h5 id="1-基本语法"><a href="#1-基本语法" class="headerlink" title="1.基本语法"></a>1.基本语法</h5><ul>
<li>k:(空格)v:表示一对键值对(空格必须有)          </li>
<li>以空格的缩进来控制层级关系,只要是左对齐的一列数据,都是统一层级的,属性和值大小写敏感</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/hello</span></span><br></pre></td></tr></table></figure>
<h5 id="2-值的写法"><a href="#2-值的写法" class="headerlink" title="2.值的写法"></a>2.值的写法</h5><h6 id="字面量-普通的值-数字-字符串-布尔"><a href="#字面量-普通的值-数字-字符串-布尔" class="headerlink" title="字面量:普通的值(数字,字符串,布尔):"></a>字面量:普通的值(数字,字符串,布尔):</h6><p>​        k: v: 字面直接来写           </p>
<p>​            字符串默认不用加单引号或双引号;          </p>
<p>​         “”:双引号;转义里面的特殊字符,特殊字符会作为本身想表示的意思             </p>
<p>​                如:name: “zhangsan \n lisi”,输出:zhangsan 换行 lisi          </p>
<pre><code>     &#39;&#39;:单引号;不会转义特殊字符,特殊字符最终只是一个普通的字符串输出             </code></pre>
<p>​                如:name: “zhangsan \n lisi”,输出:zhangsan \n lisi       </p>
<h6 id="对象-Map-属性和值-键值对"><a href="#对象-Map-属性和值-键值对" class="headerlink" title="对象,Map(属性和值)(键值对):"></a>对象,Map(属性和值)(键值对):</h6><p>​        k: v :在下一行来写对象的属性和值的关系,注意缩进           </p>
<p>​            对象还是k: v的方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">friends:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">20</span></span><br></pre></td></tr></table></figure>
<p>​        行内写法:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">friends:</span> &#123;<span class="attr">lastName:</span> <span class="string">zhangsan</span>,<span class="attr">age:</span> <span class="number">18</span>&#125;</span><br></pre></td></tr></table></figure>
<h6 id="数组-List-Set"><a href="#数组-List-Set" class="headerlink" title="数组(List,Set):"></a>数组(List,Set):</h6><p>​        用-值表示数组中的元素</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pets:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">dog</span></span><br><span class="line"> <span class="bullet">-</span> <span class="string">pig</span></span><br></pre></td></tr></table></figure>
<pre><code>     行内写法:</code></pre>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">pets:</span> [<span class="string">cat</span>,<span class="string">dog</span>,<span class="string">pig</span>]</span><br></pre></td></tr></table></figure>
<h4 id="4-YAML配置文件的注入"><a href="#4-YAML配置文件的注入" class="headerlink" title="4.YAML配置文件的注入"></a>4.YAML配置文件的注入</h4><p>配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">person:</span></span><br><span class="line">  <span class="attr">lastName:</span> <span class="string">zhangsan</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">18</span></span><br><span class="line">  <span class="attr">boss:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">birth:</span> <span class="number">2020</span><span class="string">/12/12</span></span><br><span class="line">  <span class="attr">maps:</span> &#123;<span class="attr">k1:</span> <span class="string">v1</span>,<span class="attr">k2:</span> <span class="number">12</span>&#125;</span><br><span class="line">  <span class="attr">lists:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">lisi</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">zhaoliu</span></span><br><span class="line">  <span class="attr">dog:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">小狗</span></span><br><span class="line">    <span class="attr">age:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>
<p> javaBean:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;person&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String lastName;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> Boolean boss;</span><br><span class="line">    <span class="keyword">private</span> Date birth;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; maps;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; lists;</span><br><span class="line">    <span class="keyword">private</span> Dog dog;</span><br></pre></td></tr></table></figure>
<p>我们可以导入配置文件处理器,以后编写配置就会有提示</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入配置文件处理器,配置文件绑定就会有提示--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="5-properties配置文件"><a href="#5-properties配置文件" class="headerlink" title="5.properties配置文件"></a>5.properties配置文件</h4><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">person.last-name</span>=<span class="string">张三</span></span><br><span class="line"><span class="meta">person.age</span>=<span class="string">18</span></span><br><span class="line"><span class="meta">person.birth</span>=<span class="string">2020/12/12</span></span><br><span class="line"><span class="meta">person.boss</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">person.maps.k1</span>=<span class="string">v1</span></span><br><span class="line"><span class="meta">person.maps.k2</span>=<span class="string">v2</span></span><br><span class="line"><span class="meta">person.lists</span>=<span class="string">a,b,c</span></span><br><span class="line"><span class="meta">person.dog.name</span>=<span class="string">dog</span></span><br><span class="line"><span class="meta">person.dog.age</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>
<p>idea配置文件默认utf-8编码,需将properties文件默认编码改为utf-8,操作方法见Idea配置笔记中</p>
<h4 id="6-Value获取值和-ConfigurationProperties获取值的区别"><a href="#6-Value获取值和-ConfigurationProperties获取值的区别" class="headerlink" title="6.@Value获取值和@ConfigurationProperties获取值的区别"></a>6.@Value获取值和@ConfigurationProperties获取值的区别</h4><table>
<thead>
<tr>
<th></th>
<th>@ConfigurationProperties</th>
<th>@Value</th>
</tr>
</thead>
<tbody><tr>
<td>功能</td>
<td>批量注入配置文件中属性</td>
<td>一个个指定</td>
</tr>
<tr>
<td>松散绑定(松散语法)</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>SpEL</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>JSR303数据校验</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>复杂类型封装</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<p>无论是yml还是properties他们都能取到值</p>
<p>松散绑定:对象属性和配置文件key模糊匹配</p>
<p>JSR303数据校验:javaBean添加注解@Validated表示该javaBean进行校验,属性加@Email表示校验是否是邮箱格式,只有@ConfigurationProperties才支持</p>
<p>复杂类型封装:只map或list类型,自动获取</p>
<p>==Tips:如果说我们只是在某个业务逻辑中需要获取一下配置文件的某项值,使用@Value,如果专门编写了javaBean来和配置文件进行了映射,那么我们就直接使用@ConfigurationProperties==</p>
<ul>
<li><p>@PropertySource(value = {“classpath:person.properties”})       </p>
<p>​    加载指定的配置文件</p>
</li>
<li><p>@ImportResource       </p>
<p>​    导入spring的配置文件,让配置文件里面的内容生效       </p>
<p>​    SpringBoot里面没有spring的配置文件,我们自己编写的配置文件,也不能自动识别      </p>
<ol>
<li>​    想让spring的配置文件生效,加载进来需要把@ImportResource标注在一个配置类上</li>
</ol>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ImportResource(locations = &#123;&quot;classpath:beans.xml&quot;&#125;)</span></span><br><span class="line">导入spring的配置文件,让其生效</span><br></pre></td></tr></table></figure>
<p>​                        不来编写spring的配置文件</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;helloService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.atguigu.springboot.service.HelloService&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​                    2.SpringBoot推荐给容器中添加组件的方式,推荐使用全注解的方式     使用@Bean给容器中添加组件,将方法的返回值添加到容器中,容器中这个组件默认的id就是方法名</p>
<h4 id="7-配置文件的占位符"><a href="#7-配置文件的占位符" class="headerlink" title="7.配置文件的占位符"></a>7.配置文件的占位符</h4><p>1.随机数</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">$&#123;random.uuid&#125;,$&#123;random.int&#125;,$&#123;random.long&#125;,$&#123;random.int(10)&#125;,$&#123;random.int[1024,65536]&#125;</span></span><br></pre></td></tr></table></figure>
<p>2.占位符获取之前配置的值,如果没有可以用:指定默认值</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">person.last-name</span>=<span class="string">张三$&#123;random.uuid&#125;</span></span><br><span class="line"><span class="meta">person.age</span>=<span class="string">$&#123;random.int&#125;</span></span><br><span class="line"><span class="meta">person.birth</span>=<span class="string">2020/12/12</span></span><br><span class="line"><span class="meta">person.boss</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">person.maps.k1</span>=<span class="string">v1</span></span><br><span class="line"><span class="meta">person.maps.k2</span>=<span class="string">v2</span></span><br><span class="line"><span class="meta">person.lists</span>=<span class="string">a,b,c</span></span><br><span class="line"><span class="meta">person.dog.name</span>=<span class="string">$&#123;person.hello:hello&#125;_dog</span></span><br><span class="line"><span class="meta">person.dog.age</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>
<h4 id="8-Profile"><a href="#8-Profile" class="headerlink" title="8.Profile"></a>8.Profile</h4><ol>
<li><p>多profile文件         </p>
<p>​    我们在主配置文件编写的时候,文件名可以是application-{profile}-properties/yml         </p>
<p>​    默认使用application.properties的配置</p>
</li>
<li><p>yml支持多文档块方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8083</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8084</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br></pre></td></tr></table></figure></li>
<li><p>激活指定profile         </p>
<p>①在配置文件中指定激活 spring.profiles.active=dev         </p>
<p>②命令行:         </p>
<p>​    java -jar spring-boot-02-config-0.0.1-SNAPSHOT.jar –spring.profiles.active=dev</p>
<p>​    或者可以直接在测试的时候,配置传入命令行参数</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115122.png"></p>
<p>③虚拟机参数</p>
</li>
<li><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115129.png"></p>
</li>
</ol>
<h4 id="9配置文件的加载位置"><a href="#9配置文件的加载位置" class="headerlink" title="9配置文件的加载位置"></a>9配置文件的加载位置</h4><p>SpringBoot启动会扫描一下位置的application.properties或者application.yml文件作为SpringBoot的默认文件       </p>
<ul>
<li>file/config/       当前项目config目录       </li>
<li>file/             当前项目根目录下       </li>
<li>classpath:/config      </li>
<li>classpath:/       </li>
</ul>
<p>以上按照优先级从高到低排序,高优先级的会覆盖低优先级       </p>
<p>Springboot会从四个位置全部加载主配置文件,会形成互补配置      </p>
<p>也可以通过spring.config.location来改变默认配置       </p>
<p>项目打包好以后,我们可以使用命令行参数的形式,启动项目的时候来指定配置文件的新位置,指定的配置文件和默认加载的这些配置文件会一起共同起作用,形成互补配置,只可在命令行中使用</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java -jar spring-boot-02-config-02-0.0.1-SNAPSHOT.jar --spring.config.location=C:/ideaProjects/applicati</span><br><span class="line">on.properties</span><br></pre></td></tr></table></figure>
<h4 id="10-外部配置的加载顺序"><a href="#10-外部配置的加载顺序" class="headerlink" title="10.外部配置的加载顺序"></a>10.外部配置的加载顺序</h4><p>SpringBoot也可以从一下位置加载配置,优先级从高到低,高优先级的配置覆盖低优先级的配置,所有的配置会形成互补配置</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115137.png"></p>
<p>1.java -jar spring-boot-02-config-02-0.0.1-SNAPSHOT.jar –server.port=8087 server.servlet.context-path=/boot02     </p>
<p>命令行多个配置用空格分开,–配置项=值     </p>
<p>6.7.8.9     </p>
<p>由jar包外向jar包内进行寻找,优先加载带profile的,再来加载不带profile的</p>
<p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/2.3.1.RELEASE/reference/htmlsingle/#boot-features-external-config">支持所有的加载来源,参考官方文档</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/04_SpringBoot%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" data-id="ckk2gq3th000rz8pqgcjr7zvu" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SpringBoot/03_SpringBoot自动配置注解" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/03_SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%B3%A8%E8%A7%A3/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.571Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><p><strong>@SpringBootApplication:</strong></p>
<p>​    springboot应用标注在某个类上说明这个类是springboot的主配置类,spingboot就应该运行这个类的main方法来启动springboot应用标注一个主程序类,说明这是一个springboot应用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.TYPE)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@EnableAutoConfiguration</span></span><br><span class="line"><span class="meta">@ComponentScan(excludeFilters = &#123; @Filter(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class),</span></span><br><span class="line"><span class="meta">@Filter(type = FilterType.CUSTOM, classes = AutoConfigurationExcludeFilter.class) &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span><br></pre></td></tr></table></figure>


</li>
</ul>
<ul>
<li><p><strong>@SpringBootConfiguration:</strong></p>
<p>​    springboot的配置类注解   标注在某个类上表示这是一个springboot的配置类   </p>
<p>​    **@Configuration:**配置在某一个类上来标注这个注解     </p>
<p>​    配置类—配置文件;配置类也是容器中的一个组件;@Component</p>
</li>
</ul>
<ul>
<li><p><strong>@EnableAutoConfiguration</strong>:开启自动配置功能  </p>
<p>​    以前我们需要配置的东西,springboot帮我们自动配置,使用该注解告诉springboot开启自动配置功能,这样自动配置才能生效  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigurationPackage</span>   </span><br><span class="line"><span class="meta">@Import(AutoConfigurationImportSelector.class)</span>   </span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>@AutoConfigurationPackage</strong>:自动配置包     </p>
<ul>
<li><p><strong>@Import(AutoConfigurationPackages.Registrar.class)</strong>        </p>
<p>springboot的底层注解@Import,给容器中导入一个组件;导入的组件由AutoConfigurationPackages.Registrar.class       </p>
<p>将主配置类(<strong>@SpringBootApplication</strong>标注的类所在包及所有子包所有组件扫描到spring容器中)         </p>
</li>
</ul>
</li>
<li><p><strong>@Import(AutoConfigurationImportSelector.class)</strong>     </p>
<p>​    给容器中导入组件     </p>
<p>​    <strong>AutoConfigurationImportSelector.class</strong>:导入哪些组件的选择器     </p>
<p>​    将所有需要导入的组件以全类名的方式返回,这些容器就会被添加到容器中     </p>
<p>​    会给容器中导入非常多的自动配置类(xxxAutoConfiguration);就是给容器中导入这个场景需要的所有组件,并配置好这些组件</p>
<ul>
<li><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115055.png"></li>
</ul>
<p>有了自动配置类,免去我们手动编写配置注入功能组件等工作</p>
<ul>
<li><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115105.png"></p>
<p>springboot在启动的时候类加载器从类路径下的META-INF/spring.factories中获取</p>
<p>EnableAutoConfiguration指定的值,将这些值作为自动配置类导入到容器中,自动配置类就生效了,帮我们进行自动配置工作;以前需要我们自己配置的东西,自动配置类都帮我们做了</p>
<p>J2EE的整体整合解决方案和自动配置都在spring-boot-autoconfigure-2.2.8.RELEASE.jar</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/03_SpringBoot%E8%87%AA%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%B3%A8%E8%A7%A3/" data-id="ckk2gq3th000qz8pq1uq09uds" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SpringBoot/02_idea中创建SpringBoot项目" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/02_idea%E4%B8%AD%E5%88%9B%E5%BB%BASpringBoot%E9%A1%B9%E7%9B%AE/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.568Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><p>方法1：官网下载后idea导入</p>
<ol>
<li>创建一个maven工程</li>
<li>导入springboot相关的依赖    <ol>
<li><a target="_blank" rel="noopener" href="https://start.spring.io/%E4%B8%BAspringboot%E5%BF%AB%E9%80%9F%E5%BC%80%E5%A7%8B%E7%9A%84%E5%AE%98%E7%BD%91%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%B8%8B%E8%BD%BD%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8springboot%E7%9A%84starter">https://start.spring.io/为springboot快速开始的官网，可以下载快速启动springboot的starter</a>    </li>
<li>Idea中导入maven项目</li>
</ol>
</li>
</ol>
</li>
<li><p>方法2：idea中直接创建一个springboot项目（一般开发常用）</p>
<ul>
<li><p>Idea中File-&gt;New-&gt;Spring Initializr可以直接创建springboot,默认生成的springboot特点:   </p>
<ol>
<li><p> ①主程序已经生成好,我们只需要写自己的逻辑    </p>
</li>
<li><p>②resources文件夹的目录结构        </p>
<ul>
<li><p>-static:保存所有静态资源,如:js,css,images        </p>
</li>
<li><p>-templates:保存所有的模板页面,springboot默认jar包使用嵌入式的Tomcat,默认不支持jsp页面,可以使用模板引擎(freemarker,thymeleaf)        </p>
</li>
<li><p>-application.properties:Spring Boot应用的配置文件,可以修改一些默认配置      </p>
<p>如:server.port=8081 配置端口    </p>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li><p>方法3：pom.xml中添加依赖</p>
<ul>
<li><p>父项目</p>
</li>
<li><p>```xml</p>
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.2.8.RELEASE</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 他的父项目是</span><br><span class="line"></span><br><span class="line">- &#96;&#96;&#96;xml</span><br><span class="line">  &lt;parent&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-dependencies&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;version&gt;</span><br></pre></td></tr></table></figure></li>
<li><p>springboot的版本仲裁中心,没有在dependencies中声明的自然需要声明版本号</p>
</li>
<li><pre><code class="xml">&lt;dependencies&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;
&lt;/dependencies&gt;
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">- spring-boot-starter:springboot的场景启动器,springboot将所有的功能场景都抽取出来,做成一个个starter启动器,只需要在项目中引入这些starter相关场景的所有依赖就会引入,需要什么功能就导入什么场景的启动器</span><br><span class="line"></span><br><span class="line">- spring-boot-starter-web帮我们导入运行web模块正常运行所依赖的组件</span><br><span class="line"></span><br><span class="line">- &#96;&#96;&#96;xml</span><br><span class="line">  &lt;dependency&gt;</span><br><span class="line">      &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">      &lt;artifactId&gt;spring-boot-starter-test&lt;&#x2F;artifactId&gt;</span><br><span class="line">      &lt;scope&gt;test&lt;&#x2F;scope&gt;</span><br><span class="line">      &lt;exclusions&gt;&lt;exclusion&gt;</span><br><span class="line">          &lt;groupId&gt;org.junit.vintage&lt;&#x2F;groupId&gt;</span><br><span class="line">          &lt;artifactId&gt;junit-vintage-engine&lt;&#x2F;artifactId&gt;</span><br><span class="line">          &lt;&#x2F;exclusion&gt;&lt;&#x2F;exclusions&gt;</span><br><span class="line">  &lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure></code></pre>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/02_idea%E4%B8%AD%E5%88%9B%E5%BB%BASpringBoot%E9%A1%B9%E7%9B%AE/" data-id="ckk2gq3tg000pz8pq3csmecuz" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SpringBoot/01_SpringBoot的介绍" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/01_SpringBoot%E7%9A%84%E4%BB%8B%E7%BB%8D/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.567Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="springboot的优点："><a href="#springboot的优点：" class="headerlink" title="springboot的优点："></a>springboot的优点：</h3><ol>
<li>简化配置：springboot对spring进一步封装，基于注解开发，舍弃笨重的XML，只有少量需要配置可以使用yml和properties</li>
<li>每个工程都可以打包成jar，其中内置tomcat或其他servlet容器，可以独立运行</li>
<li>强大场景启动，每个特定场景都可以封装成一个starter，只要导入starter就有了这个场景需要的一切，其中包括各种场景的自动化配置、依赖信息</li>
<li><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115018.png"></li>
</ol>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/01_SpringBoot%E7%9A%84%E4%BB%8B%E7%BB%8D/" data-id="ckk2gq3tf000oz8pq836hcchp" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-SpringBoot/00_springboot注解汇总" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/SpringBoot/00_springboot%E6%B3%A8%E8%A7%A3%E6%B1%87%E6%80%BB/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.565Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><strong>@RequestMapping(“/hello”)</strong>  </p>
<p>接受请求参数</p>
<p><strong>@Controller</strong>  </p>
<p>​    标记类为Controller</p>
<p><strong>@ResponseBody</strong> </p>
<p>​    标注为当前方法或者类的返回值写给浏览器,如果是对象还能转为json返回</p>
<p><strong>@RestController</strong>  </p>
<p>​    标记请求为RESTAPI方式,等价于@ResponseBody+@Controller,表示</p>
<p><strong>@ConfigurationProperties(prefix = “person”)</strong>   </p>
<p>告诉springboot将本类中所有的属性和配置文件中相关的配置进行绑定     prefix = “person”:配置文件中哪个下面的所有属性进行一一映射   只有这个组件是容器中的组件,才能使用容器提供的@ConfigurationProperties功能  默认从全局配置文件中导入  注:需要导入</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--导入配置文件处理器,配置文件绑定就会有提示--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>@Value(“字面量/${key}从配置文件获取值/#{SpEL}”)</strong>  </p>
<p>​    等价于spring中的,可以给对象属性赋值</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>&quot;<span class="attr">lastName</span>&quot; <span class="attr">value</span>=<span class="string">&quot;字面量/$&#123;key&#125;从配置文件获取值/#&#123;SpEL&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>@Validated</strong>  </p>
<p>​    表示javaBean中的属性需要校验,如配合@Email:校验是否是个邮箱格式,只有@ConfigurationProperties才支持该校验</p>
<p><strong>@PropertySource(value = {“classpath:person.properties”})</strong>  </p>
<p>​    加载指定的配置文件</p>
<p><strong>@ImportResource</strong>   </p>
<p>导入spring的配置文件,让配置文件里面的内容生效   SpringBoot里面没有spring的配置文件,我们自己编写的配置文件,也不能自动识别  想让spring的配置文件生效,加载进来需要把@ImportResource标注在一个配置类上</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@ImportResource(locations = &#123;&quot;classpath:beans.xml&quot;&#125;)</span><br><span class="line">导入spring的配置文件,让其生效</span><br></pre></td></tr></table></figure>
<p><strong>@Configuration</strong>   </p>
<p>指明当前类是一个配置类,就是来替代以前的spring配置文件</p>
<p><strong>@Bean</strong>   </p>
<p>将方法的返回值添加到容器中,容器中这个组件默认的id就是方法名</p>
<p><strong>@Conditional派生注解</strong>  </p>
<p>必须是@Conditional指定的条件成立,才给容器中添加组件,配置类里面的内容才生效,SpringBoot又拓展了很多</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111115001.png"></p>
<p><strong>@Mapper</strong></p>
<p>​    指定这是一个操作数据库的mapper</p>
<p><strong>@Select</strong></p>
<p>​    表示查询的sql注解，如@Select(“select * from department where id=#{id}”)</p>
<p><strong>@Delete(“delete from department where id=#{id}”)</strong></p>
<p>​    表示删除数据的sql注解</p>
<p><strong>@Insert(“insert into department(department) values(departmentName)”)</strong></p>
<p>​    表示插入数据的sql注解</p>
<p><strong>@Update(“update department set departmentName=#{departmentName} where id=#{id}”)</strong></p>
<p>​    表示更新数据的sql注解</p>
<p><strong>@MapperScan(value = “com.atguigu.springboot.mapper”)</strong></p>
<p>​    使用MapperScan批量扫描所有的mapper接口</p>
<p><strong>@Entity</strong> </p>
<p>​    告诉jpa这是一个实体类（和数据表映射的类）</p>
<p><strong>@Table(“name = tbl_user”)</strong></p>
<p>​    指定和哪个数据表对应；如果省略默认表名就是类名小写</p>
<p><strong>@Id</strong></p>
<p>​    指定属性是一个主键</p>
<p><strong>@GeneratedValue(strategy = GenerationType.IDENTITY)</strong> </p>
<p>​    指定自增主键</p>
<p><strong>@Column(name = “last_name”,length = 50)</strong> </p>
<p>​    这是和数据表对应的列，省略默认列名就是属性名</p>
<p><strong>@EnableCaching</strong></p>
<p>​    主配置类上，开启缓存功能</p>
<p><strong>@Cacheable</strong></p>
<p>​    将方法的运行结果进行缓存；以后再要相同的数据，直接从缓存中获取，不用再调用方法</p>
<p><strong>@CacheEvict</strong></p>
<p>​    缓存清除</p>
<p><strong>@CachePut</strong></p>
<p>​    既调用方法，又更新缓存，同步更新缓存</p>
<p>​    修改某个数据库数据，同事更新缓存</p>
<p><strong>@Caching</strong></p>
<p>​    定义复杂的缓存规则</p>
<p><strong>@CacheConfig</strong></p>
<p>​    标注在类上，可以抽取类中缓存的公共配置</p>
<p><strong>@RabbitListener(queues = “atguigu.news”)</strong></p>
<p>​    监听RabbitMQ消息队列</p>
<p><strong>@EnableRabbit</strong></p>
<p>​    主配置类上，表示开启基于注解的RabbitMQ </p>
<p><strong>@Autowired 与@Resource的区别：</strong></p>
<p>​    1、 <strong>@Autowired</strong>与**@Resource**都可以用来装配bean. 都可以写在字段上,或写在setter方法上。</p>
<p>​    2、 <strong>@Autowired</strong>默认按类型装配（这个注解是属于spring的），默认情况下必须要求依赖对象必须存在，如果要允许null值，可以设置它的required属性为false，如：**@Autowired(required=false)** ，如果我们想使用名称装配可以结合@Qualifier注解进行使用，如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Autowired()@Qualifier(&quot;baseDao&quot;)</span><br><span class="line">privateBaseDao baseDao;</span><br></pre></td></tr></table></figure>
<p>​    3、**@Resource**（这个注解属于J2EE的），默认按照名称进行装配，名称可以通过name属性进行指定，如果没有指定name属性，当注解写在字段上时，默认取字段名进行安装名称查找，如果注解写在setter方法上默认取属性名进行装配。当找不到与名称匹配的bean时才按照类型进行装配。但是需要注意的是，如果name属性一旦指定，就只会按照名称进行装配。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@Resource(name&#x3D;&quot;baseDao&quot;)</span><br><span class="line">privateBaseDao baseDao;</span><br></pre></td></tr></table></figure>
<p>​    推荐使用：**@Resource**注解在字段上，这样就不用写setter方法了，并且这个注解是属于J2EE的，减少了与spring的耦合。这样代码看起就比较优雅。</p>
<p><strong>@Service</strong></p>
<p>​    com.alibaba.dubbo.config.annotation.Service注解是将微服务发布出去</p>
<p><strong>@Reference</strong></p>
<p>​    com.alibaba.dubbo.config.annotation.Reference远程应用提供方的服务</p>
<p><strong>@EnableDiscoveryClient</strong> </p>
<p>​    开启发现服务的功能</p>
<p><strong>@LoadBalanced</strong></p>
<p>​    SpringCloud消费者使用负载均衡机制</p>
<p>@<strong>EnableAsync</strong></p>
<p>​    开启SpringBoot异步任务注解</p>
<p><strong>@Async</strong> </p>
<p>​    告诉Spring这是一个异步方法</p>
<p><strong>@ApiModelProperty()</strong></p>
<p>用于方法，字段； 表示对model属性的说明或者数据操作更改 </p>
<p>value–字段说明<br>name–重写属性名字<br>dataType–重写属性类型<br>required–是否必填<br>example–举例说明<br>hidden–隐藏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ApiModel(value=&quot;user对象&quot;,description=&quot;用户对象user&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">     <span class="meta">@ApiModelProperty(value=&quot;用户名&quot;,name=&quot;username&quot;,example=&quot;xingguo&quot;)</span></span><br><span class="line">     <span class="keyword">private</span> String username;</span><br><span class="line">     <span class="meta">@ApiModelProperty(value=&quot;状态&quot;,name=&quot;state&quot;,required=true)</span></span><br><span class="line">      <span class="keyword">private</span> Integer state;</span><br><span class="line">      <span class="keyword">private</span> String password;</span><br><span class="line">      <span class="keyword">private</span> String nickName;</span><br><span class="line">      <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@ApiModelProperty(value=&quot;id数组&quot;,hidden=true)</span></span><br><span class="line">      <span class="keyword">private</span> String[] ids;</span><br><span class="line">      <span class="keyword">private</span> List&lt;String&gt; idList;</span><br><span class="line">     <span class="comment">//省略get/set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>@Data()</strong></p>
<p>@Data 注解的主要作用是提高代码的简洁，使用这个注解可以省去代码中大量的get()、 set()、 toString()等方法；</p>
<p>要使用 @Data 注解要先引入lombok，lombok 是什么，它是一个工具类库，可以用简单的注解形式来简化代码，提高开发效率。</p>
<ul>
<li>在maven中添加依赖</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>在编译器中添加插件</p>
<p>这里以IDEA为例，在setting的plugin里搜索<code>lombok plugin</code>，安装插件。</p>
</li>
</ul>
<p>直接在相应的实体类上加上@Data注解即可；</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String hobbit;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>常用的几个注解</strong>：<br> @AllArgsConstructor ： 注在类上，提供类的全参构造<br> @NoArgsConstructor ： 注在类上，提供类的无参构造<br> @Setter ： 注在属性上，提供 set 方法<br> @Getter ： 注在属性上，提供 get 方法<br> @EqualsAndHashCode ：    注在类上，提供对应的 equals 和 hashCode 方法<br> @Log4j/@Slf4j   ： 注在类上，提供对应的 Logger 对象，变量名为 log</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/SpringBoot/00_springboot%E6%B3%A8%E8%A7%A3%E6%B1%87%E6%80%BB/" data-id="ckk2gq3tf000nz8pq8lr4h01v" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Redis/redis命令" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Redis/redis%E5%91%BD%E4%BB%A4/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.560Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ul>
<li><p>一个redis实例最多可连接16个数据库,默认连接0号库</p>
</li>
<li><p>选择连接数据库:  </p>
<p>select 库编号</p>
</li>
<li><p>将key移到指定库:  </p>
<p>​    move key 库编号</p>
</li>
<li><p>测试服务器是否连接:  </p>
<p>​    ping</p>
</li>
<li><p>退出连接:  </p>
<p>​    quit</p>
</li>
<li><p>删除所有数据库中所有key:  </p>
<p>​    flushall</p>
</li>
<li><p>删除当前库中所有key: </p>
<p>​     flushdb</p>
</li>
<li><p>订阅频道:  </p>
<p>​    subscribe channel</p>
</li>
<li><p>指定频道发布:  </p>
<p>​    publish channel content</p>
</li>
<li><p>批量订阅频道:  </p>
<p>​    psubscribe channel*</p>
</li>
<li><p>redis事务:更多像批处理  </p>
<p>​    multi:开启事务  </p>
<p>​    exec:提交事务  </p>
<p>​    discard:事务回滚</p>
</li>
<li><p>redis持久化  </p>
<ul>
<li><p>RDB模式:将内存中数据集快照写入磁盘,默认支持该模式,无需配置    </p>
<ul>
<li>优势:效率更高,只记录数据快照,不记录操作过程    </li>
<li>劣势:可能会丢失数据,在两次记录快照中间的数据可能丢失    </li>
<li>redis.config中可以配置快照间隔时间      <ul>
<li>save 900 1  修改一个则900秒存一次      </li>
<li>save 300 10 修改10个则300秒存一次      </li>
<li>save 60 10000  修改1万个则60秒存一次      </li>
<li>dbfilename 文件名  配置RDB记录文件名      </li>
<li>dir  路径  配置RDB记录文件路径  </li>
</ul>
</li>
</ul>
</li>
<li><p>AOF模式:以日志形式记录数据库每个操作,可读取该文件来重新构建数据库    </p>
<ul>
<li>优势:即时,不易丢失数据    </li>
<li>劣势:日志文件过大,效率较低,默认不开启    </li>
<li>redis.config中可以配置      a<ul>
<li>ppendonly yes/no  开启或关闭      a</li>
<li>ppendsync always  每次修改都写入AOF文件      </li>
<li>appendsync everysec  每秒同步一次,为缺省策略      </li>
<li>appendsync no 从不同步,高效但不会被持久化</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Redis/redis%E5%91%BD%E4%BB%A4/" data-id="ckk2gq3tc000hz8pq632j1d3v" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Nginx/Nginx的安装使用" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Nginx/Nginx%E7%9A%84%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.556Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="Nginx的目录："><a href="#Nginx的目录：" class="headerlink" title="Nginx的目录："></a>Nginx的目录：</h4><p>nginx</p>
<p>​    -html:前端代码放置目录</p>
<p>​    -conf：nginx配置文件目录，其中nginx.conf是主配置目录，反向代理也在改目录配置</p>
<p>​    -sbin：放置nginx的命令目录</p>
<h4 id="nginx的命令："><a href="#nginx的命令：" class="headerlink" title="nginx的命令："></a>nginx的命令：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">nginx -t 检测配置文件是否有语法错误，然后退出，一般先测试再启动</span><br><span class="line"></span><br><span class="line">nginx -s reopen #重启Nginx</span><br><span class="line"></span><br><span class="line">nginx -s reload #重新加载Nginx配置文件，然后以优雅的方式重启Nginx</span><br><span class="line"></span><br><span class="line">nginx -s stop #强制停止Nginx服务</span><br><span class="line"></span><br><span class="line">nginx -s quit #优雅地停止Nginx服务（即处理完所有请求后再停止服务）</span><br><span class="line"></span><br><span class="line">nginx -?,-h #打开帮助信息</span><br><span class="line"></span><br><span class="line">nginx -v #显示版本信息并退出</span><br><span class="line"></span><br><span class="line">nginx -V #显示版本和配置选项信息，然后退出</span><br><span class="line"></span><br><span class="line">nginx -t #检测配置文件是否有语法错误，然后退出</span><br><span class="line"></span><br><span class="line">nginx -T #检测配置文件是否有语法错误，转储并退出</span><br><span class="line"></span><br><span class="line">nginx -q #在检测配置文件期间屏蔽非错误信息</span><br><span class="line"></span><br><span class="line">nginx -p prefix #设置前缀路径(默认是:&#x2F;usr&#x2F;share&#x2F;nginx&#x2F;)</span><br><span class="line"></span><br><span class="line">nginx -c filename #设置配置文件(默认是:&#x2F;etc&#x2F;nginx&#x2F;nginx.conf)</span><br><span class="line"></span><br><span class="line">nginx -g directives #设置配置文件外的全局指令</span><br><span class="line"></span><br><span class="line">killall nginx #杀死所有nginx进程</span><br></pre></td></tr></table></figure>
<h4 id="niginx配置详解"><a href="#niginx配置详解" class="headerlink" title="niginx配置详解"></a>niginx配置详解</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br></pre></td><td class="code"><pre><span class="line">######Nginx配置文件nginx.conf中文详解#####</span><br><span class="line"></span><br><span class="line">#定义Nginx运行的用户和用户组</span><br><span class="line">user www www;</span><br><span class="line"></span><br><span class="line">#nginx进程数，建议设置为等于CPU总核心数。</span><br><span class="line">worker_processes 8;</span><br><span class="line"> </span><br><span class="line">#全局错误日志定义类型，[ debug | info | notice | warn | error | crit ]</span><br><span class="line">error_log /usr/local/nginx/logs/error.log info;</span><br><span class="line"></span><br><span class="line">#进程pid文件</span><br><span class="line">pid /usr/local/nginx/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">#指定进程可以打开的最大描述符：数目</span><br><span class="line">#工作模式与连接数上限</span><br><span class="line">#这个指令是指当一个nginx进程打开的最多文件描述符数目，理论值应该是最多打开文件数（ulimit -n）与nginx进程数相除，但是nginx分配请求并不是那么均匀，所以最好与ulimit -n 的值保持一致。</span><br><span class="line">#现在在linux 2.6内核下开启文件打开数为65535，worker_rlimit_nofile就相应应该填写65535。</span><br><span class="line">#这是因为nginx调度时分配请求到进程并不是那么的均衡，所以假如填写10240，总并发量达到3-4万时就有进程可能超过10240了，这时会返回502错误。</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events</span><br><span class="line">&#123;</span><br><span class="line">    #参考事件模型，use [ kqueue | rtsig | epoll | /dev/poll | select | poll ]; epoll模型</span><br><span class="line">    #是Linux 2.6以上版本内核中的高性能网络I/O模型，linux建议epoll，如果跑在FreeBSD上面，就用kqueue模型。</span><br><span class="line">    #补充说明：</span><br><span class="line">    #与apache相类，nginx针对不同的操作系统，有不同的事件模型</span><br><span class="line">    #A）标准事件模型</span><br><span class="line">    #Select、poll属于标准事件模型，如果当前系统不存在更有效的方法，nginx会选择select或poll</span><br><span class="line">    #B）高效事件模型</span><br><span class="line">    #Kqueue：使用于FreeBSD 4.1+, OpenBSD 2.9+, NetBSD 2.0 和 MacOS X.使用双处理器的MacOS X系统使用kqueue可能会造成内核崩溃。</span><br><span class="line">    #Epoll：使用于Linux内核2.6版本及以后的系统。</span><br><span class="line">    #/dev/poll：使用于Solaris 7 11/99+，HP/UX 11.22+ (eventport)，IRIX 6.5.15+ 和 Tru64 UNIX 5.1A+。</span><br><span class="line">    #Eventport：使用于Solaris 10。 为了防止出现内核崩溃的问题， 有必要安装安全补丁。</span><br><span class="line">    use epoll;</span><br><span class="line"></span><br><span class="line">    #单个进程最大连接数（最大连接数=连接数*进程数）</span><br><span class="line">    #根据硬件调整，和前面工作进程配合起来用，尽量大，但是别把cpu跑到100%就行。每个进程允许的最多连接数，理论上每台nginx服务器的最大连接数为。</span><br><span class="line">    worker_connections 65535;</span><br><span class="line"></span><br><span class="line">    #keepalive超时时间。</span><br><span class="line">    keepalive_timeout 60;</span><br><span class="line"></span><br><span class="line">    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求头的大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。</span><br><span class="line">    #分页大小可以用命令getconf PAGESIZE 取得。</span><br><span class="line">    #[root@web001 ~]# getconf PAGESIZE</span><br><span class="line">    #4096</span><br><span class="line">    #但也有client_header_buffer_size超过4k的情况，但是client_header_buffer_size该值必须设置为“系统分页大小”的整倍数。</span><br><span class="line">    client_header_buffer_size 4k;</span><br><span class="line"></span><br><span class="line">    #这个将为打开文件指定缓存，默认是没有启用的，max指定缓存数量，建议和打开文件数一致，inactive是指经过多长时间文件没被请求后删除缓存。</span><br><span class="line">    open_file_cache max=65535 inactive=60s;</span><br><span class="line"></span><br><span class="line">    #这个是指多长时间检查一次缓存的有效信息。</span><br><span class="line">    #语法:open_file_cache_valid time 默认值:open_file_cache_valid 60 使用字段:http, server, location 这个指令指定了何时需要检查open_file_cache中缓存项目的有效信息.</span><br><span class="line">    open_file_cache_valid 80s;</span><br><span class="line"></span><br><span class="line">    #open_file_cache指令中的inactive参数时间内文件的最少使用次数，如果超过这个数字，文件描述符一直是在缓存中打开的，如上例，如果有一个文件在inactive时间内一次没被使用，它将被移除。</span><br><span class="line">    #语法:open_file_cache_min_uses number 默认值:open_file_cache_min_uses 1 使用字段:http, server, location  这个指令指定了在open_file_cache指令无效的参数中一定的时间范围内可以使用的最小文件数,如果使用更大的值,文件描述符在cache中总是打开状态.</span><br><span class="line">    open_file_cache_min_uses 1;</span><br><span class="line">    </span><br><span class="line">    #语法:open_file_cache_errors on | off 默认值:open_file_cache_errors off 使用字段:http, server, location 这个指令指定是否在搜索一个文件是记录cache错误.</span><br><span class="line">    open_file_cache_errors on;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span><br><span class="line">http</span><br><span class="line">&#123;</span><br><span class="line">    #文件扩展名与文件类型映射表</span><br><span class="line">    include mime.types;</span><br><span class="line"></span><br><span class="line">    #默认文件类型</span><br><span class="line">    default_type application/octet-stream;</span><br><span class="line"></span><br><span class="line">    #默认编码</span><br><span class="line">    #charset utf-8;</span><br><span class="line"></span><br><span class="line">    #服务器名字的hash表大小</span><br><span class="line">    #保存服务器名字的hash表是由指令server_names_hash_max_size 和server_names_hash_bucket_size所控制的。参数hash bucket size总是等于hash表的大小，并且是一路处理器缓存大小的倍数。在减少了在内存中的存取次数后，使在处理器中加速查找hash表键值成为可能。如果hash bucket size等于一路处理器缓存的大小，那么在查找键的时候，最坏的情况下在内存中查找的次数为2。第一次是确定存储单元的地址，第二次是在存储单元中查找键 值。因此，如果Nginx给出需要增大hash max size 或 hash bucket size的提示，那么首要的是增大前一个参数的大小.</span><br><span class="line">    server_names_hash_bucket_size 128;</span><br><span class="line"></span><br><span class="line">    #客户端请求头部的缓冲区大小。这个可以根据你的系统分页大小来设置，一般一个请求的头部大小不会超过1k，不过由于一般系统分页都要大于1k，所以这里设置为分页大小。分页大小可以用命令getconf PAGESIZE取得。</span><br><span class="line">    client_header_buffer_size 32k;</span><br><span class="line"></span><br><span class="line">    #客户请求头缓冲大小。nginx默认会用client_header_buffer_size这个buffer来读取header值，如果header过大，它会使用large_client_header_buffers来读取。</span><br><span class="line">    large_client_header_buffers 4 64k;</span><br><span class="line"></span><br><span class="line">    #设定通过nginx上传文件的大小</span><br><span class="line">    client_max_body_size 8m;</span><br><span class="line"></span><br><span class="line">    #开启高效文件传输模式，sendfile指令指定nginx是否调用sendfile函数来输出文件，对于普通应用设为 on，如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络I/O处理速度，降低系统的负载。注意：如果图片显示不正常把这个改成off。</span><br><span class="line">    #sendfile指令指定 nginx 是否调用sendfile 函数（zero copy 方式）来输出文件，对于普通应用，必须设为on。如果用来进行下载等应用磁盘IO重负载应用，可设置为off，以平衡磁盘与网络IO处理速度，降低系统uptime。</span><br><span class="line">    sendfile on;</span><br><span class="line"></span><br><span class="line">    #开启目录列表访问，合适下载服务器，默认关闭。</span><br><span class="line">    autoindex on;</span><br><span class="line"></span><br><span class="line">    #此选项允许或禁止使用socke的TCP_CORK的选项，此选项仅在使用sendfile的时候使用</span><br><span class="line">    tcp_nopush on;</span><br><span class="line">     </span><br><span class="line">    tcp_nodelay on;</span><br><span class="line"></span><br><span class="line">    #长连接超时时间，单位是秒</span><br><span class="line">    keepalive_timeout 120;</span><br><span class="line"></span><br><span class="line">    #FastCGI相关参数是为了改善网站的性能：减少资源占用，提高访问速度。下面参数看字面意思都能理解。</span><br><span class="line">    fastcgi_connect_timeout 300;</span><br><span class="line">    fastcgi_send_timeout 300;</span><br><span class="line">    fastcgi_read_timeout 300;</span><br><span class="line">    fastcgi_buffer_size 64k;</span><br><span class="line">    fastcgi_buffers 4 64k;</span><br><span class="line">    fastcgi_busy_buffers_size 128k;</span><br><span class="line">    fastcgi_temp_file_write_size 128k;</span><br><span class="line"></span><br><span class="line">    #gzip模块设置</span><br><span class="line">    gzip on; #开启gzip压缩输出</span><br><span class="line">    gzip_min_length 1k;    #最小压缩文件大小</span><br><span class="line">    gzip_buffers 4 16k;    #压缩缓冲区</span><br><span class="line">    gzip_http_version 1.0;    #压缩版本（默认1.1，前端如果是squid2.5请使用1.0）</span><br><span class="line">    gzip_comp_level 2;    #压缩等级</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css application/xml;    #压缩类型，默认就已经包含textml，所以下面就不用再写了，写上去也不会有问题，但是会有一个warn。</span><br><span class="line">    gzip_vary on;</span><br><span class="line"></span><br><span class="line">    #开启限制IP连接数的时候需要使用</span><br><span class="line">    #limit_zone crawler $binary_remote_addr 10m;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    #负载均衡配置</span><br><span class="line">    upstream piao.jd.com &#123;</span><br><span class="line">     </span><br><span class="line">        #upstream的负载均衡，weight是权重，可以根据机器配置定义权重。weigth参数表示权值，权值越高被分配到的几率越大。</span><br><span class="line">        server 192.168.80.121:80 weight=3;</span><br><span class="line">        server 192.168.80.122:80 weight=2;</span><br><span class="line">        server 192.168.80.123:80 weight=3;</span><br><span class="line"></span><br><span class="line">        #nginx的upstream目前支持4种方式的分配</span><br><span class="line">        #1、轮询（默认）</span><br><span class="line">        #每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务器down掉，能自动剔除。</span><br><span class="line">        #2、weight</span><br><span class="line">        #指定轮询几率，weight和访问比率成正比，用于后端服务器性能不均的情况。</span><br><span class="line">        #例如：</span><br><span class="line">        #upstream bakend &#123;</span><br><span class="line">        #    server 192.168.0.14 weight=10;</span><br><span class="line">        #    server 192.168.0.15 weight=10;</span><br><span class="line">        #&#125;</span><br><span class="line">        #2、ip_hash</span><br><span class="line">        #每个请求按访问ip的hash结果分配，这样每个访客固定访问一个后端服务器，可以解决session的问题。</span><br><span class="line">        #例如：</span><br><span class="line">        #upstream bakend &#123;</span><br><span class="line">        #    ip_hash;</span><br><span class="line">        #    server 192.168.0.14:88;</span><br><span class="line">        #    server 192.168.0.15:80;</span><br><span class="line">        #&#125;</span><br><span class="line">        #3、fair（第三方）</span><br><span class="line">        #按后端服务器的响应时间来分配请求，响应时间短的优先分配。</span><br><span class="line">        #upstream backend &#123;</span><br><span class="line">        #    server server1;</span><br><span class="line">        #    server server2;</span><br><span class="line">        #    fair;</span><br><span class="line">        #&#125;</span><br><span class="line">        #4、url_hash（第三方）</span><br><span class="line">        #按访问url的hash结果来分配请求，使每个url定向到同一个后端服务器，后端服务器为缓存时比较有效。</span><br><span class="line">        #例：在upstream中加入hash语句，server语句中不能写入weight等其他的参数，hash_method是使用的hash算法</span><br><span class="line">        #upstream backend &#123;</span><br><span class="line">        #    server squid1:3128;</span><br><span class="line">        #    server squid2:3128;</span><br><span class="line">        #    hash $request_uri;</span><br><span class="line">        #    hash_method crc32;</span><br><span class="line">        #&#125;</span><br><span class="line"></span><br><span class="line">        #tips:</span><br><span class="line">        #upstream bakend&#123;#定义负载均衡设备的Ip及设备状态&#125;&#123;</span><br><span class="line">        #    ip_hash;</span><br><span class="line">        #    server 127.0.0.1:9090 down;</span><br><span class="line">        #    server 127.0.0.1:8080 weight=2;</span><br><span class="line">        #    server 127.0.0.1:6060;</span><br><span class="line">        #    server 127.0.0.1:7070 backup;</span><br><span class="line">        #&#125;</span><br><span class="line">        #在需要使用负载均衡的server中增加 proxy_pass http://bakend/;</span><br><span class="line"></span><br><span class="line">        #每个设备的状态设置为:</span><br><span class="line">        #1.down表示单前的server暂时不参与负载</span><br><span class="line">        #2.weight为weight越大，负载的权重就越大。</span><br><span class="line">        #3.max_fails：允许请求失败的次数默认为1.当超过最大次数时，返回proxy_next_upstream模块定义的错误</span><br><span class="line">        #4.fail_timeout:max_fails次失败后，暂停的时间。</span><br><span class="line">        #5.backup： 其它所有的非backup机器down或者忙的时候，请求backup机器。所以这台机器压力会最轻。</span><br><span class="line"></span><br><span class="line">        #nginx支持同时设置多组的负载均衡，用来给不用的server来使用。</span><br><span class="line">        #client_body_in_file_only设置为On 可以讲client post过来的数据记录到文件中用来做debug</span><br><span class="line">        #client_body_temp_path设置记录文件的目录 可以设置最多3层目录</span><br><span class="line">        #location对URL进行匹配.可以进行重定向或者进行新的代理 负载均衡</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">     </span><br><span class="line">    #虚拟主机的配置</span><br><span class="line">    server</span><br><span class="line">    &#123;</span><br><span class="line">        #监听端口</span><br><span class="line">        listen 80;</span><br><span class="line"></span><br><span class="line">        #域名可以有多个，用空格隔开</span><br><span class="line">        server_name www.jd.com jd.com;</span><br><span class="line">        index index.html index.htm index.php;</span><br><span class="line">        root /data/www/jd;</span><br><span class="line"></span><br><span class="line">        #对******进行负载均衡</span><br><span class="line">        location ~ .*.(php|php5)?$</span><br><span class="line">        &#123;</span><br><span class="line">            fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">            fastcgi_index index.php;</span><br><span class="line">            include fastcgi.conf;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        #图片缓存时间设置</span><br><span class="line">        location ~ .*.(gif|jpg|jpeg|png|bmp|swf)$</span><br><span class="line">        &#123;</span><br><span class="line">            expires 10d;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        #JS和CSS缓存时间设置</span><br><span class="line">        location ~ .*.(js|css)?$</span><br><span class="line">        &#123;</span><br><span class="line">            expires 1h;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        #日志格式设定</span><br><span class="line">        #$remote_addr与$http_x_forwarded_for用以记录客户端的ip地址；</span><br><span class="line">        #$remote_user：用来记录客户端用户名称；</span><br><span class="line">        #$time_local： 用来记录访问时间与时区；</span><br><span class="line">        #$request： 用来记录请求的url与http协议；</span><br><span class="line">        #$status： 用来记录请求状态；成功是200，</span><br><span class="line">        #$body_bytes_sent ：记录发送给客户端文件主体内容大小；</span><br><span class="line">        #$http_referer：用来记录从那个页面链接访问过来的；</span><br><span class="line">        #$http_user_agent：记录客户浏览器的相关信息；</span><br><span class="line">        #通常web服务器放在反向代理的后面，这样就不能获取到客户的IP地址了，通过$remote_add拿到的IP地址是反向代理服务器的iP地址。反向代理服务器在转发请求的http头信息中，可以增加x_forwarded_for信息，用以记录原有客户端的IP地址和原来客户端的请求的服务器地址。</span><br><span class="line">        log_format access &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">        &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">        &#x27;&quot;$http_user_agent&quot; $http_x_forwarded_for&#x27;;</span><br><span class="line">         </span><br><span class="line">        #定义本虚拟主机的访问日志</span><br><span class="line">        access_log  /usr/local/nginx/logs/host.access.log  main;</span><br><span class="line">        access_log  /usr/local/nginx/logs/host.access.404.log  log404;</span><br><span class="line">         </span><br><span class="line">        #对 &quot;/&quot; 启用反向代理</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://127.0.0.1:88;</span><br><span class="line">            proxy_redirect off;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">             </span><br><span class="line">            #后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">             </span><br><span class="line">            #以下是一些反向代理的配置，可选。</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line"></span><br><span class="line">            #允许客户端请求的最大单文件字节数</span><br><span class="line">            client_max_body_size 10m;</span><br><span class="line"></span><br><span class="line">            #缓冲区代理缓冲用户端请求的最大字节数，</span><br><span class="line">            #如果把它设置为比较大的数值，例如256k，那么，无论使用firefox还是IE浏览器，来提交任意小于256k的图片，都很正常。如果注释该指令，使用默认的client_body_buffer_size设置，也就是操作系统页面大小的两倍，8k或者16k，问题就出现了。</span><br><span class="line">            #无论使用firefox4.0还是IE8.0，提交一个比较大，200k左右的图片，都返回500 Internal Server Error错误</span><br><span class="line">            client_body_buffer_size 128k;</span><br><span class="line"></span><br><span class="line">            #表示使nginx阻止HTTP应答代码为400或者更高的应答。</span><br><span class="line">            proxy_intercept_errors on;</span><br><span class="line"></span><br><span class="line">            #后端服务器连接的超时时间_发起握手等候响应超时时间</span><br><span class="line">            #nginx跟后端服务器连接超时时间(代理连接超时)</span><br><span class="line">            proxy_connect_timeout 90;</span><br><span class="line"></span><br><span class="line">            #后端服务器数据回传时间(代理发送超时)</span><br><span class="line">            #后端服务器数据回传时间_就是在规定时间之内后端服务器必须传完所有的数据</span><br><span class="line">            proxy_send_timeout 90;</span><br><span class="line"></span><br><span class="line">            #连接成功后，后端服务器响应时间(代理接收超时)</span><br><span class="line">            #连接成功后_等候后端服务器响应时间_其实已经进入后端的排队之中等候处理（也可以说是后端服务器处理请求的时间）</span><br><span class="line">            proxy_read_timeout 90;</span><br><span class="line"></span><br><span class="line">            #设置代理服务器（nginx）保存用户头信息的缓冲区大小</span><br><span class="line">            #设置从被代理服务器读取的第一部分应答的缓冲区大小，通常情况下这部分应答中包含一个小的应答头，默认情况下这个值的大小为指令proxy_buffers中指定的一个缓冲区的大小，不过可以将其设置为更小</span><br><span class="line">            proxy_buffer_size 4k;</span><br><span class="line"></span><br><span class="line">            #proxy_buffers缓冲区，网页平均在32k以下的设置</span><br><span class="line">            #设置用于读取应答（来自被代理服务器）的缓冲区数目和大小，默认情况也为分页大小，根据操作系统的不同可能是4k或者8k</span><br><span class="line">            proxy_buffers 4 32k;</span><br><span class="line"></span><br><span class="line">            #高负荷下缓冲大小（proxy_buffers*2）</span><br><span class="line">            proxy_busy_buffers_size 64k;</span><br><span class="line"></span><br><span class="line">            #设置在写入proxy_temp_path时数据的大小，预防一个工作进程在传递文件时阻塞太长</span><br><span class="line">            #设定缓存文件夹大小，大于这个值，将从upstream服务器传</span><br><span class="line">            proxy_temp_file_write_size 64k;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">         </span><br><span class="line">        #设定查看Nginx状态的地址</span><br><span class="line">        location /NginxStatus &#123;</span><br><span class="line">            stub_status on;</span><br><span class="line">            access_log on;</span><br><span class="line">            auth_basic &quot;NginxStatus&quot;;</span><br><span class="line">            auth_basic_user_file confpasswd;</span><br><span class="line">            #htpasswd文件的内容可以用apache提供的htpasswd工具来产生。</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        #本地动静分离反向代理配置</span><br><span class="line">        #所有jsp的页面均交由tomcat或resin处理</span><br><span class="line">        location ~ .(jsp|jspx|do)?$ &#123;</span><br><span class="line">            proxy_set_header Host $host;</span><br><span class="line">            proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_pass http://127.0.0.1:8080;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        #所有静态文件由nginx直接读取不经过tomcat或resin</span><br><span class="line">        location ~ .*.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|</span><br><span class="line">        pdf|xls|mp3|wma)$</span><br><span class="line">        &#123;</span><br><span class="line">            expires 15d; </span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        location ~ .*.(js|css)?$</span><br><span class="line">        &#123;</span><br><span class="line">            expires 1h;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">######Nginx配置文件nginx.conf中文详解#####</span><br></pre></td></tr></table></figure>


<h4 id="niginx使用问题和解决方法："><a href="#niginx使用问题和解决方法：" class="headerlink" title="niginx使用问题和解决方法："></a>niginx使用问题和解决方法：</h4><h5 id="1）nginx-t测试报错"><a href="#1）nginx-t测试报错" class="headerlink" title="1）nginx -t测试报错"></a>1）nginx -t测试报错</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">nginx -t测试时报错</span><br><span class="line">nginx -t</span><br><span class="line">nginx: the configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf syntax is ok</span><br><span class="line">nginx: [emerg] getpwnam(&quot;nginx&quot;) failed</span><br><span class="line">nginx: configuration file &#x2F;etc&#x2F;nginx&#x2F;nginx.conf test failed</span><br><span class="line"></span><br><span class="line">解决方法：添加nginx用户再测试</span><br><span class="line">useradd -s &#x2F;sbin&#x2F;nologin -M nginx</span><br></pre></td></tr></table></figure>
<h5 id="2）nginx-s-reload报错"><a href="#2）nginx-s-reload报错" class="headerlink" title="2）nginx -s reload报错"></a>2）nginx -s reload报错</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">服务器重启之后，执行 nginx -t 是OK的，然而在执行 nginx -s reload 的时候报错</span><br><span class="line"></span><br><span class="line">nginx: [error] invalid PID number &quot;&quot; in &quot;&#x2F;run&#x2F;nginx.pid&quot;</span><br><span class="line"></span><br><span class="line">解决方法：</span><br><span class="line"></span><br><span class="line">需要先执行</span><br><span class="line"></span><br><span class="line">nginx -c &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</span><br><span class="line"></span><br><span class="line">nginx.conf文件的路径可以从nginx -t的返回中找到。</span><br><span class="line"></span><br><span class="line">nginx -s reload</span><br></pre></td></tr></table></figure>
<h5 id="3）Nginx配置各种响应头防止XSS-点击劫持，frame恶意攻击"><a href="#3）Nginx配置各种响应头防止XSS-点击劫持，frame恶意攻击" class="headerlink" title="3）Nginx配置各种响应头防止XSS,点击劫持，frame恶意攻击"></a>3）Nginx配置各种响应头防止XSS,点击劫持，frame恶意攻击</h5><h6 id="①X-Frame-Options响应头"><a href="#①X-Frame-Options响应头" class="headerlink" title="①X-Frame-Options响应头"></a>①X-Frame-Options响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">X-Frame-Options 有三个值:</span><br><span class="line">DENY</span><br><span class="line">表示该页面不允许在 frame 中展示，即便是在相同域名的页面中嵌套也不允许。</span><br><span class="line">SAMEORIGIN</span><br><span class="line">表示该页面可以在相同域名页面的 frame 中展示。</span><br><span class="line">ALLOW-FROM uri</span><br><span class="line">表示该页面可以在指定来源的 frame 中展示。</span><br><span class="line"></span><br><span class="line">配置 nginx 发送 X-Frame-Options 响应头，把下面这行添加到 &#x27;http&#x27;, &#x27;server&#x27; 或者 &#x27;location&#x27; 的配置中:</span><br><span class="line"><span class="meta">#</span><span class="bash"> add_header X-Frame-Options SAMEORIGIN;</span></span><br></pre></td></tr></table></figure>
<h6 id="②X-Content-Type-Options响应头"><a href="#②X-Content-Type-Options响应头" class="headerlink" title="②X-Content-Type-Options响应头"></a>②X-Content-Type-Options响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">互联网上的资源有各种类型，通常浏览器会根据响应头的Content-Type字段来分辨它们的类型。例如：text/html代表html文档，image/png是PNG图片，text/css是CSS样式文档。然而，有些资源的Content-Type是错的或者未定义。这时，某些浏览器会启用MIME-sniffing来猜测该资源的类型，解析内容并执行。</span><br><span class="line">例如，我们即使给一个html文档指定Content-Type为text/plain，在IE8-中这个文档依然会被当做html来解析。利用浏览器的这个特性，攻击者甚至可以让原本应该解析为图片的请求被解析为JavaScript。在Nginx里通过下面这个响应头可以禁用浏览器的类型猜测行为：</span><br><span class="line"><span class="meta">#</span><span class="bash"> add_header X-Content-Type-Options: nosniff;</span></span><br><span class="line">这个响应头的值只能是nosniff, 可用于IE8+和Chrome</span><br><span class="line">IE的行为受X-Content-Type-Options的影响，如果Web应用没有返回Content-Type，那么IE9、IE11将拒绝加载相关资源</span><br></pre></td></tr></table></figure>
<h6 id="③X-Content-Security-Policy响应头"><a href="#③X-Content-Security-Policy响应头" class="headerlink" title="③X-Content-Security-Policy响应头"></a>③X-Content-Security-Policy响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">W3C 的 Content Security Policy，简称 CSP。顾名思义，这个规范与内容安全有关，主要是用来定义页面可以加载哪些资源，减少 XSS 的发生。</span><br><span class="line">要使用 CSP，只需要服务端输出类似这样的响应头就行了：</span><br><span class="line"><span class="meta">#</span><span class="bash">add_header Content-Security-Policy: default-src <span class="string">&#x27;self&#x27;</span></span></span><br><span class="line">12621安全规则版本中可以只写&quot;default-src ‘self’， 但是在17339规则版本中 &quot;default-src ‘self’; script-src ‘self’; frame-ancestors ‘self’</span><br></pre></td></tr></table></figure>
<h6 id="④X-Content-Security-Policy响应头"><a href="#④X-Content-Security-Policy响应头" class="headerlink" title="④X-Content-Security-Policy响应头"></a>④X-Content-Security-Policy响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">4、Cache-Control</span></span><br><span class="line">Cache-Control 通用消息头字段，被用于在 http 请求和响应中，通过指定指令来实现缓存机制。缓存指令是单向的，这意味着在请求中设置的指令，不一定被包含在响应中。</span><br><span class="line">缓存机制可以减少对网络带宽的占用，可以提高访问速度，提高用户的体验，特定请求被禁止缓存可以提高安全性。</span><br><span class="line">语法</span><br><span class="line">指令不区分大小写，并且具有可选参数，可以用令牌或者带引号的字符串语法。多个指令以逗号分隔。</span><br><span class="line">缓存请求指令</span><br><span class="line">客户端可以在HTTP请求中使用的标准 Cache-Control 指令。</span><br><span class="line">Cache-Control: max-age=&lt;seconds&gt; Cache-Control: max-stale[=&lt;seconds&gt;] Cache-Control: min-fresh=&lt;seconds&gt; Cache-control: no-cache Cache-control: no-store Cache-control: no-transform Cache-control: only-if-cached</span><br><span class="line">缓存响应指令</span><br><span class="line">服务器可以在响应中使用的标准 Cache-Control 指令。</span><br><span class="line">Cache-control: must-revalidate Cache-control: no-cache Cache-control: no-store Cache-control: no-transform Cache-control: public Cache-control: private Cache-control: proxy-revalidate Cache-Control: max-age=&lt;seconds&gt; Cache-control: s-maxage=&lt;seconds&gt;</span><br><span class="line">扩展Cache-Control指令</span><br><span class="line">拓展缓存指令不是核心HTTP缓存标准文档的一部分，使用前请注意检查兼容性！</span><br><span class="line">Cache-control: immutable Cache-control: stale-while-revalidate=&lt;seconds&gt; Cache-control: stale-if-error=&lt;seconds&gt;</span><br><span class="line">指令</span><br><span class="line">可缓存性</span><br><span class="line">public</span><br><span class="line">表明响应可以被任何对象（包括：发送请求的客户端，代理服务器，等等）缓存，即使是通常不可缓存的内容。（例如：1.该响应没有max-age指令或Expires消息头；2. 该响应对应的请求方法是 POST 。）</span><br><span class="line">private</span><br><span class="line">表明响应只能被单个用户缓存，不能作为共享缓存（即代理服务器不能缓存它）。私有缓存可以缓存响应内容，比如：对应用户的本地浏览器。</span><br><span class="line">no-cache</span><br><span class="line">在发布缓存副本之前，强制要求缓存把请求提交给原始服务器进行验证(协商缓存验证)。</span><br><span class="line">no-store</span><br><span class="line">缓存不应存储有关客户端请求或服务器响应的任何内容，即不使用任何缓存。</span><br><span class="line">到期</span><br><span class="line">max-age=&lt;seconds&gt;</span><br><span class="line">设置缓存存储的最大周期，超过这个时间缓存被认为过期(单位秒)。与Expires相反，时间是相对于请求的时间。</span><br><span class="line">s-maxage=&lt;seconds&gt;</span><br><span class="line">覆盖max-age或者Expires头，但是仅适用于共享缓存(比如各个代理)，私有缓存会忽略它。</span><br><span class="line">max-stale[=&lt;seconds&gt;]</span><br><span class="line">表明客户端愿意接收一个已经过期的资源。可以设置一个可选的秒数，表示响应不能已经过时超过该给定的时间。</span><br><span class="line">min-fresh=&lt;seconds&gt;</span><br><span class="line">表示客户端希望获取一个能在指定的秒数内保持其最新状态的响应。</span><br><span class="line">stale-while-revalidate=&lt;seconds&gt;</span><br><span class="line">表明客户端愿意接受陈旧的响应，同时在后台异步检查新的响应。秒值指示客户愿意接受陈旧响应的时间长度。</span><br><span class="line">stale-if-error=&lt;seconds&gt;</span><br><span class="line">表示如果新的检查失败，则客户愿意接受陈旧的响应。秒数值表示客户在初始到期后愿意接受陈旧响应的时间。</span><br><span class="line">重新验证和重新加载</span><br><span class="line">must-revalidate</span><br><span class="line">一旦资源过期（比如已经超过max-age），在成功向原始服务器验证之前，缓存不能用该资源响应后续请求。</span><br><span class="line">proxy-revalidate</span><br><span class="line">与must-revalidate作用相同，但它仅适用于共享缓存（例如代理），并被私有缓存忽略。</span><br><span class="line">immutable</span><br><span class="line">表示响应正文不会随时间而改变。资源（如果未过期）在服务器上不发生改变，因此客户端不应发送重新验证请求头（例如If-None-Match或If-Modified-Since）来检查更新，即使用户显式地刷新页面。在Firefox中，immutable只能被用在 https:// transactions. 有关更多信息，请参阅这里。</span><br><span class="line">其他</span><br><span class="line">no-transform</span><br><span class="line">不得对资源进行转换或转变。Content-Encoding、Content-Range、Content-Type等HTTP头不能由代理修改。例如，非透明代理或者如Google&#x27;s Light Mode可能对图像格式进行转换，以便节省缓存空间或者减少缓慢链路上的流量。no-transform指令不允许这样做。</span><br><span class="line">only-if-cached</span><br><span class="line">表明客户端只接受已缓存的响应，并且不要向原始服务器检查是否有更新的拷贝。</span><br></pre></td></tr></table></figure>
<h6 id="⑤X-XSS-Protection响应头"><a href="#⑤X-XSS-Protection响应头" class="headerlink" title="⑤X-XSS-Protection响应头"></a>⑤X-XSS-Protection响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">顾名思义，这个响应头是用来防范XSS的。最早我是在介绍IE8的文章里看到这个，现在主流浏览器都支持，并且默认都开启了XSS保护，用这个header可以关闭它。它有几种配置：</span><br><span class="line">0：# 禁用XSS保护；</span><br><span class="line">1：# 启用XSS保护；</span><br><span class="line">1; # mode=block：启用XSS保护，并在检查到XSS攻击时，停止渲染页面（例如IE8中，检查到攻击时，整个页面会被一个#替换）；</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> HTTP X-XSS-Protection 响应头是 Internet Explorer，Chrome 和 Safari 的一个特性，</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 当检测到跨站脚本攻击 (XSS)时，浏览器将停止加载页面。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> X-XSS-Protection响应头的缺失使得目标URL更易遭受跨站脚本攻击。</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> 浏览器提供的XSS保护机制并不完美，但是开启后仍然可以提升攻击难度，总之没有特别的理由，不要关闭它</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> add_header X-Xss-Protection: 1;</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> add_header X-Xss-Protection: mod=block;</span></span><br></pre></td></tr></table></figure>
<h6 id="⑥StrictTransportSecurity响应头"><a href="#⑥StrictTransportSecurity响应头" class="headerlink" title="⑥StrictTransportSecurity响应头"></a>⑥StrictTransportSecurity响应头</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">一个网站接受一个HTTP的请求，然后跳转到HTTPS，用户可能在开始跳转前，通过没有加密的方式和服务器对话，比如，用户输入http://foo.com或者直接foo.com。这样存在中间人攻击潜在威胁，跳转过程可能被恶意网站利用来直接接触用户信息，而不是原来的加密信息。网站通过HTTP Strict Transport Security通知浏览器，这个网站禁止使用HTTP方式加载，浏览器应该自动把所有尝试使用HTTP的请求自动替换为HTTPS请求。</span><br><span class="line"><span class="meta">#</span><span class="bash"> add_header strict-transport-security: max-age=60</span></span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Nginx/Nginx%E7%9A%84%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/" data-id="ckk2gq3ue001mz8pqhvm29im5" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySql/MySql问题和解决方法" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/MySql/MySql%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.530Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="【Mysql】mysql-报错java-sql-SQLException-null-message-from-server-“Host-‘xx-xx-xx-xx"><a href="#【Mysql】mysql-报错java-sql-SQLException-null-message-from-server-“Host-‘xx-xx-xx-xx" class="headerlink" title="【Mysql】mysql 报错java.sql.SQLException: null, message from server: “Host ‘xx.xx.xx.xx"></a>【Mysql】mysql 报错java.sql.SQLException: null, message from server: “Host ‘xx.xx.xx.xx</h4><p>mysql  报错java.sql.SQLException: null, message from server: “Host ‘xx.xx.xx.xx’ is blocked because of many connection errors; unblock with ‘mysqladmin flush-hosts’”</p>
<p>原因：</p>
<p>说明mysqld已经得到了大量(max_connect_errors)的主机’hostname’的在中途被中断了的连接请求。在 max_connect_errors次失败请求后，mysqld认定出错了(象来自一个黑客的攻击)，并且阻止该站点进一步的连接，直到某人执行命令 mysqladmin flush-hosts。</p>
<p>解决办法：</p>
<p>cd /usr/local/mysql/bin</p>
<p>mysqladmin flush-hosts</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/MySql/MySql%E9%97%AE%E9%A2%98%E5%92%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95/" data-id="ckk2gq3ta000dz8pqgkkkdxsm" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySql/MySql锁等待超时问题排查" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/MySql/MySql%E9%94%81%E7%AD%89%E5%BE%85%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.528Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="故障分析-有效解决-MySQL-行锁等待超时问题"><a href="#故障分析-有效解决-MySQL-行锁等待超时问题" class="headerlink" title="故障分析 | 有效解决 MySQL 行锁等待超时问题"></a>故障分析 | 有效解决 MySQL 行锁等待超时问题</h3><h4 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a><strong>一、背景</strong></h4><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#### 20191219 10:10:10,234 | com.alibaba.druid.filter.logging.Log4jFilter.statementLogError(Log4jFilter.java:152) | ERROR |  &#123;conn-10593, pstmt-38675&#125; execute error. update operation_service set offlinemark = ? , resourcestatus = ?  where RowGuid = ?</span><br><span class="line">com.mysql.jdbc.exceptions.jdbc4.MySQLTransactionRollbackException: Lock wait timeout exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>
<p>上述这个错误，接触 MySQL 的同学或多或少应该都遇到过，专业一点来说，这个报错我们称之为<strong>锁等待超时</strong>。根据锁的类型主要细分为：</p>
<ul>
<li>行锁等待超时<br>当 SQL 因为等待行锁而超时，那么就为行锁等待超时，常在多并发事务场景下出现。</li>
<li>元数据锁等待超时<br>当 SQL 因为等待元数据锁而超时，那么就为元数据锁等待超时，常在 DDL 操作期间出现。</li>
</ul>
<p>本文仅介绍如何有效解决行锁等待超时，因为大多数项目都是此类错误，元数据锁等待超时则不涉及讲解。</p>
<h4 id="二、行锁的等待"><a href="#二、行锁的等待" class="headerlink" title="二、行锁的等待"></a><strong>二、行锁的等待</strong></h4><p>在介绍如何解决行锁等待问题前，先简单介绍下这类问题产生的原因。产生原因简述：当多个事务同时去操作（增删改）某一行数据的时候，MySQL 为了维护 ACID 特性，就会用锁的形式来防止多个事务同时操作某一行数据，避免数据不一致。只有分配到行锁的事务才有权力操作该数据行，直到该事务结束，才释放行锁，而其他没有分配到行锁的事务就会产生行锁等待。如果等待时间超过了配置值（也就是 innodb_lock_wait_timeout 参数的值，个人习惯配置成 5s，MySQL 官方默认为 50s），则会抛出行锁等待超时错误。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114825.jpg" alt="img"></p>
<p>如上图所示，事务 A 与事务 B 同时会去 Insert 一条主键值为 1 的数据，由于事务 A 首先获取了主键值为 1 的行锁，导致事务 B 因无法获取行锁而产生等待，等到事务 A 提交后，事务 B 才获取该行锁，完成提交。这里强调的是行锁的概念，虽然事务 B 重复插入了主键，但是在获取行锁之前，事务一直是处于行锁等待的状态，只有获取行锁后，才会报主键冲突的错误。当然这种 Inster 行锁冲突的问题比较少见，只有在大量并发插入场景下才会出现，项目上真正常见的是 update&amp;delete 之间行锁等待，这里只是用于示例，原理都是相同的。</p>
<h4 id="三、产生的原因"><a href="#三、产生的原因" class="headerlink" title="三、产生的原因"></a><strong>三、产生的原因</strong></h4><p>根据我之前接触到的此类问题，大致可以分为以下几种原因：</p>
<p><strong>1. 程序中非数据库交互操作导致事务挂起</strong></p>
<p>将接口调用或者文件操作等这一类非数据库交互操作嵌入在 SQL 事务代码之中，那么整个事务很有可能因此挂起（接口不通等待超时或是上传下载大附件）。</p>
<p><strong>2. 事务中包含性能较差的查询 SQL</strong></p>
<p>事务中存在慢查询，导致同一个事务中的其他 DML 无法及时释放占用的行锁，引起行锁等待。</p>
<p><strong>3. 单个事务中包含大量 SQL</strong></p>
<p>通常是由于在事务代码中加入 for 循环导致，虽然单个 SQL 运行很快，但是 SQL 数量一大，事务就会很慢。</p>
<p><strong>4. 级联更新 SQL 执行时间较久</strong></p>
<p>这类 SQL 容易让人产生错觉，例如：<code>update A set ... where ...in (select B)</code> 这类级联更新，不仅会占用 A 表上的行锁，也会占用 B 表上的行锁，当 SQL 执行较久时，很容易引起 B 表上的行锁等待。</p>
<p><strong>5. 磁盘问题导致的事务挂起</strong></p>
<p>极少出现的情形，比如存储突然离线，SQL 执行会卡在内核调用磁盘的步骤上，一直等待，事务无法提交。综上可以看出，如果事务长时间未提交，且事务中包含了 DML 操作，那么就有可能产生行锁等待，引起报错。</p>
<h4 id="四、定位难点"><a href="#四、定位难点" class="headerlink" title="四、定位难点"></a><strong>四、定位难点</strong></h4><p>当 web 日志中出现行锁超时错误后，很多开发都会找我来排查问题，这里说下问题定位的难点！1. MySQL 本身不会主动记录行锁等待的相关信息，所以无法有效的进行事后分析。2. 锁争用原因有多种，很难在事后判断到底是哪一类问题场景，尤其是事后无法复现问题的时候。3. 找到问题 SQL 后，开发无法有效从代码中挖掘出完整的事务，这也和公司<strong>框架-产品-项目</strong>的架构有关，需要靠 DBA 事后采集完整的事务 SQL 才可以进行分析。</p>
<h4 id="五、常用方法"><a href="#五、常用方法" class="headerlink" title="五、常用方法"></a><strong>五、常用方法</strong></h4><blockquote>
<p>先介绍下个人通常是如何解决此类问题的， 这里问题解决的前提是问题可以复现，只要不是突然出现一次，之后再也不出现，一般都是可以找到问题源头的。</p>
</blockquote>
<p>这里问题复现分为两种情景：</p>
<p>\1. 手动复现只要按照一定的操作，就可以复现报错，这种场景较简单！</p>
<p>\2. 随机复现不知道何时会突然报错，无法手动复现，这种场景较难！</p>
<p>下面先写下统一的模拟场景，用于复现行锁超时问题，便于大家理解：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">--表结构</span><br><span class="line">CREATE TABLE `emp` (</span><br><span class="line">  `id` int(11) NOT NULL,</span><br><span class="line">  KEY `idx_id` (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4</span><br><span class="line"></span><br><span class="line">从1~100w插入100w行记录。</span><br><span class="line"></span><br><span class="line">--测试过程：</span><br><span class="line">事务1：</span><br><span class="line">start transaction;</span><br><span class="line">delete from emp where id = 1;</span><br><span class="line">select * from emp where id in (select id from emp);   --&gt;模拟慢查询，执行时间很久，事务因此一直不提交，行锁也不释放.</span><br><span class="line">commit;</span><br><span class="line"></span><br><span class="line">事务2：</span><br><span class="line">start transaction;</span><br><span class="line">delete from emp where id &lt; 10;   --&gt; 处于等待id=1的行锁状态，当达到行锁超时时间（这里我配置了超时时间为 5s）后，返回行锁超时报错</span><br><span class="line">rollback;</span><br></pre></td></tr></table></figure>
<p>5.1 手动复现场景</p>
<p>这个场景通常只需要通过 innodb 行锁等待脚本就可以知道当前 MySQL 的 innodb 行锁等待情况，例如我们一边模拟上述报错场景（模拟页面操作），另一边使用脚本查询（需要在超时之前查询，否则超时报错后就看不到了）。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">/*innodb 行锁等待脚本*/</span><br><span class="line">SELECT r.trx_mysql_thread_id waiting_thread,r.trx_query waiting_query,</span><br><span class="line">concat(timestampdiff(SECOND,r.trx_wait_started,CURRENT_TIMESTAMP()),&#x27;s&#x27;) AS duration,</span><br><span class="line">b.trx_mysql_thread_id blocking_thread,t.processlist_command state,b.trx_query blocking_current_query,e.sql_text blocking_last_query</span><br><span class="line">FROM information_schema.innodb_lock_waits w</span><br><span class="line">JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id</span><br><span class="line">JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id</span><br><span class="line">JOIN performance_schema.threads t on t.processlist_id = b.trx_mysql_thread_id</span><br><span class="line">JOIN performance_schema.events_statements_current e USING(thread_id)</span><br></pre></td></tr></table></figure>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114834.jpg" alt="img"></p>
<p>如上我们可以看到事务 2 的线程 id 为 76，已经被事务 1，也就是线程 id 为 75 的事务阻塞了 3s，并且可以看到事务 1 当前执行的 SQL 为一个 SELECT。这里也解释了很多开发经常问我的，为什么 SELECT 也会阻塞其他会话？如果遇到这种情况，那么处理其实非常简单。需要优化这个 SELECT 就好了，实在优化不了，把这个查询扔到事务外就可以了，甚至都不需要挖掘出整个事务。上述这个问题模拟，其实就是对应第三节问题产生原因中的第二点<strong>（事务中包含性能较差的查询 SQL）</strong>，下面我们把第一点<strong>（程序中非数据库交互操作导致事务挂起）</strong>也模拟下，对比下现象。我们只需要将事务 1 的过程改成如下即可。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">事务1：</span><br><span class="line">start transaction;</span><br><span class="line">delete from emp where id = 1;</span><br><span class="line">select * from emp where id in (select id from emp);</span><br><span class="line">等待60s(什么都不要做)             --&gt; 模拟接口调用超时，事务夯住，随后再执行commit。</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>
<p>再次用脚本查看，可以看到现象是有所不同的，不同点在于，阻塞事务处于 sleep 状态，即事务当前并不在跑 SQL。从 DBA 的角度看，这类现象八成就可以断定是代码在事务中嵌入了其他的交互操作导致的事务挂起（另外也有可能是网络问题导致的事务僵死），因为程序并不像人，它不会偷懒，不会出现事务执行到一半，休息一会再提交一说。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114843.jpg" alt="img"></p>
<p>如果是这类现象的问题，因为本质并不是由于 SQL 慢导致的事务挂起，所以必须要到代码里去找到对应的点，看下到底是在做什么交互操作卡住了。这里就需要开发去排查代码才可以找到源头，但是唯一可用的信息就是该事务最后执行的一条 SQL，也就是上图中最后一列，从我之前的经验来看（绝大时候），开发很难单从这一条 SQL 就可以找到代码里具体位置，尤其是当这条 SQL 是一条很常见的 SQL，就更为困难！当面对这种情况，就需要 DBA 去挖掘出这个事务执行过的所有 SQL，然后再让开发去排查代码，这样难度应该就小多了。这里就需要用到 MySQL 的 general_log，该日志用于记录 MySQL 中所有运行过的 SQL。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">--查看general_log是否开启，及文件名</span><br><span class="line">mysql&gt; show variables like &#x27;%general_log%&#x27;;</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| Variable_name    | Value                                |</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line">| general_log      | OFF                                  |</span><br><span class="line">| general_log_file | /data/mysql_data/192-168-188-155.log |</span><br><span class="line">+------------------+--------------------------------------+</span><br><span class="line"></span><br><span class="line">--暂时开启general_log</span><br><span class="line">mysql&gt; set global general_log = 1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">--暂时关闭general_log</span><br><span class="line">mysql&gt; set global general_log = 0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<p>开启 general_log 后，手动复现的时候通过 innodb 行锁等待脚本查询结果中的线程 ID，去 general_log 找到对应的事务分析即可，如下：</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114852.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114859.jpg" alt="img"></p>
<p>根据线程 ID 可以很轻易的从 general_log 中找到对应时间点的事务操作（实际场景下可能需要通过管道命令过滤）。如上图所示，事务 1 与事务 2 的全部 SQL 都可以找到，再通过这些 SQL 去代码中找到对应的位置即可，比如上图中线程 ID 为 111 的事务，执行 <code>select * from emp where id in (select id from emp)</code> 后到真正提交，过了 1min 左右，原因要么就是这条 SQL 查询慢，要么就是代码在执行其他交互操作。</p>
<blockquote>
<p>PS：general_log 由于会记录所有 SQL，所以对 MySQL 性能影响较大，且容易暴涨，所以只在问题排查时暂时开启，问题排查后，请及时关闭！</p>
</blockquote>
<p>5.2 随机复现场景</p>
<p>相较于手动复现场景，这种场景因为具有随机性，所以无法一边模拟报错，一边通过脚本查询到具体的阻塞情况，因此需要通过其他方式来监控 MySQL 的阻塞情况。我一般是通过在 Linux 上后台跑监控脚本（innodb_lock_monitor.sh）来记录 MySQL 阻塞情况，脚本如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">#账号、密码、监控日志</span><br><span class="line">user=&quot;root&quot;</span><br><span class="line">password=&quot;Gepoint&quot;</span><br><span class="line">logfile=&quot;/root/innodb_lock_monitor.log&quot;</span><br><span class="line"></span><br><span class="line">while true</span><br><span class="line">do</span><br><span class="line">        num=`mysql -u$&#123;user&#125; -p$&#123;password&#125; -e &quot;select count(*) from information_schema.innodb_lock_waits&quot; |grep -v count`</span><br><span class="line">        if [[ $num -gt 0 ]];then</span><br><span class="line">            date  &gt;&gt; /root/innodb_lock_monitor.log</span><br><span class="line">            mysql -u$&#123;user&#125; -p$&#123;password&#125; -e  &quot;SELECT r.trx_mysql_thread_id waiting_thread,r.trx_query waiting_query, \</span><br><span class="line">concat(timestampdiff(SECOND,r.trx_wait_started,CURRENT_TIMESTAMP()),&#x27;s&#x27;) AS duration,\</span><br><span class="line">b.trx_mysql_thread_id blocking_thread,t.processlist_command state,b.trx_query blocking_query,e.sql_text \</span><br><span class="line">FROM information_schema.innodb_lock_waits w \</span><br><span class="line">JOIN information_schema.innodb_trx b ON b.trx_id = w.blocking_trx_id \</span><br><span class="line">JOIN information_schema.innodb_trx r ON r.trx_id = w.requesting_trx_id \</span><br><span class="line">JOIN performance_schema.threads t on t.processlist_id = b.trx_mysql_thread_id \</span><br><span class="line">JOIN performance_schema.events_statements_current e USING(thread_id) \G &quot; &gt;&gt; $&#123;logfile&#125;</span><br><span class="line">        fi</span><br><span class="line">        sleep 5</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>再次查看</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">--使用 nohup 命令后台运行监控脚本</span><br><span class="line">[root@192-168-188-155 ~]# nohup sh innodb_lock_monitor.sh  &amp;</span><br><span class="line">[2] 31464</span><br><span class="line">nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line"></span><br><span class="line">--查看 nohup.out 是否出现报错</span><br><span class="line">[root@192-168-188-155 ~]# tail -f nohup.out</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"></span><br><span class="line">--定时查看监控日志是否有输出(没有输出的话，这个日志也不会生成哦！)</span><br><span class="line">[root@192-168-188-155 ~]# tail -f innodb_lock_monitor.log</span><br><span class="line">Wed Feb  5 11:30:11 CST 2020</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line"> waiting_thread: 112</span><br><span class="line">  waiting_query: delete from emp where id &lt; 10</span><br><span class="line">       duration: 3s</span><br><span class="line">blocking_thread: 111</span><br><span class="line">          state: Sleep</span><br><span class="line"> blocking_query: NULL</span><br><span class="line">       sql_text: select * from emp where id in (select id from emp)</span><br></pre></td></tr></table></figure>
<p>当监控日志有输出阻塞信息时，后续解决方案就和之前的手动复现场景一致。</p>
<ul>
<li>如果是事务卡在慢 SQL，那么就需要优化 SQL。</li>
<li>如果是事务挂起，那么就通过 general_log 分析事务，然后找到具体的代码位置。</li>
</ul>
<blockquote>
<p>PS：问题排查完成后，请及时关闭后台监控进程，通过 <code>kill+pid</code> 的方式直接关闭即可！</p>
</blockquote>
<h4 id="六、Performance-Schema"><a href="#六、Performance-Schema" class="headerlink" title="六、Performance_Schema"></a><strong>六、Performance_Schema</strong></h4><blockquote>
<p>之前的方法感觉不是很方便，因为 general_log 需要访问服务器，且过滤分析也较难，需要一定的 MySQL 基础及 Linux 基础才适用，因此想寻找一种更为简便的方法。</p>
</blockquote>
<p>6.1 方法介绍</p>
<p>个人想法是利用 MySQL 5.5 开始提供的 performance_schema 性能引擎来进行分析，Performance_Schema 是 MySQL 提供的在系统底层监视 MySQL 服务器性能的一个特性，其提供了大量监控项，包括：锁、IO、事务、内存使用等。</p>
<p><strong>介绍下主要原理：</strong></p>
<p>\1. 主要用的表有 2 张 events_transactions_history_long 和 events_statements_history_long。2. transactions_history_long 会记录历史事务信息，events_statements_history_long 则记录历史 SQL。3. 从 transactions_history_long 中得到回滚事务的线程 ID，再根据时间范围去筛选出可疑的事务，最后从 events_statements_history_long 得到事务对应的 SQL，从中排查哪个为源头。</p>
<p><strong>优点：</strong></p>
<p>\1. 不需要通过 general_log 来获取事务 SQL。2. 不需要监控脚本来获取到行锁等待情况。3. 只需要访问 MySQL 就可以实现，而不需要访问服务器。4. 性能开销较小，且不会暴涨，因为是循环覆盖写入的。5. 可以知道每条 SQL 的运行时长。</p>
<p><strong>缺点：</strong></p>
<p>\1. history_long 相关表默认保留记录有限，可能会把有用的数据刷掉，尤其是在 SQL 运行较多的系统。2. 如果要加大 history_long 相关表的最大保留行数，需要重启 MySQL，无法在线修改参数。3. history_long 相关表记录中的时间均为相对时间，也就是距离 MySQL 启动的时长，看起来不是很方便。4. history_long 相关表不会主动记录行锁等待的信息，所以只能通过先根据时间范围刷选出可疑的事务，再进一步分析，不如脚本监控定位的准。</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">/*开启performance_schema相关监控项，需要提前开启performance_schema*/</span><br><span class="line">UPDATE performance_schema.setup_instruments SET ENABLED = &#x27;YES&#x27;, TIMED = &#x27;YES&#x27; where name = &#x27;transaction&#x27;;</span><br><span class="line">UPDATE performance_schema.setup_consumers SET ENABLED = &#x27;YES&#x27; where name like &#x27;%events_transactions%&#x27;;</span><br><span class="line">UPDATE performance_schema.setup_consumers SET ENABLED = &#x27;YES&#x27; where name like &#x27;%events_statements%&#x27;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*查看回滚事务SQL，确认是否是日志里报错的事务*/</span><br><span class="line">SELECT a.THREAD_ID</span><br><span class="line">    ,b.EVENT_ID</span><br><span class="line">    ,a.EVENT_NAME</span><br><span class="line">    ,CONCAT (b.TIMER_WAIT / 1000000000000,&#x27;s&#x27;) AS trx_druation</span><br><span class="line">    ,CONCAT (a.TIMER_WAIT / 1000000000000,&#x27;s&#x27;) sql_druation</span><br><span class="line">    ,a.SQL_TEXT,b.STATE,a.MESSAGE_TEXT</span><br><span class="line">FROM performance_schema.events_statements_history_long a</span><br><span class="line">JOIN performance_schema.events_transactions_history_long b ON a.THREAD_ID = b.THREAD_ID</span><br><span class="line">    AND (a.NESTING_EVENT_ID = b.EVENT_ID OR a.EVENT_ID = b.NESTING_EVENT_ID)</span><br><span class="line">WHERE b.autocommit = &#x27;NO&#x27; AND a.SQL_TEXT IS NOT NULL AND b.STATE = &#x27;ROLLED BACK&#x27;</span><br><span class="line"></span><br><span class="line">/*查看该时间段内可疑事务即超过5s的事务SQL，这里默认innodb_lock_wait_timeout为5s*/</span><br><span class="line">SELECT a.THREAD_ID</span><br><span class="line">    ,b.EVENT_ID</span><br><span class="line">    ,a.EVENT_NAME</span><br><span class="line">    ,CONCAT (b.TIMER_WAIT / 1000000000000,&#x27;s&#x27;) AS trx_druation</span><br><span class="line">    ,CONCAT (a.TIMER_WAIT / 1000000000000,&#x27;s&#x27;) sql_druation</span><br><span class="line">    ,a.SQL_TEXT,b.STATE,a.MESSAGE_TEXT,a.ROWS_AFFECTED,a.ROWS_EXAMINED,a.ROWS_SENT</span><br><span class="line">FROM performance_schema.events_statements_history_long a</span><br><span class="line">JOIN performance_schema.events_transactions_history_long b ON a.THREAD_ID = b.THREAD_ID</span><br><span class="line">    AND (a.NESTING_EVENT_ID = b.EVENT_ID OR a.EVENT_ID = b.NESTING_EVENT_ID)</span><br><span class="line">WHERE b.autocommit = &#x27;NO&#x27; AND SQL_TEXT IS NOT NULL AND b.STATE = &#x27;COMMITTED&#x27;</span><br><span class="line">    AND b.TIMER_WAIT / 1000000000000  &gt; 5</span><br><span class="line">    AND b.TIMER_START &lt; (SELECT TIMER_START FROM performance_schema.events_transactions_history_long</span><br><span class="line">        WHERE THREAD_ID = 70402  /*上述SQL查询结果中的线程ID*/</span><br><span class="line">        AND EVENT_ID = 518)      /*上述SQL查询结果中的事件ID*/</span><br><span class="line">    AND b.TIMER_END &gt; ( SELECT TIMER_END FROM performance_schema.events_transactions_history_long</span><br><span class="line">        WHERE THREAD_ID = 70402  /*上述SQL查询结果中的线程ID*/</span><br><span class="line">        AND EVENT_ID = 518)     /*上述SQL查询结果中的事件ID*/</span><br><span class="line">ORDER BY a.THREAD_ID</span><br></pre></td></tr></table></figure>
<p>6.2 测试模拟</p>
<p>如果是用这种方法的话，那么就不需要分手动复现还是随机复现了，操作方法都是一样的，下面模拟下如何操作：</p>
<p>\1. 首先通过上述方法开启 performance_schema 相关监控项，会直接生效，无需重启 MySQL。</p>
<p>\2. 然后复现问题，这里最好是手动复现（因为复现后如果没有及时查看，监控数据可能就会被刷掉），不行的话就只能等待随机复现了。</p>
<p>\3. 问题复现后通过上述脚本查询是否存在回滚事务（即因为行锁超时回滚的事务）。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114912.jpg" alt="img"></p>
<p>\4. 然后根据回滚事务的线程 ID 和事件 ID，带入到最后一个脚本中，查看可疑事务，进行分析。</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114920.jpg" alt="img"></p>
<p>这里由于是测试环境模拟，所以结果非常了然，项目上实际输出结果可能有很多，需要一一分析事务是否有问题！</p>
<h4 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a><strong>七、总结</strong></h4><p>实际测试后，发现通过 performance_schema 来排查行锁等待超时问题限制其实也比较多，而且最后的分析也是一门技术活，并不如一开始想象的那么简单，有点事与愿违了。通过 performance_schema 排查问题最难处理的有 3 点：</p>
<p>\1. 时间问题，相对时间如何转换为绝对时间，这个目前一直找不到好的方法。</p>
<p>\2. 不会主动记录下行锁等待的信息，所以只能通过时间节点刷选后进一步分析。</p>
<p>\3. 记录被刷问题，因为是内存表，设置很大容易内存溢出，设置很小就容易被很快刷掉。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/MySql/MySql%E9%94%81%E7%AD%89%E5%BE%85%E8%B6%85%E6%97%B6%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/" data-id="ckk2gq3ue001lz8pqe5sagt1o" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">&laquo; Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/5/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>