<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-MySql/MySql数据库优化" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/MySql/MySql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.524Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h5 id="1、选取最适用的字段属性"><a href="#1、选取最适用的字段属性" class="headerlink" title="1、选取最适用的字段属性"></a>1、选取最适用的字段属性</h5><p>MySQL可以很好的支持大数据量的存取，但是一般说来，数据库中的表越小，在它上面执行的查询也就会越快。因此，在创建表的时候，为了获得更好的性能，我们可以将表中字段的宽度设得尽可能小。</p>
<p>例如，在定义邮政编码这个字段时，如果将其设置为CHAR(255),显然给数据库增加了不必要的空间，甚至使用VARCHAR这种类型也是多余的，因为CHAR(6)就可以很好的完成任务了。同样的，如果可以的话，我们应该使用MEDIUMINT而不是BIGIN来定义整型字段。</p>
<p>另外一个提高效率的方法是在可能的情况下，应该尽量把字段设置为NOTNULL，这样在将来执行查询的时候，数据库不用去比较NULL值。<br>对于某些文本字段，例如“省份”或者“性别”，我们可以将它们定义为ENUM类型。因为在MySQL中，ENUM类型被当作数值型数据来处理，而数值型数据被处理起来的速度要比文本类型快得多。这样，我们又可以提高数据库的性能。</p>
<h5 id="2、使用连接（JOIN）来代替子查询-Sub-Queries"><a href="#2、使用连接（JOIN）来代替子查询-Sub-Queries" class="headerlink" title="2、使用连接（JOIN）来代替子查询(Sub-Queries)"></a>2、使用连接（JOIN）来代替子查询(Sub-Queries)</h5><p>MySQL从4.1开始支持SQL的子查询。这个技术可以使用SELECT语句来创建一个单列的查询结果，然后把这个结果作为过滤条件用在另一个查询中。例如，我们要将客户基本信息表中没有任何订单的客户删除掉，就可以利用子查询先从销售信息表中将所有发出订单的客户ID取出来，然后将结果传递给主查询，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELETEFROMcustomerinfo</span><br><span class="line">WHERECustomerIDNOTin(SELECTCustomerIDFROMsalesinfo)</span><br></pre></td></tr></table></figure>
<p>使用子查询可以一次性的完成很多逻辑上需要多个步骤才能完成的SQL操作，同时也可以避免事务或者表锁死，并且写起来也很容易。但是，有些情况下，子查询可以被更有效率的连接（JOIN）..替代。例如，假设我们要将所有没有订单记录的用户取出来，可以用下面这个查询完成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT*FROMcustomerinfo</span><br><span class="line">WHERECustomerIDNOTin(SELECTCustomerIDFROMsalesinfo)</span><br></pre></td></tr></table></figure>
<p>如果使用连接（JOIN）..来完成这个查询工作，速度将会快很多。尤其是当salesinfo表中对CustomerID建有索引的话，性能将会更好，查询如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT*FROMcustomerinfo</span><br><span class="line">LEFTJOINsalesinfoONcustomerinfo.CustomerID&#x3D;salesinfo.CustomerID</span><br><span class="line">WHEREsalesinfo.CustomerIDISNULL</span><br></pre></td></tr></table></figure>
<p>连接（JOIN）..之所以更有效率一些，是因为MySQL不需要在内存中创建临时表来完成这个逻辑上的需要两个步骤的查询工作。</p>
<h5 id="3、使用联合-UNION-来代替手动创建的临时表"><a href="#3、使用联合-UNION-来代替手动创建的临时表" class="headerlink" title="3、使用联合(UNION)来代替手动创建的临时表"></a>3、使用联合(UNION)来代替手动创建的临时表</h5><p>MySQL从4.0的版本开始支持union查询，它可以把需要使用临时表的两条或更多的select查询合并的一个查询中。在客户端的查询会话结束的时候，临时表会被自动删除，从而保证数据库整齐、高效。使用union来创建查询的时候，我们只需要用UNION作为关键字把多个select语句连接起来就可以了，要注意的是所有select语句中的字段数目要想同。下面的例子就演示了一个使用UNION的查询。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECTName,PhoneFROMclientUNION</span><br><span class="line">SELECTName,BirthDateFROMauthorUNION</span><br><span class="line">SELECTName,SupplierFROMproduct</span><br></pre></td></tr></table></figure>
<h5 id="4、事务"><a href="#4、事务" class="headerlink" title="4、事务"></a>4、事务</h5><p>尽管我们可以使用子查询（Sub-Queries）、连接（JOIN）和联合（UNION）来创建各种各样的查询，但不是所有的数据库操作都可以只用一条或少数几条SQL语句就可以完成的。更多的时候是需要用到一系列的语句来完成某种工作。但是在这种情况下，当这个语句块中的某一条语句运行出错的时候，整个语句块的操作就会变得不确定起来。设想一下，要把某个数据同时插入两个相关联的表中，可能会出现这样的情况：第一个表中成功更新后，数据库突然出现意外状况，造成第二个表中的操作没有完成，这样，就会造成数据的不完整，甚至会破坏数据库中的数据。要避免这种情况，就应该使用事务，它的作用是：要么语句块中每条语句都操作成功，要么都失败。换句话说，就是可以保持数据库中数据的一致性和完整性。事物以BEGIN关键字开始，COMMIT关键字结束。在这之间的一条SQL操作失败，那么，ROLLBACK命令就可以把数据库恢复到BEGIN开始之前的状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">BEGIN; INSERTINTOsalesinfoSETCustomerID&#x3D;14;UPDATEinventorySETQuantity&#x3D;11WHEREitem&#x3D;&#39;book&#39;;COMMIT;</span><br></pre></td></tr></table></figure>
<p>事务的另一个重要作用是当多个用户同时使用相同的数据源时，它可以利用锁定数据库的方法来为用户提供一种安全的访问方式，这样可以保证用户的操作不被其它的用户所干扰。</p>
<h5 id="5、锁定表"><a href="#5、锁定表" class="headerlink" title="5、锁定表"></a>5、锁定表</h5><p>尽管事务是维护数据库完整性的一个非常好的方法，但却因为它的独占性，有时会影响数据库的性能，尤其是在很大的应用系统中。由于在事务执行的过程中，数据库将会被锁定，因此其它的用户请求只能暂时等待直到该事务结束。如果一个数据库系统只有少数几个用户来使用，事务造成的影响不会成为一个太大的问题；但假设有成千上万的用户同时访问一个数据库系统，例如访问一个电子商务网站，就会产生比较严重的响应延迟。</p>
<p>其实，有些情况下我们可以通过锁定表的方法来获得更好的性能。下面的例子就用锁定表的方法来完成前面一个例子中事务的功能。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">LOCKTABLEinventoryWRITESELECTQuantityFROMinventoryWHEREItem&#x3D;&#39;book&#39;;</span><br><span class="line">...</span><br><span class="line">UPDATEinventorySETQuantity&#x3D;11WHEREItem&#x3D;&#39;book&#39;;UNLOCKTABLES</span><br></pre></td></tr></table></figure>
<p>这里，我们用一个select语句取出初始数据，通过一些计算，用update语句将新值更新到表中。包含有WRITE关键字的LOCKTABLE语句可以保证在UNLOCKTABLES命令被执行之前，不会有其它的访问来对inventory进行插入、更新或者删除的操作。</p>
<h5 id="6、使用外键"><a href="#6、使用外键" class="headerlink" title="6、使用外键"></a>6、使用外键</h5><p>锁定表的方法可以维护数据的完整性，但是它却不能保证数据的关联性。这个时候我们就可以使用外键。</p>
<p>例如，外键可以保证每一条销售记录都指向某一个存在的客户。在这里，外键可以把customerinfo表中的CustomerID映射到salesinfo表中CustomerID，任何一条没有合法CustomerID的记录都不会被更新或插入到salesinfo中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
<ol>
<li><code>CREATETABLEcustomerinfo( CustomerIDINTNOTNULL,PRIMARYKEY(CustomerID))TYPE=INNODB;</code></li>
<li></li>
<li><code>CREATETABLEsalesinfo( SalesIDINTNOTNULL,CustomerIDINTNOTNULL,</code></li>
<li></li>
<li><code>PRIMARYKEY(CustomerID,SalesID),</code></li>
<li></li>
<li><code>FOREIGNKEY(CustomerID)REFERENCEScustomerinfo(CustomerID)ONDELETECASCADE)TYPE=INNODB;</code></li>
</ol>
<p>注意例子中的参数“ONDELETECASCADE”。该参数保证当customerinfo表中的一条客户记录被删除的时候，salesinfo表中所有与该客户相关的记录也会被自动删除。如果要在MySQL中使用外键，一定要记住在创建表的时候将表的类型定义为事务安全表InnoDB类型。该类型不是MySQL表的默认类型。定义的方法是在CREATETABLE语句中加上TYPE=INNODB。如例中所示。</p>
<h5 id="7、使用索引"><a href="#7、使用索引" class="headerlink" title="7、使用索引"></a>7、使用索引</h5><p>索引是提高数据库性能的常用方法，它可以令数据库服务器以比没有索引快得多的速度检索特定的行，尤其是在查询语句当中包含有MAX(),MIN()和ORDERBY这些命令的时候，性能提高更为明显。</p>
<p>那该对哪些字段建立索引呢？</p>
<p>一般说来，索引应建立在那些将用于JOIN,WHERE判断和ORDERBY排序的字段上。尽量不要对数据库中某个含有大量重复的值的字段建立索引。对于一个ENUM类型的字段来说，出现大量重复值是很有可能的情况</p>
<p>例如customerinfo中的“province”..字段，在这样的字段上建立索引将不会有什么帮助；相反，还有可能降低数据库的性能。我们在创建表的时候可以同时创建合适的索引，也可以使用ALTERTABLE或CREATEINDEX在以后创建索引。此外，MySQL从版本3.23.23开始支持全文索引和搜索。全文索引在MySQL中是一个FULLTEXT类型索引，但仅能用于MyISAM类型的表。对于一个大的数据库，将数据装载到一个没有FULLTEXT索引的表中，然后再使用ALTERTABLE或CREATEINDEX创建索引，将是非常快的。但如果将数据装载到一个已经有FULLTEXT索引的表中，执行过程将会非常慢。</p>
<h5 id="8、优化的查询语句"><a href="#8、优化的查询语句" class="headerlink" title="8、优化的查询语句"></a>8、优化的查询语句</h5><p>绝大多数情况下，使用索引可以提高查询的速度，但如果SQL语句使用不恰当的话，索引将无法发挥它应有的作用。</p>
<p>下面是应该注意的几个方面。</p>
<ul>
<li><p>首先，最好是在相同类型的字段间进行比较的操作。</p>
<blockquote>
<p>在MySQL3.23版之前，这甚至是一个必须的条件。例如不能将一个建有索引的INT字段和BIGINT字段进行比较；但是作为特殊的情况，在CHAR类型的字段和VARCHAR类型字段的字段大小相同的时候，可以将它们进行比较。</p>
</blockquote>
</li>
<li><p>其次，在建有索引的字段上尽量不要使用函数进行操作。</p>
</li>
</ul>
<blockquote>
<p>例如，在一个DATE类型的字段上使用YEAE()函数时，将会使索引不能发挥应有的作用。所以，下面的两个查询虽然返回的结果一样，但后者要比前者快得多。</p>
</blockquote>
<ul>
<li>第三，在搜索字符型字段时，我们有时会使用LIKE关键字和通配符，这种做法虽然简单，但却也是以牺牲系统性能为代价的。</li>
</ul>
<p>例如下面的查询将会比较表中的每一条记录。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
<ol>
<li></li>
<li><code>SELECT*FROMbooks</code></li>
<li></li>
<li><code>WHEREnamelike&quot;MySQL%&quot;</code></li>
</ol>
<p>但是如果换用下面的查询，返回的结果一样，但速度就要快上很多：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"> </span><br></pre></td></tr></table></figure>
<ol>
<li></li>
<li><code>SELECT*FROMbooks</code></li>
<li></li>
<li><code>WHEREname＞=&quot;MySQL&quot;andname＜&quot;MySQM&quot;</code></li>
</ol>
<p>最后，应该注意避免在查询中让MySQL进行自动类型转换，因为转换过程也会使索引变得不起作用。</p>
<h4 id="二、优化Mysql数据库的8个方法"><a href="#二、优化Mysql数据库的8个方法" class="headerlink" title="二、优化Mysql数据库的8个方法"></a>二、优化Mysql数据库的8个方法</h4><p>本文通过8个方法优化Mysql数据库：创建索引、复合索引、索引不会包含有NULL值的列、使用短索引、排序的索引问题、like语句操作、不要在列上进行运算、不使用NOT IN和&lt;&gt;操作</p>
<h5 id="1、创建索引"><a href="#1、创建索引" class="headerlink" title="1、创建索引"></a><strong>1、创建索引</strong></h5><p>对于查询占主要的应用来说，索引显得尤为重要。很多时候性能问题很简单的就是因为我们忘了添加索引而造成的，或者说没有添加更为有效的索引导致。如果不加索引的话，那么查找任何哪怕只是一条特定的数据都会进行一次全表扫描，如果一张表的数据量很大而符合条件的结果又很少，那么不加索引会引起致命的性能下降。但是也不是什么情况都非得建索引不可，比如性别可能就只有两个值，建索引不仅没什么优势，还会影响到更新速度，这被称为过度索引。</p>
<h5 id="2、复合索引"><a href="#2、复合索引" class="headerlink" title="2、复合索引"></a><strong>2、复合索引</strong></h5><p>比如有一条语句是这样的：select * from users where area=’beijing’ and age=22;<br>如果我们是在area和age上分别创建单个索引的话，由于mysql查询每次只能使用一个索引，所以虽然这样已经相对不做索引时全表扫描提高了很多效率，但是如果在area、age两列上创建复合索引的话将带来更高的效率。如果我们创建了(area, age, salary)的复合索引，那么其实相当于创建了(area,age,salary)、(area,age)、(area)三个索引，这被称为最佳左前缀特性。因此我们在创建复合索引时应该将最常用作限制条件的列放在最左边，依次递减。</p>
<h5 id="3、索引不会包含有NULL值的列"><a href="#3、索引不会包含有NULL值的列" class="headerlink" title="3、索引不会包含有NULL值的列"></a><strong>3、索引不会包含有NULL值的列</strong></h5><p>只要列中包含有NULL值都将不会被包含在索引中，复合索引中只要有一列含有NULL值，那么这一列对于此复合索引就是无效的。所以我们在数据库设计时不要让字段的默认值为NULL。</p>
<h5 id="4、使用短索引"><a href="#4、使用短索引" class="headerlink" title="4、使用短索引"></a><strong>4、使用短索引</strong></h5><p>对串列进行索引，如果可能应该指定一个前缀长度。例如，如果有一个CHAR(255)的 列，如果在前10 个或20 个字符内，多数值是惟一的，那么就不要对整个列进行索引。短索引不仅可以提高查询速度而且可以节省磁盘空间和I/O操作。</p>
<h5 id="5、排序的索引问题"><a href="#5、排序的索引问题" class="headerlink" title="5、排序的索引问题"></a><strong>5、排序的索引问题</strong></h5><p>mysql查询只使用一个索引，因此如果where子句中已经使用了索引的话，那么order by中的列是不会使用索引的。因此数据库默认排序可以符合要求的情况下不要使用排序操作；尽量不要包含多个列的排序，如果需要最好给这些列创建复合索引。</p>
<h5 id="6、like语句操作"><a href="#6、like语句操作" class="headerlink" title="6、like语句操作"></a><strong>6、like语句操作</strong></h5><p>一般情况下不鼓励使用like操作，如果非使用不可，如何使用也是一个问题。like “%aaa%” 不会使用索引而like “aaa%”可以使用索引。</p>
<h5 id="7、不要在列上进行运算"><a href="#7、不要在列上进行运算" class="headerlink" title="7、不要在列上进行运算"></a><strong>7、不要在列上进行运算</strong></h5><p>select * from users where YEAR(adddate)&lt;2007;<br>将在每个行上进行运算，这将导致索引失效而进行全表扫描，因此我们可以改成<br>select * from users where adddate&lt;‘2007-01-01’;</p>
<h5 id="8、不使用NOT-IN和-lt-gt-操作"><a href="#8、不使用NOT-IN和-lt-gt-操作" class="headerlink" title="8、不使用NOT IN和&lt;&gt;操作"></a><strong>8、不使用NOT IN和&lt;&gt;操作</strong></h5><p>NOT IN和&lt;&gt;操作都不会使用索引将进行全表扫描。NOT IN可以NOT EXISTS代替，id&lt;&gt;3则可使用id&gt;3 or id&lt;3来代替。</p>
<h4 id="三、数据库SQL优化大总结之-百万级数据库优化方案"><a href="#三、数据库SQL优化大总结之-百万级数据库优化方案" class="headerlink" title="三、数据库SQL优化大总结之 百万级数据库优化方案"></a>三、数据库SQL优化大总结之 百万级数据库优化方案</h4><p>网上关于SQL优化的教程很多，但是比较杂乱。近日有空整理了一下，写出来跟大家分享一下，其中有错误和不足的地方，还请大家纠正补充。</p>
<p>这篇文章我花费了大量的时间查找资料、修改、排版，希望大家阅读之后，感觉好的话推荐给更多的人，让更多的人看到、纠正以及补充。</p>
<p><strong>1.对查询进行优化，要尽量避免全表扫描，首先应考虑在 where 及 order by 涉及的列上建立索引。</strong></p>
<p><strong>2.应尽量避免在 where 子句中对字段进行 null 值判断，否则将导致引擎放弃使用索引而进行全表扫描，如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num is null</span><br></pre></td></tr></table></figure>
<p>最好不要给数据库留NULL，尽可能的使用 NOT NULL填充数据库.</p>
<p>备注、描述、评论之类的可以设置为 NULL，其他的，最好不要使用NULL。</p>
<p>不要以为 NULL 不需要空间，比如：char(100) 型，在字段建立时，空间就固定了， 不管是否插入值（NULL也包含在内），都是占用 100个字符的空间的，如果是varchar这样的变长字段， null 不占用空间。</p>
<p>可以在num上设置默认值0，确保表中num列没有null值，然后这样查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num &#x3D; 0</span><br></pre></td></tr></table></figure>


<p><strong>3.应尽量避免在 where 子句中使用 != 或 &lt;&gt; 操作符，否则将引擎放弃使用索引而进行全表扫描。</strong></p>
<p><strong>4.应尽量避免在 where 子句中使用 or 来连接条件，如果一个字段有索引，一个字段没有索引，将导致引擎放弃使用索引而进行全表扫描，如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num&#x3D;10 or Name &#x3D; &#39;admin&#39;</span><br></pre></td></tr></table></figure>
<p>可以这样查询：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num &#x3D; 10</span><br><span class="line">union all</span><br><span class="line">select id from t where Name &#x3D; &#39;admin&#39;</span><br></pre></td></tr></table></figure>
<p><strong>5.in 和 not in 也要慎用，否则会导致全表扫描，如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num in(1,2,3)</span><br></pre></td></tr></table></figure>
<p>对于连续的数值，能用 between 就不要用 in 了：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num between 1 and 3</span><br></pre></td></tr></table></figure>
<p>很多时候用 exists 代替 in 是一个好的选择：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select num from a where num in(select num from b)</span><br></pre></td></tr></table></figure>
<p>用下面的语句替换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select num from a where exists(select 1 from b where num&#x3D;a.num)</span><br></pre></td></tr></table></figure>


<p><strong>6.下面的查询也将导致全表扫描：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where name like ‘%abc%’</span><br></pre></td></tr></table></figure>
<p>若要提高效率，可以考虑全文检索。</p>
<p><strong>7.如果在 where 子句中使用参数，也会导致全表扫描。因为SQL只有在运行时才会解析局部变量，但优化程序不能将访问计划的选择推迟到运行时；它必须在编译时进行选择。然 而，如果在编译时建立访问计划，变量的值还是未知的，因而无法作为索引选择的输入项。如下面语句将进行全表扫描：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num &#x3D; @num</span><br></pre></td></tr></table></figure>
<p>可以改为强制查询使用索引：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t with(index(索引名)) where num &#x3D; @num</span><br></pre></td></tr></table></figure>
<p><strong>8.应尽量避免在 where 子句中对字段进行表达式操作，这将导致引擎放弃使用索引而进行全表扫描。如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num&#x2F;2 &#x3D; 100</span><br></pre></td></tr></table></figure>
<p>应改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select id from t where num &#x3D; 100*2</span><br></pre></td></tr></table></figure>


<p><strong>9.应尽量避免在where子句中对字段进行函数操作，这将导致引擎放弃使用索引而进行全表扫描。如：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id from t where substring(name,1,3) &#x3D; ’abc’       -–name以abc开头的id</span><br><span class="line">select id from t where datediff(day,createdate,’2005-11-30′) &#x3D; 0    -–‘2005-11-30’    --生成的id</span><br></pre></td></tr></table></figure>
<p>应改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select id from t where name like &#39;abc%&#39;</span><br><span class="line">select id from t where createdate &gt;&#x3D; &#39;2005-11-30&#39; and createdate &lt; &#39;2005-12-1&#39;</span><br></pre></td></tr></table></figure>
<p><strong>10.不要在 where 子句中的“=”左边进行函数、算术运算或其他表达式运算，否则系统将可能无法正确使用索引。</strong></p>
<p><strong>11.在使用索引字段作为条件时，如果该索引是复合索引，那么必须使用到该索引中的第一个字段作为条件时才能保证系统使用该索引，否则该索引将不会被使用，并且应尽可能的让字段顺序与索引顺序相一致。</strong></p>
<p><strong>12.不要写一些没有意义的查询，如需要生成一个空表结构：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select col1,col2 into #t from t where 1&#x3D;0</span><br></pre></td></tr></table></figure>
<p>这类代码不会返回任何结果集，但是会消耗系统资源的，应改成这样：<br>create table #t(…)</p>
<p><strong>13.Update 语句，如果只更改1、2个字段，不要Update全部字段，否则频繁调用会引起明显的性能消耗，同时带来大量日志。</strong></p>
<p><strong>14.对于多张大数据量（这里几百条就算大了）的表JOIN，要先分页再JOIN，否则逻辑读会很高，性能很差。</strong></p>
<p>*<em>15.select count(</em>) from table；这样不带任何条件的count会引起全表扫描，并且没有任何业务意义，是一定要杜绝的。**</p>
<p><strong>16.索引并不是越多越好，索引固然可以提高相应的 select 的效率，但同时也降低了 insert 及 update 的效率，因为 insert 或 update 时有可能会重建索引，所以怎样建索引需要慎重考虑，视具体情况而定。一个表的索引数最好不要超过6个，若太多则应考虑一些不常使用到的列上建的索引是否有 必要。</strong></p>
<p><strong>17.应尽可能的避免更新 clustered 索引数据列，因为 clustered 索引数据列的顺序就是表记录的物理存储顺序，一旦该列值改变将导致整个表记录的顺序的调整，会耗费相当大的资源。若应用系统需要频繁更新 clustered 索引数据列，那么需要考虑是否应将该索引建为 clustered 索引。</strong></p>
<p><strong>18.尽量使用数字型字段，若只含数值信息的字段尽量不要设计为字符型，这会降低查询和连接的性能，并会增加存储开销。这是因为引擎在处理查询和连 接时会逐个比较字符串中每一个字符，而对于数字型而言只需要比较一次就够了。</strong></p>
<p><strong>19.尽可能的使用 varchar/nvarchar 代替 char/nchar ，因为首先变长字段存储空间小，可以节省存储空间，其次对于查询来说，在一个相对较小的字段内搜索效率显然要高些。</strong></p>
<p><strong>20.任何地方都不要使用 select * from t ，用具体的字段列表代替“*”，不要返回用不到的任何字段。</strong></p>
<p><strong>21.尽量使用表变量来代替临时表。如果表变量包含大量数据，请注意索引非常有限（只有主键索引）。</strong></p>
<p><strong>\22. 避免频繁创建和删除临时表，以减少系统表资源的消耗。临时表并不是不可使用，适当地使用它们可以使某些例程更有效，例如，当需要重复引用大型表或常用表中的某个数据集时。但是，对于一次性事件， 最好使用导出表。</strong></p>
<p><strong>23.在新建临时表时，如果一次性插入数据量很大，那么可以使用 select into 代替 create table，避免造成大量 log ，以提高速度；如果数据量不大，为了缓和系统表的资源，应先create table，然后insert。</strong></p>
<p><strong>24.如果使用到了临时表，在存储过程的最后务必将所有的临时表显式删除，先 truncate table ，然后 drop table ，这样可以避免系统表的较长时间锁定。</strong></p>
<p><strong>25.尽量避免使用游标，因为游标的效率较差，如果游标操作的数据超过1万行，那么就应该考虑改写。</strong></p>
<p><strong>26.使用基于游标的方法或临时表方法之前，应先寻找基于集的解决方案来解决问题，基于集的方法通常更有效。</strong></p>
<p><strong>27.与临时表一样，游标并不是不可使用。对小型数据集使用 FAST_FORWARD 游标通常要优于其他逐行处理方法，尤其是在必须引用几个表才能获得所需的数据时。在结果集中包括“合计”的例程通常要比使用游标执行的速度快。如果开发时 间允许，基于游标的方法和基于集的方法都可以尝试一下，看哪一种方法的效果更好。</strong></p>
<p><strong>28.在所有的存储过程和触发器的开始处设置 SET NOCOUNT ON ，在结束时设置 SET NOCOUNT OFF 。无需在执行存储过程和触发器的每个语句后向客户端发送 DONE_IN_PROC 消息。</strong></p>
<p><strong>29.尽量避免大事务操作，提高系统并发能力。</strong></p>
<p><strong>30.尽量避免向客户端返回大数据量，若数据量过大，应该考虑相应需求是否合理。</strong></p>
<p>实际案例分析：拆分大的 DELETE 或INSERT 语句，批量提交SQL语句<br>　　如果你需要在一个在线的网站上去执行一个大的 DELETE 或 INSERT 查询，你需要非常小心，要避免你的操作让你的整个网站停止相应。因为这两个操作是会锁表的，表一锁住了，别的操作都进不来了。<br>　　Apache 会有很多的子进程或线程。所以，其工作起来相当有效率，而我们的服务器也不希望有太多的子进程，线程和数据库链接，这是极大的占服务器资源的事情，尤其是内存。<br>　　如果你把你的表锁上一段时间，比如30秒钟，那么对于一个有很高访问量的站点来说，这30秒所积累的访问进程/线程，数据库链接，打开的文件数，可能不仅仅会让你的WEB服务崩溃，还可能会让你的整台服务器马上挂了。<br>　　所以，如果你有一个大的处理，你一定把其拆分，使用 LIMIT oracle(rownum),sqlserver(top)条件是一个好的方法。下面是一个mysql示例：</p>
<p><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">while(1)&#123;</span><br><span class="line"></span><br><span class="line"> 　　&#x2F;&#x2F;每次只做1000条</span><br><span class="line"></span><br><span class="line">　　 mysql_query(“delete from logs where log_date &lt;&#x3D; ’2012-11-01’ limit 1000”);</span><br><span class="line"></span><br><span class="line"> 　　if(mysql_affected_rows() &#x3D;&#x3D; 0)&#123;</span><br><span class="line"></span><br><span class="line">　　 　　&#x2F;&#x2F;删除完成，退出！</span><br><span class="line">　　 　　break；</span><br><span class="line">　　&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;每次暂停一段时间，释放表让其他进程&#x2F;线程访问。</span><br><span class="line">usleep(50000)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://common.cnblogs.com/images/copycode.gif" alt="复制代码"></p>
<p>好了，到这里就写完了。我知道还有很多没有写到的，还请大家补充。后面有空会介绍一些SQL优化工具给大家。让我们一起学习，一起进步吧！</p>
<h4 id="四、运维角度浅谈MySQL数据库优化"><a href="#四、运维角度浅谈MySQL数据库优化" class="headerlink" title="四、运维角度浅谈MySQL数据库优化"></a>四、运维角度浅谈MySQL数据库优化</h4><p> 一个成熟的数据库架构并不是一开始设计就具备高可用、高伸缩等特性的，它是随着用户量的增加，基础架构才逐渐完善。这篇博文主要谈MySQL数据库发展周期中所面临的问题及优化方案，暂且抛开前端应用不说，大致分为以下五个阶段：</p>
<h5 id="1、数据库表设计"><a href="#1、数据库表设计" class="headerlink" title="1、数据库表设计"></a><strong>1、数据库表设计</strong></h5><p> 项目立项后，开发部根据产品部需求开发项目，开发工程师工作其中一部分就是对表结构设计。对于数据库来说，这点很重要，如果设计不当，会直接影响访问速度和用户体验。影响的因素很多，比如慢查询、低效的查询语句、没有适当建立索引、数据库堵塞（死锁）等。当然，有测试工程师的团队，会做压力测试，找bug。对于没有测试工程师的团队来说，大多数开发工程师初期不会太多考虑数据库设计是否合理，而是尽快完成功能实现和交付，等项目有一定访问量后，隐藏的问题就会暴露，这时再去修改就不是这么容易的事了。</p>
<h5 id="2、数据库部署"><a href="#2、数据库部署" class="headerlink" title="2、数据库部署"></a><strong>2、数据库部署</strong></h5><p> 该运维工程师出场了，项目初期访问量不会很大，所以单台部署足以应对在1500左右的QPS（每秒查询率）。考虑到高可用性，可采用MySQL主从复制+Keepalived做双击热备，常见集群软件有Keepalived、Heartbeat。</p>
<p>双机热备博文：<a target="_blank" rel="noopener" href="http://lizhenliang.blog.51cto.com/7876557/1362313">http://lizhenliang.blog.51cto.com/7876557/1362313</a></p>
<h5 id="3、数据库性能优化"><a href="#3、数据库性能优化" class="headerlink" title="3、数据库性能优化"></a><strong>3、数据库性能优化</strong></h5><p> 如果将MySQL部署到普通的X86服务器上，在不经过任何优化情况下，MySQL理论值正常可以处理2000左右QPS，经过优化后，有可能会提升到2500左右QPS，否则，访问量当达到1500左右并发连接时，数据库处理性能就会变慢，而且硬件资源还很富裕，这时就该考虑软件问题了。那么怎样让数据库最大化发挥性能呢？一方面可以单台运行多个MySQL实例让服务器性能发挥到最大化，另一方面是对数据库进行优化，往往操作系统和数据库默认配置都比较保守，会对数据库发挥有一定限制，可对这些配置进行适当的调整，尽可能的处理更多连接数。</p>
<p>具体优化有以下三个层面：</p>
<h6 id="3-1-数据库配置优化"><a href="#3-1-数据库配置优化" class="headerlink" title="3.1 数据库配置优化"></a><strong>3.1 数据库配置优化</strong></h6><p> MySQL常用有两种存储引擎，一个是MyISAM，不支持事务处理，读性能处理快，表级别锁。另一个是InnoDB，支持事务处理（ACID），设计目标是为处理大容量数据发挥最大化性能，行级别锁。</p>
<p> 表锁：开销小，锁定粒度大，发生死锁概率高，相对并发也低。</p>
<p> 行锁：开销大，锁定粒度小，发生死锁概率低，相对并发也高。</p>
<p> 为什么会出现表锁和行锁呢？主要是为了保证数据的完整性，举个例子，一个用户在操作一张表，其他用户也想操作这张表，那么就要等第一个用户操作完，其他用户才能操作，表锁和行锁就是这个作用。否则多个用户同时操作一张表，肯定会数据产生冲突或者异常。</p>
<p> 根据以上看来，使用InnoDB存储引擎是最好的选择，也是MySQL5.5以后版本中默认存储引擎。每个存储引擎相关联参数比较多，以下列出主要影响数据库性能的参数。</p>
<p> 公共参数默认值：</p>
<table>
<thead>
<tr>
<th>123456</th>
<th><code>max_connections = 151``#同时处理最大连接数，推荐设置最大连接数是上限连接数的80%左右  ``sort_buffer_size = 2M``#查询排序时缓冲区大小，只对order by和group by起作用，可增大此值为16M``open_files_limit = 1024 ``#打开文件数限制，如果show global status like &#39;open_files&#39;查看的值等于或者大于open_files_limit值时，程序会无法连接数据库或卡死</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> MyISAM参数默认值：</p>
<table>
<thead>
<tr>
<th>12345678910</th>
<th><code>key_buffer_size = 16M``#索引缓存区大小，一般设置物理内存的30-40%``read_buffer_size = 128K ``#读操作缓冲区大小，推荐设置16M或32M``query_cache_type = ON``#打开查询缓存功能``query_cache_limit = 1M ``#查询缓存限制，只有1M以下查询结果才会被缓存，以免结果数据较大把缓存池覆盖``query_cache_size = 16M ``#查看缓冲区大小，用于缓存SELECT查询结果，下一次有同样SELECT查询将直接从缓存池返回结果，可适当成倍增加此值</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> InnoDB参数默认值：</p>
<table>
<thead>
<tr>
<th>12345678910</th>
<th><code>innodb_buffer_pool_size = 128M``#索引和数据缓冲区大小，一般设置物理内存的60%-70%``innodb_buffer_pool_instances = 1  ``#缓冲池实例个数，推荐设置4个或8个``innodb_flush_log_at_trx_commit = 1 ``#关键参数，0代表大约每秒写入到日志并同步到磁盘，数据库故障会丢失1秒左右事务数据。1为每执行一条SQL后写入到日志并同步到磁盘，I/O开销大，执行完SQL要等待日志读写，效率低。2代表只把日志写入到系统缓存区，再每秒同步到磁盘，效率很高，如果服务器故障，才会丢失事务数据。对数据安全性要求不是很高的推荐设置2，性能高，修改后效果明显。``innodb_file_per_table = OFF ``#默认是共享表空间，共享表空间idbdata文件不断增大，影响一定的I/O性能。推荐开启独立表空间模式，每个表的索引和数据都存在自己独立的表空间中，可以实现单表在不同数据库中移动。``innodb_log_buffer_size = 8M ``#日志缓冲区大小，由于日志最长每秒钟刷新一次，所以一般不用超过16M</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="3-2-系统内核优化"><a href="#3-2-系统内核优化" class="headerlink" title="3.2 系统内核优化"></a><strong>3.2 系统内核优化</strong></h6><p> 大多数MySQL都部署在linux系统上，所以操作系统的一些参数也会影响到MySQL性能，以下对linux内核进行适当优化。</p>
<table>
<thead>
<tr>
<th>12345678910</th>
<th><code>net.ipv4.tcp_fin_timeout = 30``#TIME_WAIT超时时间，默认是60s``net.ipv4.tcp_tw_reuse = 1  ``#1表示开启复用，允许TIME_WAIT socket重新用于新的TCP连接，0表示关闭``net.ipv4.tcp_tw_recycle = 1 ``#1表示开启TIME_WAIT socket快速回收，0表示关闭``net.ipv4.tcp_max_tw_buckets = 4096  ``#系统保持TIME_WAIT socket最大数量，如果超出这个数，系统将随机清除一些TIME_WAIT并打印警告信息``net.ipv4.tcp_max_syn_backlog = 4096``#进入SYN队列最大长度，加大队列长度可容纳更多的等待连接</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> 在linux系统中，如果进程打开的文件句柄数量超过系统默认值1024，就会提示“too many files open”信息，所以要调整打开文件句柄限制。</p>
<table>
<thead>
<tr>
<th>1234</th>
<th><code># vi /etc/security/limits.conf #加入以下配置，*代表所有用户，也可以指定用户，重启系统生效``* soft nofile 65535``* hard nofile 65535``# ulimit -SHn 65535  #立刻生效</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<h6 id="3-3-硬件配置"><a href="#3-3-硬件配置" class="headerlink" title="3.3 硬件配置"></a><strong>3.3 硬件配置</strong></h6><p> 加大物理内存，提高文件系统性能。linux内核会从内存中分配出缓存区（系统缓存和数据缓存）来存放热数据，通过文件系统延迟写入机制，等满足条件时（如缓存区大小到达一定百分比或者执行sync命令）才会同步到磁盘。也就是说物理内存越大，分配缓存区越大，缓存数据越多。当然，服务器故障会丢失一定的缓存数据。</p>
<p> SSD硬盘代替SAS硬盘，将RAID级别调整为RAID1+0，相对于RAID1和RAID5有更好的读写性能（IOPS），毕竟数据库的压力主要来自磁盘I/O方面。</p>
<h5 id="4、数据库架构扩展"><a href="#4、数据库架构扩展" class="headerlink" title="4、数据库架构扩展"></a><strong>4、数据库架构扩展</strong></h5><p> 随着业务量越来越大，单台数据库服务器性能已无法满足业务需求，该考虑加机器了，该做集群了~~~。主要思想是分解单台数据库负载，突破磁盘I/O性能，热数据存放缓存中，降低磁盘I/O访问频率。</p>
<h6 id="4-1-主从复制与读写分离"><a href="#4-1-主从复制与读写分离" class="headerlink" title="4.1 主从复制与读写分离"></a><strong>4.1 主从复制与读写分离</strong></h6><p> 因为生产环境中，数据库大多都是读操作，所以部署一主多从架构，主数据库负责写操作，并做双击热备，多台从数据库做负载均衡，负责读操作，主流的负载均衡器有LVS、HAProxy、Nginx。</p>
<p> 怎么来实现读写分离呢？大多数企业是在代码层面实现读写分离，效率比较高。另一个种方式通过代理程序实现读写分离，企业中应用较少，常见代理程序有MySQL Proxy、Amoeba。在这样数据库集群架构中，大大增加数据库高并发能力，解决单台性能瓶颈问题。如果从数据库一台从库能处理2000 QPS，那么5台就能处理1w QPS，数据库横向扩展性也很容易。</p>
<p> 有时，面对大量写操作的应用时，单台写性能达不到业务需求。如果做双主，就会遇到数据库数据不一致现象，产生这个原因是在应用程序不同的用户会有可能操作两台数据库，同时的更新操作造成两台数据库数据库数据发生冲突或者不一致。在单库时MySQL利用存储引擎机制表锁和行锁来保证数据完整性，怎样在多台主库时解决这个问题呢？有一套基于perl语言开发的主从复制管理工具，叫MySQL-MMM（Master-Master replication managerfor Mysql，Mysql主主复制管理器），这个工具最大的优点是在同一时间只提供一台数据库写操作，有效保证数据一致性。</p>
<p> 主从复制博文：<a target="_blank" rel="noopener" href="http://lizhenliang.blog.51cto.com/7876557/1290431">http://lizhenliang.blog.51cto.com/7876557/1290431</a></p>
<p> 读写分离博文：<a target="_blank" rel="noopener" href="http://lizhenliang.blog.51cto.com/7876557/1305083">http://lizhenliang.blog.51cto.com/7876557/1305083</a></p>
<p> MySQL-MMM博文：<a target="_blank" rel="noopener" href="http://lizhenliang.blog.51cto.com/7876557/1354576">http://lizhenliang.blog.51cto.com/7876557/1354576</a></p>
<h6 id="4-2-增加缓存"><a href="#4-2-增加缓存" class="headerlink" title="4.2 增加缓存"></a><strong>4.2 增加缓存</strong></h6><p> 给数据库增加缓存系统，把热数据缓存到内存中，如果缓存中有要请求的数据就不再去数据库中返回结果，提高读性能。缓存实现有本地缓存和分布式缓存，本地缓存是将数据缓存到本地服务器内存中或者文件中。分布式缓存可以缓存海量数据，扩展性好，主流的分布式缓存系统有memcached、redis，memcached性能稳定，数据缓存在内存中，速度很快，QPS可达8w左右。如果想数据持久化就选择用redis，性能不低于memcached。</p>
<p> 工作过程：</p>
<p> <img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114653.jpg" alt="wKiom1VukrqyM-JcAABPhCy-LOM409.jpg"></p>
<h6 id="4-3-分库"><a href="#4-3-分库" class="headerlink" title="4.3 分库"></a><strong>4.3 分库</strong></h6><p> 分库是根据业务不同把相关的表切分到不同的数据库中，比如web、bbs、blog等库。如果业务量很大，还可将切分后的库做主从架构，进一步避免单个库压力过大。</p>
<h6 id="4-4-分表"><a href="#4-4-分表" class="headerlink" title="4.4 分表"></a><strong>4.4 分表</strong></h6><p> 数据量的日剧增加，数据库中某个表有几百万条数据，导致查询和插入耗时太长，怎么能解决单表压力呢？你就该考虑是否把这个表拆分成多个小表，来减轻单个表的压力，提高处理效率，此方式称为分表。</p>
<p> 分表技术比较麻烦，要修改程序代码里的SQL语句，还要手动去创建其他表，也可以用merge存储引擎实现分表，相对简单许多。分表后，程序是对一个总表进行操作，这个总表不存放数据，只有一些分表的关系，以及更新数据的方式，总表会根据不同的查询，将压力分到不同的小表上，因此提高并发能力和磁盘I/O性能。</p>
<p> 分表分为垂直拆分和水平拆分：</p>
<p> 垂直拆分：把原来的一个很多字段的表拆分多个表，解决表的宽度问题。你可以把不常用的字段单独放到一个表中，也可以把大字段独立放一个表中，或者把关联密切的字段放一个表中。</p>
<p> 水平拆分：把原来一个表拆分成多个表，每个表的结构都一样，解决单表数据量大的问题。</p>
<h6 id="4-5-分区"><a href="#4-5-分区" class="headerlink" title="4.5 分区"></a><strong>4.5 分区</strong></h6><p> 分区就是把一张表的数据根据表结构中的字段（如range、list、hash等）分成多个区块，这些区块可以在一个磁盘上，也可以在不同的磁盘上，分区后，表面上还是一张表，但数据散列在多个位置，这样一来，多块硬盘同时处理不同的请求，从而提高磁盘I/O读写性能，实现比较简单。</p>
<p>注：增加缓存、分库、分表和分区主要由程序猿来实现。</p>
<h5 id="5、数据库维护"><a href="#5、数据库维护" class="headerlink" title="5、数据库维护"></a><strong>5、数据库维护</strong></h5><p> 数据库维护是运维工程师或者DBA主要工作，包括性能监控、性能分析、性能调优、数据库备份和恢复等。</p>
<h6 id="5-1-性能状态关键指标"><a href="#5-1-性能状态关键指标" class="headerlink" title="5.1 性能状态关键指标"></a><strong>5.1 性能状态关键指标</strong></h6><p> QPS，Queries Per Second：每秒查询数，一台数据库每秒能够处理的查询次数</p>
<p> TPS，Transactions Per Second：每秒处理事务数</p>
<p> 通过show status查看运行状态，会有300多条状态信息记录，其中有几个值帮可以我们计算出QPS和TPS，如下：</p>
<p> Uptime：服务器已经运行的实际，单位秒</p>
<p> Questions：已经发送给数据库查询数</p>
<p> Com_select：查询次数，实际操作数据库的</p>
<p> Com_insert：插入次数</p>
<p> Com_delete：删除次数</p>
<p> Com_update：更新次数</p>
<p> Com_commit：事务次数</p>
<p> Com_rollback：回滚次数</p>
<p> 那么，计算方法来了，基于Questions计算出QPS：</p>
<table>
<thead>
<tr>
<th>12</th>
<th><code> ``mysql&gt; show global status like ``&#39;Questions&#39;``;`` ``mysql&gt; show global status like ``&#39;Uptime&#39;``;</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> QPS = Questions / Uptime</p>
<p> 基于Com_commit和Com_rollback计算出TPS：</p>
<table>
<thead>
<tr>
<th>123</th>
<th><code> ``mysql&gt; show global status like ``&#39;Com_commit&#39;``;`` ``mysql&gt; show global status like ``&#39;Com_rollback&#39;``;`` ``mysql&gt; show global status like ``&#39;Uptime&#39;``;</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> TPS = (Com_commit + Com_rollback) / Uptime</p>
<p> 另一计算方式：基于Com_select、Com_insert、Com_delete、Com_update计算出QPS</p>
<table>
<thead>
<tr>
<th>1</th>
<th><code> ``mysql&gt; show global status where Variable_name ``in``(``&#39;com_select&#39;``,``&#39;com_insert&#39;``,``&#39;com_delete&#39;``,``&#39;com_update&#39;``);</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> 等待1秒再执行，获取间隔差值，第二次每个变量值减去第一次对应的变量值，就是QPS</p>
<p> TPS计算方法：</p>
<table>
<thead>
<tr>
<th>1</th>
<th><code> ``mysql&gt; show global status where Variable_name ``in``(``&#39;com_insert&#39;``,``&#39;com_delete&#39;``,``&#39;com_update&#39;``);</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> 计算TPS，就不算查询操作了，计算出插入、删除、更新四个值即可。</p>
<p> 经网友对这两个计算方式的测试得出，当数据库中myisam表比较多时，使用Questions计算比较准确。当数据库中innodb表比较多时，则以Com_*计算比较准确。</p>
<h6 id="5-2-开启慢查询日志"><a href="#5-2-开启慢查询日志" class="headerlink" title="5.2 开启慢查询日志"></a><strong>5.2 开启慢查询日志</strong></h6><p> MySQL开启慢查询日志，分析出哪条SQL语句比较慢，使用set设置变量，重启服务失效，可以在my.cnf添加参数永久生效。</p>
<table>
<thead>
<tr>
<th>1234</th>
<th><code>mysql&gt; ``set</code> <code>global slow-query-log=on ``#开启慢查询功能``mysql&gt; ``set</code> <code>global slow_query_log_file=``&#39;/var/log/mysql/mysql-slow.log&#39;``; ``#指定慢查询日志文件位置``mysql&gt; ``set</code> <code>global log_queries_not_using_indexes=on;  ``#记录没有使用索引的查询``mysql&gt; ``set</code> <code>global long_query_time=1;  ``#只记录处理时间1s以上的慢查询</code></th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p> 分析慢查询日志，可以使用MySQL自带的mysqldumpslow工具，分析的日志较为简单。</p>
<p> # mysqldumpslow -t 3 /var/log/mysql/mysql-slow.log   #查看最慢的前三个查询</p>
<p> 也可以使用percona公司的pt-query-digest工具，日志分析功能全面，可分析slow log、binlog、general log。</p>
<p> 分析慢查询日志：pt-query-digest /var/log/mysql/mysql-slow.log</p>
<p> 分析binlog日志：mysqlbinlog mysql-bin.000001 &gt;mysql-bin.000001.sql </p>
<p> pt-query-digest –type=binlog mysql-bin.000001.sql </p>
<p> 分析普通日志：pt-query-digest –type=genlog localhost.log</p>
<h6 id="5-3-数据库备份"><a href="#5-3-数据库备份" class="headerlink" title="5.3 数据库备份"></a><strong>5.3 数据库备份</strong></h6><p> 备份数据库是最基本的工作，也是最重要的，否则后果很严重，你懂得！但由于数据库比较大，上百G，往往备份都很耗费时间，所以就该选择一个效率高的备份策略，对于数据量大的数据库，一般都采用增量备份。常用的备份工具有mysqldump、mysqlhotcopy、xtrabackup等，mysqldump比较适用于小的数据库，因为是逻辑备份，所以备份和恢复耗时都比较长。mysqlhotcopy和xtrabackup是物理备份，备份和恢复速度快，不影响数据库服务情况下进行热拷贝，建议使用xtrabackup，支持增量备份。</p>
<p> Xtrabackup备份工具使用博文：<a target="_blank" rel="noopener" href="http://lizhenliang.blog.51cto.com/7876557/1612800">http://lizhenliang.blog.51cto.com/7876557/1612800</a></p>
<h6 id="5-4-数据库修复"><a href="#5-4-数据库修复" class="headerlink" title="5.4 数据库修复"></a><strong>5.4 数据库修复</strong></h6><p> 有时候MySQL服务器突然断电、异常关闭，会导致表损坏，无法读取表数据。这时就可以用到MySQL自带的两个工具进行修复，myisamchk和mysqlcheck。</p>
<p> myisamchk：只能修复myisam表，需要停止数据库</p>
<p> 常用参数：</p>
<p> -f –force   强制修复，覆盖老的临时文件，一般不使用</p>
<p> -r –recover  恢复模式</p>
<p> -q –quik   快速恢复</p>
<p> -a –analyze  分析表</p>
<p> -o –safe-recover 老的恢复模式，如果-r无法修复，可以使用此参数试试</p>
<p> -F –fast   只检查没有正常关闭的表</p>
<p> 快速修复weibo数据库:</p>
<p> # cd /var/lib/mysql/weibo </p>
<p> # myisamchk -r -q *.MYI</p>
<p> mysqlcheck：myisam和innodb表都可以用，不需要停止数据库，如修复单个表，可在数据库后面添加表名，以空格分割</p>
<p> 常用参数：</p>
<p> -a  –all-databases  检查所有的库</p>
<p> -r  –repair  修复表</p>
<p> -c  –check   检查表，默认选项</p>
<p> -a  –analyze  分析表</p>
<p> -o  –optimize 优化表</p>
<p> -q  –quik  最快检查或修复表</p>
<p> -F  –fast  只检查没有正常关闭的表</p>
<p> 快速修复weibo数据库:</p>
<p> mysqlcheck -r -q -uroot -p123 weibo </p>
<h6 id="5-5-另外，查看CPU和I-O性能方法"><a href="#5-5-另外，查看CPU和I-O性能方法" class="headerlink" title="5.5 另外，查看CPU和I/O性能方法"></a>5.5 另外，查看CPU和I/O性能方法</h6><p> #查看CPU性能</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114744.jpg" alt="wKiom1VtPFmCEtY9AADbdiZbn9A400.jpg"></p>
<p> #参数-P是显示CPU数，ALL为所有，也可以只显示第几颗CPU<img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114751.jpg" alt="wKioL1VtPpayB7WeAALQHX41buc367.jpg"></p>
<p> #查看I/O性能</p>
<p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114807.jpg" alt="wKiom1VtPSXTsI4zAAMkfVf2r-I743.jpg"></p>
<p> #参数-m是以M单位显示，默认K</p>
<p> #%util：当达到100%时，说明I/O很忙。</p>
<p> #await：请求在队列中等待时间，直接影响read时间。</p>
<p> I/O极限：IOPS（r/s+w/s）,一般RAID0/10在1200左右。（IOPS，每秒进行读写（I/O）操作次数）</p>
<p> I/O带宽：在顺序读写模式下SAS硬盘理论值在300M/s左右，SSD硬盘理论值在600M/s左右。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/MySql/MySql%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BC%98%E5%8C%96/" data-id="ckk2gq3ui001qz8pqak4j24gt" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-MySql/MySql操作和命令" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/MySql/MySql%E6%93%8D%E4%BD%9C%E5%92%8C%E5%91%BD%E4%BB%A4/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.523Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>连接数据库 -h 接数据库名</p>
<ul>
<li><p>mysql -h localhost -u root -p</p>
</li>
<li><p>创建数据库</p>
<ul>
<li>create database 数据库名;</li>
<li>create database 数据库名 character set gbk/utf-8;</li>
<li>db.opt文件显示编码</li>
</ul>
</li>
<li><p>查看数据库</p>
<ul>
<li>show databases;</li>
</ul>
</li>
<li><p>查看数据库(可查看编码)</p>
<ul>
<li>show create database web08;</li>
</ul>
</li>
<li><p>删除数据库</p>
<ul>
<li>drop dababase 数据库名;</li>
</ul>
</li>
<li><p>切换数据库</p>
<ul>
<li>user 数据库名;</li>
</ul>
</li>
<li><p>查看正在使用的数据库</p>
<ul>
<li>select database();</li>
</ul>
</li>
<li><p>创建表</p>
<ul>
<li><p>​    create table 表名(  </p>
<p>​        字段名 类型（长度） [约束],  </p>
<p>​        字段名 类型（长度） [约束]</p>
<p>​    );</p>
</li>
<li><p>​    字符类型：varchar(n)</p>
</li>
<li><p>​    单表约束:</p>
</li>
<li><p>主键约束:primary key，要求被修饰的字段唯一和非空     </p>
</li>
<li><p>唯一约束:unique,要求被修饰的字段唯一     </p>
</li>
<li><p>非空约束:not null,要求被修饰的字段非空查看表show tables;</p>
</li>
</ul>
</li>
<li><p>查看表结构</p>
<ul>
<li>desc 表名;</li>
<li>– show OPEN TABLES where In_use &gt; 0;   –查询mysql锁情况<br>– show processlist;   –查看正在运行sql</li>
</ul>
</li>
<li><p>删除表</p>
<ul>
<li>drop table 表名;</li>
</ul>
</li>
<li><p>修改表</p>
<ul>
<li>alter table 表名 add 字段名 类型(长度) [约束];</li>
<li>alter table 名表 modify 要修改的字段名 类型(长度) [约束];</li>
<li>alter table 表名 change 旧列名 新列名 类型(长度) [约束];</li>
<li>alter table 表名 drop 列名;</li>
<li>alter table 名 add index 索引名(字段名，字段名) ;</li>
</ul>
</li>
<li><p>修改表名</p>
<ul>
<li>rename table 表名 to 新表名;</li>
</ul>
</li>
<li><p>修改表的字符集</p>
<ul>
<li>alter table 表名 character set 编码;</li>
</ul>
</li>
<li><p>查看当前表的编码</p>
<ul>
<li>show create table 表名;</li>
</ul>
</li>
<li><p>开启事务</p>
<ul>
<li>start transaction;</li>
</ul>
</li>
<li><p>插入记录</p>
<ul>
<li>insert into 表名(列名1,列名2,列名3…) values(值1,值2,值3…);</li>
<li>insert into 表名(值1,值2,值3);</li>
<li>插入中文乱码问题解决方法  <ol>
<li>可以直接修改数据库安装目录my.ini第57行数据库客户端编码 </li>
<li>set names 编码</li>
</ol>
</li>
</ul>
</li>
<li><p>修改表记录</p>
<ul>
<li>update 表名 set 字段名 = 值,字段名 = 值 where 条件字段 = 字段值 and 条件字段 = 字段值;</li>
</ul>
</li>
<li><p>删除记录</p>
<ul>
<li>delete from 表名 where 字段名 = 值;</li>
<li>全表数据删除delete from和truncate table区别</li>
<li>delete逐条删除记录，配合事务可以将删除的记录找回,自增不重置</li>
<li>truncate直接将表销毁再重建一张一样的表，删除的数据无法找回,自增重置</li>
</ul>
</li>
<li><p>查询</p>
<ul>
<li>select 列名1，列名2 from 表名 where 字段名 = 值;</li>
</ul>
</li>
<li><p>排序查询</p>
<ul>
<li>select …order by 字段1 desc/asc,字段2 desc/asc;</li>
</ul>
</li>
<li><p>聚合查询,聚合函数不统计null</p>
<ul>
<li>select sum(字段) from 表名 条件;</li>
<li>select avg(字段) from 表名 条件;</li>
<li>select count(字段) from 表名 条件;</li>
</ul>
</li>
<li><p>分组查询</p>
<ul>
<li>select 字段 from 表名 group by 分类id;</li>
<li>select 字段 from 表名 group by 分类id having 分组条件;</li>
</ul>
</li>
<li><p>分页查询limit关键字</p>
<ul>
<li>select * from 表名 limit 起始位置（页数-1 * 每页显示数目）,每页显示数目;</li>
</ul>
</li>
<li><p>多表查询</p>
<ul>
<li>交叉连接:select * from 表A,表B;</li>
<li>显示内连接:select * from 表A inner join 表B on 表A字段 = 表B字段;</li>
<li>隐式内连接:select * from 表A c,product p where c.cid = p.category_id;</li>
<li>左外连接:select * from 表A left join 表B on 表A字段 = 表B字段;</li>
<li>右外连接:select * from 表A right join 表B on 表A字段 = 表B字段;</li>
</ul>
</li>
<li><p>子查询</p>
<ul>
<li>select * from 表A where 字段=(select 字段 from 表B where 条件);</li>
</ul>
</li>
<li><p>外键约束,可保证数据的完整性</p>
<ul>
<li><p>添加外键约束：alter table 从表 add [constraint][外键名称] foreign key(从表外键字段名) references 主表(主表的主键);</p>
</li>
<li><p>删除外键：alter table 从表 drop foreign key 外键名称;</p>
</li>
<li><p>多对多：alter table 从表(stu_course) add foreign key(sno) references stu(id);    </p>
<ul>
<li>alter table 从表(stu_course) add foreign key(cno) references course(id);</li>
</ul>
</li>
<li><p>一对一：</p>
<p>1、从表的外键唯一约束和主表的主键建立    </p>
<p>2、主键对主键建立</p>
</li>
</ul>
</li>
<li><p>mysql查看默认隔离级别：</p>
<ul>
<li>select @@tx_isolation;</li>
</ul>
</li>
<li><p>事务隔离级别</p>
<ul>
<li>read uncommitted:读取尚未提交的数据：哪个问题都不能解决</li>
<li>read committed:读取已提交数据：可以解决脏读–oracle默认</li>
<li>repeatable read:重复读：可以解决脏读和不可重复读–mysql默认</li>
<li>serializable:串行化：可以解决脏读、不可重复读和虚读–相当于锁表</li>
</ul>
</li>
<li><p>设置隔离级别：</p>
<ul>
<li>set session transaction isolation level + 隔离级别</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/MySql/MySql%E6%93%8D%E4%BD%9C%E5%92%8C%E5%91%BD%E4%BB%A4/" data-id="ckk2gq3t9000cz8pq5lt7evg1" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Maven/Maven" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Maven/Maven/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.513Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="一、Maven的介绍"><a href="#一、Maven的介绍" class="headerlink" title="一、Maven的介绍"></a>一、Maven的介绍</h4><h5 id="1-开发中存在的问题-why"><a href="#1-开发中存在的问题-why" class="headerlink" title="1.开发中存在的问题[why]"></a>1.开发中存在的问题[why]</h5><p>①一个项目就是一个工程        </p>
<p>​    如果一个项目非常庞大，就不适合继续用package来划分模块，最好是每个模块对应一个工程，利于分工协作。       </p>
<p>​    借助于Maven就可以将一个项目拆分成多个工程</p>
<p>②项目中需要的jar包必须手动复制到WEB-INF/lib目录下        </p>
<p>​    带来的问题：同样的jar包重复的出现在不同的项目工程中，一方面浪费存储空间，另外也让工程比较臃肿。        </p>
<p>​    借助Maven，可以将jar包仅仅保存在“仓库”中，有需要使用的工程“引用”这个文件接口，并不需要真的把jar包复制过来</p>
<p>③jar包需要别人替我们准备好，或到官网下载        </p>
<p>​    不同技术的官网提供jar包下载的形式是五花八门的。        </p>
<p>​    有些技术的官网就是通过Maven或者SVN等专门的工具提供下载的。            </p>
<p>​    如果是以非正规的方式下载的jar包，那么其中的内容很可能也是不规范的。             </p>
<p>​    借助于Maven可以以一种规范的方式下载jar包，因为所有知名的框架或者第三方工具的jar包已经按照统一的规范存放在Maven的中央仓库中             </p>
<p>​    Tips:“统一的规范”非常重要</p>
<p>④一个jar依赖的其他jar包需要自己手动添加到项目中       </p>
<p>​    FileUpload组件–&gt;IO组件。       </p>
<p>​    如果所有jar包之间的依赖关系都需要程序员自己非常清楚的了解。那么会极大的增加学习成本<br>​           Maven会自动将依赖的jar包导入进来。</p>
<h5 id="2-Maven是什么-what"><a href="#2-Maven是什么-what" class="headerlink" title="2.Maven是什么[what]"></a>2.Maven是什么[what]</h5><p>①Maven是一款服务于java平台的自动化构建工具       </p>
<p>​    Make–&gt;Ant–&gt;Maven–&gt;Gradle     </p>
<p>②构建       </p>
<p>​    [1]概念：以“java源文件”、“框架配置文件”、“JSP”、“HTML”、“图片”等资源为原材料，去“生产”一个可以运行的项目的过程。         </p>
<p>​        编译         测试         运行        打包        部署</p>
<p>​    [2]编译：java源文件–&gt;编译–&gt;class字节码文件–&gt;交给虚拟机JVM去运行       </p>
<p>​    [3]部署:一个BS项目最终运行的并不是一个动态web工程本身，而是这个动态web工程“编译的结果”                        Tips:运行时环境，其实是一组jar包的引用，并没有把jar包本身复制到工程中，所以并不是目录</p>
<h5 id="3-Maven的结构"><a href="#3-Maven的结构" class="headerlink" title="3.Maven的结构"></a>3.Maven的结构</h5><p>bin目录：Maven命令目录，mvn命令用于构建项目   </p>
<p>boot目录：Maven自身运行需要的类加载器   </p>
<p>conf目录：Maven的配置文件目录，其中settings.xml主要配置文件   </p>
<p>lib目录：Maven自身运行需要的jar包</p>
<h5 id="4-Maven环境变量的配置"><a href="#4-Maven环境变量的配置" class="headerlink" title="4.Maven环境变量的配置"></a>4.Maven环境变量的配置</h5><p>（1）高级环境变量中新增   </p>
<p>​    ①MAVEN_HOME变量，值为Maven安装目录的路径   </p>
<p>​    ②Path环境变量中添加，%MAVEN_HOME%\bin   </p>
<p>​    ③Maven环境依赖于JAVA_HOME，确认已经存在JAVA_HOME环境变量   </p>
<p>​    ④验证Maven环境配置是否成功     </p>
<p>（2）环境变量配置方法2—未试验  </p>
<p>​    ①M2_HOME变量，值为Maven安装目录的路径   </p>
<p>​    ②Path环境变量中添加，%M2_HOME%\bin</p>
<p>5.Maven仓库的种类和各种仓库的关系   </p>
<p>​    conf目录-&gt;settings.xml中, 可以设置本地仓库路径</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>C:/apache-maven-3.6.3/repository<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>​    设置中央仓库为aliyun，速度快很多 </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mirror</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>   </span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/repositories/central/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>①本地仓库：${user.home}/.m2/repository默认作为本地仓库的位置   </p>
<p>② 远程仓库：公司内部使用的吃馕库，又叫私服，远程仓库的jar可以从中央仓库下载jar包，也可以从本地仓库上传  </p>
<p>③镜像：中央仓库的备份，在各地都有镜像，如阿里云镜像  </p>
<p>④中央仓库：如果联网的话Maven会自动前往中央仓库下载jar包，中央仓库几乎放置了所有开源的jar包  </p>
<p>​    Maven默认找jar包顺序：本地仓库-&gt;远程仓库-&gt;镜像-&gt;中央仓库</p>
<h5 id="5-Maven标准目录结构"><a href="#5-Maven标准目录结构" class="headerlink" title="5.Maven标准目录结构"></a>5.Maven标准目录结构</h5><p>src/main/java   核心代码目录   </p>
<p>src/main/resources  配置文件目录   </p>
<p>src/test/java  测试代码目录 </p>
<p>src/test/resources  测试配置文件目录  </p>
<p>src/main/webapp  页面资源，包含js,css,图片等</p>
<h5 id="6-Maven常用命令"><a href="#6-Maven常用命令" class="headerlink" title="6.Maven常用命令"></a>6.Maven常用命令</h5><p>mvn clean  把编译好的项目删掉  </p>
<p>mvn compile  把src/main目录下的代码编译放置到target下 </p>
<p>mvn test  将测试代码和正式代码都编译到target下  </p>
<p>mvn package  将项目编译并打包，pom.xml中可以配置打包类型  </p>
<p>mvn install  将项目编译打包，并将包部署本地仓库中  </p>
<p>mvn deploy  将项目编译、测试、打包，并部署到本地仓库和远程私服仓库中，并部署到web容器中</p>
<h4 id="二、Maven的生命周期"><a href="#二、Maven的生命周期" class="headerlink" title="二、Maven的生命周期"></a>二、Maven的生命周期</h4><p>生命周期：</p>
<p>maven构建项目的过程清除编译信息     编译            测试    打包           安装       发布</p>
<p>​            clean                                           compile    test     package    install     deploy</p>
<p>默认生命周期：编译-&gt;测试-&gt;打包-&gt;安装-&gt;发布</p>
<p>清理生命周期：cean</p>
<p>站点生命周期：</p>
<p>​    1）单元测试：用的时junit，是一个专门的测试类工具,     </p>
<p>​        junit的测试内容：测试的是类中的方法，每个方法都独立测试                   </p>
<p>​                                        方法是测试的基本单元  maven借助单元测试，批量测试你的类中方法是否符合预期</p>
<p>​    2）使用步骤：  </p>
<p>​        ①加入单元测试依赖           </p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>              </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>                </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>                            </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>                         </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br></pre></td></tr></table></figure>
<p>​        ②在src/test/java目录下创建测试程序     </p>
<p>​            推荐创建类和方法:  </p>
<p>​            1、测试类的名称，Test+测试的类名     </p>
<p>​            2、测试方法名称，test+方法名称，其中测试方法的定义规则         </p>
<p>​                1&gt;方法必须是public           </p>
<p>​                2&gt;方法必须没有返回值         </p>
<p>​                3&gt;方法名称推荐是自定义的         </p>
<p>​                4&gt;方法上加注解@Test</p>
<p>​    3）测试会生成surfire-reports文件，保存测试结果 </p>
<h4 id="三、Maven的概念模型图"><a href="#三、Maven的概念模型图" class="headerlink" title="三、Maven的概念模型图"></a>三、Maven的概念模型图</h4><h5 id="1-POM对象模型："><a href="#1-POM对象模型：" class="headerlink" title="1.POM对象模型："></a>1.POM对象模型：</h5><p>pom.xml文件，maven把一个项目当作一个模型，控制maven构建项目的过程，管理jar依赖</p>
<p>三类信息：    </p>
<p>​    ①项目自身信息    </p>
<p>​    ②dependencies标签下项目运行依赖的jar包信息    </p>
<p>​    ③build标签是运行环境信息,如jdk，tomcat              </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javex.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    公司组织名称       </span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>               项目名       </span><br><span class="line"><span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>                  版本号       </span><br><span class="line"><span class="tag">&lt;<span class="name">packageing</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packageing</span>&gt;</span>            打包文件类型，可以不写，默认jar    </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>	#设置属性    </span><br><span class="line">          </span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span>    构建项目时的配置信息，例如指定编译java代码时使用的jdk            </span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span>                    </span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span>        </span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            &lt;artifactId<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span> </span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>                          </span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span>                            </span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span>                            </span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span>                        </span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span>                    </span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span>                </span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span>            </span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-依赖管理模型（dependency）"><a href="#2-依赖管理模型（dependency）" class="headerlink" title="2.依赖管理模型（dependency）"></a>2.依赖管理模型（dependency）</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javex.servlet.jsp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>    公司组织名称        </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>                            项目名        </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span>                            版本号    </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>以上两点注意是依赖管理</p>
<h5 id="3-Maven的默认生命周期"><a href="#3-Maven的默认生命周期" class="headerlink" title="3.Maven的默认生命周期"></a>3.Maven的默认生命周期</h5><p>​    每一个构建项目的命令都对应了Maven底层一个插件   </p>
<p>​    compile      test        package      install        deploy</p>
<p>​    这涉及到Maven的一键构建</p>
<h4 id="四、IDEA继承Maven"><a href="#四、IDEA继承Maven" class="headerlink" title="四、IDEA继承Maven"></a>四、IDEA继承Maven</h4><p>在idea的settings-&gt;Build,Execution,Deployment-&gt;Build Tools-&gt;Maven中配置Maven，</p>
<p>也可以使用默认settings-&gt;Build,Execution,Deployment-&gt;Build Tools-&gt;Maven-&gt;VM Options中配置-DarchetypeCatalog=internal可以不联网创建工程</p>
<h4 id="五、创建Maven工程"><a href="#五、创建Maven工程" class="headerlink" title="五、创建Maven工程"></a>五、创建Maven工程</h4><p>①使用骨架创建Maven项目，   选中Create from archetype，选择quickstart骨架</p>
<p>②不使用骨架创建Maven项目  不选中Create from archetype</p>
<p>③创建Maven的web工程   选中Create from archetype，选择maven-webapp骨架</p>
<p>④导入Maven工程  project Structure-&gt;Modules-&gt;+号Import Module-&gt;选择项目文件夹-&gt;Import module from external model-&gt;Maven-&gt;finish-&gt;Dependencies-&gt;选择jdk</p>
<h4 id="六、Maven的依赖范围"><a href="#六、Maven的依赖范围" class="headerlink" title="六、Maven的依赖范围"></a>六、Maven的依赖范围</h4><p><strong>依赖范围使用scope表示</strong>    </p>
<p>scope的值有complie、test、provided，默认值为compile    </p>
<p>scope：表示依赖的使用范围，也就是在maven构建项目的哪些阶段起作用        </p>
<p>maven构建项目：编译，测试，打包，安装，部署                </p>
<p>如junit只在测试阶段起作用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span>        </span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span>        </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>  provided编译测试时使用，打包、安装、部署时不需要，如servlet的jar在tomcat有，不需要提供jar包</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.servlet-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="七、Maven的常用操作"><a href="#七、Maven的常用操作" class="headerlink" title="七、Maven的常用操作"></a>七、Maven的常用操作</h4><h5 id="1-Maven的属性设置"><a href="#1-Maven的属性设置" class="headerlink" title="1.Maven的属性设置"></a>1.Maven的属性设置</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span>    </span><br><span class="line">    <span class="comment">&lt;!-- Maven构建项目使用编码，避免中文乱码--&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span>    </span><br><span class="line">    <span class="comment">&lt;!-- 编译代码使用的jdk版本--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span>    </span><br><span class="line">    <span class="comment">&lt;!-- 运行程序使用的jdk版本--&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h5 id="2-Maven的全局变量"><a href="#2-Maven的全局变量" class="headerlink" title="2.Maven的全局变量"></a>2.Maven的全局变量</h5><p>自定义属性：        </p>
<p>​    1、在<properties>中通过自定义标签声明变量（标签名就是变量名）        </p>
<p>​    2、在pom.xml文件的其他位置，使用${标签名}使用变量的值            </p>
<p>自定义全局的变量一般是定义依赖的版本号，当你的项目中要使用多个相同的版本号    </p>
<p>先使用全局变量定义，再使用${变量名}    </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 自定义变量，表示版本号--&gt;</span><span class="tag">&lt;<span class="name">spring.version</span>&gt;</span>5.2.0<span class="tag">&lt;/<span class="name">spring.version</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">dependency</span>&gt;</span><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>


<h5 id="3-资源插件"><a href="#3-资源插件" class="headerlink" title="3.资源插件"></a>3.资源插件</h5><p><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114614.png" alt="Image"></p>
<p>作用：mybatis课程中会用到这个作用</p>
<p>​    1.默认没有使用resources的使用，maven执行编译代码时，会把src/main/resource目录中的文件拷贝到target/classes目录中，对于src/main/java目录下的非java文件不处理，不拷贝到classes中</p>
<p>​    2.我们的程序有需要把一些文件放到src/main/java目录中，当执行时需要用到src/main/java目录中的文件需要告诉maven 再mvn compile src/main/java目录下程序时，需要把文件放到target/classes目录中此时需要在<build>中加入<resources></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">directory</span>&gt;</span>src/main/java<span class="tag">&lt;/<span class="name">directory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--所在的目录--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">includes</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--包括目录下的properties、xml文件会被扫描--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">include</span>&gt;</span>/*.properties<span class="tag">&lt;/<span class="name">include</span>&gt;</span> </span><br><span class="line">        	<span class="tag">&lt;<span class="name">include</span>&gt;</span>/.xml<span class="tag">&lt;/<span class="name">include</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">includes</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--filtering选项false不启用过滤器，.properties已经起到过滤作用--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filtering</span>&gt;</span>false<span class="tag">&lt;/<span class="name">filtering</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Maven/Maven/" data-id="ckk2gq3t9000bz8pq9j9c9g7k" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Linux/Linux设置命令提示符" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Linux/Linux%E8%AE%BE%E7%BD%AE%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.501Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>centos特有的/etc/bashrc可以修改全局PS1</p>
<p>只修改当前用户可修改  .bashrc文件</p>
<p>PS1变量中提示符各项含义:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">\d ：代表日期，格式为weekday month date，例如：Wed Dec 12</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\H ：完整的主机名称。例如：hostname是debian.linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\h ：仅取主机的第一个名字，如上例，则为debian，.linux则被省略</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\t ：显示时间为24小时格式，如：HH：MM：SS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\T ：显示时间为12小时格式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\A ：显示时间为24小时格式：HH：MM</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\u ：当前用户的账号名称 如：root</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\v ：BASH的版本信息  如:3.2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\w ：完整的工作目录名称。家目录会以 ~代替 如显示&#x2F;etc&#x2F;default&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\W ：利用basename取得工作目录名称，所以只会列出最后一个目录 如上例则只显示default</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\# ：下达的第几个命令  www.2cto.com  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">\$ ：提示字符，如果是root时，提示符为：# ，普通用户则为：$</span><br><span class="line"></span><br><span class="line">&#96;pwd&#96; 可以设置变量，如当前路径</span><br></pre></td></tr></table></figure>
<p>操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ vi ~&#x2F;.bash_profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 或者下边这个</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ vi ~&#x2F;.bashrc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加下边这行代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">PS1&#x3D;&#39;[\u@\h \d \A \W]\$ &#39;</span><br></pre></td></tr></table></figure>
<p>保存后，重新读取配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ source ~&#x2F;.bash_profile</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 或者下边这个</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Linux/Linux%E8%AE%BE%E7%BD%AE%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6/" data-id="ckk2gq3tc000gz8pqbjjq87va" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Linux/Linux" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Linux/Linux/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.500Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><p>/etc/resolv.conf 配置文件配置dns映射</p>
</li>
<li><p>重启linux网卡命令：service network restart</p>
</li>
<li><p>查看linux的ip地址:ip addr</p>
</li>
<li><p>win10启动wsl2使用linux环境：</p>
<p>​    1）以管理员身份打开PowerShell并运行：</p>
<p>​         Enable-WindowsOptionalFeature -Online -FeatureName VirtualMachinePlatform</p>
<p>​        重新启动计算机以完成WSL安装并更新到WSL 2。</p>
<p>​    2)以管理员权限启动 PowerShell，然后输入以下命令启用 Linux 子系统功能：</p>
<p>​        Enable-WindowsOptionalFeature -Online -FeatureName Microsoft-Windows-Subsystem-Linux</p>
<p>​    3)微软商店中搜索linux，选择一个你喜欢的版本下载即可。如果你不知道选择哪个版本，那么下载ubuntu还需要运行一次已安装的 Linux 发行版以执行真正的安装操作</p>
<p>​    4）将WSL 2设置为默认版本</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ wsl -l    <span class="meta">## 查看子系统名称</span></span><br><span class="line">   $ wsl --<span class="keyword">set</span>-version Ubuntu <span class="number">2</span>   <span class="meta">## 设置一个 Linux 发行版的 WSL 版本</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>​        wsl –set-default-version 2安装linux发行版</p>
<p>​        微软商店中搜索linux，选择一个你喜欢的版本下载即可。如果你不知道选择哪个版本，那么下载ubuntu即可</p>
<p>​    </p>
<p>   ​    3）检查是否成功</p>
<p>   ​        wsl –list –verbose显示这个图片则表示你已经成功了。</p>
<p>   ​    4）使用terminal进入wsl2系统</p>
<p>   ​        打开微软商店，下载terminal软件。 然后打开terminal软件，右上角有一个下拉，找到ubuntu就可以直接进入了。</p>
<p>   ​        </p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Linux/Linux/" data-id="ckk2gq3tb000fz8pqejn2afup" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Linux/Centos8.0安装mysql" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Linux/Centos8.0%E5%AE%89%E8%A3%85mysql/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.498Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="安装MySQL8-0"><a href="#安装MySQL8-0" class="headerlink" title="安装MySQL8.0"></a>安装MySQL8.0</h4><p>使用最新的包管理器安装MySQL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dnf install @mysql</span><br></pre></td></tr></table></figure>
<h4 id="开启启动"><a href="#开启启动" class="headerlink" title="开启启动"></a>开启启动</h4><p>安装完成后，运行以下命令来启动MySQL服务并使它在启动时自动启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable --now mysqld</span><br></pre></td></tr></table></figure>
<p>要检查MySQL服务器是否正在运行，请输入：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl status mysqld</span><br></pre></td></tr></table></figure>
<h4 id="添加密码及安全设置"><a href="#添加密码及安全设置" class="headerlink" title="添加密码及安全设置"></a>添加密码及安全设置</h4><p>运行mysql_secure_installation脚本，该脚本执行一些与安全性相关的操作并设置MySQL根密码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql_secure_installation</span><br></pre></td></tr></table></figure>
<p>步骤如下：</p>
<ol>
<li>要求你配置VALIDATE PASSWORD component（验证密码组件）： 输入y ，回车进入该配置<ul>
<li>选择密码验证策略等级， 我这里选择0 （low），回车</li>
<li>输入新密码两次</li>
<li>确认是否继续使用提供的密码？输入y ，回车</li>
<li>移除匿名用户？ 输入y ，回车</li>
<li>不允许root远程登陆？ 我这里需要远程登陆，所以输入n ，回车<br><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114424.png" alt="img"></li>
</ul>
</li>
<li>移除test数据库？ 输入y ，回车</li>
<li>重新载入权限表？ 输入y ，回车<br><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114458.png" alt="img"></li>
</ol>
<h4 id="配置远程登陆"><a href="#配置远程登陆" class="headerlink" title="配置远程登陆"></a>配置远程登陆</h4><p>如果需要设置root账户远程登陆，上一步骤中，<code>不允许root远程登陆？</code>这一步需要设为n。<br>接下来本机登录MySQL，将root用户的host字段设为’%’，意为接受root所有IP地址的登录请求：<br>本机登录MySQL:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p&lt;上面步骤中设置的密码&gt;</span><br></pre></td></tr></table></figure>
<p>回车后即可登录，接下来终端变成了<code>mysql&gt;</code>开头:<br><img src="https://cdn.jsdelivr.net/gh/FateCause/typoraPic/images/20210111114432.png" alt="img"></p>
<p>接着继续执行mysql语句，将将root用户的host字段设为’%’：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">update user set host&#x3D;&#39;%&#39; where user&#x3D;&#39;root&#39;;</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>
<p>设置完成后输入exit退出mysql，回到终端shell界面，接着开启系统防火墙的3306端口：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo firewall-cmd --add-port&#x3D;3306&#x2F;tcp --permanent</span><br><span class="line">sudo firewall-cmd --reload</span><br></pre></td></tr></table></figure>
<h4 id="关闭MySQL主机查询dns"><a href="#关闭MySQL主机查询dns" class="headerlink" title="关闭MySQL主机查询dns"></a>关闭MySQL主机查询dns</h4><p>MySQL会反向解析远程连接地址的dns记录，如果MySQL主机无法连接外网，则dns可能无法解析成功，导致第一次连接MySQL速度很慢，所以在配置中可以关闭该功能。<br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/liruning/p/7111015.html">参考文档</a><br>打开<code>/etc/my.cnf</code>文件，添加以下配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">skip-name-resolve</span><br></pre></td></tr></table></figure>
<h4 id="重启服务"><a href="#重启服务" class="headerlink" title="重启服务"></a>重启服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart mysqld</span><br></pre></td></tr></table></figure>
<p>本机测试安装后，MySQL8.0默认已经是utf8mb4字符集，所以字符集不再修改</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Linux/Centos8.0%E5%AE%89%E8%A3%85mysql/" data-id="ckk2gq3tb000ez8pqgpwq3ab4" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Kubernetes/k8s笔记" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Kubernetes/k8s%E7%AC%94%E8%AE%B0/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.495Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Kubernetes/k8s%E7%AC%94%E8%AE%B0/" data-id="ckk2gq3sy0001z8pq7ocwbug0" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Kafka/kafka源码" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Kafka/kafka%E6%BA%90%E7%A0%81/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.490Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="1、启动kafka"><a href="#1、启动kafka" class="headerlink" title="1、启动kafka"></a>1、启动kafka</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">config/server.properties是kafka的配置文件</span><br><span class="line">执行shell:bin/kafka-server-start.sh	config/server.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">shell最后执行,调用kafka.kafka</span></span><br><span class="line">exec $base_dir/kafka-run-class.sh $EXTRA_ARGS kafka.Kafka &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<h4 id="2、kafka-Kafka"><a href="#2、kafka-Kafka" class="headerlink" title="2、kafka.Kafka"></a>2、kafka.Kafka</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kafka</span> <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">val</span> serverProps = getPropsFromArgs(args)	<span class="comment">//加载配置文件config/server.properties</span></span><br><span class="line">      <span class="comment">//初始化kafka.server.KafkaServerStartable</span></span><br><span class="line">      <span class="keyword">val</span> kafkaServerStartable = <span class="type">KafkaServerStartable</span>.fromProps(serverProps)	</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="type">OperatingSystem</span>.<span class="type">IS_WINDOWS</span> &amp;&amp; !<span class="type">Java</span>.isIbmJdk)</span><br><span class="line">          <span class="keyword">new</span> <span class="type">LoggingSignalHandler</span>().register()</span><br><span class="line">      &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> e: <span class="type">ReflectiveOperationException</span> =&gt;</span><br><span class="line">          warn(<span class="string">&quot;Failed to register optional signal handler that logs a message when the process is terminated &quot;</span> +</span><br><span class="line">            <span class="string">s&quot;by a signal. Reason for registration failure is: <span class="subst">$e</span>&quot;</span>, e)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// attach shutdown handler to catch terminating signals as well as normal termination</span></span><br><span class="line">      <span class="type">Exit</span>.addShutdownHook(<span class="string">&quot;kafka-shutdown-hook&quot;</span>, kafkaServerStartable.shutdown)	<span class="comment">//捕获control-c中断,停止当前服务</span></span><br><span class="line"></span><br><span class="line">      kafkaServerStartable.startup()	<span class="comment">//启动服务kafka.server.KafkaServer</span></span><br><span class="line">      kafkaServerStartable.awaitShutdown()	<span class="comment">//等待服务结束</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        fatal(<span class="string">&quot;Exiting Kafka due to fatal exception&quot;</span>, e)</span><br><span class="line">        <span class="type">Exit</span>.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Exit</span>.exit(<span class="number">0</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3、kafka-server-KafkaServerStartable"><a href="#3、kafka-server-KafkaServerStartable" class="headerlink" title="3、kafka.server.KafkaServerStartable"></a>3、kafka.server.KafkaServerStartable</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">KafkaServerStartable</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">fromProps</span></span>(serverProps: <span class="type">Properties</span>, threadNamePrefix: <span class="type">Option</span>[<span class="type">String</span>]): <span class="type">KafkaServerStartable</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> reporters = <span class="type">KafkaMetricsReporter</span>.startReporters(<span class="keyword">new</span> <span class="type">VerifiableProperties</span>(serverProps))</span><br><span class="line">    <span class="keyword">new</span> <span class="type">KafkaServerStartable</span>(<span class="type">KafkaConfig</span>.fromProps(serverProps, <span class="literal">false</span>), reporters, threadNamePrefix)</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">startup</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">try</span> server.startup()	<span class="comment">//调用kafka.server.KafkaServer的startup方法启动</span></span><br><span class="line">    <span class="keyword">catch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> _: <span class="type">Throwable</span> =&gt;</span><br><span class="line">        <span class="comment">// KafkaServer.startup() calls shutdown() in case of exceptions, so we invoke `exit` to set the status code</span></span><br><span class="line">        fatal(<span class="string">&quot;Exiting Kafka.&quot;</span>)</span><br><span class="line">        <span class="type">Exit</span>.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4、kafka-server-KafkaServer"><a href="#4、kafka-server-KafkaServer" class="headerlink" title="4、kafka.server.KafkaServer"></a>4、kafka.server.KafkaServer</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startup</span></span>(): <span class="type">Unit</span> = &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    info(<span class="string">&quot;starting&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isShuttingDown.get)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">&quot;Kafka server is still shutting down, cannot re-start!&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (startupComplete.get)</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> canStartup = isStartingUp.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">    <span class="keyword">if</span> (canStartup) &#123;</span><br><span class="line">      brokerState.newState(<span class="type">Starting</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* setup zookeeper */</span></span><br><span class="line">      initZkClient(time)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Get or create cluster_id */</span></span><br><span class="line">      _clusterId = getOrGenerateClusterId(zkClient)</span><br><span class="line">      info(<span class="string">s&quot;Cluster ID = <span class="subst">$clusterId</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* load metadata */</span></span><br><span class="line">      <span class="keyword">val</span> (preloadedBrokerMetadataCheckpoint, initialOfflineDirs) = getBrokerMetadataAndOfflineDirs</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* check cluster id */</span></span><br><span class="line">      <span class="keyword">if</span> (preloadedBrokerMetadataCheckpoint.clusterId.isDefined &amp;&amp; preloadedBrokerMetadataCheckpoint.clusterId.get != clusterId)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">InconsistentClusterIdException</span>(</span><br><span class="line">          <span class="string">s&quot;The Cluster ID <span class="subst">$&#123;clusterId&#125;</span> doesn&#x27;t match stored clusterId <span class="subst">$&#123;preloadedBrokerMetadataCheckpoint.clusterId&#125;</span> in meta.properties. &quot;</span> +</span><br><span class="line">          <span class="string">s&quot;The broker is trying to join the wrong cluster. Configured zookeeper.connect may be wrong.&quot;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* generate brokerId */</span></span><br><span class="line">      config.brokerId = getOrGenerateBrokerId(preloadedBrokerMetadataCheckpoint)</span><br><span class="line">      logContext = <span class="keyword">new</span> <span class="type">LogContext</span>(<span class="string">s&quot;[KafkaServer id=<span class="subst">$&#123;config.brokerId&#125;</span>] &quot;</span>)</span><br><span class="line">      <span class="keyword">this</span>.logIdent = logContext.logPrefix</span><br><span class="line"></span><br><span class="line">      <span class="comment">// initialize dynamic broker configs from ZooKeeper. Any updates made after this will be</span></span><br><span class="line">      <span class="comment">// applied after DynamicConfigManager starts.</span></span><br><span class="line">      config.dynamicConfig.initialize(zkClient)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start scheduler */</span></span><br><span class="line">      kafkaScheduler = <span class="keyword">new</span> <span class="type">KafkaScheduler</span>(config.backgroundThreads)</span><br><span class="line">      kafkaScheduler.startup()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* create and configure metrics */</span></span><br><span class="line">      <span class="keyword">val</span> reporters = <span class="keyword">new</span> util.<span class="type">ArrayList</span>[<span class="type">MetricsReporter</span>]</span><br><span class="line">      reporters.add(<span class="keyword">new</span> <span class="type">JmxReporter</span>(jmxPrefix))</span><br><span class="line">      <span class="keyword">val</span> metricConfig = <span class="type">KafkaServer</span>.metricConfig(config)</span><br><span class="line">      metrics = <span class="keyword">new</span> <span class="type">Metrics</span>(metricConfig, reporters, time, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* register broker metrics */</span></span><br><span class="line">      _brokerTopicStats = <span class="keyword">new</span> <span class="type">BrokerTopicStats</span></span><br><span class="line"></span><br><span class="line">      quotaManagers = <span class="type">QuotaFactory</span>.instantiate(config, metrics, time, threadNamePrefix.getOrElse(<span class="string">&quot;&quot;</span>))</span><br><span class="line">      notifyClusterListeners(kafkaMetricsReporters ++ metrics.reporters.asScala)</span><br><span class="line"></span><br><span class="line">      logDirFailureChannel = <span class="keyword">new</span> <span class="type">LogDirFailureChannel</span>(config.logDirs.size)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start log manager */</span></span><br><span class="line">      logManager = <span class="type">LogManager</span>(config, initialOfflineDirs, zkClient, brokerState, kafkaScheduler, time, brokerTopicStats, logDirFailureChannel)</span><br><span class="line">      logManager.startup()</span><br><span class="line"></span><br><span class="line">      metadataCache = <span class="keyword">new</span> <span class="type">MetadataCache</span>(config.brokerId)</span><br><span class="line">      <span class="comment">// Enable delegation token cache for all SCRAM mechanisms to simplify dynamic update.</span></span><br><span class="line">      <span class="comment">// This keeps the cache up-to-date if new SCRAM mechanisms are enabled dynamically.</span></span><br><span class="line">      tokenCache = <span class="keyword">new</span> <span class="type">DelegationTokenCache</span>(<span class="type">ScramMechanism</span>.mechanismNames)</span><br><span class="line">      credentialProvider = <span class="keyword">new</span> <span class="type">CredentialProvider</span>(<span class="type">ScramMechanism</span>.mechanismNames, tokenCache)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Create and start the socket server acceptor threads so that the bound port is known.</span></span><br><span class="line">      <span class="comment">// Delay starting processors until the end of the initialization sequence to ensure</span></span><br><span class="line">      <span class="comment">// that credentials have been loaded before processing authentications.</span></span><br><span class="line">      socketServer = <span class="keyword">new</span> <span class="type">SocketServer</span>(config, metrics, time, credentialProvider)</span><br><span class="line">      socketServer.startup(startupProcessors = <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start replica manager */</span></span><br><span class="line">      replicaManager = createReplicaManager(isShuttingDown)</span><br><span class="line">      replicaManager.startup()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> brokerInfo = createBrokerInfo</span><br><span class="line">      <span class="keyword">val</span> brokerEpoch = zkClient.registerBroker(brokerInfo)</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Now that the broker is successfully registered, checkpoint its metadata</span></span><br><span class="line">      checkpointBrokerMetadata(<span class="type">BrokerMetadata</span>(config.brokerId, <span class="type">Some</span>(clusterId)))</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start token manager */</span></span><br><span class="line">      tokenManager = <span class="keyword">new</span> <span class="type">DelegationTokenManager</span>(config, tokenCache, time , zkClient)</span><br><span class="line">      tokenManager.startup()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start kafka controller */</span></span><br><span class="line">      kafkaController = <span class="keyword">new</span> <span class="type">KafkaController</span>(config, zkClient, time, metrics, brokerInfo, brokerEpoch, tokenManager, threadNamePrefix)</span><br><span class="line">      kafkaController.startup()</span><br><span class="line"></span><br><span class="line">      adminManager = <span class="keyword">new</span> <span class="type">AdminManager</span>(config, metrics, metadataCache, zkClient)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start group coordinator */</span></span><br><span class="line">      <span class="comment">// Hardcode Time.SYSTEM for now as some Streams tests fail otherwise, it would be good to fix the underlying issue</span></span><br><span class="line">      groupCoordinator = <span class="type">GroupCoordinator</span>(config, zkClient, replicaManager, <span class="type">Time</span>.<span class="type">SYSTEM</span>, metrics)</span><br><span class="line">      groupCoordinator.startup()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start transaction coordinator, with a separate background thread scheduler for transaction expiration and log loading */</span></span><br><span class="line">      <span class="comment">// Hardcode Time.SYSTEM for now as some Streams tests fail otherwise, it would be good to fix the underlying issue</span></span><br><span class="line">      transactionCoordinator = <span class="type">TransactionCoordinator</span>(config, replicaManager, <span class="keyword">new</span> <span class="type">KafkaScheduler</span>(threads = <span class="number">1</span>, threadNamePrefix = <span class="string">&quot;transaction-log-manager-&quot;</span>), zkClient, metrics, metadataCache, <span class="type">Time</span>.<span class="type">SYSTEM</span>)</span><br><span class="line">      transactionCoordinator.startup()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Get the authorizer and initialize it if one is specified.*/</span></span><br><span class="line">      authorizer = config.authorizer</span><br><span class="line">      authorizer.foreach(_.configure(config.originals))</span><br><span class="line">      <span class="keyword">val</span> authorizerFutures: <span class="type">Map</span>[<span class="type">Endpoint</span>, <span class="type">CompletableFuture</span>[<span class="type">Void</span>]] = authorizer <span class="keyword">match</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="type">Some</span>(authZ) =&gt;</span><br><span class="line">          authZ.start(brokerInfo.broker.toServerInfo(clusterId, config)).asScala.mapValues(_.toCompletableFuture).toMap</span><br><span class="line">        <span class="keyword">case</span> <span class="type">None</span> =&gt;</span><br><span class="line">          brokerInfo.broker.endPoints.map &#123; ep =&gt; ep.toJava -&gt; <span class="type">CompletableFuture</span>.completedFuture[<span class="type">Void</span>](<span class="literal">null</span>) &#125;.toMap</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">val</span> fetchManager = <span class="keyword">new</span> <span class="type">FetchManager</span>(<span class="type">Time</span>.<span class="type">SYSTEM</span>,</span><br><span class="line">        <span class="keyword">new</span> <span class="type">FetchSessionCache</span>(config.maxIncrementalFetchSessionCacheSlots,</span><br><span class="line">          <span class="type">KafkaServer</span>.<span class="type">MIN_INCREMENTAL_FETCH_SESSION_EVICTION_MS</span>))</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start processing requests */</span></span><br><span class="line">      dataPlaneRequestProcessor = <span class="keyword">new</span> <span class="type">KafkaApis</span>(socketServer.dataPlaneRequestChannel, replicaManager, adminManager, groupCoordinator, transactionCoordinator,</span><br><span class="line">        kafkaController, zkClient, config.brokerId, config, metadataCache, metrics, authorizer, quotaManagers,</span><br><span class="line">        fetchManager, brokerTopicStats, clusterId, time, tokenManager)</span><br><span class="line"></span><br><span class="line">      dataPlaneRequestHandlerPool = <span class="keyword">new</span> <span class="type">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.dataPlaneRequestChannel, dataPlaneRequestProcessor, time,</span><br><span class="line">        config.numIoThreads, <span class="string">s&quot;<span class="subst">$&#123;SocketServer.DataPlaneMetricPrefix&#125;</span>RequestHandlerAvgIdlePercent&quot;</span>, <span class="type">SocketServer</span>.<span class="type">DataPlaneThreadPrefix</span>)</span><br><span class="line"></span><br><span class="line">      socketServer.controlPlaneRequestChannelOpt.foreach &#123; controlPlaneRequestChannel =&gt;</span><br><span class="line">        controlPlaneRequestProcessor = <span class="keyword">new</span> <span class="type">KafkaApis</span>(controlPlaneRequestChannel, replicaManager, adminManager, groupCoordinator, transactionCoordinator,</span><br><span class="line">          kafkaController, zkClient, config.brokerId, config, metadataCache, metrics, authorizer, quotaManagers,</span><br><span class="line">          fetchManager, brokerTopicStats, clusterId, time, tokenManager)</span><br><span class="line"></span><br><span class="line">        controlPlaneRequestHandlerPool = <span class="keyword">new</span> <span class="type">KafkaRequestHandlerPool</span>(config.brokerId, socketServer.controlPlaneRequestChannelOpt.get, controlPlaneRequestProcessor, time,</span><br><span class="line">          <span class="number">1</span>, <span class="string">s&quot;<span class="subst">$&#123;SocketServer.ControlPlaneMetricPrefix&#125;</span>RequestHandlerAvgIdlePercent&quot;</span>, <span class="type">SocketServer</span>.<span class="type">ControlPlaneThreadPrefix</span>)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="type">Mx4jLoader</span>.maybeLoad()</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* Add all reconfigurables for config change notification before starting config handlers */</span></span><br><span class="line">      config.dynamicConfig.addReconfigurables(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* start dynamic config manager */</span></span><br><span class="line">      dynamicConfigHandlers = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">ConfigHandler</span>](<span class="type">ConfigType</span>.<span class="type">Topic</span> -&gt; <span class="keyword">new</span> <span class="type">TopicConfigHandler</span>(logManager, config, quotaManagers, kafkaController),</span><br><span class="line">                                                         <span class="type">ConfigType</span>.<span class="type">Client</span> -&gt; <span class="keyword">new</span> <span class="type">ClientIdConfigHandler</span>(quotaManagers),</span><br><span class="line">                                                         <span class="type">ConfigType</span>.<span class="type">User</span> -&gt; <span class="keyword">new</span> <span class="type">UserConfigHandler</span>(quotaManagers, credentialProvider),</span><br><span class="line">                                                         <span class="type">ConfigType</span>.<span class="type">Broker</span> -&gt; <span class="keyword">new</span> <span class="type">BrokerConfigHandler</span>(config, quotaManagers))</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Create the config manager. start listening to notifications</span></span><br><span class="line">      dynamicConfigManager = <span class="keyword">new</span> <span class="type">DynamicConfigManager</span>(zkClient, dynamicConfigHandlers)</span><br><span class="line">      dynamicConfigManager.startup()</span><br><span class="line"></span><br><span class="line">      socketServer.startControlPlaneProcessor(authorizerFutures)</span><br><span class="line">      socketServer.startDataPlaneProcessors(authorizerFutures)</span><br><span class="line">      brokerState.newState(<span class="type">RunningAsBroker</span>)</span><br><span class="line">      shutdownLatch = <span class="keyword">new</span> <span class="type">CountDownLatch</span>(<span class="number">1</span>)</span><br><span class="line">      startupComplete.set(<span class="literal">true</span>)</span><br><span class="line">      isStartingUp.set(<span class="literal">false</span>)</span><br><span class="line">      <span class="type">AppInfoParser</span>.registerAppInfo(jmxPrefix, config.brokerId.toString, metrics, time.milliseconds())</span><br><span class="line">      info(<span class="string">&quot;started&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">Throwable</span> =&gt;</span><br><span class="line">      fatal(<span class="string">&quot;Fatal error during KafkaServer startup. Prepare to shutdown&quot;</span>, e)</span><br><span class="line">      isStartingUp.set(<span class="literal">false</span>)</span><br><span class="line">      shutdown()</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动插件"><a href="#启动插件" class="headerlink" title="启动插件"></a>启动插件</h4><h5 id="1、执行命令启动connect"><a href="#1、执行命令启动connect" class="headerlink" title="1、执行命令启动connect"></a>1、执行命令启动connect</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connect-standalone.sh	</span><br><span class="line">最后执行：org.apache.kafka.connect.cli.ConnectStandalone</span><br></pre></td></tr></table></figure>
<h5 id="2、org-apache-kafka-connect-cli-ConnectStandalone"><a href="#2、org-apache-kafka-connect-cli-ConnectStandalone" class="headerlink" title="2、org.apache.kafka.connect.cli.ConnectStandalone"></a>2、org.apache.kafka.connect.cli.ConnectStandalone</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectStandalone</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (args.length &lt; <span class="number">2</span> || Arrays.asList(args).contains(<span class="string">&quot;--help&quot;</span>)) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Usage: ConnectStandalone worker.properties connector1.properties [connector2.properties ...]&quot;</span>);</span><br><span class="line">            Exit.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Time time = Time.SYSTEM;</span><br><span class="line">            log.info(<span class="string">&quot;Kafka Connect standalone worker initializing ...&quot;</span>);</span><br><span class="line">            <span class="keyword">long</span> initStart = time.hiResClockMs();</span><br><span class="line">            WorkerInfo initInfo = <span class="keyword">new</span> WorkerInfo();</span><br><span class="line">            initInfo.logAll();</span><br><span class="line"></span><br><span class="line">            String workerPropsFile = args[<span class="number">0</span>];</span><br><span class="line">            Map&lt;String, String&gt; workerProps = !workerPropsFile.isEmpty() ?</span><br><span class="line">                    Utils.propsToStringMap(Utils.loadProps(workerPropsFile)) : Collections.&lt;String, String&gt;emptyMap();	<span class="comment">//读取kafka配置文件</span></span><br><span class="line"></span><br><span class="line">            log.info(<span class="string">&quot;Scanning for plugin classes. This might take a moment ...&quot;</span>);</span><br><span class="line">            <span class="comment">//实例化插件org.apache.kafka.connect.runtime.isolation.Plugins</span></span><br><span class="line">            Plugins plugins = <span class="keyword">new</span> Plugins(workerProps);		<span class="comment">//实例化插件管理类Plugins</span></span><br><span class="line">            plugins.compareAndSwapWithDelegatingLoader();	<span class="comment">//获取当前线程的ClassLoader</span></span><br><span class="line">            StandaloneConfig config = <span class="keyword">new</span> StandaloneConfig(workerProps);	<span class="comment">//实例化StandaloneConfig</span></span><br><span class="line"></span><br><span class="line">            String kafkaClusterId = ConnectUtils.lookupKafkaClusterId(config);</span><br><span class="line">            log.debug(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line"></span><br><span class="line">            RestServer rest = <span class="keyword">new</span> RestServer(config);	<span class="comment">//实例化rest api的内嵌服务</span></span><br><span class="line">            rest.initializeServer();</span><br><span class="line"></span><br><span class="line">            URI advertisedUrl = rest.advertisedUrl();</span><br><span class="line">            String workerId = advertisedUrl.getHost() + <span class="string">&quot;:&quot;</span> + advertisedUrl.getPort();</span><br><span class="line"></span><br><span class="line">            ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy = plugins.newPlugin(</span><br><span class="line">                config.getString(WorkerConfig.CONNECTOR_CLIENT_POLICY_CLASS_CONFIG),</span><br><span class="line">                config, ConnectorClientConfigOverridePolicy.class);	<span class="comment">//connector.client.config.override.policy配置的连接客户端</span></span><br><span class="line">            Worker worker = <span class="keyword">new</span> Worker(workerId, time, plugins, config, <span class="keyword">new</span> FileOffsetBackingStore(),</span><br><span class="line">                                       connectorClientConfigOverridePolicy);</span><br><span class="line"></span><br><span class="line">            Herder herder = <span class="keyword">new</span> StandaloneHerder(worker, kafkaClusterId, connectorClientConfigOverridePolicy);</span><br><span class="line">            <span class="keyword">final</span> Connect connect = <span class="keyword">new</span> Connect(herder, rest);</span><br><span class="line">            log.info(<span class="string">&quot;Kafka Connect standalone worker initialization took &#123;&#125;ms&quot;</span>, time.hiResClockMs() - initStart);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                connect.start();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">final</span> String connectorPropsFile : Arrays.copyOfRange(args, <span class="number">1</span>, args.length)) &#123;</span><br><span class="line">                    Map&lt;String, String&gt; connectorProps = Utils.propsToStringMap(Utils.loadProps(connectorPropsFile));</span><br><span class="line">                    FutureCallback&lt;Herder.Created&lt;ConnectorInfo&gt;&gt; cb = <span class="keyword">new</span> FutureCallback&lt;&gt;(<span class="keyword">new</span> Callback&lt;Herder.Created&lt;ConnectorInfo&gt;&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(Throwable error, Herder.Created&lt;ConnectorInfo&gt; info)</span> </span>&#123;</span><br><span class="line">                            <span class="keyword">if</span> (error != <span class="keyword">null</span>)</span><br><span class="line">                                log.error(<span class="string">&quot;Failed to create job for &#123;&#125;&quot;</span>, connectorPropsFile);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                log.info(<span class="string">&quot;Created connector &#123;&#125;&quot;</span>, info.result().name());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                    herder.putConnectorConfig(</span><br><span class="line">                            connectorProps.get(ConnectorConfig.NAME_CONFIG),</span><br><span class="line">                            connectorProps, <span class="keyword">false</span>, cb);</span><br><span class="line">                    cb.get();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;Stopping after connector error&quot;</span>, t);</span><br><span class="line">                connect.stop();</span><br><span class="line">                Exit.exit(<span class="number">3</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Shutdown will be triggered by Ctrl-C or via HTTP shutdown request</span></span><br><span class="line">            connect.awaitStop();</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Stopping due to error&quot;</span>, t);</span><br><span class="line">            Exit.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="3、org-apache-kafka-connect-runtime-isolation-Plugins"><a href="#3、org-apache-kafka-connect-runtime-isolation-Plugins" class="headerlink" title="3、org.apache.kafka.connect.runtime.isolation.Plugins"></a>3、org.apache.kafka.connect.runtime.isolation.Plugins</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Plugins</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">    List&lt;String&gt; pluginLocations = WorkerConfig.pluginLocations(props);</span><br><span class="line">    delegatingLoader = newDelegatingClassLoader(pluginLocations);</span><br><span class="line">    delegatingLoader.initLoaders();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4、org-apache-kafka-connect-runtime-rest-RestServer"><a href="#4、org-apache-kafka-connect-runtime-rest-RestServer" class="headerlink" title="4、org.apache.kafka.connect.runtime.rest.RestServer"></a>4、org.apache.kafka.connect.runtime.rest.RestServer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">org.apache.kafka.connect.runtime.rest.RestServer&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RestServer</span><span class="params">(WorkerConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; listeners = parseListeners();</span><br><span class="line">        List&lt;String&gt; adminListeners = config.getList(WorkerConfig.ADMIN_LISTENERS_CONFIG);</span><br><span class="line"></span><br><span class="line">        jettyServer = <span class="keyword">new</span> Server();</span><br><span class="line">        handlers = <span class="keyword">new</span> ContextHandlerCollection();</span><br><span class="line"></span><br><span class="line">        createConnectors(listeners, adminListeners);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newPlugin</span><span class="params">(String klassName, AbstractConfig config, Class&lt;T&gt; pluginKlass)</span> </span>&#123;</span><br><span class="line">        T plugin;</span><br><span class="line">        Class&lt;? extends T&gt; klass;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            klass = pluginClass(delegatingLoader, klassName, pluginKlass);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            String msg = String.format(<span class="string">&quot;Failed to find any class that implements %s and which &quot;</span></span><br><span class="line">                                       + <span class="string">&quot;name matches %s&quot;</span>, pluginKlass, klassName);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        ClassLoader savedLoader = compareAndSwapLoaders(klass.getClassLoader());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            plugin = newPlugin(klass);</span><br><span class="line">            <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Versioned) &#123;</span><br><span class="line">                Versioned versionedPlugin = (Versioned) plugin;</span><br><span class="line">                <span class="keyword">if</span> (versionedPlugin.version() == <span class="keyword">null</span> || versionedPlugin.version().trim()</span><br><span class="line">                    .isEmpty()) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Version not defined for &#x27;&quot;</span> + klassName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Configurable) &#123;</span><br><span class="line">                ((Configurable) plugin).configure(config.originals());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            compareAndSwapLoaders(savedLoader);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> plugin;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="5、org-apache-kafka-connect-runtime-standalone-StandaloneConfig"><a href="#5、org-apache-kafka-connect-runtime-standalone-StandaloneConfig" class="headerlink" title="5、org.apache.kafka.connect.runtime.standalone.StandaloneConfig"></a>5、org.apache.kafka.connect.runtime.standalone.StandaloneConfig</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StandaloneConfig</span> <span class="keyword">extends</span> <span class="title">WorkerConfig</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConfigDef CONFIG;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * &lt;code&gt;offset.storage.file.filename&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String OFFSET_STORAGE_FILE_FILENAME_CONFIG = <span class="string">&quot;offset.storage.file.filename&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String OFFSET_STORAGE_FILE_FILENAME_DOC = <span class="string">&quot;File to store offset data in&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        CONFIG = baseConfigDef()</span><br><span class="line">                .define(OFFSET_STORAGE_FILE_FILENAME_CONFIG,</span><br><span class="line">                        ConfigDef.Type.STRING,</span><br><span class="line">                        ConfigDef.Importance.HIGH,</span><br><span class="line">                        OFFSET_STORAGE_FILE_FILENAME_DOC);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">StandaloneConfig</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(CONFIG, props);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Kafka/kafka%E6%BA%90%E7%A0%81/" data-id="ckk2gq3ue001kz8pq3nusdfxx" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Kafka/kafka connect源码分析" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Kafka/kafka%20connect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.489Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[toc]</p>
<h3 id="1、安装并启动zookeeper"><a href="#1、安装并启动zookeeper" class="headerlink" title="1、安装并启动zookeeper"></a>1、安装并启动zookeeper</h3><p>kafka运行依赖zookeeper，下载部署zookeeper后，/conf/zoo.cfg配置zookeeper</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> The number of milliseconds of each tick</span></span><br><span class="line">tickTime=2000</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that the initial</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> synchronization phase can take</span></span><br><span class="line">initLimit=10</span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of ticks that can pass between</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> sending a request and getting an acknowledgement</span></span><br><span class="line">syncLimit=5</span><br><span class="line"><span class="meta">#</span><span class="bash"> the directory <span class="built_in">where</span> the snapshot is stored.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">do</span> not use /tmp <span class="keyword">for</span> storage, /tmp here is just</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> example sakes.</span></span><br><span class="line">dataDir=D:/WorkSoft/apache-zookeeper-3.5.8-bin/dataDir</span><br><span class="line">dataLogDir=D:/WorkSoft/apache-zookeeper-3.5.8-bin/logs</span><br><span class="line"><span class="meta">#</span><span class="bash"> the port at <span class="built_in">which</span> the clients will connect</span></span><br><span class="line">clientPort=2181</span><br><span class="line"><span class="meta">#</span><span class="bash"> the maximum number of client connections.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> increase this <span class="keyword">if</span> you need to handle more clients</span></span><br><span class="line"><span class="meta">#</span><span class="bash">maxClientCnxns=60</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Be sure to read the maintenance section of the</span></span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> administrator guide before turning on autopurge.</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># http://zookeeper.apache.org/doc/current/zookeeperAdmin.html#sc_maintenance</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># The number of snapshots to retain in dataDir</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.snapRetainCount=3</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Purge task interval <span class="keyword">in</span> hours</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to <span class="string">&quot;0&quot;</span> to <span class="built_in">disable</span> auto purge feature</span></span><br><span class="line"><span class="meta">#</span><span class="bash">autopurge.purgeInterval=1</span></span><br></pre></td></tr></table></figure>
<p>执行./bin/zkServer.sh启动zookeeper</p>
<h3 id="2、安装并启动kafka"><a href="#2、安装并启动kafka" class="headerlink" title="2、安装并启动kafka"></a>2、安装并启动kafka</h3><p>下载并部署kafka到后，在config/server.properties文件中配置kafka，zookeeper.connect配置zookeeper地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this work <span class="keyword">for</span> additional information regarding copyright ownership.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (the <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> see kafka.server.KafkaConfig <span class="keyword">for</span> additional details and defaults</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Server Basics #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The id of the broker. This must be <span class="built_in">set</span> to a unique <span class="built_in">integer</span> <span class="keyword">for</span> each broker.</span></span><br><span class="line">broker.id=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Socket Server Settings #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The address the socket server listens on. It will get the value returned from</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> java.net.InetAddress.getCanonicalHostName() <span class="keyword">if</span> not configured.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   FORMAT:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     listeners = listener_name://host_name:port</span></span><br><span class="line"><span class="meta">#</span><span class="bash">   EXAMPLE:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">     listeners = PLAINTEXT://your.host.name:9092</span></span><br><span class="line">listeners=PLAINTEXT://0.0.0.0:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Hostname and port the broker will advertise to producers and consumers. If not <span class="built_in">set</span>,</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> it uses the value <span class="keyword">for</span> <span class="string">&quot;listeners&quot;</span> <span class="keyword">if</span> configured.  Otherwise, it will use the value</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> returned from java.net.InetAddress.getCanonicalHostName().</span></span><br><span class="line">advertised.listeners=PLAINTEXT://127.0.0.1:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Maps listener names to security protocols, the default is <span class="keyword">for</span> them to be the same. See the config documentation <span class="keyword">for</span> more details</span></span><br><span class="line"><span class="meta">#</span><span class="bash">listener.security.protocol.map=PLAINTEXT:PLAINTEXT,SSL:SSL,SASL_PLAINTEXT:SASL_PLAINTEXT,SASL_SSL:SASL_SSL</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads that the server uses <span class="keyword">for</span> receiving requests from the network and sending responses to the network</span></span><br><span class="line">num.network.threads=3</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads that the server uses <span class="keyword">for</span> processing requests, <span class="built_in">which</span> may include disk I/O</span></span><br><span class="line">num.io.threads=8</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The send buffer (SO_SNDBUF) used by the socket server</span></span><br><span class="line">socket.send.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The receive buffer (SO_RCVBUF) used by the socket server</span></span><br><span class="line">socket.receive.buffer.bytes=102400</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum size of a request that the socket server will accept (protection against OOM)</span></span><br><span class="line">socket.request.max.bytes=104857600</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Basics #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A comma separated list of directories under <span class="built_in">which</span> to store <span class="built_in">log</span> files</span></span><br><span class="line">log.dirs=/kafka/logs</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default number of <span class="built_in">log</span> partitions per topic. More partitions allow greater</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> parallelism <span class="keyword">for</span> consumption, but this will also result <span class="keyword">in</span> more files across</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the brokers.</span></span><br><span class="line">num.partitions=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of threads per data directory to be used <span class="keyword">for</span> <span class="built_in">log</span> recovery at startup and flushing at shutdown.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This value is recommended to be increased <span class="keyword">for</span> installations with data <span class="built_in">dirs</span> located <span class="keyword">in</span> RAID array.</span></span><br><span class="line">num.recovery.threads.per.data.dir=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Internal Topic Settings  #############################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The replication factor <span class="keyword">for</span> the group metadata internal topics <span class="string">&quot;__consumer_offsets&quot;</span> and <span class="string">&quot;__transaction_state&quot;</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> For anything other than development testing, a value greater than 1 is recommended to ensure availability such as 3.</span></span><br><span class="line">offsets.topic.replication.factor=1</span><br><span class="line">transaction.state.log.replication.factor=1</span><br><span class="line">transaction.state.log.min.isr=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Flush Policy #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Messages are immediately written to the filesystem but by default we only fsync() to sync</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the OS cache lazily. The following configurations control the flush of data to disk.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> There are a few important trade-offs here:</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    1. Durability: Unflushed data may be lost <span class="keyword">if</span> you are not using replication.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    2. Latency: Very large flush intervals may lead to latency spikes when the flush does occur as there will be a lot of data to flush.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">    3. Throughput: The flush is generally the most expensive operation, and a small flush interval may lead to excessive seeks.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The settings below allow one to configure the flush policy to flush data after a period of time or</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> every N messages (or both). This can be <span class="keyword">done</span> globally and overridden on a per-topic basis.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The number of messages to accept before forcing a flush of data to disk</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.messages=10000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum amount of time a message can sit <span class="keyword">in</span> a <span class="built_in">log</span> before we force a flush</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.flush.interval.ms=1000</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Log Retention Policy #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following configurations control the disposal of <span class="built_in">log</span> segments. The policy can</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be <span class="built_in">set</span> to delete segments after a period of time, or after a given size has accumulated.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> A segment will be deleted whenever *either* of these criteria are met. Deletion always happens</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> from the end of the <span class="built_in">log</span>.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The minimum age of a <span class="built_in">log</span> file to be eligible <span class="keyword">for</span> deletion due to age</span></span><br><span class="line">log.retention.hours=168</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A size-based retention policy <span class="keyword">for</span> logs. Segments are pruned from the <span class="built_in">log</span> unless the remaining</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> segments drop below log.retention.bytes. Functions independently of log.retention.hours.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">log.retention.bytes=1073741824</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The maximum size of a <span class="built_in">log</span> segment file. When this size is reached a new <span class="built_in">log</span> segment will be created.</span></span><br><span class="line">log.segment.bytes=1073741824</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The interval at <span class="built_in">which</span> <span class="built_in">log</span> segments are checked to see <span class="keyword">if</span> they can be deleted according</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to the retention policies</span></span><br><span class="line">log.retention.check.interval.ms=300000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Zookeeper #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Zookeeper connection string (see zookeeper docs <span class="keyword">for</span> details).</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> This is a comma separated host:port pairs, each corresponding to a zk</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> server. e.g. <span class="string">&quot;127.0.0.1:3000,127.0.0.1:3001,127.0.0.1:3002&quot;</span>.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> You can also append an optional chroot string to the urls to specify the</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> root directory <span class="keyword">for</span> all kafka znodes.</span></span><br><span class="line">zookeeper.connect=localhost:2181/kafka</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Timeout <span class="keyword">in</span> ms <span class="keyword">for</span> connecting to zookeeper</span></span><br><span class="line">zookeeper.connection.timeout.ms=18000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################ Group Coordinator Settings #############################</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The following configuration specifies the time, <span class="keyword">in</span> milliseconds, that the GroupCoordinator will delay the initial consumer rebalance.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The rebalance will be further delayed by the value of group.initial.rebalance.delay.ms as new members join the group, up to a maximum of max.poll.interval.ms.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The default value <span class="keyword">for</span> this is 3 seconds.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> We override this to 0 here as it makes <span class="keyword">for</span> a better out-of-the-box experience <span class="keyword">for</span> development and testing.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> However, <span class="keyword">in</span> production environments the default value of 3 seconds is more suitable as this will <span class="built_in">help</span> to avoid unnecessary, and potentially expensive, rebalances during application startup.</span></span><br><span class="line">group.initial.rebalance.delay.ms=0</span><br></pre></td></tr></table></figure>
<p>执行命令启动kafka：./bin/kafka-server-start.sh config/server.properties</p>
<h3 id="3、下载并部署debezium-connector-mysql"><a href="#3、下载并部署debezium-connector-mysql" class="headerlink" title="3、下载并部署debezium-connector-mysql"></a>3、下载并部署debezium-connector-mysql</h3><p>debezium-connector-mysql作为kafka connect的一个插件连接mysql数据库，所以下载好debezium-connector-mysql.jar后上传到kafka服务器的插件配置路径下，默认/usr/local/share/java,/usr/local/share/kafka/plugins，也可以在kafka connect配置文件中修改</p>
<h3 id="4、配置并启动kafka-connect"><a href="#4、配置并启动kafka-connect" class="headerlink" title="4、配置并启动kafka connect"></a>4、配置并启动kafka connect</h3><p>kafka connnect启动有两种模式：stanalone独立模式和distributed集群模式</p>
<p>下面主要介绍集群模式启动的方法和步骤</p>
<h4 id="4-1配置kafka-connect"><a href="#4-1配置kafka-connect" class="headerlink" title="4.1配置kafka connect"></a>4.1配置kafka connect</h4><p>在config/connect-distributed.properties配置文件中配置kafka connect，其中bootstrap.servers配置kafka集群列表，plugin.path配置kafka connect插件路径，offset.storage.topic、config.storage.topic、</p>
<p>status.storage.topic分别配置connect存储偏移量、配置、状态主题</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Licensed to the Apache Software Foundation (ASF) under one or more</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> contributor license agreements.  See the NOTICE file distributed with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> this work <span class="keyword">for</span> additional information regarding copyright ownership.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The ASF licenses this file to You under the Apache License, Version 2.0</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (the <span class="string">&quot;License&quot;</span>); you may not use this file except <span class="keyword">in</span> compliance with</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the License.  You may obtain a copy of the License at</span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment">#    http://www.apache.org/licenses/LICENSE-2.0</span></span></span><br><span class="line"><span class="meta">#</span></span><br><span class="line"><span class="bash"><span class="comment"># Unless required by applicable law or agreed to in writing, software</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> distributed under the License is distributed on an <span class="string">&quot;AS IS&quot;</span> BASIS,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> See the License <span class="keyword">for</span> the specific language governing permissions and</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> limitations under the License.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> This file contains some of the configurations <span class="keyword">for</span> the Kafka Connect distributed worker. This file is intended</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to be used with the examples, and some settings may differ from those used <span class="keyword">in</span> a production system, especially</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the `bootstrap.servers` and those specifying replication factors.</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> A list of host/port pairs to use <span class="keyword">for</span> establishing the initial connection to the Kafka cluster.</span></span><br><span class="line">bootstrap.servers=127.0.0.1:9092</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> unique name <span class="keyword">for</span> the cluster, used <span class="keyword">in</span> forming the Connect cluster group. Note that this must not conflict with consumer group IDs</span></span><br><span class="line">group.id=connect-cluster</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The converters specify the format of data <span class="keyword">in</span> Kafka and how to translate it into Connect data. Every Connect user will</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> need to configure these based on the format they want their data <span class="keyword">in</span> when loaded from or stored into Kafka</span></span><br><span class="line">key.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line">value.converter=org.apache.kafka.connect.json.JsonConverter</span><br><span class="line"><span class="meta">#</span><span class="bash"> Converter-specific settings can be passed <span class="keyword">in</span> by prefixing the Converter<span class="string">&#x27;s setting with the converter we want to apply</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> it to</span></span><br><span class="line">key.converter.schemas.enable=true</span><br><span class="line">value.converter.schemas.enable=true</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing offsets. This topic should have many partitions and be replicated and compacted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">offset.storage.topic=connect-offsets</span><br><span class="line">offset.storage.replication.factor=1</span><br><span class="line"><span class="meta">#</span><span class="bash">offset.storage.partitions=25</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing connector and task configurations; note that this should be a single partition, highly replicated,</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> and compacted topic. Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">config.storage.topic=connect-configs</span><br><span class="line">config.storage.replication.factor=1</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Topic to use <span class="keyword">for</span> storing statuses. This topic can have multiple partitions and should be replicated and compacted.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Kafka Connect will attempt to create the topic automatically when needed, but you can always manually create</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the topic before starting Kafka Connect <span class="keyword">if</span> a specific topic configuration is needed.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Most users will want to use the built-in default replication factor of 3 or <span class="keyword">in</span> some cases even specify a larger value.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Since this means there must be at least as many brokers as the maximum replication factor used, we<span class="string">&#x27;d like to be able</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> to run this example on a single-broker cluster and so here we instead <span class="built_in">set</span> the replication factor to 1.</span></span><br><span class="line">status.storage.topic=connect-status</span><br><span class="line">status.storage.replication.factor=1</span><br><span class="line"><span class="meta">#</span><span class="bash">status.storage.partitions=5</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Flush much faster than normal, <span class="built_in">which</span> is useful <span class="keyword">for</span> testing/debugging</span></span><br><span class="line">offset.flush.interval.ms=10000</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> These are provided to inform the user about the presence of the REST host and port configs</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> Hostname &amp; Port <span class="keyword">for</span> the REST API to listen on. If this is <span class="built_in">set</span>, it will <span class="built_in">bind</span> to the interface used to listen to requests.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.host.name=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.port=8083</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> The Hostname &amp; Port that will be given out to other workers to connect to i.e. URLs that are routable from other servers.</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.advertised.host.name=</span></span><br><span class="line"><span class="meta">#</span><span class="bash">rest.advertised.port=</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> Set to a list of filesystem paths separated by commas (,) to <span class="built_in">enable</span> class loading isolation <span class="keyword">for</span> plugins</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> (connectors, converters, transformations). The list should consist of top level directories that include</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> any combination of:</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> a) directories immediately containing jars with plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> b) uber-jars with plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> c) directories immediately containing the package directory structure of classes of plugins and their dependencies</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Examples:</span> </span><br><span class="line"><span class="meta">#</span><span class="bash"> plugin.path=/usr/<span class="built_in">local</span>/share/java,/usr/<span class="built_in">local</span>/share/kafka/plugins,/opt/connectors,</span></span><br><span class="line">plugin.path=/usr/local/share/java,/usr/local/share/kafka/plugins,/opt/connectors,D:/PracticeProjects/plugins</span><br></pre></td></tr></table></figure>
<h4 id="4-2行命令启动kafka-connect"><a href="#4-2行命令启动kafka-connect" class="headerlink" title="4.2行命令启动kafka connect"></a>4.2行命令启动kafka connect</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">执行命令启动kafka connect</span></span><br><span class="line">./bin/connect-distributed.sh config/connect-distributed.properties</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">该shell最后一步执行，调起了kafka connect集群模式启动的main方法</span></span><br><span class="line">exec $(dirname $0)/kafka-run-class.sh $EXTRA_ARGS org.apache.kafka.connect.cli.ConnectDistributed &quot;$@&quot;</span><br></pre></td></tr></table></figure>
<h4 id="4-3kafka-connect启动源码解读"><a href="#4-3kafka-connect启动源码解读" class="headerlink" title="4.3kafka connect启动源码解读"></a>4.3kafka connect启动源码解读</h4><h5 id="4-3-1ConnectDistributed的main方法"><a href="#4-3-1ConnectDistributed的main方法" class="headerlink" title="4.3.1ConnectDistributed的main方法"></a>4.3.1ConnectDistributed的main方法</h5><p>kafka connect启动命令最终调用org.apache.kafka.connect.cli.ConnectDistributed的main方法开始初始化并启动kafka connect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;    <span class="comment">//入参为config\connect-distributed.properties配置文件</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果入参数量小于1或者包含--help则推出</span></span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">1</span> || Arrays.asList(args).contains(<span class="string">&quot;--help&quot;</span>)) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Usage: ConnectDistributed worker.properties&quot;</span>);</span><br><span class="line">        Exit.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//初始化系统运行时环境对象,包含操作系统参数和jvm参数</span></span><br><span class="line">        WorkerInfo initInfo = <span class="keyword">new</span> WorkerInfo();</span><br><span class="line">        initInfo.logAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//赋值config\connect-distributed.properties入参到workerPropsFile</span></span><br><span class="line">        String workerPropsFile = args[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">//将配置文件转换为map</span></span><br><span class="line">        Map&lt;String, String&gt; workerProps = !workerPropsFile.isEmpty() ?</span><br><span class="line">                Utils.propsToStringMap(Utils.loadProps(workerPropsFile)) : Collections.emptyMap();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化connectDistributed对象</span></span><br><span class="line">        ConnectDistributed connectDistributed = <span class="keyword">new</span> ConnectDistributed();</span><br><span class="line">        <span class="comment">//重要方法:调用connectDistributed的startConnect方法启动connect</span></span><br><span class="line">        Connect connect = connectDistributed.startConnect(workerProps);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Shutdown will be triggered by Ctrl-C or via HTTP shutdown request</span></span><br><span class="line">        <span class="comment">//等待Ctrl-C或http客户端停止请求</span></span><br><span class="line">        connect.awaitStop();</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Stopping due to error&quot;</span>, t);</span><br><span class="line">        Exit.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="4-3-2ConnectDistributed的startConnect方法"><a href="#4-3-2ConnectDistributed的startConnect方法" class="headerlink" title="4.3.2ConnectDistributed的startConnect方法"></a>4.3.2ConnectDistributed的startConnect方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Connect <span class="title">startConnect</span><span class="params">(Map&lt;String, String&gt; workerProps)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Scanning for plugin classes. This might take a moment ...&quot;</span>);</span><br><span class="line">    <span class="comment">//从配置文件plugin.path配置路径下所有的插件列表</span></span><br><span class="line">    Plugins plugins = <span class="keyword">new</span> Plugins(workerProps);</span><br><span class="line">    <span class="comment">//切换类加载器</span></span><br><span class="line">    plugins.compareAndSwapWithDelegatingLoader();</span><br><span class="line">    <span class="comment">//从workerProps中实例化DistributedConfig</span></span><br><span class="line">    DistributedConfig config = <span class="keyword">new</span> DistributedConfig(workerProps);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过kafka连接客户端请求kafka获取kafka集群id</span></span><br><span class="line">    String kafkaClusterId = ConnectUtils.lookupKafkaClusterId(config);</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化jetty rest服务，如uri、监听器</span></span><br><span class="line">    RestServer rest = <span class="keyword">new</span> RestServer(config);</span><br><span class="line">    <span class="comment">//调用rest方法启动服务</span></span><br><span class="line">    rest.initializeServer();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取访问url</span></span><br><span class="line">    URI advertisedUrl = rest.advertisedUrl();</span><br><span class="line">    <span class="comment">//赋值workerId为ip:端口</span></span><br><span class="line">    String workerId = advertisedUrl.getHost() + <span class="string">&quot;:&quot;</span> + advertisedUrl.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化KafkaOffsetBackingStore偏移量存储对象以及其静态属性</span></span><br><span class="line">    KafkaOffsetBackingStore offsetBackingStore = <span class="keyword">new</span> KafkaOffsetBackingStore();</span><br><span class="line">    <span class="comment">//offsetBackingStore调用configure方法初始化生产者、消费者、管理者配置，创建offset日志</span></span><br><span class="line">    offsetBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取connector.client.config.override.policy配置代理类加载插件类</span></span><br><span class="line">    ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy = plugins.newPlugin(</span><br><span class="line">            config.getString(WorkerConfig.CONNECTOR_CLIENT_POLICY_CLASS_CONFIG),</span><br><span class="line">            config, ConnectorClientConfigOverridePolicy.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化kafka的org.apache.kafka.connect.runtime.Worker</span></span><br><span class="line">    Worker worker = <span class="keyword">new</span> Worker(workerId, time, plugins, config, offsetBackingStore, connectorClientConfigOverridePolicy);</span><br><span class="line">    <span class="comment">//获取worker的配置转换者</span></span><br><span class="line">    WorkerConfigTransformer configTransformer = worker.configTransformer();</span><br><span class="line">    <span class="comment">//获取worker的internalValueConverter转换者</span></span><br><span class="line">    Converter internalValueConverter = worker.getInternalValueConverter();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化KafkaStatusBackingStore状态存储对象及其静态属性</span></span><br><span class="line">    StatusBackingStore statusBackingStore = <span class="keyword">new</span> KafkaStatusBackingStore(time, internalValueConverter);</span><br><span class="line">    <span class="comment">//statusBackingStore调用configure方法初始化生产者、消费者、管理者配置，创建status日志</span></span><br><span class="line">    statusBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化ConfigBackingStore,配置存储对象及其静态属性，并初始化生产者、消费者、管理者配置，创建config日志</span></span><br><span class="line">    ConfigBackingStore configBackingStore = <span class="keyword">new</span> KafkaConfigBackingStore(</span><br><span class="line">            internalValueConverter,</span><br><span class="line">            config,</span><br><span class="line">            configTransformer);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化集群herder</span></span><br><span class="line">    DistributedHerder herder = <span class="keyword">new</span> DistributedHerder(config, time, worker,</span><br><span class="line">            kafkaClusterId, statusBackingStore, configBackingStore,</span><br><span class="line">            advertisedUrl.toString(), connectorClientConfigOverridePolicy);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化Connect</span></span><br><span class="line">    <span class="keyword">final</span> Connect connect = <span class="keyword">new</span> Connect(herder, rest);</span><br><span class="line">    log.info(<span class="string">&quot;Kafka Connect distributed worker initialization took &#123;&#125;ms&quot;</span>, time.hiResClockMs() - initStart);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        connect.start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        log.error(<span class="string">&quot;Failed to start Connect&quot;</span>, e);</span><br><span class="line">        connect.stop();</span><br><span class="line">        Exit.exit(<span class="number">3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> connect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h6 id="4-3-2-1加载所有插件类"><a href="#4-3-2-1加载所有插件类" class="headerlink" title="4.3.2.1加载所有插件类"></a>4.3.2.1加载所有插件类</h6><p>Plugins plugins = new Plugins(workerProps)调用用Plugins的初始化方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Plugins</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从配置文件plugin.path配置获取插件位置</span></span><br><span class="line">    List&lt;String&gt; pluginLocations = WorkerConfig.pluginLocations(props);</span><br><span class="line">    <span class="comment">//创建代理类加载器</span></span><br><span class="line">    delegatingLoader = newDelegatingClassLoader(pluginLocations);</span><br><span class="line">    <span class="comment">//加载classpath中所有的插件类</span></span><br><span class="line">    delegatingLoader.initLoaders();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">pluginLocations</span><span class="params">(Map&lt;String, String&gt; props)</span> </span>&#123;</span><br><span class="line">    String locationList = props.get(WorkerConfig.PLUGIN_PATH_CONFIG);	<span class="comment">//插件路径配置plugin.path</span></span><br><span class="line">    <span class="keyword">return</span> locationList == <span class="keyword">null</span></span><br><span class="line">                     ? <span class="keyword">new</span> ArrayList&lt;String&gt;()</span><br><span class="line">                     : Arrays.asList(COMMA_WITH_WHITESPACE.split(locationList.trim(), -<span class="number">1</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-2初始化DistributedConfig列表对象"><a href="#4-3-2-2初始化DistributedConfig列表对象" class="headerlink" title="4.3.2.2初始化DistributedConfig列表对象"></a>4.3.2.2初始化DistributedConfig列表对象</h6><p>调用plugins的compareAndSwapWithDelegatingLoader方法，切换当前线程的类加载器为代理类加载器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">compareAndSwapWithDelegatingLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//获取当前线程的类加载器</span></span><br><span class="line">    ClassLoader current = Thread.currentThread().getContextClassLoader();</span><br><span class="line">    <span class="comment">//如果当前线程的类加器和代理加载器不相同，设置当前线程的类加载器为代理类加载器</span></span><br><span class="line">    <span class="keyword">if</span> (!current.equals(delegatingLoader)) &#123;</span><br><span class="line">        Thread.currentThread().setContextClassLoader(delegatingLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-3通过kafka客户端请求kafka获取集群id"><a href="#4-3-2-3通过kafka客户端请求kafka获取集群id" class="headerlink" title="4.3.2.3通过kafka客户端请求kafka获取集群id"></a>4.3.2.3通过kafka客户端请求kafka获取集群id</h6><p>使用ConnectUtils工具类调用lookupKafkaClusterId方法连接kafka获取kafka集群id</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">//通过kafka连接客户端请求kafka获取kafka集群id</span></span><br><span class="line">    String kafkaClusterId = ConnectUtils.lookupKafkaClusterId(config);</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">lookupKafkaClusterId</span><span class="params">(WorkerConfig config)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">&quot;Creating Kafka admin client&quot;</span>);</span><br><span class="line">    <span class="comment">//创建kafka连接客户端</span></span><br><span class="line">    <span class="keyword">try</span> (Admin adminClient = Admin.create(config.originals())) &#123;</span><br><span class="line">        <span class="comment">//调用lookupKafkaClusterId方法</span></span><br><span class="line">        <span class="keyword">return</span> lookupKafkaClusterId(adminClient);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> String <span class="title">lookupKafkaClusterId</span><span class="params">(Admin adminClient)</span> </span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Looking up Kafka cluster ID&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//请求kafka获取集群id</span></span><br><span class="line">        KafkaFuture&lt;String&gt; clusterIdFuture = adminClient.describeCluster().clusterId();</span><br><span class="line">        <span class="keyword">if</span> (clusterIdFuture == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Kafka cluster version is too old to return cluster ID&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        log.debug(<span class="string">&quot;Fetching Kafka cluster ID&quot;</span>);</span><br><span class="line">        String kafkaClusterId = clusterIdFuture.get();</span><br><span class="line">        log.info(<span class="string">&quot;Kafka cluster ID: &#123;&#125;&quot;</span>, kafkaClusterId);</span><br><span class="line">        <span class="keyword">return</span> kafkaClusterId;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unexpectedly interrupted when looking up Kafka cluster info&quot;</span>, e);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Failed to connect to and describe Kafka cluster. &quot;</span></span><br><span class="line">                                   + <span class="string">&quot;Check worker&#x27;s broker connection and security properties.&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-4初始化jetty-rest服务"><a href="#4-3-2-4初始化jetty-rest服务" class="headerlink" title="4.3.2.4初始化jetty rest服务"></a>4.3.2.4初始化jetty rest服务</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//初始化jetty rest服务，如uri、监听器</span></span><br><span class="line">RestServer rest = <span class="keyword">new</span> RestServer(config);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RestServer</span><span class="params">(WorkerConfig config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.config = config;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//加载配置文件获取rest http的uri</span></span><br><span class="line">        List&lt;String&gt; listeners = parseListeners();</span><br><span class="line">        <span class="comment">//获取配置文件admin.listeners配置</span></span><br><span class="line">        List&lt;String&gt; adminListeners = config.getList(WorkerConfig.ADMIN_LISTENERS_CONFIG);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化jetty服务</span></span><br><span class="line">        jettyServer = <span class="keyword">new</span> Server();</span><br><span class="line">        handlers = <span class="keyword">new</span> ContextHandlerCollection();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加监听服务</span></span><br><span class="line">        createConnectors(listeners, adminListeners);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;String&gt; <span class="title">parseListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//获取配置文件listeners配置信息</span></span><br><span class="line">        List&lt;String&gt; listeners = config.getList(WorkerConfig.LISTENERS_CONFIG);</span><br><span class="line">        <span class="comment">//如果配置为空,获取配置文件rest.host.name配置</span></span><br><span class="line">        <span class="keyword">if</span> (listeners == <span class="keyword">null</span> || listeners.size() == <span class="number">0</span>) &#123;</span><br><span class="line">            String hostname = config.getString(WorkerConfig.REST_HOST_NAME_CONFIG);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (hostname == <span class="keyword">null</span>)</span><br><span class="line">                hostname = <span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//获取rest.port端口配置，默认8083，拼接为url</span></span><br><span class="line">            listeners = Collections.singletonList(String.format(<span class="string">&quot;%s://%s:%d&quot;</span>, PROTOCOL_HTTP, hostname, config.getInt(WorkerConfig.REST_PORT_CONFIG)));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> listeners;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-5启动rest服务"><a href="#4-3-2-5启动rest服务" class="headerlink" title="4.3.2.5启动rest服务"></a>4.3.2.5启动rest服务</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用rest方法启动服务</span></span><br><span class="line">rest.initializeServer();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initializing REST server&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Needed for graceful shutdown as per `setStopTimeout` documentation */</span></span><br><span class="line">        StatisticsHandler statsHandler = <span class="keyword">new</span> StatisticsHandler();</span><br><span class="line">        statsHandler.setHandler(handlers);</span><br><span class="line">        jettyServer.setHandler(statsHandler);</span><br><span class="line">        jettyServer.setStopTimeout(GRACEFUL_SHUTDOWN_TIMEOUT_MS);</span><br><span class="line">        jettyServer.setStopAtShutdown(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//启动jettyServer服务</span></span><br><span class="line">            jettyServer.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize REST server&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;REST server listening at &quot;</span> + jettyServer.getURI() + <span class="string">&quot;, advertising URL &quot;</span> + advertisedUrl());</span><br><span class="line">        log.info(<span class="string">&quot;REST admin endpoints at &quot;</span> + adminUrl());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-6获取rest服务uri"><a href="#4-3-2-6获取rest服务uri" class="headerlink" title="4.3.2.6获取rest服务uri"></a>4.3.2.6获取rest服务uri</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> URI <span class="title">advertisedUrl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从rest服务的uri获取UriBuilder，uri为上一步从配置文件生成,若未配置ip取默认的本机ip</span></span><br><span class="line">    UriBuilder builder = UriBuilder.fromUri(jettyServer.getURI());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用方法从rest.advertised.listener或listeners获取请求方式http还是https</span></span><br><span class="line">    String advertisedSecurityProtocol = determineAdvertisedProtocol();</span><br><span class="line">    <span class="comment">//根据url类型获取connector</span></span><br><span class="line">    ServerConnector serverConnector = findConnector(advertisedSecurityProtocol);</span><br><span class="line">    <span class="comment">//构建scheme的请求方式http或https</span></span><br><span class="line">    builder.scheme(advertisedSecurityProtocol);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从配置文件获取rest.advertised.host.name配置,不为空则构建host为配置，否则构建上一步connector的host</span></span><br><span class="line">    String advertisedHostname = config.getString(WorkerConfig.REST_ADVERTISED_HOST_NAME_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (advertisedHostname != <span class="keyword">null</span> &amp;&amp; !advertisedHostname.isEmpty())</span><br><span class="line">        builder.host(advertisedHostname);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (serverConnector != <span class="keyword">null</span> &amp;&amp; serverConnector.getHost() != <span class="keyword">null</span> &amp;&amp; serverConnector.getHost().length() &gt; <span class="number">0</span>)</span><br><span class="line">        builder.host(serverConnector.getHost());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//从配置文件获取rest.advertised.port的配置，不为空则构建port为配置，否则构建上一步connector的port</span></span><br><span class="line">    Integer advertisedPort = config.getInt(WorkerConfig.REST_ADVERTISED_PORT_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (advertisedPort != <span class="keyword">null</span>)</span><br><span class="line">        builder.port(advertisedPort);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (serverConnector != <span class="keyword">null</span> &amp;&amp; serverConnector.getPort() &gt; <span class="number">0</span>)</span><br><span class="line">        builder.port(serverConnector.getPort());</span><br><span class="line"></span><br><span class="line">    log.info(<span class="string">&quot;Advertised URI: &#123;&#125;&quot;</span>, builder.build());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> builder.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-7初始化并构建KafkaOffsetBackingStore偏移量主题存储"><a href="#4-3-2-7初始化并构建KafkaOffsetBackingStore偏移量主题存储" class="headerlink" title="4.3.2.7初始化并构建KafkaOffsetBackingStore偏移量主题存储"></a>4.3.2.7初始化并构建KafkaOffsetBackingStore偏移量主题存储</h6><p>初始化并创建connect的偏移量topic，并创建kafka日志文件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(<span class="keyword">final</span> WorkerConfig config)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//从配置文件获取offset.storage.topic配置信息，若为空抛出异常</span></span><br><span class="line">    String topic = config.getString(DistributedConfig.OFFSET_STORAGE_TOPIC_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (topic == <span class="keyword">null</span> || topic.trim().length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Offset storage topic must be specified&quot;</span>);</span><br><span class="line"></span><br><span class="line">    data = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取connect配置文件originals类配置到originals</span></span><br><span class="line">    Map&lt;String, Object&gt; originals = config.originals();</span><br><span class="line">    <span class="comment">//初始化生产者配置map，存入key.serializer、value.serializer、delivery.timeout.ms序列化配置</span></span><br><span class="line">    Map&lt;String, Object&gt; producerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG, Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化消费者配置map，存入key.deserializer、value.deserializer反序列化配置</span></span><br><span class="line">    Map&lt;String, Object&gt; consumerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化admin管理者map,存入offset.storage.partitions、offset.storage.replication.factor分区和复制因子配置</span></span><br><span class="line">    Map&lt;String, Object&gt; adminProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription = TopicAdmin.defineTopic(topic).</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(config.getInt(DistributedConfig.OFFSET_STORAGE_PARTITIONS_CONFIG)).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.OFFSET_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用当前类createKafkaBasedLog方法,请求kafka创建日志</span></span><br><span class="line">    offsetLog = createKafkaBasedLog(topic, producerProps, consumerProps, consumedCallback, topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-8获取connector-client-config-override-policy配置代理类加载插件类"><a href="#4-3-2-8获取connector-client-config-override-policy配置代理类加载插件类" class="headerlink" title="4.3.2.8获取connector.client.config.override.policy配置代理类加载插件类"></a>4.3.2.8获取connector.client.config.override.policy配置代理类加载插件类</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">newPlugin</span><span class="params">(String klassName, AbstractConfig config, Class&lt;T&gt; pluginKlass)</span> </span>&#123;</span><br><span class="line">    T plugin;</span><br><span class="line">    Class&lt;? extends T&gt; klass;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//加载class org.apache.kafka.connect.connector.policy.NoneConnectorClientConfigOverridePolicy接口的实现类</span></span><br><span class="line">        klass = pluginClass(delegatingLoader, klassName, pluginKlass);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        String msg = String.format(<span class="string">&quot;Failed to find any class that implements %s and which &quot;</span></span><br><span class="line">                                   + <span class="string">&quot;name matches %s&quot;</span>, pluginKlass, klassName);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(msg);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//获取klass的类加载器并切换为当前线程的类加载器</span></span><br><span class="line">    ClassLoader savedLoader = compareAndSwapLoaders(klass.getClassLoader());</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//加载插件类</span></span><br><span class="line">        plugin = newPlugin(klass);</span><br><span class="line">        <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Versioned) &#123;</span><br><span class="line">            Versioned versionedPlugin = (Versioned) plugin;</span><br><span class="line">            <span class="keyword">if</span> (versionedPlugin.version() == <span class="keyword">null</span> || versionedPlugin.version().trim()</span><br><span class="line">                .isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Version not defined for &#x27;&quot;</span> + klassName + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (plugin <span class="keyword">instanceof</span> Configurable) &#123;</span><br><span class="line">            ((Configurable) plugin).configure(config.originals());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//获取savedLoader的类加载器并切换为当前线程的类加载器</span></span><br><span class="line">        compareAndSwapLoaders(savedLoader);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> plugin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-9初始化kafka的Worker"><a href="#4-3-2-9初始化kafka的Worker" class="headerlink" title="4.3.2.9初始化kafka的Worker"></a>4.3.2.9初始化kafka的Worker</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Worker(</span><br><span class="line">        String workerId,</span><br><span class="line">        Time time,</span><br><span class="line">        Plugins plugins,</span><br><span class="line">        WorkerConfig config,</span><br><span class="line">        OffsetBackingStore offsetBackingStore,</span><br><span class="line">        ExecutorService executorService,</span><br><span class="line">        ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="comment">//实例化指标和报表</span></span><br><span class="line">    <span class="keyword">this</span>.metrics = <span class="keyword">new</span> ConnectMetrics(workerId, config, time);</span><br><span class="line">    <span class="comment">//赋值执行线程池</span></span><br><span class="line">    <span class="keyword">this</span>.executor = executorService;</span><br><span class="line">    <span class="keyword">this</span>.workerId = workerId;</span><br><span class="line">    <span class="keyword">this</span>.time = time;</span><br><span class="line">    <span class="keyword">this</span>.plugins = plugins;</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line">    <span class="keyword">this</span>.connectorClientConfigOverridePolicy = connectorClientConfigOverridePolicy;</span><br><span class="line">    <span class="comment">//初始化指标群</span></span><br><span class="line">    <span class="keyword">this</span>.workerMetricsGroup = <span class="keyword">new</span> WorkerMetricsGroup(metrics);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Internal converters are required properties, thus getClass won&#x27;t return null.</span></span><br><span class="line">    <span class="comment">//根据配置internal.key.converter初始化internalKeyConverter</span></span><br><span class="line">    <span class="keyword">this</span>.internalKeyConverter = plugins.newConverter(</span><br><span class="line">            config,</span><br><span class="line">            WorkerConfig.INTERNAL_KEY_CONVERTER_CLASS_CONFIG,</span><br><span class="line">            ClassLoaderUsage.PLUGINS</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="comment">//根据配置internal.value.converter初始化internalValueConverter</span></span><br><span class="line">    <span class="keyword">this</span>.internalValueConverter = plugins.newConverter(</span><br><span class="line">            config,</span><br><span class="line">            WorkerConfig.INTERNAL_VALUE_CONVERTER_CLASS_CONFIG,</span><br><span class="line">            ClassLoaderUsage.PLUGINS</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.offsetBackingStore = offsetBackingStore;</span><br><span class="line">    <span class="keyword">this</span>.offsetBackingStore.configure(config);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.workerConfigTransformer = initConfigTransformer();</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-10初始化并构建ConfigBackingStore状态主题存储"><a href="#4-3-2-10初始化并构建ConfigBackingStore状态主题存储" class="headerlink" title="4.3.2.10初始化并构建ConfigBackingStore状态主题存储"></a>4.3.2.10初始化并构建ConfigBackingStore状态主题存储</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">public void configure(final WorkerConfig config) &#123;</span><br><span class="line">    &#x2F;&#x2F;获取配置status.storage.topic状态存储topic配置</span><br><span class="line">    this.statusTopic &#x3D; config.getString(DistributedConfig.STATUS_STORAGE_TOPIC_CONFIG);</span><br><span class="line">    if (this.statusTopic &#x3D;&#x3D; null || this.statusTopic.trim().length() &#x3D;&#x3D; 0)</span><br><span class="line">        throw new ConfigException(&quot;Must specify topic for connector status.&quot;);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Object&gt; originals &#x3D; config.originals();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化生产者配置参数，存入key.serializer、value.serializer、retries序列化配置和对象类</span><br><span class="line">    Map&lt;String, Object&gt; producerProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.RETRIES_CONFIG, 0); &#x2F;&#x2F; we handle retries in this class</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化消费者配置参数，存入key.deserializer、value.deserializer反序列化配置和对象类</span><br><span class="line">    Map&lt;String, Object&gt; consumerProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;初始化管理者配置参数，根据status.storage.topic、status.storage.partitions、status.storage.replication.factor配置初始化topic对象</span><br><span class="line">    Map&lt;String, Object&gt; adminProps &#x3D; new HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription &#x3D; TopicAdmin.defineTopic(statusTopic).    &#x2F;&#x2F;创建topic创建者</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(config.getInt(DistributedConfig.STATUS_STORAGE_PARTITIONS_CONFIG)).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.STATUS_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    Callback&lt;ConsumerRecord&lt;String, byte[]&gt;&gt; readCallback &#x3D; new Callback&lt;ConsumerRecord&lt;String, byte[]&gt;&gt;() &#123;</span><br><span class="line">        @Override</span><br><span class="line">        public void onCompletion(Throwable error, ConsumerRecord&lt;String, byte[]&gt; record) &#123;</span><br><span class="line">            read(record);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;实例化org.apache.kafka.connect.util.KafkaBasedLog</span><br><span class="line">    this.kafkaLog &#x3D; createKafkaBasedLog(statusTopic, producerProps, consumerProps, readCallback, topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.3.2.11初始化并构建ConfigBackingStore状态主题存储</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KafkaConfigBackingStore</span><span class="params">(Converter converter, WorkerConfig config, WorkerConfigTransformer configTransformer)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.lock = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="keyword">this</span>.started = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">this</span>.converter = converter;</span><br><span class="line">    <span class="keyword">this</span>.offset = -<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//获取配置config.storage.topic</span></span><br><span class="line">    <span class="keyword">this</span>.topic = config.getString(DistributedConfig.CONFIG_TOPIC_CONFIG);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.topic == <span class="keyword">null</span> || <span class="keyword">this</span>.topic.trim().length() == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ConfigException(<span class="string">&quot;Must specify topic for connector configuration.&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//调用当前类方法设置并创建configLog</span></span><br><span class="line">    configLog = setupAndCreateKafkaBasedLog(<span class="keyword">this</span>.topic, config);</span><br><span class="line">    <span class="keyword">this</span>.configTransformer = configTransformer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调用当前类的方法创建设置并创建kafka日志</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">KafkaBasedLog&lt;String, <span class="keyword">byte</span>[]&gt; setupAndCreateKafkaBasedLog(String topic, <span class="keyword">final</span> WorkerConfig config) &#123;</span><br><span class="line">    Map&lt;String, Object&gt; originals = config.originals();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化生产者配置参数，存入key.serializer、value.serializer、delivery.timeout.ms序列化配置和对象类</span></span><br><span class="line">    Map&lt;String, Object&gt; producerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, ByteArraySerializer.class.getName());</span><br><span class="line">    producerProps.put(ProducerConfig.DELIVERY_TIMEOUT_MS_CONFIG, Integer.MAX_VALUE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化消费者配置参数，存入key.deserializer、value.deserializer反序列化配置和对象类</span></span><br><span class="line">    Map&lt;String, Object&gt; consumerProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, StringDeserializer.class.getName());</span><br><span class="line">    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class.getName());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//初始化管理者配置参数，根据config.storage.topic、config.storage.replication.factor配置初始化topic对象</span></span><br><span class="line">    Map&lt;String, Object&gt; adminProps = <span class="keyword">new</span> HashMap&lt;&gt;(originals);</span><br><span class="line">    NewTopic topicDescription = TopicAdmin.defineTopic(topic).</span><br><span class="line">            compacted().</span><br><span class="line">            partitions(<span class="number">1</span>).</span><br><span class="line">            replicationFactor(config.getShort(DistributedConfig.CONFIG_STORAGE_REPLICATION_FACTOR_CONFIG)).</span><br><span class="line">            build();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> createKafkaBasedLog(topic, producerProps, consumerProps, <span class="keyword">new</span> ConsumeCallback(), topicDescription, adminProps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-11初始化并构建核心调度DistributedHerder"><a href="#4-3-2-11初始化并构建核心调度DistributedHerder" class="headerlink" title="4.3.2.11初始化并构建核心调度DistributedHerder"></a>4.3.2.11初始化并构建核心调度DistributedHerder</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistributedHerder</span><span class="params">(DistributedConfig config,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Time time,</span></span></span><br><span class="line"><span class="function"><span class="params">                         Worker worker,</span></span></span><br><span class="line"><span class="function"><span class="params">                         String kafkaClusterId,</span></span></span><br><span class="line"><span class="function"><span class="params">                         StatusBackingStore statusBackingStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                         ConfigBackingStore configBackingStore,</span></span></span><br><span class="line"><span class="function"><span class="params">                         String restUrl,</span></span></span><br><span class="line"><span class="function"><span class="params">                         ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//调用构造函数初始化</span></span><br><span class="line">    <span class="keyword">this</span>(config, worker, worker.workerId(), kafkaClusterId, statusBackingStore, configBackingStore, <span class="keyword">null</span>, restUrl, worker.metrics(),</span><br><span class="line">         time, connectorClientConfigOverridePolicy);</span><br><span class="line">    <span class="comment">//设置configBackingStore的更新监听者</span></span><br><span class="line">    configBackingStore.setUpdateListener(<span class="keyword">new</span> ConfigUpdateListener());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用重载方法初始化DistributedHerder</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">DistributedHerder(DistributedConfig config,</span><br><span class="line">                  Worker worker,</span><br><span class="line">                  String workerId,</span><br><span class="line">                  String kafkaClusterId,</span><br><span class="line">                  StatusBackingStore statusBackingStore,</span><br><span class="line">                  ConfigBackingStore configBackingStore,</span><br><span class="line">                  WorkerGroupMember member,</span><br><span class="line">                  String restUrl,</span><br><span class="line">                  ConnectMetrics metrics,</span><br><span class="line">                  Time time,</span><br><span class="line">                  ConnectorClientConfigOverridePolicy connectorClientConfigOverridePolicy) &#123;</span><br><span class="line">    <span class="keyword">super</span>(worker, workerId, kafkaClusterId, statusBackingStore, configBackingStore, connectorClientConfigOverridePolicy);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.time = time;</span><br><span class="line">    <span class="keyword">this</span>.herderMetrics = <span class="keyword">new</span> HerderMetrics(metrics);</span><br><span class="line">    <span class="keyword">this</span>.workerGroupId = config.getString(DistributedConfig.GROUP_ID_CONFIG);   <span class="comment">//获取配置group.id</span></span><br><span class="line">    <span class="keyword">this</span>.workerSyncTimeoutMs = config.getInt(DistributedConfig.WORKER_SYNC_TIMEOUT_MS_CONFIG);  <span class="comment">//获取配置worker.sync.timeout.ms</span></span><br><span class="line">    <span class="keyword">this</span>.workerTasksShutdownTimeoutMs = config.getLong(DistributedConfig.TASK_SHUTDOWN_GRACEFUL_TIMEOUT_MS_CONFIG); <span class="comment">//获取配置task.shutdown.graceful.timeout.ms</span></span><br><span class="line">    <span class="keyword">this</span>.workerUnsyncBackoffMs = config.getInt(DistributedConfig.WORKER_UNSYNC_BACKOFF_MS_CONFIG);  <span class="comment">//获取配置worker.unsync.backoff.ms</span></span><br><span class="line">    <span class="keyword">this</span>.requestSignatureAlgorithm = config.getString(DistributedConfig.INTER_WORKER_SIGNATURE_ALGORITHM_CONFIG);   <span class="comment">//获取配置inter.worker.signature.algorithm</span></span><br><span class="line">    <span class="keyword">this</span>.keyRotationIntervalMs = config.getInt(DistributedConfig.INTER_WORKER_KEY_TTL_MS_CONFIG);   <span class="comment">//获取配置inter.worker.key.ttl.ms</span></span><br><span class="line">    <span class="keyword">this</span>.keySignatureVerificationAlgorithms = config.getList(DistributedConfig.INTER_WORKER_VERIFICATION_ALGORITHMS_CONFIG);    <span class="comment">//获取配置inter.worker.verification.algorithms</span></span><br><span class="line">    <span class="keyword">this</span>.keyGenerator = config.getInternalRequestKeyGenerator();    <span class="comment">//调用当前类方法根据配置inter.worker.key.generation.algorithm、inter.worker.key.size创建keyGenerator，</span></span><br><span class="line">    <span class="keyword">this</span>.isTopicTrackingEnabled = config.getBoolean(TOPIC_TRACKING_ENABLE_CONFIG);  <span class="comment">//获取配置topic.tracking.enable</span></span><br><span class="line"></span><br><span class="line">    String clientIdConfig = config.getString(CommonClientConfigs.CLIENT_ID_CONFIG); <span class="comment">//获取配置client.id</span></span><br><span class="line">    <span class="comment">//若client.id为空，拼接&quot;connect-&quot;+自动序列，不为空则取配置</span></span><br><span class="line">    String clientId = clientIdConfig.length() &lt;= <span class="number">0</span> ? <span class="string">&quot;connect-&quot;</span> + CONNECT_CLIENT_ID_SEQUENCE.getAndIncrement() : clientIdConfig;</span><br><span class="line">    LogContext logContext = <span class="keyword">new</span> LogContext(<span class="string">&quot;[Worker clientId=&quot;</span> + clientId + <span class="string">&quot;, groupId=&quot;</span> + <span class="keyword">this</span>.workerGroupId + <span class="string">&quot;] &quot;</span>);</span><br><span class="line">    log = logContext.logger(DistributedHerder.class);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果member为空，则实例化WorkerGroupMember</span></span><br><span class="line">    <span class="keyword">this</span>.member = member != <span class="keyword">null</span></span><br><span class="line">                  ? member</span><br><span class="line">                  : <span class="keyword">new</span> WorkerGroupMember(config, restUrl, <span class="keyword">this</span>.configBackingStore,</span><br><span class="line">                          <span class="keyword">new</span> RebalanceListener(time), time, clientId, logContext);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化herderExecutor线程池</span></span><br><span class="line">    <span class="keyword">this</span>.herderExecutor = <span class="keyword">new</span> ThreadPoolExecutor(<span class="number">1</span>, <span class="number">1</span>, <span class="number">0L</span>,</span><br><span class="line">            TimeUnit.MILLISECONDS,</span><br><span class="line">            <span class="keyword">new</span> LinkedBlockingDeque&lt;Runnable&gt;(<span class="number">1</span>),</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="keyword">this</span>.getClass().getSimpleName() + <span class="string">&quot;-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实例化转发请求线程池</span></span><br><span class="line">    <span class="keyword">this</span>.forwardRequestExecutor = Executors.newFixedThreadPool(<span class="number">1</span>,</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="string">&quot;ForwardRequestExecutor-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line">    <span class="comment">//实例化启动和停止线程池</span></span><br><span class="line">    <span class="keyword">this</span>.startAndStopExecutor = Executors.newFixedThreadPool(START_STOP_THREAD_POOL_SIZE,</span><br><span class="line">            ThreadUtils.createThreadFactory(</span><br><span class="line">                    <span class="string">&quot;StartAndStopExecutor-&quot;</span> + clientId + <span class="string">&quot;-%d&quot;</span>, <span class="keyword">false</span>));</span><br><span class="line">    <span class="keyword">this</span>.config = config;</span><br><span class="line"></span><br><span class="line">    stopping = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line">    configState = ClusterConfigState.EMPTY;</span><br><span class="line">    rebalanceResolved = <span class="keyword">true</span>; <span class="comment">// If we still need to follow up after a rebalance occurred, starting up tasks</span></span><br><span class="line">    needsReconfigRebalance = <span class="keyword">false</span>;</span><br><span class="line">    canReadConfigs = <span class="keyword">true</span>; <span class="comment">// We didn&#x27;t try yet, but Configs are readable until proven otherwise</span></span><br><span class="line">    scheduledRebalance = Long.MAX_VALUE;</span><br><span class="line">    keyExpiration = Long.MAX_VALUE;</span><br><span class="line">    sessionKey = <span class="keyword">null</span>;</span><br><span class="line">    backoffRetries = BACKOFF_RETRIES;</span><br><span class="line">    <span class="comment">//获取connect.protocol配置，赋值当前版本</span></span><br><span class="line">    currentProtocolVersion = ConnectProtocolCompatibility.compatibility(</span><br><span class="line">        config.getString(DistributedConfig.CONNECT_PROTOCOL_CONFIG)</span><br><span class="line">    ).protocolVersion();</span><br><span class="line">    <span class="keyword">if</span> (!internalRequestValidationEnabled(currentProtocolVersion)) &#123;</span><br><span class="line">        log.warn(</span><br><span class="line">            <span class="string">&quot;Internal request verification will be disabled for this cluster as this worker&#x27;s &#123;&#125; configuration has been set to &#x27;&#123;&#125;&#x27;. &quot;</span></span><br><span class="line">                + <span class="string">&quot;If this is not intentional, either remove the &#x27;&#123;&#125;&#x27; configuration from the worker config file or change its value &quot;</span></span><br><span class="line">                + <span class="string">&quot;to &#x27;&#123;&#125;&#x27;. If this configuration is left as-is, the cluster will be insecure; for more information, see KIP-507: &quot;</span></span><br><span class="line">                + <span class="string">&quot;https://cwiki.apache.org/confluence/display/KAFKA/KIP-507%3A+Securing+Internal+Connect+REST+Endpoints&quot;</span>,</span><br><span class="line">            DistributedConfig.CONNECT_PROTOCOL_CONFIG,</span><br><span class="line">            config.getString(DistributedConfig.CONNECT_PROTOCOL_CONFIG),</span><br><span class="line">            DistributedConfig.CONNECT_PROTOCOL_CONFIG,</span><br><span class="line">            ConnectProtocolCompatibility.SESSIONED.name()</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>4.3.2.13初始化connect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Connect</span><span class="params">(Herder herder, RestServer rest)</span> </span>&#123;</span><br><span class="line">    log.debug(<span class="string">&quot;Kafka Connect instance created&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.herder = herder;</span><br><span class="line">    <span class="keyword">this</span>.rest = rest;</span><br><span class="line">    shutdownHook = <span class="keyword">new</span> ShutdownHook();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="4-3-2-12启动connect"><a href="#4-3-2-12启动connect" class="headerlink" title="4.3.2.12启动connect"></a>4.3.2.12启动connect</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;Kafka Connect starting&quot;</span>);</span><br><span class="line">        Exit.addShutdownHook(<span class="string">&quot;connect-shutdown-hook&quot;</span>, shutdownHook);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//启动herder线程，并启动守护线程</span></span><br><span class="line">        herder.start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化rest服务资源并启动服务</span></span><br><span class="line">        rest.initializeResources(herder);</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;Kafka Connect started&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        startLatch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initializeResources</span><span class="params">(Herder herder)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">&quot;Initializing REST resources&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化并添加资源配置</span></span><br><span class="line">        ResourceConfig resourceConfig = <span class="keyword">new</span> ResourceConfig();</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> JacksonJsonProvider());</span><br><span class="line"></span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> RootResource(herder));</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> ConnectorsResource(herder, config));</span><br><span class="line">        resourceConfig.register(<span class="keyword">new</span> ConnectorPluginsResource(herder));</span><br><span class="line"></span><br><span class="line">        resourceConfig.register(ConnectExceptionMapper.class);</span><br><span class="line">        resourceConfig.property(ServerProperties.WADL_FEATURE_DISABLE, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">        registerRestExtensions(herder, resourceConfig);</span><br><span class="line"></span><br><span class="line">        List&lt;String&gt; adminListeners = config.getList(WorkerConfig.ADMIN_LISTENERS_CONFIG);  <span class="comment">//获取admin.listeners配置列表</span></span><br><span class="line">        <span class="comment">//初始化管理者监听列表，如果为空，则使用resourceConfig，如果不为空则初始化adminResourceConfig</span></span><br><span class="line">        ResourceConfig adminResourceConfig;</span><br><span class="line">        <span class="keyword">if</span> (adminListeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Adding admin resources to main listener&quot;</span>);</span><br><span class="line">            adminResourceConfig = resourceConfig;</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> LoggingResource());</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (adminListeners.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> we need to check if these listeners are same as &#x27;listeners&#x27;</span></span><br><span class="line">            <span class="comment">// <span class="doctag">TODO:</span> the following code assumes that they are different</span></span><br><span class="line">            log.info(<span class="string">&quot;Adding admin resources to admin listener&quot;</span>);</span><br><span class="line">            adminResourceConfig = <span class="keyword">new</span> ResourceConfig();</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> JacksonJsonProvider());</span><br><span class="line">            adminResourceConfig.register(<span class="keyword">new</span> LoggingResource());</span><br><span class="line">            adminResourceConfig.register(ConnectExceptionMapper.class);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.info(<span class="string">&quot;Skipping adding admin resources&quot;</span>);</span><br><span class="line">            <span class="comment">// set up adminResource but add no handlers to it</span></span><br><span class="line">            adminResourceConfig = resourceConfig;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ServletContainer servletContainer = <span class="keyword">new</span> ServletContainer(resourceConfig);   <span class="comment">//初始化servlet容器</span></span><br><span class="line">        ServletHolder servletHolder = <span class="keyword">new</span> ServletHolder(servletContainer);  <span class="comment">//实例化servlet持有者</span></span><br><span class="line">        List&lt;Handler&gt; contextHandlers = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化servlet上下处理器</span></span><br><span class="line">        ServletContextHandler context = <span class="keyword">new</span> ServletContextHandler(ServletContextHandler.SESSIONS);</span><br><span class="line">        context.setContextPath(<span class="string">&quot;/&quot;</span>);    <span class="comment">//设置根路径</span></span><br><span class="line">        context.addServlet(servletHolder, <span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        contextHandlers.add(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果设置了管理者配置，则实例化管理者上下文处理器</span></span><br><span class="line">        ServletContextHandler adminContext = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (adminResourceConfig != resourceConfig) &#123;</span><br><span class="line">            adminContext = <span class="keyword">new</span> ServletContextHandler(ServletContextHandler.SESSIONS);</span><br><span class="line">            ServletHolder adminServletHolder = <span class="keyword">new</span> ServletHolder(<span class="keyword">new</span> ServletContainer(adminResourceConfig));</span><br><span class="line">            adminContext.setContextPath(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            adminContext.addServlet(adminServletHolder, <span class="string">&quot;/*&quot;</span>);</span><br><span class="line">            adminContext.setVirtualHosts(<span class="keyword">new</span> String[]&#123;<span class="string">&quot;@&quot;</span> + ADMIN_SERVER_CONNECTOR_NAME&#125;);</span><br><span class="line">            contextHandlers.add(adminContext);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取配置access.control.allow.origin、allowedOrigins、access.control.allow.methods、allowedMethods，并设置相应过滤规则</span></span><br><span class="line">        String allowedOrigins = config.getString(WorkerConfig.ACCESS_CONTROL_ALLOW_ORIGIN_CONFIG);</span><br><span class="line">        <span class="keyword">if</span> (allowedOrigins != <span class="keyword">null</span> &amp;&amp; !allowedOrigins.trim().isEmpty()) &#123;</span><br><span class="line">            FilterHolder filterHolder = <span class="keyword">new</span> FilterHolder(<span class="keyword">new</span> CrossOriginFilter());</span><br><span class="line">            filterHolder.setName(<span class="string">&quot;cross-origin&quot;</span>);</span><br><span class="line">            filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_ORIGINS_PARAM, allowedOrigins);</span><br><span class="line">            String allowedMethods = config.getString(WorkerConfig.ACCESS_CONTROL_ALLOW_METHODS_CONFIG);</span><br><span class="line">            <span class="keyword">if</span> (allowedMethods != <span class="keyword">null</span> &amp;&amp; !allowedOrigins.trim().isEmpty()) &#123;</span><br><span class="line">                filterHolder.setInitParameter(CrossOriginFilter.ALLOWED_METHODS_PARAM, allowedMethods);</span><br><span class="line">            &#125;</span><br><span class="line">            context.addFilter(filterHolder, <span class="string">&quot;/*&quot;</span>, EnumSet.of(DispatcherType.REQUEST));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//初始化请求日志处理器</span></span><br><span class="line">        RequestLogHandler requestLogHandler = <span class="keyword">new</span> RequestLogHandler();</span><br><span class="line">        Slf4jRequestLogWriter slf4jRequestLogWriter = <span class="keyword">new</span> Slf4jRequestLogWriter();</span><br><span class="line">        slf4jRequestLogWriter.setLoggerName(RestServer.class.getCanonicalName());</span><br><span class="line">        CustomRequestLog requestLog = <span class="keyword">new</span> CustomRequestLog(slf4jRequestLogWriter, CustomRequestLog.EXTENDED_NCSA_FORMAT + <span class="string">&quot; %msT&quot;</span>);</span><br><span class="line">        requestLogHandler.setRequestLog(requestLog);</span><br><span class="line"></span><br><span class="line">        contextHandlers.add(<span class="keyword">new</span> DefaultHandler());</span><br><span class="line">        contextHandlers.add(requestLogHandler);</span><br><span class="line"></span><br><span class="line">        handlers.setHandlers(contextHandlers.toArray(<span class="keyword">new</span> Handler[]&#123;&#125;));</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//启动服务</span></span><br><span class="line">            context.start();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize REST resources&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果Admin配置不为空，启动Admin REST</span></span><br><span class="line">        <span class="keyword">if</span> (adminResourceConfig != resourceConfig) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;Starting admin context&quot;</span>);</span><br><span class="line">                adminContext.start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> ConnectException(<span class="string">&quot;Unable to initialize Admin REST resources&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        log.info(<span class="string">&quot;REST resources initialized; server is started and ready to handle requests&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="5、使用crul运行debezium-connector-mysql"><a href="#5、使用crul运行debezium-connector-mysql" class="headerlink" title="5、使用crul运行debezium-connector-mysql"></a>5、使用crul运行debezium-connector-mysql</h3><p>debezium-connector-mysql的配置如下:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123; </span><br><span class="line">	<span class="attr">&quot;name&quot;</span> : <span class="string">&quot;debezium-mysql-source-3308&quot;</span>,</span><br><span class="line">	<span class="attr">&quot;config&quot;</span>:</span><br><span class="line">	&#123;</span><br><span class="line">	     <span class="attr">&quot;connector.class&quot;</span> : <span class="string">&quot;io.debezium.connector.mysql.MySqlConnector&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.hostname&quot;</span> : <span class="string">&quot;mysql的IP地址&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.port&quot;</span> : <span class="string">&quot;mysql的端口号&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.user&quot;</span> : <span class="string">&quot;mysql的用户名&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.password&quot;</span> : <span class="string">&quot;mysql用户对应的密码&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.server.id&quot;</span> : <span class="string">&quot;184000&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.server.name&quot;</span> : <span class="string">&quot;mysql服务的逻辑名，例如fullfillment&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.kafka.bootstrap.servers&quot;</span> : <span class="string">&quot;ip1:9092,ip2:9092,ip3:9092&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.kafka.topic&quot;</span> : <span class="string">&quot;dbhistory.fullfillment&quot;</span> ,</span><br><span class="line">	     <span class="attr">&quot;include.schema.changes&quot;</span> : <span class="string">&quot;true&quot;</span> ,</span><br><span class="line">	     <span class="attr">&quot;mode&quot;</span> : <span class="string">&quot;incrementing&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;incrementing.column.name&quot;</span> : <span class="string">&quot;id&quot;</span>,</span><br><span class="line">	     <span class="attr">&quot;database.history.skip.unparseable.ddl&quot;</span> : <span class="string">&quot;true&quot;</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Kafka/kafka%20connect%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" data-id="ckk2gq3ul001uz8pqb97hevqe" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-Java/开发框架和工具/Protobuf" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/01/18/Java/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/Protobuf/" class="article-date">
  <time class="dt-published" datetime="2021-01-18T11:01:37.398Z" itemprop="datePublished">2021-01-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/shuiyonglewodezzzzz/p/11347304.html">如何在Java内使用Protobuf</a></p>
<p>首先，你需要安装protoBuf的编译器。假设你已经安装好protobuf的编译器。</p>
<p>新建一个maven项目，pom内添加如下依赖</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.protobuf&lt;&#x2F;groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;protobuf-java&lt;&#x2F;artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.4.0&lt;&#x2F;version&gt;</span><br><span class="line">        &lt;&#x2F;dependency&gt;</span><br><span class="line">    &lt;&#x2F;dependencies&gt;</span><br></pre></td></tr></table></figure>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>第二步，在src/main/java新建proto目录。在里面写.proto文件，声明你对象的格式。比如我的，如果不懂，先抄，看最后结果。</p>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">syntax&#x3D;&quot;proto3&quot;;</span><br><span class="line"></span><br><span class="line">package cc.protobuf;</span><br><span class="line"></span><br><span class="line">option java_package &#x3D; &quot;cc.protobuf.model&quot;;</span><br><span class="line">option java_multiple_files&#x3D;true;</span><br><span class="line">option java_outer_classname&#x3D;&quot;AddressBookProtos&quot;;</span><br><span class="line"></span><br><span class="line">message Person</span><br><span class="line">&#123;</span><br><span class="line">    string name &#x3D; 1;</span><br><span class="line">    int32 id &#x3D; 2;</span><br><span class="line">    string emial &#x3D; 3;</span><br><span class="line">    enum PhoneType &#123;</span><br><span class="line">     MOBILE&#x3D;0;</span><br><span class="line">     HOME&#x3D;1;</span><br><span class="line">     WORK&#x3D;3;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    message PhoneNumber</span><br><span class="line">    &#123;</span><br><span class="line">        string number &#x3D; 1;</span><br><span class="line">        PhoneType rtpe &#x3D; 2;</span><br><span class="line">    &#125;</span><br><span class="line">    repeated PhoneNumber phone &#x3D; 4;</span><br><span class="line">    </span><br><span class="line">    message AddressBook</span><br><span class="line">    &#123;</span><br><span class="line">        repeated Person people &#x3D; 4;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="javascript:void(0);"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></p>
<p>第三步，使用protoc根据.proto文件生成代码。命令如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用cd 命令到 src&#x2F;main&#x2F;java&#x2F;proto</span><br><span class="line">protoc --java_out&#x3D;..&#x2F; .&#x2F;addressBook.proto</span><br></pre></td></tr></table></figure>
<p>第四步，刷新你的项目目录。你应该会看到这个model</p>
<p><img src="https://img2018.cnblogs.com/blog/874342/201908/874342-20190813172726105-239154302.png" alt="img"></p>
<p>这个就是protoc生成代码。具体完整代码查看git</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tangzhe7/test-protobuf">https://github.com/tangzhe7/test-protobuf</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/01/18/Java/%E5%BC%80%E5%8F%91%E6%A1%86%E6%9E%B6%E5%92%8C%E5%B7%A5%E5%85%B7/Protobuf/" data-id="ckk2gq3u0001hz8pqg4tod9gl" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">&laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/6/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/01/18/%E4%BA%91%E8%AE%A1%E7%AE%97/%E4%BA%91%E8%AE%A1%E7%AE%97%E5%B8%B8%E8%A7%81%E6%A6%82%E5%BF%B5/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/03_Redis%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/02_RabbitMQ%E5%AE%9E%E7%8E%B0%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%BB%B6%E8%BF%9F%E6%B6%88%E6%81%AF%E5%8F%91%E9%80%81/01_%E5%BB%B6%E8%BF%9F%E9%98%9F%E5%88%97%E7%9A%84%E6%96%B9%E6%A1%88%E4%BB%8B%E7%BB%8D/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/01/18/%E5%85%B6%E4%BB%96%E5%B0%8F%E6%8A%80%E5%B7%A7/github%E4%B8%8B%E8%BD%BD%E9%80%9F%E5%BA%A6%E5%A4%AA%E6%85%A2/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>